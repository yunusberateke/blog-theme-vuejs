{"remainingRequest":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js?{}!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js","dependencies":[{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyIGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiL2hvbWUvZWtlYmVyYXQvWWFuZGV4LkRpc2svUHJvamVsZXJpbS9CZW5pbVByb2plbGVyaW0vd2Vic2l0ZW0vd2Vic2l0ZW0td2ViL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiL2hvbWUvZWtlYmVyYXQvWWFuZGV4LkRpc2svUHJvamVsZXJpbS9CZW5pbVByb2plbGVyaW0vd2Vic2l0ZW0vd2Vic2l0ZW0td2ViL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jcmVhdGVDbGFzcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zZXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZnJvbS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmpvaW4uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5tYXAuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5uYW1lLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuY29uY2F0LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLmFuY2hvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZS5qcyI7CgovKioKICogQGxpY2Vuc2UgQ29weXJpZ2h0IChjKSAyMDAzLTIwMjEsIENLU291cmNlIC0gRnJlZGVyaWNvIEtuYWJiZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIEZvciBsaWNlbnNpbmcsIHNlZSBMSUNFTlNFLm1kIG9yIGh0dHBzOi8vY2tlZGl0b3IuY29tL2xlZ2FsL2NrZWRpdG9yLW9zcy1saWNlbnNlCiAqLwoKLyogZ2xvYmFscyBOb2RlICovCgovKioKICogQG1vZHVsZSBlbmdpbmUvdmlldy9yZW5kZXJlcgogKi8KaW1wb3J0IFZpZXdUZXh0IGZyb20gJy4vdGV4dCc7CmltcG9ydCBWaWV3UG9zaXRpb24gZnJvbSAnLi9wb3NpdGlvbic7CmltcG9ydCB7IElOTElORV9GSUxMRVIsIElOTElORV9GSUxMRVJfTEVOR1RILCBzdGFydHNXaXRoRmlsbGVyLCBpc0lubGluZUZpbGxlciB9IGZyb20gJy4vZmlsbGVyJzsKaW1wb3J0IG1peCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9taXgnOwppbXBvcnQgZGlmZiBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9kaWZmJzsKaW1wb3J0IGluc2VydEF0IGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2RvbS9pbnNlcnRhdCc7CmltcG9ydCByZW1vdmUgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZG9tL3JlbW92ZSc7CmltcG9ydCBPYnNlcnZhYmxlTWl4aW4gZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvb2JzZXJ2YWJsZW1peGluJzsKaW1wb3J0IENLRWRpdG9yRXJyb3IgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvY2tlZGl0b3JlcnJvcic7CmltcG9ydCBpc1RleHQgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZG9tL2lzdGV4dCc7CmltcG9ydCBpc05vZGUgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZG9tL2lzbm9kZSc7CmltcG9ydCBmYXN0RGlmZiBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9mYXN0ZGlmZic7CmltcG9ydCBlbnYgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMvZW52JzsKLyoqCiAqIFJlbmRlcmVyIGlzIHJlc3BvbnNpYmxlIGZvciB1cGRhdGluZyB0aGUgRE9NIHN0cnVjdHVyZSBhbmQgdGhlIERPTSBzZWxlY3Rpb24gYmFzZWQgb24KICogdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvcmVuZGVyZXJ+UmVuZGVyZXIjbWFya1RvU3luYyBpbmZvcm1hdGlvbiBhYm91dCB1cGRhdGVkIHZpZXcgbm9kZXN9LgogKiBJbiBvdGhlciB3b3JkcywgaXQgcmVuZGVycyB0aGUgdmlldyB0byB0aGUgRE9NLgogKgogKiBJdHMgbWFpbiByZXNwb25zaWJpbGl0eSBpcyB0byBtYWtlIG9ubHkgdGhlIG5lY2Vzc2FyeSwgbWluaW1hbCBjaGFuZ2VzIHRvIHRoZSBET00uIEhvd2V2ZXIsIHVubGlrZSBpbiBtYW55CiAqIHZpcnR1YWwgRE9NIGltcGxlbWVudGF0aW9ucywgdGhlIHByaW1hcnkgcmVhc29uIGZvciBkb2luZyBtaW5pbWFsIGNoYW5nZXMgaXMgbm90IHRoZSBwZXJmb3JtYW5jZSBidXQgZW5zdXJpbmcKICogdGhhdCBuYXRpdmUgZWRpdGluZyBmZWF0dXJlcyBzdWNoIGFzIHRleHQgY29tcG9zaXRpb24sIGF1dG9jb21wbGV0aW9uLCBzcGVsbCBjaGVja2luZywgc2VsZWN0aW9uJ3MgeC1pbmRleCBhcmUKICogYWZmZWN0ZWQgYXMgbGl0dGxlIGFzIHBvc3NpYmxlLgogKgogKiBSZW5kZXJlciB1c2VzIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZG9tY29udmVydGVyfkRvbUNvbnZlcnRlcn0gdG8gdHJhbnNmb3JtIHZpZXcgbm9kZXMgYW5kIHBvc2l0aW9ucwogKiB0byBhbmQgZnJvbSB0aGUgRE9NLgogKi8KCnZhciBSZW5kZXJlciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlbmRlcmVyIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG9tY29udmVydGVyfkRvbUNvbnZlcnRlcn0gZG9tQ29udmVydGVyIENvbnZlcnRlciBpbnN0YW5jZS4KICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0gc2VsZWN0aW9uIFZpZXcgc2VsZWN0aW9uLgogICAqLwogIGZ1bmN0aW9uIFJlbmRlcmVyKGRvbUNvbnZlcnRlciwgc2VsZWN0aW9uKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUmVuZGVyZXIpOwoKICAgIC8qKgogICAgICogU2V0IG9mIERPTSBEb2N1bWVudHMgaW5zdGFuY2VzLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQG1lbWJlciB7U2V0LjxEb2N1bWVudD59CiAgICAgKi8KICAgIHRoaXMuZG9tRG9jdW1lbnRzID0gbmV3IFNldCgpOwogICAgLyoqCiAgICAgKiBDb252ZXJ0ZXIgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG9tY29udmVydGVyfkRvbUNvbnZlcnRlcn0KICAgICAqLwoKICAgIHRoaXMuZG9tQ29udmVydGVyID0gZG9tQ29udmVydGVyOwogICAgLyoqCiAgICAgKiBTZXQgb2Ygbm9kZXMgd2hpY2ggYXR0cmlidXRlcyBjaGFuZ2VkIGFuZCBtYXkgbmVlZCB0byBiZSByZW5kZXJlZC4KICAgICAqCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEBtZW1iZXIge1NldC48bW9kdWxlOmVuZ2luZS92aWV3L25vZGV+Tm9kZT59CiAgICAgKi8KCiAgICB0aGlzLm1hcmtlZEF0dHJpYnV0ZXMgPSBuZXcgU2V0KCk7CiAgICAvKioKICAgICAqIFNldCBvZiBlbGVtZW50cyB3aGljaCBjaGlsZCBsaXN0cyBjaGFuZ2VkIGFuZCBtYXkgbmVlZCB0byBiZSByZW5kZXJlZC4KICAgICAqCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEBtZW1iZXIge1NldC48bW9kdWxlOmVuZ2luZS92aWV3L25vZGV+Tm9kZT59CiAgICAgKi8KCiAgICB0aGlzLm1hcmtlZENoaWxkcmVuID0gbmV3IFNldCgpOwogICAgLyoqCiAgICAgKiBTZXQgb2YgdGV4dCBub2RlcyB3aGljaCB0ZXh0IGRhdGEgY2hhbmdlZCBhbmQgbWF5IG5lZWQgdG8gYmUgcmVuZGVyZWQuCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAbWVtYmVyIHtTZXQuPG1vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGU+fQogICAgICovCgogICAgdGhpcy5tYXJrZWRUZXh0cyA9IG5ldyBTZXQoKTsKICAgIC8qKgogICAgICogVmlldyBzZWxlY3Rpb24uIFJlbmRlcmVyIHVwZGF0ZXMgRE9NIHNlbGVjdGlvbiBiYXNlZCBvbiB0aGUgdmlldyBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb259CiAgICAgKi8KCiAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvbjsKICAgIC8qKgogICAgICogSW5kaWNhdGVzIGlmIHRoZSB2aWV3IGRvY3VtZW50IGlzIGZvY3VzZWQgYW5kIHNlbGVjdGlvbiBjYW4gYmUgcmVuZGVyZWQuIFNlbGVjdGlvbiB3aWxsIG5vdCBiZSByZW5kZXJlZCBpZgogICAgICogdGhpcyBpcyBzZXQgdG8gYGZhbHNlYC4KICAgICAqCiAgICAgKiBAbWVtYmVyIHtCb29sZWFufQogICAgICovCgogICAgdGhpcy5pc0ZvY3VzZWQgPSBmYWxzZTsKICAgIC8qKgogICAgICogVGhlIHRleHQgbm9kZSBpbiB3aGljaCB0aGUgaW5saW5lIGZpbGxlciB3YXMgcmVuZGVyZWQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBtZW1iZXIge1RleHR9CiAgICAgKi8KCiAgICB0aGlzLl9pbmxpbmVGaWxsZXIgPSBudWxsOwogICAgLyoqCiAgICAgKiBET00gZWxlbWVudCBjb250YWluaW5nIGZha2Ugc2VsZWN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSB7bnVsbHxIVE1MRWxlbWVudH0KICAgICAqLwoKICAgIHRoaXMuX2Zha2VTZWxlY3Rpb25Db250YWluZXIgPSBudWxsOwogIH0KICAvKioKICAgKiBNYXJrcyBhIHZpZXcgbm9kZSB0byBiZSB1cGRhdGVkIGluIHRoZSBET00gYnkge0BsaW5rICNyZW5kZXIgYHJlbmRlcigpYH0uCiAgICoKICAgKiBOb3RlIHRoYXQgb25seSB2aWV3IG5vZGVzIHdob3NlIHBhcmVudHMgaGF2ZSBjb3JyZXNwb25kaW5nIERPTSBlbGVtZW50cyBuZWVkIHRvIGJlIG1hcmtlZCB0byBiZSBzeW5jaHJvbml6ZWQuCiAgICoKICAgKiBAc2VlICNtYXJrZWRBdHRyaWJ1dGVzCiAgICogQHNlZSAjbWFya2VkQ2hpbGRyZW4KICAgKiBAc2VlICNtYXJrZWRUZXh0cwogICAqCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZG9jdW1lbnR+Q2hhbmdlVHlwZX0gdHlwZSBUeXBlIG9mIHRoZSBjaGFuZ2UuCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlfSBub2RlIE5vZGUgdG8gYmUgbWFya2VkLgogICAqLwoKCiAgX2NyZWF0ZUNsYXNzKFJlbmRlcmVyLCBbewogICAga2V5OiAibWFya1RvU3luYyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gbWFya1RvU3luYyh0eXBlLCBub2RlKSB7CiAgICAgIGlmICh0eXBlID09PSAndGV4dCcpIHsKICAgICAgICBpZiAodGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKG5vZGUucGFyZW50KSkgewogICAgICAgICAgdGhpcy5tYXJrZWRUZXh0cy5hZGQobm9kZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIHRoZSBub2RlIGhhcyBubyBET00gZWxlbWVudCBpdCBpcyBub3QgcmVuZGVyZWQgeWV0LAogICAgICAgIC8vIGl0cyBjaGlsZHJlbi9hdHRyaWJ1dGVzIGRvIG5vdCBuZWVkIHRvIGJlIG1hcmtlZCB0byBiZSBzeW5jLgogICAgICAgIGlmICghdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKG5vZGUpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZSA9PT0gJ2F0dHJpYnV0ZXMnKSB7CiAgICAgICAgICB0aGlzLm1hcmtlZEF0dHJpYnV0ZXMuYWRkKG5vZGUpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2NoaWxkcmVuJykgewogICAgICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5hZGQobm9kZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogVW5rbm93biB0eXBlIHBhc3NlZCB0byBSZW5kZXJlci5tYXJrVG9TeW5jLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBlcnJvciB2aWV3LXJlbmRlcmVyLXVua25vd24tdHlwZQogICAgICAgICAgICovCiAgICAgICAgICB0aHJvdyBuZXcgQ0tFZGl0b3JFcnJvcigndmlldy1yZW5kZXJlci11bmtub3duLXR5cGUnLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVuZGVycyBhbGwgYnVmZmVyZWQgY2hhbmdlcyAoe0BsaW5rICNtYXJrZWRBdHRyaWJ1dGVzfSwge0BsaW5rICNtYXJrZWRDaGlsZHJlbn0gYW5kIHtAbGluayAjbWFya2VkVGV4dHN9KSBhbmQKICAgICAqIHRoZSBjdXJyZW50IHZpZXcgc2VsZWN0aW9uIChpZiBuZWVkZWQpIHRvIHRoZSBET00gYnkgYXBwbHlpbmcgYSBtaW5pbWFsIHNldCBvZiBjaGFuZ2VzIHRvIGl0LgogICAgICoKICAgICAqIFJlbmRlcmVyIHRyaWVzIG5vdCB0byBicmVhayB0aGUgdGV4dCBjb21wb3NpdGlvbiAoZS5nLiBJTUUpIGFuZCB4LWluZGV4IG9mIHRoZSBzZWxlY3Rpb24sCiAgICAgKiBzbyBpdCBkb2VzIGFzIGxpdHRsZSBhcyBpdCBpcyBuZWVkZWQgdG8gdXBkYXRlIHRoZSBET00uCiAgICAgKgogICAgICogUmVuZGVyZXIgYWxzbyBoYW5kbGVzIHtAbGluayBtb2R1bGU6ZW5naW5lL3ZpZXcvZmlsbGVyIGZpbGxlcnN9LiBFc3BlY2lhbGx5LCBpdCBjaGVja3MgaWYgdGhlIGlubGluZSBmaWxsZXIgaXMgbmVlZGVkCiAgICAgKiBhdCB0aGUgc2VsZWN0aW9uIHBvc2l0aW9uIGFuZCBhZGRzIG9yIHJlbW92ZXMgaXQuIFRvIHByZXZlbnQgYnJlYWtpbmcgdGV4dCBjb21wb3NpdGlvbiBpbmxpbmUgZmlsbGVyIHdpbGwgbm90IGJlCiAgICAgKiByZW1vdmVkIGFzIGxvbmcgYXMgdGhlIHNlbGVjdGlvbiBpcyBpbiB0aGUgdGV4dCBub2RlIHdoaWNoIG5lZWRlZCBpdCBhdCBmaXJzdC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZW5kZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIGlubGluZUZpbGxlclBvc2l0aW9uOyAvLyBSZWZyZXNoIG1hcHBpbmdzLgoKICAgICAgdmFyIF9pdGVyYXRvciA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMubWFya2VkQ2hpbGRyZW4pLAogICAgICAgICAgX3N0ZXA7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yLnMoKTsgIShfc3RlcCA9IF9pdGVyYXRvci5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IF9zdGVwLnZhbHVlOwoKICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoaWxkcmVuTWFwcGluZ3MoZWxlbWVudCk7CiAgICAgICAgfSAvLyBUaGVyZSB3YXMgaW5saW5lIGZpbGxlciByZW5kZXJlZCBpbiB0aGUgRE9NIGJ1dCBpdCdzIG5vdAogICAgICAgIC8vIGF0IHRoZSBzZWxlY3Rpb24gcG9zaXRpb24gYW55IG1vcmUsIHNvIHdlIGNhbiByZW1vdmUgaXQKICAgICAgICAvLyAoY2F1c2UgZXZlbiBpZiBpdCdzIG5lZWRlZCwgaXQgbXVzdCBiZSBwbGFjZWQgaW4gYW5vdGhlciBsb2NhdGlvbikuCgogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfaXRlcmF0b3IuZShlcnIpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIF9pdGVyYXRvci5mKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9pbmxpbmVGaWxsZXIgJiYgIXRoaXMuX2lzU2VsZWN0aW9uSW5JbmxpbmVGaWxsZXIoKSkgewogICAgICAgIHRoaXMuX3JlbW92ZUlubGluZUZpbGxlcigpOwogICAgICB9IC8vIElmIHdlJ3ZlIGdvdCB0aGUgZmlsbGVyLCBsZXQncyB0cnkgdG8gZ3Vlc3MgaXRzIHBvc2l0aW9uIGluIHRoZSB2aWV3LgoKCiAgICAgIGlmICh0aGlzLl9pbmxpbmVGaWxsZXIpIHsKICAgICAgICBpbmxpbmVGaWxsZXJQb3NpdGlvbiA9IHRoaXMuX2dldElubGluZUZpbGxlclBvc2l0aW9uKCk7CiAgICAgIH0gLy8gT3RoZXJ3aXNlLCBpZiBpdCdzIG5lZWRlZCwgY3JlYXRlIGl0IGF0IHRoZSBzZWxlY3Rpb24gcG9zaXRpb24uCiAgICAgIGVsc2UgaWYgKHRoaXMuX25lZWRzSW5saW5lRmlsbGVyQXRTZWxlY3Rpb24oKSkgewogICAgICAgICAgaW5saW5lRmlsbGVyUG9zaXRpb24gPSB0aGlzLnNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCk7IC8vIERvIG5vdCB1c2UgYG1hcmtUb1N5bmNgIHNvIGl0IHdpbGwgYmUgYWRkZWQgZXZlbiBpZiB0aGUgcGFyZW50IGlzIGFscmVhZHkgYWRkZWQuCgogICAgICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5hZGQoaW5saW5lRmlsbGVyUG9zaXRpb24ucGFyZW50KTsKICAgICAgICB9CgogICAgICB2YXIgX2l0ZXJhdG9yMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMubWFya2VkQXR0cmlidXRlcyksCiAgICAgICAgICBfc3RlcDI7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yMi5zKCk7ICEoX3N0ZXAyID0gX2l0ZXJhdG9yMi5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX2VsZW1lbnQgPSBfc3RlcDIudmFsdWU7CgogICAgICAgICAgdGhpcy5fdXBkYXRlQXR0cnMoX2VsZW1lbnQpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yMi5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yMi5mKCk7CiAgICAgIH0KCiAgICAgIHZhciBfaXRlcmF0b3IzID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy5tYXJrZWRDaGlsZHJlbiksCiAgICAgICAgICBfc3RlcDM7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yMy5zKCk7ICEoX3N0ZXAzID0gX2l0ZXJhdG9yMy5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX2VsZW1lbnQyID0gX3N0ZXAzLnZhbHVlOwoKICAgICAgICAgIHRoaXMuX3VwZGF0ZUNoaWxkcmVuKF9lbGVtZW50MiwgewogICAgICAgICAgICBpbmxpbmVGaWxsZXJQb3NpdGlvbjogaW5saW5lRmlsbGVyUG9zaXRpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yMy5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yMy5mKCk7CiAgICAgIH0KCiAgICAgIHZhciBfaXRlcmF0b3I0ID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy5tYXJrZWRUZXh0cyksCiAgICAgICAgICBfc3RlcDQ7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yNC5zKCk7ICEoX3N0ZXA0ID0gX2l0ZXJhdG9yNC5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IF9zdGVwNC52YWx1ZTsKCiAgICAgICAgICBpZiAoIXRoaXMubWFya2VkQ2hpbGRyZW4uaGFzKG5vZGUucGFyZW50KSAmJiB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20obm9kZS5wYXJlbnQpKSB7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRleHQobm9kZSwgewogICAgICAgICAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uOiBpbmxpbmVGaWxsZXJQb3NpdGlvbgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIENoZWNrIHdoZXRoZXIgdGhlIGlubGluZSBmaWxsZXIgaXMgcmVxdWlyZWQgYW5kIHdoZXJlIGl0IHJlYWxseSBpcyBpbiB0aGUgRE9NLgogICAgICAgIC8vIEF0IHRoaXMgcG9pbnQgaW4gbW9zdCBjYXNlcyBpdCB3aWxsIGJlIGluIHRoZSBET00sIGJ1dCB0aGVyZSBhcmUgZXhjZXB0aW9ucy4KICAgICAgICAvLyBGb3IgZXhhbXBsZSwgaWYgdGhlIGlubGluZSBmaWxsZXIgd2FzIGRlZXAgaW4gdGhlIGNyZWF0ZWQgRE9NIHN0cnVjdHVyZSwgaXQgd2lsbCBub3QgYmUgY3JlYXRlZC4KICAgICAgICAvLyBTaW1pbGFybHksIGlmIGl0IHdhcyByZW1vdmVkIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhpcyBmdW5jdGlvbiBhbmQgdGhlbiBuZWl0aGVyIHRleHQgbm9yIGNoaWxkcmVuIHdlcmUgdXBkYXRlZCwKICAgICAgICAvLyBpdCB3aWxsIG5vdCBiZSBwcmVzZW50LgogICAgICAgIC8vIEZpeCB0aG9zZSBhbmQgc2ltaWxhciBzY2VuYXJpb3MuCgogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfaXRlcmF0b3I0LmUoZXJyKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBfaXRlcmF0b3I0LmYoKTsKICAgICAgfQoKICAgICAgaWYgKGlubGluZUZpbGxlclBvc2l0aW9uKSB7CiAgICAgICAgdmFyIGZpbGxlckRvbVBvc2l0aW9uID0gdGhpcy5kb21Db252ZXJ0ZXIudmlld1Bvc2l0aW9uVG9Eb20oaW5saW5lRmlsbGVyUG9zaXRpb24pOwogICAgICAgIHZhciBkb21Eb2N1bWVudCA9IGZpbGxlckRvbVBvc2l0aW9uLnBhcmVudC5vd25lckRvY3VtZW50OwoKICAgICAgICBpZiAoIXN0YXJ0c1dpdGhGaWxsZXIoZmlsbGVyRG9tUG9zaXRpb24ucGFyZW50KSkgewogICAgICAgICAgLy8gRmlsbGVyIGhhcyBub3QgYmVlbiBjcmVhdGVkIGF0IGZpbGxlciBwb3NpdGlvbi4gQ3JlYXRlIGl0IG5vdy4KICAgICAgICAgIHRoaXMuX2lubGluZUZpbGxlciA9IGFkZElubGluZUZpbGxlcihkb21Eb2N1bWVudCwgZmlsbGVyRG9tUG9zaXRpb24ucGFyZW50LCBmaWxsZXJEb21Qb3NpdGlvbi5vZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBGaWxsZXIgaGFzIGJlZW4gZm91bmQsIHNhdmUgaXQuCiAgICAgICAgICB0aGlzLl9pbmxpbmVGaWxsZXIgPSBmaWxsZXJEb21Qb3NpdGlvbi5wYXJlbnQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRoZXJlIGlzIG5vIGZpbGxlciBuZWVkZWQuCiAgICAgICAgdGhpcy5faW5saW5lRmlsbGVyID0gbnVsbDsKICAgICAgfSAvLyBGaXJzdCBmb2N1cyB0aGUgbmV3IGVkaXRpbmcgaG9zdCwgdGhlbiB1cGRhdGUgdGhlIHNlbGVjdGlvbi4KICAgICAgLy8gT3RoZXJ3aXNlLCBGRiBtYXkgdGhyb3cgYW4gZXJyb3IgKGh0dHBzOi8vZ2l0aHViLmNvbS9ja2VkaXRvci9ja2VkaXRvcjUvaXNzdWVzLzcyMSkuCgoKICAgICAgdGhpcy5fdXBkYXRlRm9jdXMoKTsKCiAgICAgIHRoaXMuX3VwZGF0ZVNlbGVjdGlvbigpOwoKICAgICAgdGhpcy5tYXJrZWRUZXh0cy5jbGVhcigpOwogICAgICB0aGlzLm1hcmtlZEF0dHJpYnV0ZXMuY2xlYXIoKTsKICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5jbGVhcigpOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIG1hcHBpbmdzIG9mIHZpZXcgZWxlbWVudCdzIGNoaWxkcmVuLgogICAgICoKICAgICAqIENoaWxkcmVuIHRoYXQgd2VyZSByZXBsYWNlZCBpbiB0aGUgdmlldyBzdHJ1Y3R1cmUgYnkgc2ltaWxhciBlbGVtZW50cyAoc2FtZSB0YWcgbmFtZSkgYXJlIHRyZWF0ZWQgYXMgJ3JlcGxhY2VkJy4KICAgICAqIFRoaXMgbWVhbnMgdGhhdCB0aGVpciBtYXBwaW5ncyBjYW4gYmUgdXBkYXRlZCBzbyB0aGUgbmV3IHZpZXcgZWxlbWVudHMgYXJlIG1hcHBlZCB0byB0aGUgZXhpc3RpbmcgRE9NIGVsZW1lbnRzLgogICAgICogVGhhbmtzIHRvIHRoYXQgdGhlc2UgZWxlbWVudHMgZG8gbm90IG5lZWQgdG8gYmUgcmUtcmVuZGVyZWQgY29tcGxldGVseS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlfSB2aWV3RWxlbWVudCBUaGUgdmlldyBlbGVtZW50IHdob3NlIGNoaWxkcmVuIG1hcHBpbmdzIHdpbGwgYmUgdXBkYXRlZC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlQ2hpbGRyZW5NYXBwaW5ncyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUNoaWxkcmVuTWFwcGluZ3Modmlld0VsZW1lbnQpIHsKICAgICAgdmFyIGRvbUVsZW1lbnQgPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odmlld0VsZW1lbnQpOwoKICAgICAgaWYgKCFkb21FbGVtZW50KSB7CiAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gYGRvbUVsZW1lbnRgIGl0IG1lYW5zIHRoYXQgaXQgd2FzIGFscmVhZHkgcmVtb3ZlZCBmcm9tIERPTSBhbmQgdGhlcmUgaXMgbm8gbmVlZCB0byBwcm9jZXNzIGl0LgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGFjdHVhbERvbUNoaWxkcmVuID0gdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHZpZXdFbGVtZW50KS5jaGlsZE5vZGVzOwogICAgICB2YXIgZXhwZWN0ZWREb21DaGlsZHJlbiA9IEFycmF5LmZyb20odGhpcy5kb21Db252ZXJ0ZXIudmlld0NoaWxkcmVuVG9Eb20odmlld0VsZW1lbnQsIGRvbUVsZW1lbnQub3duZXJEb2N1bWVudCwgewogICAgICAgIHdpdGhDaGlsZHJlbjogZmFsc2UKICAgICAgfSkpOwoKICAgICAgdmFyIGRpZmYgPSB0aGlzLl9kaWZmTm9kZUxpc3RzKGFjdHVhbERvbUNoaWxkcmVuLCBleHBlY3RlZERvbUNoaWxkcmVuKTsKCiAgICAgIHZhciBhY3Rpb25zID0gdGhpcy5fZmluZFJlcGxhY2VBY3Rpb25zKGRpZmYsIGFjdHVhbERvbUNoaWxkcmVuLCBleHBlY3RlZERvbUNoaWxkcmVuKTsKCiAgICAgIGlmIChhY3Rpb25zLmluZGV4T2YoJ3JlcGxhY2UnKSAhPT0gLTEpIHsKICAgICAgICB2YXIgY291bnRlciA9IHsKICAgICAgICAgIGVxdWFsOiAwLAogICAgICAgICAgaW5zZXJ0OiAwLAogICAgICAgICAgZGVsZXRlOiAwCiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9pdGVyYXRvcjUgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihhY3Rpb25zKSwKICAgICAgICAgICAgX3N0ZXA1OwoKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIChfaXRlcmF0b3I1LnMoKTsgIShfc3RlcDUgPSBfaXRlcmF0b3I1Lm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgdmFyIGFjdGlvbiA9IF9zdGVwNS52YWx1ZTsKCiAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdyZXBsYWNlJykgewogICAgICAgICAgICAgIHZhciBpbnNlcnRJbmRleCA9IGNvdW50ZXIuZXF1YWwgKyBjb3VudGVyLmluc2VydDsKICAgICAgICAgICAgICB2YXIgZGVsZXRlSW5kZXggPSBjb3VudGVyLmVxdWFsICsgY291bnRlci5kZWxldGU7CiAgICAgICAgICAgICAgdmFyIHZpZXdDaGlsZCA9IHZpZXdFbGVtZW50LmdldENoaWxkKGluc2VydEluZGV4KTsgLy8gVUlFbGVtZW50IGFuZCBSYXdFbGVtZW50IGFyZSBzcGVjaWFsIGNhc2VzLiBUaGVpciBjaGlsZHJlbiBhcmUgbm90IHN0b3JlZCBpbiBhIHZpZXcgKCM3OTkpCiAgICAgICAgICAgICAgLy8gc28gd2UgY2Fubm90IHVzZSB0aGVtIHdpdGggcmVwbGFjaW5nIGZsb3cgKHNpbmNlIHRoZXkgdXNlIHZpZXcgY2hpbGRyZW4gZHVyaW5nIHJlbmRlcmluZwogICAgICAgICAgICAgIC8vIHdoaWNoIHdpbGwgYWx3YXlzIHJlc3VsdCBpbiByZW5kZXJpbmcgZW1wdHkgZWxlbWVudHMpLgoKICAgICAgICAgICAgICBpZiAodmlld0NoaWxkICYmICEodmlld0NoaWxkLmlzKCd1aUVsZW1lbnQnKSB8fCB2aWV3Q2hpbGQuaXMoJ3Jhd0VsZW1lbnQnKSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUVsZW1lbnRNYXBwaW5ncyh2aWV3Q2hpbGQsIGFjdHVhbERvbUNoaWxkcmVuW2RlbGV0ZUluZGV4XSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZW1vdmUoZXhwZWN0ZWREb21DaGlsZHJlbltpbnNlcnRJbmRleF0pOwogICAgICAgICAgICAgIGNvdW50ZXIuZXF1YWwrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb3VudGVyW2FjdGlvbl0rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgX2l0ZXJhdG9yNS5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvcjUuZigpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIG1hcHBpbmdzIG9mIGEgZ2l2ZW4gdmlldyBlbGVtZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9ub2Rlfk5vZGV9IHZpZXdFbGVtZW50IFRoZSB2aWV3IGVsZW1lbnQgd2hvc2UgbWFwcGluZ3Mgd2lsbCBiZSB1cGRhdGVkLgogICAgICogQHBhcmFtIHtOb2RlfSBkb21FbGVtZW50IFRoZSBET00gZWxlbWVudCByZXByZXNlbnRpbmcgdGhlIGdpdmVuIHZpZXcgZWxlbWVudC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlRWxlbWVudE1hcHBpbmdzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlRWxlbWVudE1hcHBpbmdzKHZpZXdFbGVtZW50LCBkb21FbGVtZW50KSB7CiAgICAgIC8vIFJlbWFwICdEb21Db252ZXJ0ZXInIGJpbmRpbmdzLgogICAgICB0aGlzLmRvbUNvbnZlcnRlci51bmJpbmREb21FbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICB0aGlzLmRvbUNvbnZlcnRlci5iaW5kRWxlbWVudHMoZG9tRWxlbWVudCwgdmlld0VsZW1lbnQpOyAvLyBWaWV3IGVsZW1lbnQgbWF5IGhhdmUgY2hpbGRyZW4gd2hpY2ggbmVlZHMgdG8gYmUgdXBkYXRlZCwgYnV0IGFyZSBub3QgbWFya2VkLCBtYXJrIHRoZW0gdG8gdXBkYXRlLgoKICAgICAgdGhpcy5tYXJrZWRDaGlsZHJlbi5hZGQodmlld0VsZW1lbnQpOyAvLyBCZWNhdXNlIHdlIHJlcGxhY2UgbmV3IHZpZXcgZWxlbWVudCBtYXBwaW5nIHdpdGggdGhlIGV4aXN0aW5nIG9uZSwgdGhlIGNvcnJlc3BvbmRpbmcgRE9NIGVsZW1lbnQKICAgICAgLy8gd2lsbCBub3QgYmUgcmVyZW5kZXJlZC4gVGhlIG5ldyB2aWV3IGVsZW1lbnQgbWF5IGhhdmUgZGlmZmVyZW50IGF0dHJpYnV0ZXMgdGhhbiB0aGUgcHJldmlvdXMgb25lLgogICAgICAvLyBTaW5jZSBpdHMgY29ycmVzcG9uZGluZyBET00gZWxlbWVudCB3aWxsIG5vdCBiZSByZXJlbmRlcmVkLCBuZXcgYXR0cmlidXRlcyB3aWxsIG5vdCBiZSBhZGRlZAogICAgICAvLyB0byB0aGUgRE9NLCBzbyB3ZSBuZWVkIHRvIG1hcmsgaXQgaGVyZSB0byBtYWtlIHN1cmUgaXRzIGF0dHJpYnV0ZXMgZ2V0cyB1cGRhdGVkLiBTZWUgIzE0MjcgZm9yIG1vcmUKICAgICAgLy8gZGV0YWlsZWQgY2FzZSBzdHVkeS4KICAgICAgLy8gQWxzbyB0aGVyZSBhcmUgY2FzZXMgd2hlcmUgcmVwbGFjZWQgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIHZpZXcgc3RydWN0dXJlIGFuZCB0aGVuIGhhcwogICAgICAvLyBpdHMgYXR0cmlidXRlcyBjaGFuZ2VkIG9yIHJlbW92ZWQuIEluIHN1Y2ggY2FzZXMgdGhlIGVsZW1lbnQgd2lsbCBub3QgYmUgcHJlc2VudCBpbiBgbWFya2VkQXR0cmlidXRlc2AKICAgICAgLy8gYW5kIGFsc28gbWF5IGJlIHRoZSBzYW1lIChgZWxlbWVudC5pc1NpbWlsYXIoKWApIGFzIHRoZSByZXVzZWQgZWxlbWVudCBub3QgaGF2aW5nIGl0cyBhdHRyaWJ1dGVzIHVwZGF0ZWQuCiAgICAgIC8vIFRvIHByZXZlbnQgc3VjaCBzaXR1YXRpb25zIHdlIGFsd2F5cyBtYXJrIHJldXNlZCBlbGVtZW50IHRvIGhhdmUgaXRzIGF0dHJpYnV0ZXMgcmVyZW5kZXJkICgjMTU2MCkuCgogICAgICB0aGlzLm1hcmtlZEF0dHJpYnV0ZXMuYWRkKHZpZXdFbGVtZW50KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgcG9zaXRpb24gb2YgdGhlIGlubGluZSBmaWxsZXIgYmFzZWQgb24gdGhlIGN1cnJlbnQgc2VsZWN0aW9uLgogICAgICogSGVyZSwgd2UgYXNzdW1lIHRoYXQgd2Uga25vdyB0aGF0IHRoZSBmaWxsZXIgaXMgbmVlZGVkIGFuZAogICAgICoge0BsaW5rICNfaXNTZWxlY3Rpb25JbklubGluZUZpbGxlciBpcyBhdCB0aGUgc2VsZWN0aW9uIHBvc2l0aW9ufSwgYW5kLCBzaW5jZSBpdCBpcyBuZWVkZWQsCiAgICAgKiBpdCBpcyBzb21ld2hlcmUgYXQgdGhlIHNlbGVjdGlvbiBwb3NpdGlvbi4KICAgICAqCiAgICAgKiBOb3RlOiBUaGUgZmlsbGVyIHBvc2l0aW9uIGNhbm5vdCBiZSByZXN0b3JlZCBiYXNlZCBvbiB0aGUgZmlsbGVyJ3MgRE9NIHRleHQgbm9kZSwgYmVjYXVzZQogICAgICogd2hlbiB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgKGJlZm9yZSByZW5kZXJpbmcpLCB0aGUgYmluZGluZ3Mgd2lsbCBvZnRlbiBiZSBicm9rZW4uIFZpZXctdG8tRE9NCiAgICAgKiBiaW5kaW5ncyBhcmUgb25seSBkZXBlbmRhYmxlIGFmdGVyIHJlbmRlcmluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvdmlldy9wb3NpdGlvbn5Qb3NpdGlvbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZ2V0SW5saW5lRmlsbGVyUG9zaXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRJbmxpbmVGaWxsZXJQb3NpdGlvbigpIHsKICAgICAgdmFyIGZpcnN0UG9zID0gdGhpcy5zZWxlY3Rpb24uZ2V0Rmlyc3RQb3NpdGlvbigpOwoKICAgICAgaWYgKGZpcnN0UG9zLnBhcmVudC5pcygnJHRleHQnKSkgewogICAgICAgIHJldHVybiBWaWV3UG9zaXRpb24uX2NyZWF0ZUJlZm9yZSh0aGlzLnNlbGVjdGlvbi5nZXRGaXJzdFBvc2l0aW9uKCkucGFyZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmlyc3RQb3M7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHNlbGVjdGlvbiBoYXMgbm90IGxlZnQgdGhlIGlubGluZSBmaWxsZXIncyB0ZXh0IG5vZGUuCiAgICAgKiBJZiBpdCBpcyBgdHJ1ZWAsIGl0IG1lYW5zIHRoYXQgdGhlIGZpbGxlciBoYWQgYmVlbiBhZGRlZCBmb3IgYSByZWFzb24gYW5kIHRoZSBzZWxlY3Rpb24gZGlkIG5vdAogICAgICogbGVhdmUgdGhlIGZpbGxlcidzIHRleHQgbm9kZS4gRm9yIGV4YW1wbGUsIHRoZSB1c2VyIGNhbiBiZSBpbiB0aGUgbWlkZGxlIG9mIGEgY29tcG9zaXRpb24gc28gaXQgc2hvdWxkIG5vdCBiZSB0b3VjaGVkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gYHRydWVgIGlmIHRoZSBpbmxpbmUgZmlsbGVyIGFuZCBzZWxlY3Rpb24gYXJlIGluIHRoZSBzYW1lIHBsYWNlLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9pc1NlbGVjdGlvbkluSW5saW5lRmlsbGVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNTZWxlY3Rpb25JbklubGluZUZpbGxlcigpIHsKICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uLnJhbmdlQ291bnQgIT0gMSB8fCAhdGhpcy5zZWxlY3Rpb24uaXNDb2xsYXBzZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gTm90ZSwgd2UgY2FuJ3QgY2hlY2sgaWYgc2VsZWN0aW9uJ3MgcG9zaXRpb24gZXF1YWxzIHBvc2l0aW9uIG9mIHRoZQogICAgICAvLyB0aGlzLl9pbmxpbmVGaWxsZXIgbm9kZSwgYmVjYXVzZSBvZiAjNjYzLiBXZSBtYXkgbm90IGJlIGFibGUgdG8gY2FsY3VsYXRlCiAgICAgIC8vIHRoZSBmaWxsZXIncyBwb3NpdGlvbiBpbiB0aGUgdmlldyBhdCB0aGlzIHN0YWdlLgogICAgICAvLyBJbnN0ZWFkLCB3ZSBjaGVjayBpdCB0aGUgb3RoZXIgd2F5IOKAkyB3aGV0aGVyIHNlbGVjdGlvbiBpcyBhbmNob3JlZCBpbgogICAgICAvLyB0aGF0IHRleHQgbm9kZSBvciBuZXh0IHRvIGl0LgogICAgICAvLyBQb3NzaWJsZSBvcHRpb25zIGFyZToKICAgICAgLy8gIkZJTExFUnt9IgogICAgICAvLyAiRklMTEVSYWRkZWQtdGV4dHt9IgoKCiAgICAgIHZhciBzZWxlY3Rpb25Qb3NpdGlvbiA9IHRoaXMuc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKTsKICAgICAgdmFyIHBvc2l0aW9uID0gdGhpcy5kb21Db252ZXJ0ZXIudmlld1Bvc2l0aW9uVG9Eb20oc2VsZWN0aW9uUG9zaXRpb24pOwoKICAgICAgaWYgKHBvc2l0aW9uICYmIGlzVGV4dChwb3NpdGlvbi5wYXJlbnQpICYmIHN0YXJ0c1dpdGhGaWxsZXIocG9zaXRpb24ucGFyZW50KSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZXMgdGhlIGlubGluZSBmaWxsZXIuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfcmVtb3ZlSW5saW5lRmlsbGVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVtb3ZlSW5saW5lRmlsbGVyKCkgewogICAgICB2YXIgZG9tRmlsbGVyTm9kZSA9IHRoaXMuX2lubGluZUZpbGxlcjsgLy8gU29tZXRoaW5nIHdlaXJkIGhhcHBlbmVkIGFuZCB0aGUgc3RvcmVkIG5vZGUgZG9lc24ndCBjb250YWluIHRoZSBmaWxsZXIncyB0ZXh0LgoKICAgICAgaWYgKCFzdGFydHNXaXRoRmlsbGVyKGRvbUZpbGxlck5vZGUpKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGlubGluZSBmaWxsZXIgbm9kZSB3YXMgbG9zdC4gTW9zdCBsaWtlbHksIHNvbWV0aGluZyBvdmVyd3JvdGUgdGhlIGZpbGxlciB0ZXh0IG5vZGUKICAgICAgICAgKiBpbiB0aGUgRE9NLgogICAgICAgICAqCiAgICAgICAgICogQGVycm9yIHZpZXctcmVuZGVyZXItZmlsbGVyLXdhcy1sb3N0CiAgICAgICAgICovCiAgICAgICAgdGhyb3cgbmV3IENLRWRpdG9yRXJyb3IoJ3ZpZXctcmVuZGVyZXItZmlsbGVyLXdhcy1sb3N0JywgdGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChpc0lubGluZUZpbGxlcihkb21GaWxsZXJOb2RlKSkgewogICAgICAgIGRvbUZpbGxlck5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkb21GaWxsZXJOb2RlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb21GaWxsZXJOb2RlLmRhdGEgPSBkb21GaWxsZXJOb2RlLmRhdGEuc3Vic3RyKElOTElORV9GSUxMRVJfTEVOR1RIKTsKICAgICAgfQoKICAgICAgdGhpcy5faW5saW5lRmlsbGVyID0gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBpbmxpbmUge0BsaW5rIG1vZHVsZTplbmdpbmUvdmlldy9maWxsZXIgZmlsbGVyfSBzaG91bGQgYmUgYWRkZWQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIGlubGluZSBmaWxsZXIgc2hvdWxkIGJlIGFkZGVkLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9uZWVkc0lubGluZUZpbGxlckF0U2VsZWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbmVlZHNJbmxpbmVGaWxsZXJBdFNlbGVjdGlvbigpIHsKICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uLnJhbmdlQ291bnQgIT0gMSB8fCAhdGhpcy5zZWxlY3Rpb24uaXNDb2xsYXBzZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBzZWxlY3Rpb25Qb3NpdGlvbiA9IHRoaXMuc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKTsKICAgICAgdmFyIHNlbGVjdGlvblBhcmVudCA9IHNlbGVjdGlvblBvc2l0aW9uLnBhcmVudDsKICAgICAgdmFyIHNlbGVjdGlvbk9mZnNldCA9IHNlbGVjdGlvblBvc2l0aW9uLm9mZnNldDsgLy8gSWYgdGhlcmUgaXMgbm8gRE9NIHJvb3Qgd2UgZG8gbm90IGNhcmUgYWJvdXQgZmlsbGVycy4KCiAgICAgIGlmICghdGhpcy5kb21Db252ZXJ0ZXIubWFwVmlld1RvRG9tKHNlbGVjdGlvblBhcmVudC5yb290KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCFzZWxlY3Rpb25QYXJlbnQuaXMoJ2VsZW1lbnQnKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSAvLyBQcmV2ZW50IGFkZGluZyBpbmxpbmUgZmlsbGVyIGluc2lkZSBlbGVtZW50cyB3aXRoIGNvbnRlbnRlZGl0YWJsZT1mYWxzZS4KICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzExNzAKCgogICAgICBpZiAoIWlzRWRpdGFibGUoc2VsZWN0aW9uUGFyZW50KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSAvLyBXZSBoYXZlIGJsb2NrIGZpbGxlciwgd2UgZG8gbm90IG5lZWQgaW5saW5lIG9uZS4KCgogICAgICBpZiAoc2VsZWN0aW9uT2Zmc2V0ID09PSBzZWxlY3Rpb25QYXJlbnQuZ2V0RmlsbGVyT2Zmc2V0KCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBub2RlQmVmb3JlID0gc2VsZWN0aW9uUG9zaXRpb24ubm9kZUJlZm9yZTsKICAgICAgdmFyIG5vZGVBZnRlciA9IHNlbGVjdGlvblBvc2l0aW9uLm5vZGVBZnRlcjsKCiAgICAgIGlmIChub2RlQmVmb3JlIGluc3RhbmNlb2YgVmlld1RleHQgfHwgbm9kZUFmdGVyIGluc3RhbmNlb2YgVmlld1RleHQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGV4dCBuZWVkcyB0byBiZSB1cGRhdGVkIGFuZCBwb3NzaWJseSB1cGRhdGVzIGl0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy90ZXh0flRleHR9IHZpZXdUZXh0IFZpZXcgdGV4dCB0byB1cGRhdGUuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvcG9zaXRpb25+UG9zaXRpb259IG9wdGlvbnMuaW5saW5lRmlsbGVyUG9zaXRpb24gVGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBpbmxpbmUKICAgICAqIGZpbGxlciBzaG91bGQgYmUgcmVuZGVyZWQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3VwZGF0ZVRleHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVUZXh0KHZpZXdUZXh0LCBvcHRpb25zKSB7CiAgICAgIHZhciBkb21UZXh0ID0gdGhpcy5kb21Db252ZXJ0ZXIuZmluZENvcnJlc3BvbmRpbmdEb21UZXh0KHZpZXdUZXh0KTsKICAgICAgdmFyIG5ld0RvbVRleHQgPSB0aGlzLmRvbUNvbnZlcnRlci52aWV3VG9Eb20odmlld1RleHQsIGRvbVRleHQub3duZXJEb2N1bWVudCk7CiAgICAgIHZhciBhY3R1YWxUZXh0ID0gZG9tVGV4dC5kYXRhOwogICAgICB2YXIgZXhwZWN0ZWRUZXh0ID0gbmV3RG9tVGV4dC5kYXRhOwogICAgICB2YXIgZmlsbGVyID0gb3B0aW9ucy5pbmxpbmVGaWxsZXJQb3NpdGlvbjsKCiAgICAgIGlmIChmaWxsZXIgJiYgZmlsbGVyLnBhcmVudCA9PSB2aWV3VGV4dC5wYXJlbnQgJiYgZmlsbGVyLm9mZnNldCA9PSB2aWV3VGV4dC5pbmRleCkgewogICAgICAgIGV4cGVjdGVkVGV4dCA9IElOTElORV9GSUxMRVIgKyBleHBlY3RlZFRleHQ7CiAgICAgIH0KCiAgICAgIGlmIChhY3R1YWxUZXh0ICE9IGV4cGVjdGVkVGV4dCkgewogICAgICAgIHZhciBhY3Rpb25zID0gZmFzdERpZmYoYWN0dWFsVGV4dCwgZXhwZWN0ZWRUZXh0KTsKCiAgICAgICAgdmFyIF9pdGVyYXRvcjYgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihhY3Rpb25zKSwKICAgICAgICAgICAgX3N0ZXA2OwoKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIChfaXRlcmF0b3I2LnMoKTsgIShfc3RlcDYgPSBfaXRlcmF0b3I2Lm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgdmFyIGFjdGlvbiA9IF9zdGVwNi52YWx1ZTsKCiAgICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PT0gJ2luc2VydCcpIHsKICAgICAgICAgICAgICBkb21UZXh0Lmluc2VydERhdGEoYWN0aW9uLmluZGV4LCBhY3Rpb24udmFsdWVzLmpvaW4oJycpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyAnZGVsZXRlJwogICAgICAgICAgICAgIGRvbVRleHQuZGVsZXRlRGF0YShhY3Rpb24uaW5kZXgsIGFjdGlvbi5ob3dNYW55KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgX2l0ZXJhdG9yNi5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvcjYuZigpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYXR0cmlidXRlIGxpc3QgbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvZWxlbWVudH5FbGVtZW50fSB2aWV3RWxlbWVudCBUaGUgdmlldyBlbGVtZW50IHRvIHVwZGF0ZS4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlQXR0cnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVBdHRycyh2aWV3RWxlbWVudCkgewogICAgICB2YXIgZG9tRWxlbWVudCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh2aWV3RWxlbWVudCk7CgogICAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBgZG9tRWxlbWVudGAgaXQgbWVhbnMgdGhhdCAndmlld0VsZW1lbnQnIGlzIG91dGRhdGVkIGFzIGl0cyBtYXBwaW5nIHdhcyB1cGRhdGVkCiAgICAgICAgLy8gaW4gJ3RoaXMuX3VwZGF0ZUNoaWxkcmVuTWFwcGluZ3MoKScuIFRoZXJlIGlzIG5vIG5lZWQgdG8gcHJvY2VzcyBpdCBhcyBuZXcgdmlldyBlbGVtZW50IHdoaWNoCiAgICAgICAgLy8gcmVwbGFjZWQgb2xkICd2aWV3RWxlbWVudCcgbWFwcGluZyB3YXMgYWxzbyBhZGRlZCB0byAndGhpcy5tYXJrZWRBdHRyaWJ1dGVzJwogICAgICAgIC8vIGluICd0aGlzLl91cGRhdGVDaGlsZHJlbk1hcHBpbmdzKCknIHNvIGl0IHdpbGwgYmUgcHJvY2Vzc2VkIHNlcGFyYXRlbHkuCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZG9tQXR0cktleXMgPSBBcnJheS5mcm9tKGRvbUVsZW1lbnQuYXR0cmlidXRlcykubWFwKGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgcmV0dXJuIGF0dHIubmFtZTsKICAgICAgfSk7CiAgICAgIHZhciB2aWV3QXR0cktleXMgPSB2aWV3RWxlbWVudC5nZXRBdHRyaWJ1dGVLZXlzKCk7IC8vIEFkZCBvciBvdmVyd3JpdGUgYXR0cmlidXRlcy4KCiAgICAgIHZhciBfaXRlcmF0b3I3ID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodmlld0F0dHJLZXlzKSwKICAgICAgICAgIF9zdGVwNzsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yIChfaXRlcmF0b3I3LnMoKTsgIShfc3RlcDcgPSBfaXRlcmF0b3I3Lm4oKSkuZG9uZTspIHsKICAgICAgICAgIHZhciBrZXkgPSBfc3RlcDcudmFsdWU7CiAgICAgICAgICBkb21FbGVtZW50LnNldEF0dHJpYnV0ZShrZXksIHZpZXdFbGVtZW50LmdldEF0dHJpYnV0ZShrZXkpKTsKICAgICAgICB9IC8vIFJlbW92ZSBmcm9tIERPTSBhdHRyaWJ1dGVzIHdoaWNoIGRvIG5vdCBleGlzdHMgaW4gdGhlIHZpZXcuCgogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfaXRlcmF0b3I3LmUoZXJyKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBfaXRlcmF0b3I3LmYoKTsKICAgICAgfQoKICAgICAgdmFyIF9pdGVyYXRvcjggPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihkb21BdHRyS2V5cyksCiAgICAgICAgICBfc3RlcDg7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yOC5zKCk7ICEoX3N0ZXA4ID0gX2l0ZXJhdG9yOC5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX2tleSA9IF9zdGVwOC52YWx1ZTsKCiAgICAgICAgICBpZiAoIXZpZXdFbGVtZW50Lmhhc0F0dHJpYnV0ZShfa2V5KSkgewogICAgICAgICAgICBkb21FbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShfa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvcjguZShlcnIpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIF9pdGVyYXRvcjguZigpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBpZiBlbGVtZW50cyBjaGlsZCBsaXN0IG5lZWRzIHRvIGJlIHVwZGF0ZWQgYW5kIHBvc3NpYmx5IHVwZGF0ZXMgaXQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS92aWV3L2VsZW1lbnR+RWxlbWVudH0gdmlld0VsZW1lbnQgVmlldyBlbGVtZW50IHRvIHVwZGF0ZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9wb3NpdGlvbn5Qb3NpdGlvbn0gb3B0aW9ucy5pbmxpbmVGaWxsZXJQb3NpdGlvbiBUaGUgcG9zaXRpb24gd2hlcmUgdGhlIGlubGluZQogICAgICogZmlsbGVyIHNob3VsZCBiZSByZW5kZXJlZC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlQ2hpbGRyZW4iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVDaGlsZHJlbih2aWV3RWxlbWVudCwgb3B0aW9ucykgewogICAgICB2YXIgZG9tRWxlbWVudCA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh2aWV3RWxlbWVudCk7CgogICAgICBpZiAoIWRvbUVsZW1lbnQpIHsKICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBgZG9tRWxlbWVudGAgaXQgbWVhbnMgdGhhdCBpdCB3YXMgYWxyZWFkeSByZW1vdmVkIGZyb20gRE9NLgogICAgICAgIC8vIFRoZXJlIGlzIG5vIG5lZWQgdG8gcHJvY2VzcyBpdC4gSXQgd2lsbCBiZSBwcm9jZXNzZWQgd2hlbiByZS1pbnNlcnRlZC4KICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBpbmxpbmVGaWxsZXJQb3NpdGlvbiA9IG9wdGlvbnMuaW5saW5lRmlsbGVyUG9zaXRpb247CiAgICAgIHZhciBhY3R1YWxEb21DaGlsZHJlbiA9IHRoaXMuZG9tQ29udmVydGVyLm1hcFZpZXdUb0RvbSh2aWV3RWxlbWVudCkuY2hpbGROb2RlczsKICAgICAgdmFyIGV4cGVjdGVkRG9tQ2hpbGRyZW4gPSBBcnJheS5mcm9tKHRoaXMuZG9tQ29udmVydGVyLnZpZXdDaGlsZHJlblRvRG9tKHZpZXdFbGVtZW50LCBkb21FbGVtZW50Lm93bmVyRG9jdW1lbnQsIHsKICAgICAgICBiaW5kOiB0cnVlLAogICAgICAgIGlubGluZUZpbGxlclBvc2l0aW9uOiBpbmxpbmVGaWxsZXJQb3NpdGlvbgogICAgICB9KSk7IC8vIElubGluZSBmaWxsZXIgZWxlbWVudCBoYXMgdG8gYmUgY3JlYXRlZCBhcyBpdCBpcyBwcmVzZW50IGluIHRoZSBET00sIGJ1dCBub3QgaW4gdGhlIHZpZXcuIEl0IGlzIHJlcXVpcmVkCiAgICAgIC8vIGR1cmluZyBkaWZmaW5nIHNvIHRleHQgbm9kZXMgY291bGQgYmUgY29tcGFyZWQgY29ycmVjdGx5IGFuZCBhbHNvIGR1cmluZyByZW5kZXJpbmcgdG8gbWFpbnRhaW4KICAgICAgLy8gcHJvcGVyIG9yZGVyIGFuZCBpbmRleGVzIHdoaWxlIHVwZGF0aW5nIHRoZSBET00uCgogICAgICBpZiAoaW5saW5lRmlsbGVyUG9zaXRpb24gJiYgaW5saW5lRmlsbGVyUG9zaXRpb24ucGFyZW50ID09PSB2aWV3RWxlbWVudCkgewogICAgICAgIGFkZElubGluZUZpbGxlcihkb21FbGVtZW50Lm93bmVyRG9jdW1lbnQsIGV4cGVjdGVkRG9tQ2hpbGRyZW4sIGlubGluZUZpbGxlclBvc2l0aW9uLm9mZnNldCk7CiAgICAgIH0KCiAgICAgIHZhciBkaWZmID0gdGhpcy5fZGlmZk5vZGVMaXN0cyhhY3R1YWxEb21DaGlsZHJlbiwgZXhwZWN0ZWREb21DaGlsZHJlbik7CgogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBub2Rlc1RvVW5iaW5kID0gbmV3IFNldCgpOyAvLyBIYW5kbGUgZGVsZXRpb25zIGZpcnN0LgogICAgICAvLyBUaGlzIGlzIHRvIHByZXZlbnQgYSBzaXR1YXRpb24gd2hlcmUgYW4gZWxlbWVudCB0aGF0IGFscmVhZHkgZXhpc3RzIGluIGBhY3R1YWxEb21DaGlsZHJlbmAgaXMgaW5zZXJ0ZWQgYXQgYSBkaWZmZXJlbnQKICAgICAgLy8gaW5kZXggaW4gYGFjdHVhbERvbUNoaWxkcmVuYC4gU2luY2UgYGFjdHVhbERvbUNoaWxkcmVuYCBpcyBhIGBOb2RlTGlzdGAsIHRoaXMgd29ya3MgbGlrZSBtb3ZlLCBub3QgbGlrZSBhbiBpbnNlcnQsCiAgICAgIC8vIGFuZCBpdCBkaXNydXB0cyB0aGUgd2hvbGUgYWxnb3JpdGhtLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS9pc3N1ZXMvNjM2Ny4KICAgICAgLy8KICAgICAgLy8gSXQgZG9lc24ndCBtYXR0ZXIgaW4gd2hhdCBvcmRlciB3ZSByZW1vdmUgb3IgYWRkIG5vZGVzLCBhcyBsb25nIGFzIHdlIHJlbW92ZSBhbmQgYWRkIGNvcnJlY3Qgbm9kZXMgYXQgY29ycmVjdCBpbmRleGVzLgoKICAgICAgdmFyIF9pdGVyYXRvcjkgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihkaWZmKSwKICAgICAgICAgIF9zdGVwOTsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yIChfaXRlcmF0b3I5LnMoKTsgIShfc3RlcDkgPSBfaXRlcmF0b3I5Lm4oKSkuZG9uZTspIHsKICAgICAgICAgIHZhciBhY3Rpb24gPSBfc3RlcDkudmFsdWU7CgogICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ2RlbGV0ZScpIHsKICAgICAgICAgICAgbm9kZXNUb1VuYmluZC5hZGQoYWN0dWFsRG9tQ2hpbGRyZW5baV0pOwogICAgICAgICAgICByZW1vdmUoYWN0dWFsRG9tQ2hpbGRyZW5baV0pOwogICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdlcXVhbCcpIHsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yOS5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yOS5mKCk7CiAgICAgIH0KCiAgICAgIGkgPSAwOwoKICAgICAgdmFyIF9pdGVyYXRvcjEwID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoZGlmZiksCiAgICAgICAgICBfc3RlcDEwOwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKF9pdGVyYXRvcjEwLnMoKTsgIShfc3RlcDEwID0gX2l0ZXJhdG9yMTAubigpKS5kb25lOykgewogICAgICAgICAgdmFyIF9hY3Rpb24gPSBfc3RlcDEwLnZhbHVlOwoKICAgICAgICAgIGlmIChfYWN0aW9uID09PSAnaW5zZXJ0JykgewogICAgICAgICAgICBpbnNlcnRBdChkb21FbGVtZW50LCBpLCBleHBlY3RlZERvbUNoaWxkcmVuW2ldKTsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgfSBlbHNlIGlmIChfYWN0aW9uID09PSAnZXF1YWwnKSB7CiAgICAgICAgICAgIC8vIEZvcmNlIHVwZGF0aW5nIHRleHQgbm9kZXMgaW5zaWRlIGVsZW1lbnRzIHdoaWNoIGRpZCBub3QgY2hhbmdlIGFuZCBkbyBub3QgbmVlZCB0byBiZSByZS1yZW5kZXJlZCAoIzExMjUpLgogICAgICAgICAgICAvLyBEbyBpdCBoZXJlIChub3QgaW4gdGhlIGxvb3AgYWJvdmUpIGJlY2F1c2Ugb25seSBhZnRlciBpbnNlcnRpb25zIHRoZSBgaWAgaW5kZXggaXMgY29ycmVjdC4KICAgICAgICAgICAgdGhpcy5fbWFya0Rlc2NlbmRhbnRUZXh0VG9TeW5jKHRoaXMuZG9tQ29udmVydGVyLmRvbVRvVmlldyhleHBlY3RlZERvbUNoaWxkcmVuW2ldKSk7CgogICAgICAgICAgICBpKys7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBVbmJpbmQgcmVtb3ZlZCBub2Rlcy4gV2hlbiBub2RlIGRvZXMgbm90IGhhdmUgYSBwYXJlbnQgaXQgbWVhbnMgdGhhdCBpdCB3YXMgcmVtb3ZlZCBmcm9tIERPTSB0cmVlIGR1cmluZwogICAgICAgIC8vIGNvbXBhcmlzb24gd2l0aCB0aGUgZXhwZWN0ZWQgRE9NLiBXZSBkb24ndCBuZWVkIHRvIGNoZWNrIGNoaWxkIG5vZGVzLCBiZWNhdXNlIGlmIGNoaWxkIG5vZGUgd2FzIHJlaW5zZXJ0ZWQsCiAgICAgICAgLy8gaXQgd2FzIG1vdmVkIHRvIERPTSB0cmVlIG91dCBvZiB0aGUgcmVtb3ZlZCBub2RlLgoKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yMTAuZShlcnIpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIF9pdGVyYXRvcjEwLmYoKTsKICAgICAgfQoKICAgICAgdmFyIF9pdGVyYXRvcjExID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIobm9kZXNUb1VuYmluZCksCiAgICAgICAgICBfc3RlcDExOwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKF9pdGVyYXRvcjExLnMoKTsgIShfc3RlcDExID0gX2l0ZXJhdG9yMTEubigpKS5kb25lOykgewogICAgICAgICAgdmFyIG5vZGUgPSBfc3RlcDExLnZhbHVlOwoKICAgICAgICAgIGlmICghbm9kZS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRoaXMuZG9tQ29udmVydGVyLnVuYmluZERvbUVsZW1lbnQobm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfaXRlcmF0b3IxMS5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yMTEuZigpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNob3J0aGFuZCBmb3IgZGlmZmluZyB0d28gYXJyYXlzIG9yIG5vZGUgbGlzdHMgb2YgRE9NIG5vZGVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5LjxOb2RlPnxOb2RlTGlzdH0gYWN0dWFsRG9tQ2hpbGRyZW4gQWN0dWFsIERPTSBjaGlsZHJlbgogICAgICogQHBhcmFtIHtBcnJheS48Tm9kZT58Tm9kZUxpc3R9IGV4cGVjdGVkRG9tQ2hpbGRyZW4gRXhwZWN0ZWQgRE9NIGNoaWxkcmVuLgogICAgICogQHJldHVybnMge0FycmF5LjxTdHJpbmc+fSBUaGUgbGlzdCBvZiBhY3Rpb25zIGJhc2VkIG9uIHRoZSB7QGxpbmsgbW9kdWxlOnV0aWxzL2RpZmZ+ZGlmZn0gZnVuY3Rpb24uCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2RpZmZOb2RlTGlzdHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9kaWZmTm9kZUxpc3RzKGFjdHVhbERvbUNoaWxkcmVuLCBleHBlY3RlZERvbUNoaWxkcmVuKSB7CiAgICAgIGFjdHVhbERvbUNoaWxkcmVuID0gZmlsdGVyT3V0RmFrZVNlbGVjdGlvbkNvbnRhaW5lcihhY3R1YWxEb21DaGlsZHJlbiwgdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lcik7CiAgICAgIHJldHVybiBkaWZmKGFjdHVhbERvbUNoaWxkcmVuLCBleHBlY3RlZERvbUNoaWxkcmVuLCBzYW1lTm9kZXMuYmluZChudWxsLCB0aGlzLmRvbUNvbnZlcnRlcikpOwogICAgfQogICAgLyoqCiAgICAgKiBGaW5kcyBET00gbm9kZXMgdGhhdCB3ZXJlIHJlcGxhY2VkIHdpdGggdGhlIHNpbWlsYXIgbm9kZXMgKHNhbWUgdGFnIG5hbWUpIGluIHRoZSB2aWV3LiBBbGwgbm9kZXMgYXJlIGNvbXBhcmVkCiAgICAgKiB3aXRoaW4gb25lIGBpbnNlcnRgL2BkZWxldGVgIGFjdGlvbiBncm91cCwgZm9yIGV4YW1wbGU6CiAgICAgKgogICAgICogCQlBY3R1YWwgRE9NOgkJPHA+PGI+Rm9vPC9iPkJhcjxpPkJhejwvaT48Yj5CYXg8L2I+PC9wPgogICAgICogCQlFeHBlY3RlZCBET006CTxwPkJhcjxiPjEyMzwvYj48aT5CYXo8L2k+PGI+NDU2PC9iPjwvcD4KICAgICAqIAkJSW5wdXQgYWN0aW9uczoJWyBpbnNlcnQsIGluc2VydCwgZGVsZXRlLCBkZWxldGUsIGVxdWFsLCBpbnNlcnQsIGRlbGV0ZSBdCiAgICAgKiAJCU91dHB1dCBhY3Rpb25zOglbIGluc2VydCwgcmVwbGFjZSwgZGVsZXRlLCBlcXVhbCwgcmVwbGFjZSBdCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXkuPFN0cmluZz59IGFjdGlvbnMgQWN0aW9ucyBhcnJheSB3aGljaCBpcyBhIHJlc3VsdCBvZiB0aGUge0BsaW5rIG1vZHVsZTp1dGlscy9kaWZmfmRpZmZ9IGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtBcnJheS48Tm9kZT58Tm9kZUxpc3R9IGFjdHVhbERvbSBBY3R1YWwgRE9NIGNoaWxkcmVuCiAgICAgKiBAcGFyYW0ge0FycmF5LjxOb2RlPn0gZXhwZWN0ZWREb20gRXhwZWN0ZWQgRE9NIGNoaWxkcmVuLgogICAgICogQHJldHVybnMge0FycmF5LjxTdHJpbmc+fSBBY3Rpb25zIGFycmF5IG1vZGlmaWVkIHdpdGggdGhlIGByZXBsYWNlYCBhY3Rpb25zLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9maW5kUmVwbGFjZUFjdGlvbnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maW5kUmVwbGFjZUFjdGlvbnMoYWN0aW9ucywgYWN0dWFsRG9tLCBleHBlY3RlZERvbSkgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBib3RoICdpbnNlcnQnIGFuZCAnZGVsZXRlJyBhY3Rpb25zLCBubyBuZWVkIHRvIGNoZWNrIGZvciByZXBsYWNlZCBlbGVtZW50cy4KICAgICAgaWYgKGFjdGlvbnMuaW5kZXhPZignaW5zZXJ0JykgPT09IC0xIHx8IGFjdGlvbnMuaW5kZXhPZignZGVsZXRlJykgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuIGFjdGlvbnM7CiAgICAgIH0KCiAgICAgIHZhciBuZXdBY3Rpb25zID0gW107CiAgICAgIHZhciBhY3R1YWxTbGljZSA9IFtdOwogICAgICB2YXIgZXhwZWN0ZWRTbGljZSA9IFtdOwogICAgICB2YXIgY291bnRlciA9IHsKICAgICAgICBlcXVhbDogMCwKICAgICAgICBpbnNlcnQ6IDAsCiAgICAgICAgZGVsZXRlOiAwCiAgICAgIH07CgogICAgICB2YXIgX2l0ZXJhdG9yMTIgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihhY3Rpb25zKSwKICAgICAgICAgIF9zdGVwMTI7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yMTIucygpOyAhKF9zdGVwMTIgPSBfaXRlcmF0b3IxMi5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgYWN0aW9uID0gX3N0ZXAxMi52YWx1ZTsKCiAgICAgICAgICBpZiAoYWN0aW9uID09PSAnaW5zZXJ0JykgewogICAgICAgICAgICBleHBlY3RlZFNsaWNlLnB1c2goZXhwZWN0ZWREb21bY291bnRlci5lcXVhbCArIGNvdW50ZXIuaW5zZXJ0XSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ2RlbGV0ZScpIHsKICAgICAgICAgICAgYWN0dWFsU2xpY2UucHVzaChhY3R1YWxEb21bY291bnRlci5lcXVhbCArIGNvdW50ZXIuZGVsZXRlXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBlcXVhbAogICAgICAgICAgICBuZXdBY3Rpb25zID0gbmV3QWN0aW9ucy5jb25jYXQoZGlmZihhY3R1YWxTbGljZSwgZXhwZWN0ZWRTbGljZSwgYXJlU2ltaWxhcikubWFwKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHggPT09ICdlcXVhbCcgPyAncmVwbGFjZScgOiB4OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIG5ld0FjdGlvbnMucHVzaCgnZXF1YWwnKTsgLy8gUmVzZXQgc3RvcmVkIGVsZW1lbnRzIG9uICdlcXVhbCcuCgogICAgICAgICAgICBhY3R1YWxTbGljZSA9IFtdOwogICAgICAgICAgICBleHBlY3RlZFNsaWNlID0gW107CiAgICAgICAgICB9CgogICAgICAgICAgY291bnRlclthY3Rpb25dKys7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfaXRlcmF0b3IxMi5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yMTIuZigpOwogICAgICB9CgogICAgICByZXR1cm4gbmV3QWN0aW9ucy5jb25jYXQoZGlmZihhY3R1YWxTbGljZSwgZXhwZWN0ZWRTbGljZSwgYXJlU2ltaWxhcikubWFwKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgcmV0dXJuIHggPT09ICdlcXVhbCcgPyAncmVwbGFjZScgOiB4OwogICAgICB9KSk7CiAgICB9CiAgICAvKioKICAgICAqIE1hcmtzIHRleHQgbm9kZXMgdG8gYmUgc3luY2hyb25pemVkLgogICAgICoKICAgICAqIElmIGEgdGV4dCBub2RlIGlzIHBhc3NlZCwgaXQgd2lsbCBiZSBtYXJrZWQuIElmIGFuIGVsZW1lbnQgaXMgcGFzc2VkLCBhbGwgZGVzY2VuZGFudCB0ZXh0IG5vZGVzIGluc2lkZSBpdCB3aWxsIGJlIG1hcmtlZC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL3ZpZXcvbm9kZX5Ob2RlfSB2aWV3Tm9kZSBWaWV3IG5vZGUgdG8gc3luYy4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfbWFya0Rlc2NlbmRhbnRUZXh0VG9TeW5jIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbWFya0Rlc2NlbmRhbnRUZXh0VG9TeW5jKHZpZXdOb2RlKSB7CiAgICAgIGlmICghdmlld05vZGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh2aWV3Tm9kZS5pcygnJHRleHQnKSkgewogICAgICAgIHRoaXMubWFya2VkVGV4dHMuYWRkKHZpZXdOb2RlKTsKICAgICAgfSBlbHNlIGlmICh2aWV3Tm9kZS5pcygnZWxlbWVudCcpKSB7CiAgICAgICAgdmFyIF9pdGVyYXRvcjEzID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodmlld05vZGUuZ2V0Q2hpbGRyZW4oKSksCiAgICAgICAgICAgIF9zdGVwMTM7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKF9pdGVyYXRvcjEzLnMoKTsgIShfc3RlcDEzID0gX2l0ZXJhdG9yMTMubigpKS5kb25lOykgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBfc3RlcDEzLnZhbHVlOwoKICAgICAgICAgICAgdGhpcy5fbWFya0Rlc2NlbmRhbnRUZXh0VG9TeW5jKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvcjEzLmUoZXJyKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgX2l0ZXJhdG9yMTMuZigpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIHNlbGVjdGlvbiBuZWVkcyB0byBiZSB1cGRhdGVkIGFuZCBwb3NzaWJseSB1cGRhdGVzIGl0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3VwZGF0ZVNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVNlbGVjdGlvbigpIHsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gc2VsZWN0aW9uIC0gcmVtb3ZlIERPTSBhbmQgZmFrZSBzZWxlY3Rpb25zLgogICAgICBpZiAodGhpcy5zZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgIHRoaXMuX3JlbW92ZURvbVNlbGVjdGlvbigpOwoKICAgICAgICB0aGlzLl9yZW1vdmVGYWtlU2VsZWN0aW9uKCk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGRvbVJvb3QgPSB0aGlzLmRvbUNvbnZlcnRlci5tYXBWaWV3VG9Eb20odGhpcy5zZWxlY3Rpb24uZWRpdGFibGVFbGVtZW50KTsgLy8gRG8gbm90aGluZyBpZiB0aGVyZSBpcyBubyBmb2N1cywgb3IgdGhlcmUgaXMgbm8gRE9NIGVsZW1lbnQgY29ycmVzcG9uZGluZyB0byBzZWxlY3Rpb24ncyBlZGl0YWJsZSBlbGVtZW50LgoKICAgICAgaWYgKCF0aGlzLmlzRm9jdXNlZCB8fCAhZG9tUm9vdCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBSZW5kZXIgc2VsZWN0aW9uLgoKCiAgICAgIGlmICh0aGlzLnNlbGVjdGlvbi5pc0Zha2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVGYWtlU2VsZWN0aW9uKGRvbVJvb3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3JlbW92ZUZha2VTZWxlY3Rpb24oKTsKCiAgICAgICAgdGhpcy5fdXBkYXRlRG9tU2VsZWN0aW9uKGRvbVJvb3QpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZXMgdGhlIGZha2Ugc2VsZWN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBkb21Sb290IEEgdmFsaWQgRE9NIHJvb3Qgd2hlcmUgdGhlIGZha2Ugc2VsZWN0aW9uIGNvbnRhaW5lciBzaG91bGQgYmUgYWRkZWQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3VwZGF0ZUZha2VTZWxlY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVGYWtlU2VsZWN0aW9uKGRvbVJvb3QpIHsKICAgICAgdmFyIGRvbURvY3VtZW50ID0gZG9tUm9vdC5vd25lckRvY3VtZW50OwoKICAgICAgaWYgKCF0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lciA9IGNyZWF0ZUZha2VTZWxlY3Rpb25Db250YWluZXIoZG9tRG9jdW1lbnQpOwogICAgICB9CgogICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lcjsgLy8gQmluZCBmYWtlIHNlbGVjdGlvbiBjb250YWluZXIgd2l0aCB0aGUgY3VycmVudCBzZWxlY3Rpb24gKnBvc2l0aW9uKi4KCiAgICAgIHRoaXMuZG9tQ29udmVydGVyLmJpbmRGYWtlU2VsZWN0aW9uKGNvbnRhaW5lciwgdGhpcy5zZWxlY3Rpb24pOwoKICAgICAgaWYgKCF0aGlzLl9mYWtlU2VsZWN0aW9uTmVlZHNVcGRhdGUoZG9tUm9vdCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghY29udGFpbmVyLnBhcmVudEVsZW1lbnQgfHwgY29udGFpbmVyLnBhcmVudEVsZW1lbnQgIT0gZG9tUm9vdCkgewogICAgICAgIGRvbVJvb3QuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKICAgICAgfQoKICAgICAgY29udGFpbmVyLnRleHRDb250ZW50ID0gdGhpcy5zZWxlY3Rpb24uZmFrZVNlbGVjdGlvbkxhYmVsIHx8ICJceEEwIjsKICAgICAgdmFyIGRvbVNlbGVjdGlvbiA9IGRvbURvY3VtZW50LmdldFNlbGVjdGlvbigpOwogICAgICB2YXIgZG9tUmFuZ2UgPSBkb21Eb2N1bWVudC5jcmVhdGVSYW5nZSgpOwogICAgICBkb21TZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgIGRvbVJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhjb250YWluZXIpOwogICAgICBkb21TZWxlY3Rpb24uYWRkUmFuZ2UoZG9tUmFuZ2UpOwogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIHRoZSBET00gc2VsZWN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBkb21Sb290IEEgdmFsaWQgRE9NIHJvb3Qgd2hlcmUgdGhlIERPTSBzZWxlY3Rpb24gc2hvdWxkIGJlIHJlbmRlcmVkLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl91cGRhdGVEb21TZWxlY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVEb21TZWxlY3Rpb24oZG9tUm9vdCkgewogICAgICB2YXIgZG9tU2VsZWN0aW9uID0gZG9tUm9vdC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldFNlbGVjdGlvbigpOyAvLyBMZXQncyBjaGVjayB3aGV0aGVyIERPTSBzZWxlY3Rpb24gbmVlZHMgdXBkYXRpbmcgYXQgYWxsLgoKICAgICAgaWYgKCF0aGlzLl9kb21TZWxlY3Rpb25OZWVkc1VwZGF0ZShkb21TZWxlY3Rpb24pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIE11bHRpLXJhbmdlIHNlbGVjdGlvbiBpcyBub3QgYXZhaWxhYmxlIGluIG1vc3QgYnJvd3NlcnMsIGFuZCwgYXQgbGVhc3QgaW4gQ2hyb21lLCB0cnlpbmcgdG8KICAgICAgLy8gc2V0IHN1Y2ggc2VsZWN0aW9uLCB0aGF0IGlzIG5vdCBjb250aW51b3VzLCB0aHJvd3MgYW4gZXJyb3IuIEJlY2F1c2Ugb2YgdGhhdCwgd2Ugd2lsbCBqdXN0IHVzZSBhbmNob3IKICAgICAgLy8gYW5kIGZvY3VzIG9mIHZpZXcgc2VsZWN0aW9uLgogICAgICAvLyBTaW5jZSB3ZSBhcmUgbm90IHN1cHBvcnRpbmcgbXVsdGktcmFuZ2Ugc2VsZWN0aW9uLCB3ZSBhbHNvIGRvIG5vdCBuZWVkIHRvIGNoZWNrIGlmIHByb3BlciBlZGl0YWJsZSBpcwogICAgICAvLyBzZWxlY3RlZC4gSWYgdGhlcmUgaXMgYW55IGVkaXRhYmxlIHNlbGVjdGVkLCBpdCBpcyBva2F5IChlZGl0YWJsZSBpcyB0YWtlbiBmcm9tIHNlbGVjdGlvbiBhbmNob3IpLgoKCiAgICAgIHZhciBhbmNob3IgPSB0aGlzLmRvbUNvbnZlcnRlci52aWV3UG9zaXRpb25Ub0RvbSh0aGlzLnNlbGVjdGlvbi5hbmNob3IpOwogICAgICB2YXIgZm9jdXMgPSB0aGlzLmRvbUNvbnZlcnRlci52aWV3UG9zaXRpb25Ub0RvbSh0aGlzLnNlbGVjdGlvbi5mb2N1cyk7CiAgICAgIGRvbVNlbGVjdGlvbi5jb2xsYXBzZShhbmNob3IucGFyZW50LCBhbmNob3Iub2Zmc2V0KTsKICAgICAgZG9tU2VsZWN0aW9uLmV4dGVuZChmb2N1cy5wYXJlbnQsIGZvY3VzLm9mZnNldCk7IC8vIEZpcmVmb3jigJNzcGVjaWZpYyBoYWNrIChodHRwczovL2dpdGh1Yi5jb20vY2tlZGl0b3IvY2tlZGl0b3I1LWVuZ2luZS9pc3N1ZXMvMTQzOSkuCgogICAgICBpZiAoZW52LmlzR2Vja28pIHsKICAgICAgICBmaXhHZWNrb1NlbGVjdGlvbkFmdGVyQnIoZm9jdXMsIGRvbVNlbGVjdGlvbik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgYSBnaXZlbiBET00gc2VsZWN0aW9uIG5lZWRzIHRvIGJlIHVwZGF0ZWQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7U2VsZWN0aW9ufSBkb21TZWxlY3Rpb24gVGhlIERPTSBzZWxlY3Rpb24gdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZG9tU2VsZWN0aW9uTmVlZHNVcGRhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9kb21TZWxlY3Rpb25OZWVkc1VwZGF0ZShkb21TZWxlY3Rpb24pIHsKICAgICAgaWYgKCF0aGlzLmRvbUNvbnZlcnRlci5pc0RvbVNlbGVjdGlvbkNvcnJlY3QoZG9tU2VsZWN0aW9uKSkgewogICAgICAgIC8vIEN1cnJlbnQgRE9NIHNlbGVjdGlvbiBpcyBpbiBpbmNvcnJlY3QgcG9zaXRpb24uIFdlIG5lZWQgdG8gdXBkYXRlIGl0LgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgb2xkVmlld1NlbGVjdGlvbiA9IGRvbVNlbGVjdGlvbiAmJiB0aGlzLmRvbUNvbnZlcnRlci5kb21TZWxlY3Rpb25Ub1ZpZXcoZG9tU2VsZWN0aW9uKTsKCiAgICAgIGlmIChvbGRWaWV3U2VsZWN0aW9uICYmIHRoaXMuc2VsZWN0aW9uLmlzRXF1YWwob2xkVmlld1NlbGVjdGlvbikpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gSWYgc2VsZWN0aW9uIGlzIG5vdCBjb2xsYXBzZWQsIGl0IGRvZXMgbm90IG5lZWQgdG8gYmUgdXBkYXRlZCBpZiBpdCBpcyBzaW1pbGFyLgoKCiAgICAgIGlmICghdGhpcy5zZWxlY3Rpb24uaXNDb2xsYXBzZWQgJiYgdGhpcy5zZWxlY3Rpb24uaXNTaW1pbGFyKG9sZFZpZXdTZWxlY3Rpb24pKSB7CiAgICAgICAgLy8gU2VsZWN0aW9uIGRpZCBub3QgY2hhbmdlZCBhbmQgaXMgY29ycmVjdCwgZG8gbm90IHVwZGF0ZS4KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gU2VsZWN0aW9ucyBhcmUgbm90IHNpbWlsYXIuCgoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyB3aGV0aGVyIHRoZSBmYWtlIHNlbGVjdGlvbiBuZWVkcyB0byBiZSB1cGRhdGVkLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBkb21Sb290IEEgdmFsaWQgRE9NIHJvb3Qgd2hlcmUgYSBuZXcgZmFrZSBzZWxlY3Rpb24gY29udGFpbmVyIHNob3VsZCBiZSBhZGRlZC4KICAgICAqIEByZXR1cm5zIHtCb29sZWFufQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9mYWtlU2VsZWN0aW9uTmVlZHNVcGRhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9mYWtlU2VsZWN0aW9uTmVlZHNVcGRhdGUoZG9tUm9vdCkgewogICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5fZmFrZVNlbGVjdGlvbkNvbnRhaW5lcjsKICAgICAgdmFyIGRvbVNlbGVjdGlvbiA9IGRvbVJvb3Qub3duZXJEb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsgLy8gRmFrZSBzZWxlY3Rpb24gbmVlZHMgdG8gYmUgdXBkYXRlZCBpZiB0aGVyZSdzIG5vIGZha2Ugc2VsZWN0aW9uIGNvbnRhaW5lciwgb3IgdGhlIGNvbnRhaW5lciBjdXJyZW50bHkgc2l0cwogICAgICAvLyBpbiBhIGRpZmZlcmVudCByb290LgoKICAgICAgaWYgKCFjb250YWluZXIgfHwgY29udGFpbmVyLnBhcmVudEVsZW1lbnQgIT09IGRvbVJvb3QpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgc2VsZWN0aW9uIGFjdHVhbGx5IGlzIHdpdGhpbiB0aGUgZmFrZSBzZWxlY3Rpb24uCgoKICAgICAgaWYgKGRvbVNlbGVjdGlvbi5hbmNob3JOb2RlICE9PSBjb250YWluZXIgJiYgIWNvbnRhaW5lci5jb250YWlucyhkb21TZWxlY3Rpb24uYW5jaG9yTm9kZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNvbnRhaW5lci50ZXh0Q29udGVudCAhPT0gdGhpcy5zZWxlY3Rpb24uZmFrZVNlbGVjdGlvbkxhYmVsOwogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIHRoZSBET00gc2VsZWN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3JlbW92ZURvbVNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3JlbW92ZURvbVNlbGVjdGlvbigpIHsKICAgICAgdmFyIF9pdGVyYXRvcjE0ID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy5kb21Eb2N1bWVudHMpLAogICAgICAgICAgX3N0ZXAxNDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yIChfaXRlcmF0b3IxNC5zKCk7ICEoX3N0ZXAxNCA9IF9pdGVyYXRvcjE0Lm4oKSkuZG9uZTspIHsKICAgICAgICAgIHZhciBkb2MgPSBfc3RlcDE0LnZhbHVlOwogICAgICAgICAgdmFyIGRvbVNlbGVjdGlvbiA9IGRvYy5nZXRTZWxlY3Rpb24oKTsKCiAgICAgICAgICBpZiAoZG9tU2VsZWN0aW9uLnJhbmdlQ291bnQpIHsKICAgICAgICAgICAgdmFyIGFjdGl2ZURvbUVsZW1lbnQgPSBkb2MuYWN0aXZlRWxlbWVudDsKICAgICAgICAgICAgdmFyIHZpZXdFbGVtZW50ID0gdGhpcy5kb21Db252ZXJ0ZXIubWFwRG9tVG9WaWV3KGFjdGl2ZURvbUVsZW1lbnQpOwoKICAgICAgICAgICAgaWYgKGFjdGl2ZURvbUVsZW1lbnQgJiYgdmlld0VsZW1lbnQpIHsKICAgICAgICAgICAgICBkb2MuZ2V0U2VsZWN0aW9uKCkucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvcjE0LmUoZXJyKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBfaXRlcmF0b3IxNC5mKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyB0aGUgZmFrZSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfcmVtb3ZlRmFrZVNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3JlbW92ZUZha2VTZWxlY3Rpb24oKSB7CiAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9mYWtlU2VsZWN0aW9uQ29udGFpbmVyOwoKICAgICAgaWYgKGNvbnRhaW5lcikgewogICAgICAgIGNvbnRhaW5lci5yZW1vdmUoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgZm9jdXMgbmVlZHMgdG8gYmUgdXBkYXRlZCBhbmQgcG9zc2libHkgdXBkYXRlcyBpdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCgogIH0sIHsKICAgIGtleTogIl91cGRhdGVGb2N1cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUZvY3VzKCkgewogICAgICBpZiAodGhpcy5pc0ZvY3VzZWQpIHsKICAgICAgICB2YXIgZWRpdGFibGUgPSB0aGlzLnNlbGVjdGlvbi5lZGl0YWJsZUVsZW1lbnQ7CgogICAgICAgIGlmIChlZGl0YWJsZSkgewogICAgICAgICAgdGhpcy5kb21Db252ZXJ0ZXIuZm9jdXMoZWRpdGFibGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH1dKTsKCiAgcmV0dXJuIFJlbmRlcmVyOwp9KCk7CgpleHBvcnQgeyBSZW5kZXJlciBhcyBkZWZhdWx0IH07Cm1peChSZW5kZXJlciwgT2JzZXJ2YWJsZU1peGluKTsgLy8gQ2hlY2tzIGlmIHByb3ZpZGVkIGVsZW1lbnQgaXMgZWRpdGFibGUuCi8vCi8vIEBwcml2YXRlCi8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS92aWV3L2VsZW1lbnR+RWxlbWVudH0gZWxlbWVudAovLyBAcmV0dXJucyB7Qm9vbGVhbn0KCmZ1bmN0aW9uIGlzRWRpdGFibGUoZWxlbWVudCkgewogIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY29udGVudGVkaXRhYmxlJykgPT0gJ2ZhbHNlJykgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIHBhcmVudCA9IGVsZW1lbnQuZmluZEFuY2VzdG9yKGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5oYXNBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScpOwogIH0pOwogIHJldHVybiAhcGFyZW50IHx8IHBhcmVudC5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScpID09ICd0cnVlJzsKfSAvLyBBZGRzIGlubGluZSBmaWxsZXIgYXQgYSBnaXZlbiBwb3NpdGlvbi4KLy8KLy8gVGhlIHBvc2l0aW9uIGNhbiBiZSBnaXZlbiBhcyBhbiBhcnJheSBvZiBET00gbm9kZXMgYW5kIGFuIG9mZnNldCBpbiB0aGF0IGFycmF5LAovLyBvciBhIERPTSBwYXJlbnQgZWxlbWVudCBhbmQgYW4gb2Zmc2V0IGluIHRoYXQgZWxlbWVudC4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHtEb2N1bWVudH0gZG9tRG9jdW1lbnQKLy8gQHBhcmFtIHtFbGVtZW50fEFycmF5LjxOb2RlPn0gZG9tUGFyZW50T3JBcnJheQovLyBAcGFyYW0ge051bWJlcn0gb2Zmc2V0Ci8vIEByZXR1cm5zIHtUZXh0fSBUaGUgRE9NIHRleHQgbm9kZSB0aGF0IGNvbnRhaW5zIGFuIGlubGluZSBmaWxsZXIuCgoKZnVuY3Rpb24gYWRkSW5saW5lRmlsbGVyKGRvbURvY3VtZW50LCBkb21QYXJlbnRPckFycmF5LCBvZmZzZXQpIHsKICB2YXIgY2hpbGROb2RlcyA9IGRvbVBhcmVudE9yQXJyYXkgaW5zdGFuY2VvZiBBcnJheSA/IGRvbVBhcmVudE9yQXJyYXkgOiBkb21QYXJlbnRPckFycmF5LmNoaWxkTm9kZXM7CiAgdmFyIG5vZGVBZnRlckZpbGxlciA9IGNoaWxkTm9kZXNbb2Zmc2V0XTsKCiAgaWYgKGlzVGV4dChub2RlQWZ0ZXJGaWxsZXIpKSB7CiAgICBub2RlQWZ0ZXJGaWxsZXIuZGF0YSA9IElOTElORV9GSUxMRVIgKyBub2RlQWZ0ZXJGaWxsZXIuZGF0YTsKICAgIHJldHVybiBub2RlQWZ0ZXJGaWxsZXI7CiAgfSBlbHNlIHsKICAgIHZhciBmaWxsZXJOb2RlID0gZG9tRG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoSU5MSU5FX0ZJTExFUik7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZG9tUGFyZW50T3JBcnJheSkpIHsKICAgICAgY2hpbGROb2Rlcy5zcGxpY2Uob2Zmc2V0LCAwLCBmaWxsZXJOb2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIGluc2VydEF0KGRvbVBhcmVudE9yQXJyYXksIG9mZnNldCwgZmlsbGVyTm9kZSk7CiAgICB9CgogICAgcmV0dXJuIGZpbGxlck5vZGU7CiAgfQp9IC8vIFdoZXRoZXIgdHdvIERPTSBub2RlcyBzaG91bGQgYmUgY29uc2lkZXJlZCBhcyBzaW1pbGFyLgovLyBOb2RlcyBhcmUgY29uc2lkZXJlZCBzaW1pbGFyIGlmIHRoZXkgaGF2ZSB0aGUgc2FtZSB0YWcgbmFtZS4KLy8KLy8gQHByaXZhdGUKLy8gQHBhcmFtIHtOb2RlfSBub2RlMQovLyBAcGFyYW0ge05vZGV9IG5vZGUyCi8vIEByZXR1cm5zIHtCb29sZWFufQoKCmZ1bmN0aW9uIGFyZVNpbWlsYXIobm9kZTEsIG5vZGUyKSB7CiAgcmV0dXJuIGlzTm9kZShub2RlMSkgJiYgaXNOb2RlKG5vZGUyKSAmJiAhaXNUZXh0KG5vZGUxKSAmJiAhaXNUZXh0KG5vZGUyKSAmJiBub2RlMS5ub2RlVHlwZSAhPT0gTm9kZS5DT01NRU5UX05PREUgJiYgbm9kZTIubm9kZVR5cGUgIT09IE5vZGUuQ09NTUVOVF9OT0RFICYmIG5vZGUxLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZTIudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwp9IC8vIFdoZXRoZXIgdHdvIGRvbSBub2RlcyBzaG91bGQgYmUgY29uc2lkZXJlZCBhcyB0aGUgc2FtZS4KLy8gVHdvIG5vZGVzIHdoaWNoIGFyZSBjb25zaWRlcmVkIHRoZSBzYW1lIGFyZToKLy8KLy8JCSogVGV4dCBub2RlcyB3aXRoIHRoZSBzYW1lIHRleHQuCi8vCQkqIEVsZW1lbnQgbm9kZXMgcmVwcmVzZW50ZWQgYnkgdGhlIHNhbWUgb2JqZWN0LgovLwkJKiBUd28gYmxvY2sgZmlsbGVyIGVsZW1lbnRzLgovLwovLyBAcHJpdmF0ZQovLyBAcGFyYW0ge1N0cmluZ30gYmxvY2tGaWxsZXJNb2RlIEJsb2NrIGZpbGxlciBtb2RlLCBzZWUge0BsaW5rIG1vZHVsZTplbmdpbmUvdmlldy9kb21jb252ZXJ0ZXJ+RG9tQ29udmVydGVyI2Jsb2NrRmlsbGVyTW9kZX0uCi8vIEBwYXJhbSB7Tm9kZX0gbm9kZTEKLy8gQHBhcmFtIHtOb2RlfSBub2RlMgovLyBAcmV0dXJucyB7Qm9vbGVhbn0KCgpmdW5jdGlvbiBzYW1lTm9kZXMoZG9tQ29udmVydGVyLCBhY3R1YWxEb21DaGlsZCwgZXhwZWN0ZWREb21DaGlsZCkgewogIC8vIEVsZW1lbnRzLgogIGlmIChhY3R1YWxEb21DaGlsZCA9PT0gZXhwZWN0ZWREb21DaGlsZCkgewogICAgcmV0dXJuIHRydWU7CiAgfSAvLyBUZXh0cy4KICBlbHNlIGlmIChpc1RleHQoYWN0dWFsRG9tQ2hpbGQpICYmIGlzVGV4dChleHBlY3RlZERvbUNoaWxkKSkgewogICAgICByZXR1cm4gYWN0dWFsRG9tQ2hpbGQuZGF0YSA9PT0gZXhwZWN0ZWREb21DaGlsZC5kYXRhOwogICAgfSAvLyBCbG9jayBmaWxsZXJzLgogICAgZWxzZSBpZiAoZG9tQ29udmVydGVyLmlzQmxvY2tGaWxsZXIoYWN0dWFsRG9tQ2hpbGQpICYmIGRvbUNvbnZlcnRlci5pc0Jsb2NrRmlsbGVyKGV4cGVjdGVkRG9tQ2hpbGQpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gLy8gTm90IG1hdGNoaW5nIHR5cGVzLgoKCiAgcmV0dXJuIGZhbHNlOwp9IC8vIFRoZSBmb2xsb3dpbmcgaXMgYSBGaXJlZm944oCTc3BlY2lmaWMgaGFjayAoaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS1lbmdpbmUvaXNzdWVzLzE0MzkpLgovLyBXaGVuIHRoZSBuYXRpdmUgRE9NIHNlbGVjdGlvbiBpcyBhdCB0aGUgZW5kIG9mIHRoZSBibG9jayBhbmQgcHJlY2VkZWQgYnkgPGJyIC8+IGUuZy4KLy8KLy8JCTxwPmZvbzxici8+W108L3A+Ci8vCi8vIHdoaWNoIGhhcHBlbnMgYSBsb3Qgd2hlbiB1c2luZyB0aGUgc29mdCBsaW5lIGJyZWFrLCB0aGUgYnJvd3NlciBmYWlscyB0byAodmlzdWFsbHkpIG1vdmUgdGhlCi8vIGNhcmV0IHRvIHRoZSBuZXcgbGluZS4gQSBxdWljayBmaXggaXMgYXMgc2ltcGxlIGFzIGZvcmNl4oCTcmVmcmVzaGluZyB0aGUgc2VsZWN0aW9uIHdpdGggdGhlIHNhbWUgcmFuZ2UuCgoKZnVuY3Rpb24gZml4R2Vja29TZWxlY3Rpb25BZnRlckJyKGZvY3VzLCBkb21TZWxlY3Rpb24pIHsKICB2YXIgcGFyZW50ID0gZm9jdXMucGFyZW50OyAvLyBUaGlzIGZpeCB3b3JrcyBvbmx5IHdoZW4gdGhlIGZvY3VzIHBvaW50IGlzIGF0IHRoZSB2ZXJ5IGVuZCBvZiBhbiBlbGVtZW50LgogIC8vIFRoZXJlIGlzIG5vIHBvaW50IGluIHJ1bm5pbmcgaXQgaW4gY2FzZXMgdW5yZWxhdGVkIHRvIHRoZSBicm93c2VyIGJ1Zy4KCiAgaWYgKHBhcmVudC5ub2RlVHlwZSAhPSBOb2RlLkVMRU1FTlRfTk9ERSB8fCBmb2N1cy5vZmZzZXQgIT0gcGFyZW50LmNoaWxkTm9kZXMubGVuZ3RoIC0gMSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGNoaWxkQXRPZmZzZXQgPSBwYXJlbnQuY2hpbGROb2Rlc1tmb2N1cy5vZmZzZXRdOyAvLyBUbyBzdGF5IG9uIHRoZSBzYWZlIHNpZGUsIHRoZSBmaXggYmVpbmcgYXMgc3BlY2lmaWMgYXMgcG9zc2libGUsIGl0IHRhcmdldHMgb25seSB0aGUKICAvLyBzZWxlY3Rpb24gd2hpY2ggaXMgYXQgdGhlIHZlcnkgZW5kIG9mIHRoZSBlbGVtZW50IGFuZCBwcmVjZWRlZCBieSA8YnIgLz4uCgogIGlmIChjaGlsZEF0T2Zmc2V0ICYmIGNoaWxkQXRPZmZzZXQudGFnTmFtZSA9PSAnQlInKSB7CiAgICBkb21TZWxlY3Rpb24uYWRkUmFuZ2UoZG9tU2VsZWN0aW9uLmdldFJhbmdlQXQoMCkpOwogIH0KfQoKZnVuY3Rpb24gZmlsdGVyT3V0RmFrZVNlbGVjdGlvbkNvbnRhaW5lcihkb21DaGlsZExpc3QsIGZha2VTZWxlY3Rpb25Db250YWluZXIpIHsKICB2YXIgY2hpbGRMaXN0ID0gQXJyYXkuZnJvbShkb21DaGlsZExpc3QpOwoKICBpZiAoY2hpbGRMaXN0Lmxlbmd0aCA9PSAwIHx8ICFmYWtlU2VsZWN0aW9uQ29udGFpbmVyKSB7CiAgICByZXR1cm4gY2hpbGRMaXN0OwogIH0KCiAgdmFyIGxhc3QgPSBjaGlsZExpc3RbY2hpbGRMaXN0Lmxlbmd0aCAtIDFdOwoKICBpZiAobGFzdCA9PSBmYWtlU2VsZWN0aW9uQ29udGFpbmVyKSB7CiAgICBjaGlsZExpc3QucG9wKCk7CiAgfQoKICByZXR1cm4gY2hpbGRMaXN0Owp9IC8vIENyZWF0ZXMgYSBmYWtlIHNlbGVjdGlvbiBjb250YWluZXIgZm9yIGEgZ2l2ZW4gZG9jdW1lbnQuCi8vCi8vIEBwcml2YXRlCi8vIEBwYXJhbSB7RG9jdW1lbnR9IGRvbURvY3VtZW50Ci8vIEByZXR1cm5zIHtIVE1MRWxlbWVudH0KCgpmdW5jdGlvbiBjcmVhdGVGYWtlU2VsZWN0aW9uQ29udGFpbmVyKGRvbURvY3VtZW50KSB7CiAgdmFyIGNvbnRhaW5lciA9IGRvbURvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogIGNvbnRhaW5lci5jbGFzc05hbWUgPSAnY2stZmFrZS1zZWxlY3Rpb24tY29udGFpbmVyJzsKICBPYmplY3QuYXNzaWduKGNvbnRhaW5lci5zdHlsZSwgewogICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICB0b3A6IDAsCiAgICBsZWZ0OiAnLTk5OTlweCcsCiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2NrZWRpdG9yL2NrZWRpdG9yNS9pc3N1ZXMvNzUyLgogICAgd2lkdGg6ICc0MnB4JwogIH0pOyAvLyBGaWxsIGl0IHdpdGggYSB0ZXh0IG5vZGUgc28gd2UgY2FuIHVwZGF0ZSBpdCBsYXRlci4KCiAgY29udGFpbmVyLnRleHRDb250ZW50ID0gIlx4QTAiOwogIHJldHVybiBjb250YWluZXI7Cn0="},{"version":3,"sources":["/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/view/renderer.js"],"names":["ViewText","ViewPosition","INLINE_FILLER","INLINE_FILLER_LENGTH","startsWithFiller","isInlineFiller","mix","diff","insertAt","remove","ObservableMixin","CKEditorError","isText","isNode","fastDiff","env","Renderer","domConverter","selection","domDocuments","Set","markedAttributes","markedChildren","markedTexts","isFocused","_inlineFiller","_fakeSelectionContainer","type","node","mapViewToDom","parent","add","inlineFillerPosition","element","_updateChildrenMappings","_isSelectionInInlineFiller","_removeInlineFiller","_getInlineFillerPosition","_needsInlineFillerAtSelection","getFirstPosition","_updateAttrs","_updateChildren","has","_updateText","fillerDomPosition","viewPositionToDom","domDocument","ownerDocument","addInlineFiller","offset","_updateFocus","_updateSelection","clear","viewElement","domElement","actualDomChildren","childNodes","expectedDomChildren","Array","from","viewChildrenToDom","withChildren","_diffNodeLists","actions","_findReplaceActions","indexOf","counter","equal","insert","delete","action","insertIndex","deleteIndex","viewChild","getChild","is","_updateElementMappings","unbindDomElement","bindElements","firstPos","_createBefore","rangeCount","isCollapsed","selectionPosition","position","domFillerNode","parentNode","removeChild","data","substr","selectionParent","selectionOffset","root","isEditable","getFillerOffset","nodeBefore","nodeAfter","viewText","options","domText","findCorrespondingDomText","newDomText","viewToDom","actualText","expectedText","filler","index","insertData","values","join","deleteData","howMany","domAttrKeys","attributes","map","attr","name","viewAttrKeys","getAttributeKeys","key","setAttribute","getAttribute","hasAttribute","removeAttribute","bind","i","nodesToUnbind","_markDescendantTextToSync","domToView","filterOutFakeSelectionContainer","sameNodes","actualDom","expectedDom","newActions","actualSlice","expectedSlice","push","concat","areSimilar","x","viewNode","getChildren","child","_removeDomSelection","_removeFakeSelection","domRoot","editableElement","isFake","_updateFakeSelection","_updateDomSelection","createFakeSelectionContainer","container","bindFakeSelection","_fakeSelectionNeedsUpdate","parentElement","appendChild","textContent","fakeSelectionLabel","domSelection","getSelection","domRange","createRange","removeAllRanges","selectNodeContents","addRange","defaultView","_domSelectionNeedsUpdate","anchor","focus","collapse","extend","isGecko","fixGeckoSelectionAfterBr","isDomSelectionCorrect","oldViewSelection","domSelectionToView","isEqual","isSimilar","anchorNode","contains","doc","activeDomElement","activeElement","mapDomToView","editable","findAncestor","domParentOrArray","nodeAfterFiller","fillerNode","createTextNode","isArray","splice","node1","node2","nodeType","Node","COMMENT_NODE","tagName","toLowerCase","actualDomChild","expectedDomChild","isBlockFiller","ELEMENT_NODE","length","childAtOffset","getRangeAt","domChildList","fakeSelectionContainer","childList","last","pop","createElement","className","Object","assign","style","top","left","width"],"mappings":"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","sourcesContent":["/**\n * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/* globals Node */\n\n/**\n * @module engine/view/renderer\n */\n\nimport ViewText from './text';\nimport ViewPosition from './position';\nimport { INLINE_FILLER, INLINE_FILLER_LENGTH, startsWithFiller, isInlineFiller } from './filler';\n\nimport mix from '@ckeditor/ckeditor5-utils/src/mix';\nimport diff from '@ckeditor/ckeditor5-utils/src/diff';\nimport insertAt from '@ckeditor/ckeditor5-utils/src/dom/insertat';\nimport remove from '@ckeditor/ckeditor5-utils/src/dom/remove';\nimport ObservableMixin from '@ckeditor/ckeditor5-utils/src/observablemixin';\nimport CKEditorError from '@ckeditor/ckeditor5-utils/src/ckeditorerror';\nimport isText from '@ckeditor/ckeditor5-utils/src/dom/istext';\nimport isNode from '@ckeditor/ckeditor5-utils/src/dom/isnode';\nimport fastDiff from '@ckeditor/ckeditor5-utils/src/fastdiff';\nimport env from '@ckeditor/ckeditor5-utils/src/env';\n\n/**\n * Renderer is responsible for updating the DOM structure and the DOM selection based on\n * the {@link module:engine/view/renderer~Renderer#markToSync information about updated view nodes}.\n * In other words, it renders the view to the DOM.\n *\n * Its main responsibility is to make only the necessary, minimal changes to the DOM. However, unlike in many\n * virtual DOM implementations, the primary reason for doing minimal changes is not the performance but ensuring\n * that native editing features such as text composition, autocompletion, spell checking, selection's x-index are\n * affected as little as possible.\n *\n * Renderer uses {@link module:engine/view/domconverter~DomConverter} to transform view nodes and positions\n * to and from the DOM.\n */\nexport default class Renderer {\n\t/**\n\t * Creates a renderer instance.\n\t *\n\t * @param {module:engine/view/domconverter~DomConverter} domConverter Converter instance.\n\t * @param {module:engine/view/documentselection~DocumentSelection} selection View selection.\n\t */\n\tconstructor( domConverter, selection ) {\n\t\t/**\n\t\t * Set of DOM Documents instances.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<Document>}\n\t\t */\n\t\tthis.domDocuments = new Set();\n\n\t\t/**\n\t\t * Converter instance.\n\t\t *\n\t\t * @readonly\n\t\t * @member {module:engine/view/domconverter~DomConverter}\n\t\t */\n\t\tthis.domConverter = domConverter;\n\n\t\t/**\n\t\t * Set of nodes which attributes changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedAttributes = new Set();\n\n\t\t/**\n\t\t * Set of elements which child lists changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedChildren = new Set();\n\n\t\t/**\n\t\t * Set of text nodes which text data changed and may need to be rendered.\n\t\t *\n\t\t * @readonly\n\t\t * @member {Set.<module:engine/view/node~Node>}\n\t\t */\n\t\tthis.markedTexts = new Set();\n\n\t\t/**\n\t\t * View selection. Renderer updates DOM selection based on the view selection.\n\t\t *\n\t\t * @readonly\n\t\t * @member {module:engine/view/documentselection~DocumentSelection}\n\t\t */\n\t\tthis.selection = selection;\n\n\t\t/**\n\t\t * Indicates if the view document is focused and selection can be rendered. Selection will not be rendered if\n\t\t * this is set to `false`.\n\t\t *\n\t\t * @member {Boolean}\n\t\t */\n\t\tthis.isFocused = false;\n\n\t\t/**\n\t\t * The text node in which the inline filler was rendered.\n\t\t *\n\t\t * @private\n\t\t * @member {Text}\n\t\t */\n\t\tthis._inlineFiller = null;\n\n\t\t/**\n\t\t * DOM element containing fake selection.\n\t\t *\n\t\t * @private\n\t\t * @type {null|HTMLElement}\n\t\t */\n\t\tthis._fakeSelectionContainer = null;\n\t}\n\n\t/**\n\t * Marks a view node to be updated in the DOM by {@link #render `render()`}.\n\t *\n\t * Note that only view nodes whose parents have corresponding DOM elements need to be marked to be synchronized.\n\t *\n\t * @see #markedAttributes\n\t * @see #markedChildren\n\t * @see #markedTexts\n\t *\n\t * @param {module:engine/view/document~ChangeType} type Type of the change.\n\t * @param {module:engine/view/node~Node} node Node to be marked.\n\t */\n\tmarkToSync( type, node ) {\n\t\tif ( type === 'text' ) {\n\t\t\tif ( this.domConverter.mapViewToDom( node.parent ) ) {\n\t\t\t\tthis.markedTexts.add( node );\n\t\t\t}\n\t\t} else {\n\t\t\t// If the node has no DOM element it is not rendered yet,\n\t\t\t// its children/attributes do not need to be marked to be sync.\n\t\t\tif ( !this.domConverter.mapViewToDom( node ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( type === 'attributes' ) {\n\t\t\t\tthis.markedAttributes.add( node );\n\t\t\t} else if ( type === 'children' ) {\n\t\t\t\tthis.markedChildren.add( node );\n\t\t\t} else {\n\t\t\t\t/**\n\t\t\t\t * Unknown type passed to Renderer.markToSync.\n\t\t\t\t *\n\t\t\t\t * @error view-renderer-unknown-type\n\t\t\t\t */\n\t\t\t\tthrow new CKEditorError( 'view-renderer-unknown-type', this );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Renders all buffered changes ({@link #markedAttributes}, {@link #markedChildren} and {@link #markedTexts}) and\n\t * the current view selection (if needed) to the DOM by applying a minimal set of changes to it.\n\t *\n\t * Renderer tries not to break the text composition (e.g. IME) and x-index of the selection,\n\t * so it does as little as it is needed to update the DOM.\n\t *\n\t * Renderer also handles {@link module:engine/view/filler fillers}. Especially, it checks if the inline filler is needed\n\t * at the selection position and adds or removes it. To prevent breaking text composition inline filler will not be\n\t * removed as long as the selection is in the text node which needed it at first.\n\t */\n\trender() {\n\t\tlet inlineFillerPosition;\n\n\t\t// Refresh mappings.\n\t\tfor ( const element of this.markedChildren ) {\n\t\t\tthis._updateChildrenMappings( element );\n\t\t}\n\n\t\t// There was inline filler rendered in the DOM but it's not\n\t\t// at the selection position any more, so we can remove it\n\t\t// (cause even if it's needed, it must be placed in another location).\n\t\tif ( this._inlineFiller && !this._isSelectionInInlineFiller() ) {\n\t\t\tthis._removeInlineFiller();\n\t\t}\n\n\t\t// If we've got the filler, let's try to guess its position in the view.\n\t\tif ( this._inlineFiller ) {\n\t\t\tinlineFillerPosition = this._getInlineFillerPosition();\n\t\t}\n\t\t// Otherwise, if it's needed, create it at the selection position.\n\t\telse if ( this._needsInlineFillerAtSelection() ) {\n\t\t\tinlineFillerPosition = this.selection.getFirstPosition();\n\n\t\t\t// Do not use `markToSync` so it will be added even if the parent is already added.\n\t\t\tthis.markedChildren.add( inlineFillerPosition.parent );\n\t\t}\n\n\t\tfor ( const element of this.markedAttributes ) {\n\t\t\tthis._updateAttrs( element );\n\t\t}\n\n\t\tfor ( const element of this.markedChildren ) {\n\t\t\tthis._updateChildren( element, { inlineFillerPosition } );\n\t\t}\n\n\t\tfor ( const node of this.markedTexts ) {\n\t\t\tif ( !this.markedChildren.has( node.parent ) && this.domConverter.mapViewToDom( node.parent ) ) {\n\t\t\t\tthis._updateText( node, { inlineFillerPosition } );\n\t\t\t}\n\t\t}\n\n\t\t// Check whether the inline filler is required and where it really is in the DOM.\n\t\t// At this point in most cases it will be in the DOM, but there are exceptions.\n\t\t// For example, if the inline filler was deep in the created DOM structure, it will not be created.\n\t\t// Similarly, if it was removed at the beginning of this function and then neither text nor children were updated,\n\t\t// it will not be present.\n\t\t// Fix those and similar scenarios.\n\t\tif ( inlineFillerPosition ) {\n\t\t\tconst fillerDomPosition = this.domConverter.viewPositionToDom( inlineFillerPosition );\n\t\t\tconst domDocument = fillerDomPosition.parent.ownerDocument;\n\n\t\t\tif ( !startsWithFiller( fillerDomPosition.parent ) ) {\n\t\t\t\t// Filler has not been created at filler position. Create it now.\n\t\t\t\tthis._inlineFiller = addInlineFiller( domDocument, fillerDomPosition.parent, fillerDomPosition.offset );\n\t\t\t} else {\n\t\t\t\t// Filler has been found, save it.\n\t\t\t\tthis._inlineFiller = fillerDomPosition.parent;\n\t\t\t}\n\t\t} else {\n\t\t\t// There is no filler needed.\n\t\t\tthis._inlineFiller = null;\n\t\t}\n\n\t\t// First focus the new editing host, then update the selection.\n\t\t// Otherwise, FF may throw an error (https://github.com/ckeditor/ckeditor5/issues/721).\n\t\tthis._updateFocus();\n\t\tthis._updateSelection();\n\n\t\tthis.markedTexts.clear();\n\t\tthis.markedAttributes.clear();\n\t\tthis.markedChildren.clear();\n\t}\n\n\t/**\n\t * Updates mappings of view element's children.\n\t *\n\t * Children that were replaced in the view structure by similar elements (same tag name) are treated as 'replaced'.\n\t * This means that their mappings can be updated so the new view elements are mapped to the existing DOM elements.\n\t * Thanks to that these elements do not need to be re-rendered completely.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewElement The view element whose children mappings will be updated.\n\t */\n\t_updateChildrenMappings( viewElement ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that it was already removed from DOM and there is no need to process it.\n\t\t\treturn;\n\t\t}\n\n\t\tconst actualDomChildren = this.domConverter.mapViewToDom( viewElement ).childNodes;\n\t\tconst expectedDomChildren = Array.from(\n\t\t\tthis.domConverter.viewChildrenToDom( viewElement, domElement.ownerDocument, { withChildren: false } )\n\t\t);\n\t\tconst diff = this._diffNodeLists( actualDomChildren, expectedDomChildren );\n\t\tconst actions = this._findReplaceActions( diff, actualDomChildren, expectedDomChildren );\n\n\t\tif ( actions.indexOf( 'replace' ) !== -1 ) {\n\t\t\tconst counter = { equal: 0, insert: 0, delete: 0 };\n\n\t\t\tfor ( const action of actions ) {\n\t\t\t\tif ( action === 'replace' ) {\n\t\t\t\t\tconst insertIndex = counter.equal + counter.insert;\n\t\t\t\t\tconst deleteIndex = counter.equal + counter.delete;\n\t\t\t\t\tconst viewChild = viewElement.getChild( insertIndex );\n\n\t\t\t\t\t// UIElement and RawElement are special cases. Their children are not stored in a view (#799)\n\t\t\t\t\t// so we cannot use them with replacing flow (since they use view children during rendering\n\t\t\t\t\t// which will always result in rendering empty elements).\n\t\t\t\t\tif ( viewChild && !( viewChild.is( 'uiElement' ) || viewChild.is( 'rawElement' ) ) ) {\n\t\t\t\t\t\tthis._updateElementMappings( viewChild, actualDomChildren[ deleteIndex ] );\n\t\t\t\t\t}\n\n\t\t\t\t\tremove( expectedDomChildren[ insertIndex ] );\n\t\t\t\t\tcounter.equal++;\n\t\t\t\t} else {\n\t\t\t\t\tcounter[ action ]++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Updates mappings of a given view element.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewElement The view element whose mappings will be updated.\n\t * @param {Node} domElement The DOM element representing the given view element.\n\t */\n\t_updateElementMappings( viewElement, domElement ) {\n\t\t// Remap 'DomConverter' bindings.\n\t\tthis.domConverter.unbindDomElement( domElement );\n\t\tthis.domConverter.bindElements( domElement, viewElement );\n\n\t\t// View element may have children which needs to be updated, but are not marked, mark them to update.\n\t\tthis.markedChildren.add( viewElement );\n\n\t\t// Because we replace new view element mapping with the existing one, the corresponding DOM element\n\t\t// will not be rerendered. The new view element may have different attributes than the previous one.\n\t\t// Since its corresponding DOM element will not be rerendered, new attributes will not be added\n\t\t// to the DOM, so we need to mark it here to make sure its attributes gets updated. See #1427 for more\n\t\t// detailed case study.\n\t\t// Also there are cases where replaced element is removed from the view structure and then has\n\t\t// its attributes changed or removed. In such cases the element will not be present in `markedAttributes`\n\t\t// and also may be the same (`element.isSimilar()`) as the reused element not having its attributes updated.\n\t\t// To prevent such situations we always mark reused element to have its attributes rerenderd (#1560).\n\t\tthis.markedAttributes.add( viewElement );\n\t}\n\n\t/**\n\t * Gets the position of the inline filler based on the current selection.\n\t * Here, we assume that we know that the filler is needed and\n\t * {@link #_isSelectionInInlineFiller is at the selection position}, and, since it is needed,\n\t * it is somewhere at the selection position.\n\t *\n\t * Note: The filler position cannot be restored based on the filler's DOM text node, because\n\t * when this method is called (before rendering), the bindings will often be broken. View-to-DOM\n\t * bindings are only dependable after rendering.\n\t *\n\t * @private\n\t * @returns {module:engine/view/position~Position}\n\t */\n\t_getInlineFillerPosition() {\n\t\tconst firstPos = this.selection.getFirstPosition();\n\n\t\tif ( firstPos.parent.is( '$text' ) ) {\n\t\t\treturn ViewPosition._createBefore( this.selection.getFirstPosition().parent );\n\t\t} else {\n\t\t\treturn firstPos;\n\t\t}\n\t}\n\n\t/**\n\t * Returns `true` if the selection has not left the inline filler's text node.\n\t * If it is `true`, it means that the filler had been added for a reason and the selection did not\n\t * leave the filler's text node. For example, the user can be in the middle of a composition so it should not be touched.\n\t *\n\t * @private\n\t * @returns {Boolean} `true` if the inline filler and selection are in the same place.\n\t */\n\t_isSelectionInInlineFiller() {\n\t\tif ( this.selection.rangeCount != 1 || !this.selection.isCollapsed ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Note, we can't check if selection's position equals position of the\n\t\t// this._inlineFiller node, because of #663. We may not be able to calculate\n\t\t// the filler's position in the view at this stage.\n\t\t// Instead, we check it the other way  whether selection is anchored in\n\t\t// that text node or next to it.\n\n\t\t// Possible options are:\n\t\t// \"FILLER{}\"\n\t\t// \"FILLERadded-text{}\"\n\t\tconst selectionPosition = this.selection.getFirstPosition();\n\t\tconst position = this.domConverter.viewPositionToDom( selectionPosition );\n\n\t\tif ( position && isText( position.parent ) && startsWithFiller( position.parent ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Removes the inline filler.\n\t *\n\t * @private\n\t */\n\t_removeInlineFiller() {\n\t\tconst domFillerNode = this._inlineFiller;\n\n\t\t// Something weird happened and the stored node doesn't contain the filler's text.\n\t\tif ( !startsWithFiller( domFillerNode ) ) {\n\t\t\t/**\n\t\t\t * The inline filler node was lost. Most likely, something overwrote the filler text node\n\t\t\t * in the DOM.\n\t\t\t *\n\t\t\t * @error view-renderer-filler-was-lost\n\t\t\t */\n\t\t\tthrow new CKEditorError( 'view-renderer-filler-was-lost', this );\n\t\t}\n\n\t\tif ( isInlineFiller( domFillerNode ) ) {\n\t\t\tdomFillerNode.parentNode.removeChild( domFillerNode );\n\t\t} else {\n\t\t\tdomFillerNode.data = domFillerNode.data.substr( INLINE_FILLER_LENGTH );\n\t\t}\n\n\t\tthis._inlineFiller = null;\n\t}\n\n\t/**\n\t * Checks if the inline {@link module:engine/view/filler filler} should be added.\n\t *\n\t * @private\n\t * @returns {Boolean} `true` if the inline filler should be added.\n\t */\n\t_needsInlineFillerAtSelection() {\n\t\tif ( this.selection.rangeCount != 1 || !this.selection.isCollapsed ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst selectionPosition = this.selection.getFirstPosition();\n\t\tconst selectionParent = selectionPosition.parent;\n\t\tconst selectionOffset = selectionPosition.offset;\n\n\t\t// If there is no DOM root we do not care about fillers.\n\t\tif ( !this.domConverter.mapViewToDom( selectionParent.root ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif ( !( selectionParent.is( 'element' ) ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Prevent adding inline filler inside elements with contenteditable=false.\n\t\t// https://github.com/ckeditor/ckeditor5-engine/issues/1170\n\t\tif ( !isEditable( selectionParent ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// We have block filler, we do not need inline one.\n\t\tif ( selectionOffset === selectionParent.getFillerOffset() ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst nodeBefore = selectionPosition.nodeBefore;\n\t\tconst nodeAfter = selectionPosition.nodeAfter;\n\n\t\tif ( nodeBefore instanceof ViewText || nodeAfter instanceof ViewText ) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Checks if text needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/text~Text} viewText View text to update.\n\t * @param {Object} options\n\t * @param {module:engine/view/position~Position} options.inlineFillerPosition The position where the inline\n\t * filler should be rendered.\n\t */\n\t_updateText( viewText, options ) {\n\t\tconst domText = this.domConverter.findCorrespondingDomText( viewText );\n\t\tconst newDomText = this.domConverter.viewToDom( viewText, domText.ownerDocument );\n\n\t\tconst actualText = domText.data;\n\t\tlet expectedText = newDomText.data;\n\n\t\tconst filler = options.inlineFillerPosition;\n\n\t\tif ( filler && filler.parent == viewText.parent && filler.offset == viewText.index ) {\n\t\t\texpectedText = INLINE_FILLER + expectedText;\n\t\t}\n\n\t\tif ( actualText != expectedText ) {\n\t\t\tconst actions = fastDiff( actualText, expectedText );\n\n\t\t\tfor ( const action of actions ) {\n\t\t\t\tif ( action.type === 'insert' ) {\n\t\t\t\t\tdomText.insertData( action.index, action.values.join( '' ) );\n\t\t\t\t} else { // 'delete'\n\t\t\t\t\tdomText.deleteData( action.index, action.howMany );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if attribute list needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/element~Element} viewElement The view element to update.\n\t */\n\t_updateAttrs( viewElement ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that 'viewElement' is outdated as its mapping was updated\n\t\t\t// in 'this._updateChildrenMappings()'. There is no need to process it as new view element which\n\t\t\t// replaced old 'viewElement' mapping was also added to 'this.markedAttributes'\n\t\t\t// in 'this._updateChildrenMappings()' so it will be processed separately.\n\t\t\treturn;\n\t\t}\n\n\t\tconst domAttrKeys = Array.from( domElement.attributes ).map( attr => attr.name );\n\t\tconst viewAttrKeys = viewElement.getAttributeKeys();\n\n\t\t// Add or overwrite attributes.\n\t\tfor ( const key of viewAttrKeys ) {\n\t\t\tdomElement.setAttribute( key, viewElement.getAttribute( key ) );\n\t\t}\n\n\t\t// Remove from DOM attributes which do not exists in the view.\n\t\tfor ( const key of domAttrKeys ) {\n\t\t\tif ( !viewElement.hasAttribute( key ) ) {\n\t\t\t\tdomElement.removeAttribute( key );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if elements child list needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t * @param {module:engine/view/element~Element} viewElement View element to update.\n\t * @param {Object} options\n\t * @param {module:engine/view/position~Position} options.inlineFillerPosition The position where the inline\n\t * filler should be rendered.\n\t */\n\t_updateChildren( viewElement, options ) {\n\t\tconst domElement = this.domConverter.mapViewToDom( viewElement );\n\n\t\tif ( !domElement ) {\n\t\t\t// If there is no `domElement` it means that it was already removed from DOM.\n\t\t\t// There is no need to process it. It will be processed when re-inserted.\n\t\t\treturn;\n\t\t}\n\n\t\tconst inlineFillerPosition = options.inlineFillerPosition;\n\t\tconst actualDomChildren = this.domConverter.mapViewToDom( viewElement ).childNodes;\n\t\tconst expectedDomChildren = Array.from(\n\t\t\tthis.domConverter.viewChildrenToDom( viewElement, domElement.ownerDocument, { bind: true, inlineFillerPosition } )\n\t\t);\n\n\t\t// Inline filler element has to be created as it is present in the DOM, but not in the view. It is required\n\t\t// during diffing so text nodes could be compared correctly and also during rendering to maintain\n\t\t// proper order and indexes while updating the DOM.\n\t\tif ( inlineFillerPosition && inlineFillerPosition.parent === viewElement ) {\n\t\t\taddInlineFiller( domElement.ownerDocument, expectedDomChildren, inlineFillerPosition.offset );\n\t\t}\n\n\t\tconst diff = this._diffNodeLists( actualDomChildren, expectedDomChildren );\n\n\t\tlet i = 0;\n\t\tconst nodesToUnbind = new Set();\n\n\t\t// Handle deletions first.\n\t\t// This is to prevent a situation where an element that already exists in `actualDomChildren` is inserted at a different\n\t\t// index in `actualDomChildren`. Since `actualDomChildren` is a `NodeList`, this works like move, not like an insert,\n\t\t// and it disrupts the whole algorithm. See https://github.com/ckeditor/ckeditor5/issues/6367.\n\t\t//\n\t\t// It doesn't matter in what order we remove or add nodes, as long as we remove and add correct nodes at correct indexes.\n\t\tfor ( const action of diff ) {\n\t\t\tif ( action === 'delete' ) {\n\t\t\t\tnodesToUnbind.add( actualDomChildren[ i ] );\n\t\t\t\tremove( actualDomChildren[ i ] );\n\t\t\t} else if ( action === 'equal' ) {\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t\ti = 0;\n\n\t\tfor ( const action of diff ) {\n\t\t\tif ( action === 'insert' ) {\n\t\t\t\tinsertAt( domElement, i, expectedDomChildren[ i ] );\n\t\t\t\ti++;\n\t\t\t} else if ( action === 'equal' ) {\n\t\t\t\t// Force updating text nodes inside elements which did not change and do not need to be re-rendered (#1125).\n\t\t\t\t// Do it here (not in the loop above) because only after insertions the `i` index is correct.\n\t\t\t\tthis._markDescendantTextToSync( this.domConverter.domToView( expectedDomChildren[ i ] ) );\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t\t// Unbind removed nodes. When node does not have a parent it means that it was removed from DOM tree during\n\t\t// comparison with the expected DOM. We don't need to check child nodes, because if child node was reinserted,\n\t\t// it was moved to DOM tree out of the removed node.\n\t\tfor ( const node of nodesToUnbind ) {\n\t\t\tif ( !node.parentNode ) {\n\t\t\t\tthis.domConverter.unbindDomElement( node );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Shorthand for diffing two arrays or node lists of DOM nodes.\n\t *\n\t * @private\n\t * @param {Array.<Node>|NodeList} actualDomChildren Actual DOM children\n\t * @param {Array.<Node>|NodeList} expectedDomChildren Expected DOM children.\n\t * @returns {Array.<String>} The list of actions based on the {@link module:utils/diff~diff} function.\n\t */\n\t_diffNodeLists( actualDomChildren, expectedDomChildren ) {\n\t\tactualDomChildren = filterOutFakeSelectionContainer( actualDomChildren, this._fakeSelectionContainer );\n\n\t\treturn diff( actualDomChildren, expectedDomChildren, sameNodes.bind( null, this.domConverter ) );\n\t}\n\n\t/**\n\t * Finds DOM nodes that were replaced with the similar nodes (same tag name) in the view. All nodes are compared\n\t * within one `insert`/`delete` action group, for example:\n\t *\n\t * \t\tActual DOM:\t\t<p><b>Foo</b>Bar<i>Baz</i><b>Bax</b></p>\n\t * \t\tExpected DOM:\t<p>Bar<b>123</b><i>Baz</i><b>456</b></p>\n\t * \t\tInput actions:\t[ insert, insert, delete, delete, equal, insert, delete ]\n\t * \t\tOutput actions:\t[ insert, replace, delete, equal, replace ]\n\t *\n\t * @private\n\t * @param {Array.<String>} actions Actions array which is a result of the {@link module:utils/diff~diff} function.\n\t * @param {Array.<Node>|NodeList} actualDom Actual DOM children\n\t * @param {Array.<Node>} expectedDom Expected DOM children.\n\t * @returns {Array.<String>} Actions array modified with the `replace` actions.\n\t */\n\t_findReplaceActions( actions, actualDom, expectedDom ) {\n\t\t// If there is no both 'insert' and 'delete' actions, no need to check for replaced elements.\n\t\tif ( actions.indexOf( 'insert' ) === -1 || actions.indexOf( 'delete' ) === -1 ) {\n\t\t\treturn actions;\n\t\t}\n\n\t\tlet newActions = [];\n\t\tlet actualSlice = [];\n\t\tlet expectedSlice = [];\n\n\t\tconst counter = { equal: 0, insert: 0, delete: 0 };\n\n\t\tfor ( const action of actions ) {\n\t\t\tif ( action === 'insert' ) {\n\t\t\t\texpectedSlice.push( expectedDom[ counter.equal + counter.insert ] );\n\t\t\t} else if ( action === 'delete' ) {\n\t\t\t\tactualSlice.push( actualDom[ counter.equal + counter.delete ] );\n\t\t\t} else { // equal\n\t\t\t\tnewActions = newActions.concat( diff( actualSlice, expectedSlice, areSimilar ).map( x => x === 'equal' ? 'replace' : x ) );\n\t\t\t\tnewActions.push( 'equal' );\n\t\t\t\t// Reset stored elements on 'equal'.\n\t\t\t\tactualSlice = [];\n\t\t\t\texpectedSlice = [];\n\t\t\t}\n\t\t\tcounter[ action ]++;\n\t\t}\n\n\t\treturn newActions.concat( diff( actualSlice, expectedSlice, areSimilar ).map( x => x === 'equal' ? 'replace' : x ) );\n\t}\n\n\t/**\n\t * Marks text nodes to be synchronized.\n\t *\n\t * If a text node is passed, it will be marked. If an element is passed, all descendant text nodes inside it will be marked.\n\t *\n\t * @private\n\t * @param {module:engine/view/node~Node} viewNode View node to sync.\n\t */\n\t_markDescendantTextToSync( viewNode ) {\n\t\tif ( !viewNode ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( viewNode.is( '$text' ) ) {\n\t\t\tthis.markedTexts.add( viewNode );\n\t\t} else if ( viewNode.is( 'element' ) ) {\n\t\t\tfor ( const child of viewNode.getChildren() ) {\n\t\t\t\tthis._markDescendantTextToSync( child );\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks if the selection needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t */\n\t_updateSelection() {\n\t\t// If there is no selection - remove DOM and fake selections.\n\t\tif ( this.selection.rangeCount === 0 ) {\n\t\t\tthis._removeDomSelection();\n\t\t\tthis._removeFakeSelection();\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst domRoot = this.domConverter.mapViewToDom( this.selection.editableElement );\n\n\t\t// Do nothing if there is no focus, or there is no DOM element corresponding to selection's editable element.\n\t\tif ( !this.isFocused || !domRoot ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Render selection.\n\t\tif ( this.selection.isFake ) {\n\t\t\tthis._updateFakeSelection( domRoot );\n\t\t} else {\n\t\t\tthis._removeFakeSelection();\n\t\t\tthis._updateDomSelection( domRoot );\n\t\t}\n\t}\n\n\t/**\n\t * Updates the fake selection.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where the fake selection container should be added.\n\t */\n\t_updateFakeSelection( domRoot ) {\n\t\tconst domDocument = domRoot.ownerDocument;\n\n\t\tif ( !this._fakeSelectionContainer ) {\n\t\t\tthis._fakeSelectionContainer = createFakeSelectionContainer( domDocument );\n\t\t}\n\n\t\tconst container = this._fakeSelectionContainer;\n\n\t\t// Bind fake selection container with the current selection *position*.\n\t\tthis.domConverter.bindFakeSelection( container, this.selection );\n\n\t\tif ( !this._fakeSelectionNeedsUpdate( domRoot ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( !container.parentElement || container.parentElement != domRoot ) {\n\t\t\tdomRoot.appendChild( container );\n\t\t}\n\n\t\tcontainer.textContent = this.selection.fakeSelectionLabel || '\\u00A0';\n\n\t\tconst domSelection = domDocument.getSelection();\n\t\tconst domRange = domDocument.createRange();\n\n\t\tdomSelection.removeAllRanges();\n\t\tdomRange.selectNodeContents( container );\n\t\tdomSelection.addRange( domRange );\n\t}\n\n\t/**\n\t * Updates the DOM selection.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where the DOM selection should be rendered.\n\t */\n\t_updateDomSelection( domRoot ) {\n\t\tconst domSelection = domRoot.ownerDocument.defaultView.getSelection();\n\n\t\t// Let's check whether DOM selection needs updating at all.\n\t\tif ( !this._domSelectionNeedsUpdate( domSelection ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Multi-range selection is not available in most browsers, and, at least in Chrome, trying to\n\t\t// set such selection, that is not continuous, throws an error. Because of that, we will just use anchor\n\t\t// and focus of view selection.\n\t\t// Since we are not supporting multi-range selection, we also do not need to check if proper editable is\n\t\t// selected. If there is any editable selected, it is okay (editable is taken from selection anchor).\n\t\tconst anchor = this.domConverter.viewPositionToDom( this.selection.anchor );\n\t\tconst focus = this.domConverter.viewPositionToDom( this.selection.focus );\n\n\t\tdomSelection.collapse( anchor.parent, anchor.offset );\n\t\tdomSelection.extend( focus.parent, focus.offset );\n\n\t\t// Firefoxspecific hack (https://github.com/ckeditor/ckeditor5-engine/issues/1439).\n\t\tif ( env.isGecko ) {\n\t\t\tfixGeckoSelectionAfterBr( focus, domSelection );\n\t\t}\n\t}\n\n\t/**\n\t * Checks whether a given DOM selection needs to be updated.\n\t *\n\t * @private\n\t * @param {Selection} domSelection The DOM selection to check.\n\t * @returns {Boolean}\n\t */\n\t_domSelectionNeedsUpdate( domSelection ) {\n\t\tif ( !this.domConverter.isDomSelectionCorrect( domSelection ) ) {\n\t\t\t// Current DOM selection is in incorrect position. We need to update it.\n\t\t\treturn true;\n\t\t}\n\n\t\tconst oldViewSelection = domSelection && this.domConverter.domSelectionToView( domSelection );\n\n\t\tif ( oldViewSelection && this.selection.isEqual( oldViewSelection ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If selection is not collapsed, it does not need to be updated if it is similar.\n\t\tif ( !this.selection.isCollapsed && this.selection.isSimilar( oldViewSelection ) ) {\n\t\t\t// Selection did not changed and is correct, do not update.\n\t\t\treturn false;\n\t\t}\n\n\t\t// Selections are not similar.\n\t\treturn true;\n\t}\n\n\t/**\n\t * Checks whether the fake selection needs to be updated.\n\t *\n\t * @private\n\t * @param {HTMLElement} domRoot A valid DOM root where a new fake selection container should be added.\n\t * @returns {Boolean}\n\t */\n\t_fakeSelectionNeedsUpdate( domRoot ) {\n\t\tconst container = this._fakeSelectionContainer;\n\t\tconst domSelection = domRoot.ownerDocument.getSelection();\n\n\t\t// Fake selection needs to be updated if there's no fake selection container, or the container currently sits\n\t\t// in a different root.\n\t\tif ( !container || container.parentElement !== domRoot ) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Make sure that the selection actually is within the fake selection.\n\t\tif ( domSelection.anchorNode !== container && !container.contains( domSelection.anchorNode ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn container.textContent !== this.selection.fakeSelectionLabel;\n\t}\n\n\t/**\n\t * Removes the DOM selection.\n\t *\n\t * @private\n\t */\n\t_removeDomSelection() {\n\t\tfor ( const doc of this.domDocuments ) {\n\t\t\tconst domSelection = doc.getSelection();\n\n\t\t\tif ( domSelection.rangeCount ) {\n\t\t\t\tconst activeDomElement = doc.activeElement;\n\t\t\t\tconst viewElement = this.domConverter.mapDomToView( activeDomElement );\n\n\t\t\t\tif ( activeDomElement && viewElement ) {\n\t\t\t\t\tdoc.getSelection().removeAllRanges();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Removes the fake selection.\n\t *\n\t * @private\n\t */\n\t_removeFakeSelection() {\n\t\tconst container = this._fakeSelectionContainer;\n\n\t\tif ( container ) {\n\t\t\tcontainer.remove();\n\t\t}\n\t}\n\n\t/**\n\t * Checks if focus needs to be updated and possibly updates it.\n\t *\n\t * @private\n\t */\n\t_updateFocus() {\n\t\tif ( this.isFocused ) {\n\t\t\tconst editable = this.selection.editableElement;\n\n\t\t\tif ( editable ) {\n\t\t\t\tthis.domConverter.focus( editable );\n\t\t\t}\n\t\t}\n\t}\n}\n\nmix( Renderer, ObservableMixin );\n\n// Checks if provided element is editable.\n//\n// @private\n// @param {module:engine/view/element~Element} element\n// @returns {Boolean}\nfunction isEditable( element ) {\n\tif ( element.getAttribute( 'contenteditable' ) == 'false' ) {\n\t\treturn false;\n\t}\n\n\tconst parent = element.findAncestor( element => element.hasAttribute( 'contenteditable' ) );\n\n\treturn !parent || parent.getAttribute( 'contenteditable' ) == 'true';\n}\n\n// Adds inline filler at a given position.\n//\n// The position can be given as an array of DOM nodes and an offset in that array,\n// or a DOM parent element and an offset in that element.\n//\n// @private\n// @param {Document} domDocument\n// @param {Element|Array.<Node>} domParentOrArray\n// @param {Number} offset\n// @returns {Text} The DOM text node that contains an inline filler.\nfunction addInlineFiller( domDocument, domParentOrArray, offset ) {\n\tconst childNodes = domParentOrArray instanceof Array ? domParentOrArray : domParentOrArray.childNodes;\n\tconst nodeAfterFiller = childNodes[ offset ];\n\n\tif ( isText( nodeAfterFiller ) ) {\n\t\tnodeAfterFiller.data = INLINE_FILLER + nodeAfterFiller.data;\n\n\t\treturn nodeAfterFiller;\n\t} else {\n\t\tconst fillerNode = domDocument.createTextNode( INLINE_FILLER );\n\n\t\tif ( Array.isArray( domParentOrArray ) ) {\n\t\t\tchildNodes.splice( offset, 0, fillerNode );\n\t\t} else {\n\t\t\tinsertAt( domParentOrArray, offset, fillerNode );\n\t\t}\n\n\t\treturn fillerNode;\n\t}\n}\n\n// Whether two DOM nodes should be considered as similar.\n// Nodes are considered similar if they have the same tag name.\n//\n// @private\n// @param {Node} node1\n// @param {Node} node2\n// @returns {Boolean}\nfunction areSimilar( node1, node2 ) {\n\treturn isNode( node1 ) && isNode( node2 ) &&\n\t\t!isText( node1 ) && !isText( node2 ) &&\n\t\tnode1.nodeType !== Node.COMMENT_NODE && node2.nodeType !== Node.COMMENT_NODE &&\n\t\tnode1.tagName.toLowerCase() === node2.tagName.toLowerCase();\n}\n\n// Whether two dom nodes should be considered as the same.\n// Two nodes which are considered the same are:\n//\n//\t\t* Text nodes with the same text.\n//\t\t* Element nodes represented by the same object.\n//\t\t* Two block filler elements.\n//\n// @private\n// @param {String} blockFillerMode Block filler mode, see {@link module:engine/view/domconverter~DomConverter#blockFillerMode}.\n// @param {Node} node1\n// @param {Node} node2\n// @returns {Boolean}\nfunction sameNodes( domConverter, actualDomChild, expectedDomChild ) {\n\t// Elements.\n\tif ( actualDomChild === expectedDomChild ) {\n\t\treturn true;\n\t}\n\t// Texts.\n\telse if ( isText( actualDomChild ) && isText( expectedDomChild ) ) {\n\t\treturn actualDomChild.data === expectedDomChild.data;\n\t}\n\t// Block fillers.\n\telse if ( domConverter.isBlockFiller( actualDomChild ) &&\n\t\tdomConverter.isBlockFiller( expectedDomChild ) ) {\n\t\treturn true;\n\t}\n\n\t// Not matching types.\n\treturn false;\n}\n\n// The following is a Firefoxspecific hack (https://github.com/ckeditor/ckeditor5-engine/issues/1439).\n// When the native DOM selection is at the end of the block and preceded by <br /> e.g.\n//\n//\t\t<p>foo<br/>[]</p>\n//\n// which happens a lot when using the soft line break, the browser fails to (visually) move the\n// caret to the new line. A quick fix is as simple as forcerefreshing the selection with the same range.\nfunction fixGeckoSelectionAfterBr( focus, domSelection ) {\n\tconst parent = focus.parent;\n\n\t// This fix works only when the focus point is at the very end of an element.\n\t// There is no point in running it in cases unrelated to the browser bug.\n\tif ( parent.nodeType != Node.ELEMENT_NODE || focus.offset != parent.childNodes.length - 1 ) {\n\t\treturn;\n\t}\n\n\tconst childAtOffset = parent.childNodes[ focus.offset ];\n\n\t// To stay on the safe side, the fix being as specific as possible, it targets only the\n\t// selection which is at the very end of the element and preceded by <br />.\n\tif ( childAtOffset && childAtOffset.tagName == 'BR' ) {\n\t\tdomSelection.addRange( domSelection.getRangeAt( 0 ) );\n\t}\n}\n\nfunction filterOutFakeSelectionContainer( domChildList, fakeSelectionContainer ) {\n\tconst childList = Array.from( domChildList );\n\n\tif ( childList.length == 0 || !fakeSelectionContainer ) {\n\t\treturn childList;\n\t}\n\n\tconst last = childList[ childList.length - 1 ];\n\n\tif ( last == fakeSelectionContainer ) {\n\t\tchildList.pop();\n\t}\n\n\treturn childList;\n}\n\n// Creates a fake selection container for a given document.\n//\n// @private\n// @param {Document} domDocument\n// @returns {HTMLElement}\nfunction createFakeSelectionContainer( domDocument ) {\n\tconst container = domDocument.createElement( 'div' );\n\n\tcontainer.className = 'ck-fake-selection-container';\n\n\tObject.assign( container.style, {\n\t\tposition: 'fixed',\n\t\ttop: 0,\n\t\tleft: '-9999px',\n\t\t// See https://github.com/ckeditor/ckeditor5/issues/752.\n\t\twidth: '42px'\n\t} );\n\n\t// Fill it with a text node so we can update it later.\n\tcontainer.textContent = '\\u00A0';\n\n\treturn container;\n}\n"]}]}