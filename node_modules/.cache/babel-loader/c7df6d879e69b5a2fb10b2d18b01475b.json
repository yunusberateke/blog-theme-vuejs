{"remainingRequest":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js?{}!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-widget/src/widgettypearound/widgettypearound.js","dependencies":[{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-widget/src/widgettypearound/widgettypearound.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9zbGljZWRUb0FycmF5IGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vc2xpY2VkVG9BcnJheSI7CmltcG9ydCBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlciBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIiOwppbXBvcnQgX2NsYXNzQ2FsbENoZWNrIGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY2xhc3NDYWxsQ2hlY2siOwppbXBvcnQgX2NyZWF0ZUNsYXNzIGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlQ2xhc3MiOwppbXBvcnQgX2luaGVyaXRzIGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vaW5oZXJpdHMiOwppbXBvcnQgX2NyZWF0ZVN1cGVyIGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlU3VwZXIiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5tYXAuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmNsdWRlcy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pbmNsdWRlcy5qcyI7CgovKioKICogQGxpY2Vuc2UgQ29weXJpZ2h0IChjKSAyMDAzLTIwMjEsIENLU291cmNlIC0gRnJlZGVyaWNvIEtuYWJiZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIEZvciBsaWNlbnNpbmcsIHNlZSBMSUNFTlNFLm1kIG9yIGh0dHBzOi8vY2tlZGl0b3IuY29tL2xlZ2FsL2NrZWRpdG9yLW9zcy1saWNlbnNlCiAqLwoKLyogZ2xvYmFsIERPTVBhcnNlciAqLwoKLyoqCiAqIEBtb2R1bGUgd2lkZ2V0L3dpZGdldHR5cGVhcm91bmQKICovCmltcG9ydCBQbHVnaW4gZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS1jb3JlL3NyYy9wbHVnaW4nOwppbXBvcnQgVGVtcGxhdGUgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11aS9zcmMvdGVtcGxhdGUnOwppbXBvcnQgRW50ZXIgZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS1lbnRlci9zcmMvZW50ZXInOwppbXBvcnQgRGVsZXRlIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdHlwaW5nL3NyYy9kZWxldGUnOwppbXBvcnQgeyBpc0ZvcndhcmRBcnJvd0tleUNvZGUsIGtleUNvZGVzIH0gZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS11dGlscy9zcmMva2V5Ym9hcmQnOwppbXBvcnQgeyBpc1R5cGVBcm91bmRXaWRnZXQsIGdldENsb3Nlc3RUeXBlQXJvdW5kRG9tQnV0dG9uLCBnZXRUeXBlQXJvdW5kQnV0dG9uUG9zaXRpb24sIGdldENsb3Nlc3RXaWRnZXRWaWV3RWxlbWVudCwgZ2V0VHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uLCBUWVBFX0FST1VORF9TRUxFQ1RJT05fQVRUUklCVVRFIH0gZnJvbSAnLi91dGlscyc7CmltcG9ydCB7IGlzTm9uVHlwaW5nS2V5c3Ryb2tlIH0gZnJvbSAnQGNrZWRpdG9yL2NrZWRpdG9yNS10eXBpbmcvc3JjL3V0aWxzL2luamVjdHVuc2FmZWtleXN0cm9rZXNoYW5kbGluZyc7CmltcG9ydCB7IGlzV2lkZ2V0IH0gZnJvbSAnLi4vdXRpbHMnOwppbXBvcnQgcmV0dXJuSWNvbiBmcm9tICcuLi8uLi90aGVtZS9pY29ucy9yZXR1cm4tYXJyb3cuc3ZnJzsKaW1wb3J0ICcuLi8uLi90aGVtZS93aWRnZXR0eXBlYXJvdW5kLmNzcyc7CnZhciBQT1NTSUJMRV9JTlNFUlRJT05fUE9TSVRJT05TID0gWydiZWZvcmUnLCAnYWZ0ZXInXTsgLy8gRG8gdGhlIFNWRyBwYXJzaW5nIG9uY2UgYW5kIHRoZW4gY2xvbmUgdGhlIHJlc3VsdCA8c3ZnPiBET00gZWxlbWVudCBmb3IgZWFjaCBuZXcgYnV0dG9uLgoKdmFyIFJFVFVSTl9BUlJPV19JQ09OX0VMRU1FTlQgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHJldHVybkljb24sICdpbWFnZS9zdmcreG1sJykuZmlyc3RDaGlsZDsKdmFyIFBMVUdJTl9ESVNBQkxFRF9FRElUSU5HX1JPT1RfQ0xBU1MgPSAnY2std2lkZ2V0X190eXBlLWFyb3VuZF9kaXNhYmxlZCc7Ci8qKgogKiBBIHBsdWdpbiB0aGF0IGFsbG93cyB1c2VycyB0byB0eXBlIGFyb3VuZCB3aWRnZXRzIHdoZXJlIG5vcm1hbGx5IGl0IGlzIGltcG9zc2libGUgdG8gcGxhY2UgdGhlIGNhcmV0IGR1ZQogKiB0byBsaW1pdGF0aW9ucyBvZiB3ZWIgYnJvd3NlcnMuIFRoZXNlICJ0aWdodCBzcG90cyIgb2NjdXIsIGZvciBpbnN0YW5jZSwgYmVmb3JlIChvciBhZnRlcikgYSB3aWRnZXQgYmVpbmcKICogdGhlIGZpcnN0IChvciBsYXN0KSBjaGlsZCBvZiBpdHMgcGFyZW50IG9yIGJldHdlZW4gdHdvIGJsb2NrIHdpZGdldHMuCiAqCiAqIFRoaXMgcGx1Z2luIGV4dGVuZHMgdGhlIHtAbGluayBtb2R1bGU6d2lkZ2V0L3dpZGdldH5XaWRnZXQgYFdpZGdldGB9IHBsdWdpbiBhbmQgaW5qZWN0cyB0aGUgdXNlciBpbnRlcmZhY2UKICogd2l0aCB0d28gYnV0dG9ucyBpbnRvIGVhY2ggd2lkZ2V0IGluc3RhbmNlIGluIHRoZSBlZGl0b3IuIEVhY2ggb2YgdGhlIGJ1dHRvbnMgY2FuIGJlIGNsaWNrZWQgYnkgdGhlCiAqIHVzZXIgaWYgdGhlIHdpZGdldCBpcyBuZXh0IHRvIHRoZSAidGlnaHQgc3BvdCIuIE9uY2UgY2xpY2tlZCwgYSBwYXJhZ3JhcGggaXMgY3JlYXRlZCB3aXRoIHRoZSBzZWxlY3Rpb24gYW5jaG9yZWQKICogaW4gaXQgc28gdGhhdCB1c2VycyBjYW4gdHlwZSAob3IgaW5zZXJ0IGNvbnRlbnQsIHBhc3RlLCBldGMuKSBzdHJhaWdodCBhd2F5LgogKgogKiBAZXh0ZW5kcyBtb2R1bGU6Y29yZS9wbHVnaW5+UGx1Z2luCiAqLwoKdmFyIFdpZGdldFR5cGVBcm91bmQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9QbHVnaW4pIHsKICBfaW5oZXJpdHMoV2lkZ2V0VHlwZUFyb3VuZCwgX1BsdWdpbik7CgogIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoV2lkZ2V0VHlwZUFyb3VuZCk7CgogIC8qKgogICAqIEBpbmhlcml0RG9jCiAgICovCiAgZnVuY3Rpb24gV2lkZ2V0VHlwZUFyb3VuZChlZGl0b3IpIHsKICAgIHZhciBfdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgV2lkZ2V0VHlwZUFyb3VuZCk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBlZGl0b3IpOwogICAgLyoqCiAgICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgbW9kZWwgd2lkZ2V0IGVsZW1lbnQgdGhhdCBoYXMgdGhlIGZha2UgY2FyZXQgYWN0aXZlCiAgICAgKiBvbiBlaXRoZXIgc2lkZSBvZiBpdC4gSXQgaXMgbGF0ZXIgdXNlZCB0byByZW1vdmUgQ1NTIGNsYXNzZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBmYWtlIGNhcmV0CiAgICAgKiB3aGVuIHRoZSB3aWRnZXQgbm8gbG9uZ2VyIG5lZWRzIGl0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL21vZGVsL2VsZW1lbnR+RWxlbWVudHxudWxsfQogICAgICovCgogICAgX3RoaXMuX2N1cnJlbnRGYWtlQ2FyZXRNb2RlbEVsZW1lbnQgPSBudWxsOwogICAgcmV0dXJuIF90aGlzOwogIH0KICAvKioKICAgKiBAaW5oZXJpdERvYwogICAqLwoKCiAgX2NyZWF0ZUNsYXNzKFdpZGdldFR5cGVBcm91bmQsIFt7CiAgICBrZXk6ICJpbml0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpbml0KCkgewogICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3I7CiAgICAgIHZhciBlZGl0aW5nVmlldyA9IGVkaXRvci5lZGl0aW5nLnZpZXc7IC8vIFNldCBhIENTUyBjbGFzcyBvbiB0aGUgdmlldyBlZGl0aW5nIHJvb3Qgd2hlbiB0aGUgcGx1Z2luIGlzIGRpc2FibGVkIHNvIGFsbCB0aGUgYnV0dG9ucwogICAgICAvLyBhbmQgbGluZXMgdmlzdWFsbHkgZGlzYXBwZWFyLiBBbGwgdGhlIGludGVyYWN0aW9ucyBhcmUgZGlzYWJsZWQgaW4gaW5kaXZpZHVhbCBwbHVnaW4gbWV0aG9kcy4KCiAgICAgIHRoaXMub24oJ2NoYW5nZTppc0VuYWJsZWQnLCBmdW5jdGlvbiAoZXZ0LCBkYXRhLCBpc0VuYWJsZWQpIHsKICAgICAgICBlZGl0aW5nVmlldy5jaGFuZ2UoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgdmFyIF9pdGVyYXRvciA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKGVkaXRpbmdWaWV3LmRvY3VtZW50LnJvb3RzKSwKICAgICAgICAgICAgICBfc3RlcDsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvci5zKCk7ICEoX3N0ZXAgPSBfaXRlcmF0b3IubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciByb290ID0gX3N0ZXAudmFsdWU7CgogICAgICAgICAgICAgIGlmIChpc0VuYWJsZWQpIHsKICAgICAgICAgICAgICAgIHdyaXRlci5yZW1vdmVDbGFzcyhQTFVHSU5fRElTQUJMRURfRURJVElOR19ST09UX0NMQVNTLCByb290KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd3JpdGVyLmFkZENsYXNzKFBMVUdJTl9ESVNBQkxFRF9FRElUSU5HX1JPT1RfQ0xBU1MsIHJvb3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3IuZigpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBpZiAoIWlzRW5hYmxlZCkgewogICAgICAgICAgZWRpdG9yLm1vZGVsLmNoYW5nZShmdW5jdGlvbiAod3JpdGVyKSB7CiAgICAgICAgICAgIHdyaXRlci5yZW1vdmVTZWxlY3Rpb25BdHRyaWJ1dGUoVFlQRV9BUk9VTkRfU0VMRUNUSU9OX0FUVFJJQlVURSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgdGhpcy5fZW5hYmxlVHlwZUFyb3VuZFVJSW5qZWN0aW9uKCk7CgogICAgICB0aGlzLl9lbmFibGVJbnNlcnRpbmdQYXJhZ3JhcGhzT25CdXR0b25DbGljaygpOwoKICAgICAgdGhpcy5fZW5hYmxlSW5zZXJ0aW5nUGFyYWdyYXBoc09uRW50ZXJLZXlwcmVzcygpOwoKICAgICAgdGhpcy5fZW5hYmxlSW5zZXJ0aW5nUGFyYWdyYXBoc09uVHlwaW5nS2V5c3Ryb2tlKCk7CgogICAgICB0aGlzLl9lbmFibGVUeXBlQXJvdW5kRmFrZUNhcmV0QWN0aXZhdGlvblVzaW5nS2V5Ym9hcmRBcnJvd3MoKTsKCiAgICAgIHRoaXMuX2VuYWJsZURlbGV0ZUludGVncmF0aW9uKCk7CgogICAgICB0aGlzLl9lbmFibGVJbnNlcnRDb250ZW50SW50ZWdyYXRpb24oKTsKICAgIH0KICAgIC8qKgogICAgICogQGluaGVyaXREb2MKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJkZXN0cm95IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICB0aGlzLl9jdXJyZW50RmFrZUNhcmV0TW9kZWxFbGVtZW50ID0gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhIG5ldyBwYXJhZ3JhcGggbmV4dCB0byBhIHdpZGdldCBlbGVtZW50IHdpdGggdGhlIHNlbGVjdGlvbiBhbmNob3JlZCBpbiBpdC4KICAgICAqCiAgICAgKiAqKk5vdGUqKjogVGhpcyBtZXRob2QgaXMgaGVhdmlseSB1c2VyLW9yaWVudGVkIGFuZCB3aWxsIGJvdGggZm9jdXMgdGhlIGVkaXRpbmcgdmlldyBhbmQgc2Nyb2xsCiAgICAgKiB0aGUgdmlld3BvcnQgdG8gdGhlIHNlbGVjdGlvbiBpbiB0aGUgaW5zZXJ0ZWQgcGFyYWdyYXBoLgogICAgICoKICAgICAqIEBwcm90ZWN0ZWQKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnR9IHdpZGdldE1vZGVsRWxlbWVudCBUaGUgbW9kZWwgd2lkZ2V0IGVsZW1lbnQgbmV4dCB0byB3aGljaCBhIHBhcmFncmFwaCBpcyBpbnNlcnRlZC4KICAgICAqIEBwYXJhbSB7J2JlZm9yZSd8J2FmdGVyJ30gcG9zaXRpb24gVGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBwYXJhZ3JhcGggaXMgaW5zZXJ0ZWQuIEVpdGhlciBgJ2JlZm9yZSdgIG9yIGAnYWZ0ZXInYCB0aGUgd2lkZ2V0LgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9pbnNlcnRQYXJhZ3JhcGgiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbnNlcnRQYXJhZ3JhcGgod2lkZ2V0TW9kZWxFbGVtZW50LCBwb3NpdGlvbikgewogICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3I7CiAgICAgIHZhciBlZGl0aW5nVmlldyA9IGVkaXRvci5lZGl0aW5nLnZpZXc7CiAgICAgIGVkaXRvci5leGVjdXRlKCdpbnNlcnRQYXJhZ3JhcGgnLCB7CiAgICAgICAgcG9zaXRpb246IGVkaXRvci5tb2RlbC5jcmVhdGVQb3NpdGlvbkF0KHdpZGdldE1vZGVsRWxlbWVudCwgcG9zaXRpb24pCiAgICAgIH0pOwogICAgICBlZGl0aW5nVmlldy5mb2N1cygpOwogICAgICBlZGl0aW5nVmlldy5zY3JvbGxUb1RoZVNlbGVjdGlvbigpOwogICAgfQogICAgLyoqCiAgICAgKiBBIHdyYXBwZXIgZm9yIHRoZSB7QGxpbmsgbW9kdWxlOnV0aWxzL2VtaXR0ZXJtaXhpbn5FbWl0dGVyTWl4aW4jbGlzdGVuVG99IG1ldGhvZCB0aGF0IGV4ZWN1dGVzIHRoZSBjYWxsYmFja3Mgb25seQogICAgICogd2hlbiB0aGUgcGx1Z2luIHtAbGluayAjaXNFbmFibGVkIGlzIGVuYWJsZWR9LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTp1dGlscy9lbWl0dGVybWl4aW5+RW1pdHRlcn0gZW1pdHRlciBUaGUgb2JqZWN0IHRoYXQgZmlyZXMgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBuYW1lIG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnM9e31dIEFkZGl0aW9uYWwgb3B0aW9ucy4KICAgICAqIEBwYXJhbSB7bW9kdWxlOnV0aWxzL3ByaW9yaXRpZXN+UHJpb3JpdHlTdHJpbmd8TnVtYmVyfSBbb3B0aW9ucy5wcmlvcml0eT0nbm9ybWFsJ10gVGhlIHByaW9yaXR5IG9mIHRoaXMgZXZlbnQgY2FsbGJhY2suIFRoZSBoaWdoZXIKICAgICAqIHRoZSBwcmlvcml0eSB2YWx1ZSB0aGUgc29vbmVyIHRoZSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkLiBFdmVudHMgaGF2aW5nIHRoZSBzYW1lIHByaW9yaXR5IGFyZSBjYWxsZWQgaW4gdGhlCiAgICAgKiBvcmRlciB0aGV5IHdlcmUgYWRkZWQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2xpc3RlblRvSWZFbmFibGVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbGlzdGVuVG9JZkVuYWJsZWQoZW1pdHRlciwgZXZlbnQsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdGhpcy5saXN0ZW5UbyhlbWl0dGVyLCBldmVudCwgZnVuY3Rpb24gKCkgewogICAgICAgIC8vIERvIG5vdCByZXNwb25kIGlmIHRoZSBwbHVnaW4gaXMgZGlzYWJsZWQuCiAgICAgICAgaWYgKF90aGlzMi5pc0VuYWJsZWQpIHsKICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHZvaWQgMCwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgIH0sIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBTaW1pbGFyIHRvIHtAbGluayAjX2luc2VydFBhcmFncmFwaH0sIHRoaXMgbWV0aG9kIGluc2VydHMgYSBwYXJhZ3JhcGggZXhjZXB0IHRoYXQgaXQKICAgICAqIGRvZXMgbm90IGV4cGVjdCBhIHBvc2l0aW9uLiBJbnN0ZWFkLCBpdCBwZXJmb3JtcyB0aGUgaW5zZXJ0aW9uIG5leHQgdG8gYSBzZWxlY3RlZCB3aWRnZXQKICAgICAqIGFjY29yZGluZyB0byB0aGUgYHdpZGdldC10eXBlLWFyb3VuZGAgbW9kZWwgc2VsZWN0aW9uIGF0dHJpYnV0ZSB2YWx1ZSAoZmFrZSBjYXJldCBwb3NpdGlvbikuCiAgICAgKgogICAgICogQmVjYXVzZSB0aGlzIG1ldGhvZCByZXF1aXJlcyB0aGUgYHdpZGdldC10eXBlLWFyb3VuZGAgYXR0cmlidXRlIHRvIGJlIHNldCwKICAgICAqIHRoZSBpbnNlcnRpb24gY2FuIG9ubHkgaGFwcGVuIHdoZW4gdGhlIHdpZGdldCdzIGZha2UgY2FyZXQgaXMgYWN0aXZlIChlLmcuIGFjdGl2YXRlZAogICAgICogdXNpbmcgdGhlIGtleWJvYXJkKS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHJldHVybnMge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIHdoZW4gdGhlIHBhcmFncmFwaCB3YXMgaW5zZXJ0ZWQgKHRoZSBhdHRyaWJ1dGUgd2FzIHByZXNlbnQpIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfaW5zZXJ0UGFyYWdyYXBoQWNjb3JkaW5nVG9GYWtlQ2FyZXRQb3NpdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2luc2VydFBhcmFncmFwaEFjY29yZGluZ1RvRmFrZUNhcmV0UG9zaXRpb24oKSB7CiAgICAgIHZhciBlZGl0b3IgPSB0aGlzLmVkaXRvcjsKICAgICAgdmFyIG1vZGVsID0gZWRpdG9yLm1vZGVsOwogICAgICB2YXIgbW9kZWxTZWxlY3Rpb24gPSBtb2RlbC5kb2N1bWVudC5zZWxlY3Rpb247CiAgICAgIHZhciB0eXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24gPSBnZXRUeXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24obW9kZWxTZWxlY3Rpb24pOwoKICAgICAgaWYgKCF0eXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciBzZWxlY3RlZE1vZGVsRWxlbWVudCA9IG1vZGVsU2VsZWN0aW9uLmdldFNlbGVjdGVkRWxlbWVudCgpOwoKICAgICAgdGhpcy5faW5zZXJ0UGFyYWdyYXBoKHNlbGVjdGVkTW9kZWxFbGVtZW50LCB0eXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24pOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBsaXN0ZW5lciBpbiB0aGUgZWRpdGluZyBjb252ZXJzaW9uIHBpcGVsaW5lIHRoYXQgaW5qZWN0cyB0aGUgd2lkZ2V0IHR5cGUgYXJvdW5kCiAgICAgKiBVSSBpbnRvIGV2ZXJ5IHNpbmdsZSB3aWRnZXQgaW5zdGFuY2UgY3JlYXRlZCBpbiB0aGUgZWRpdG9yLgogICAgICoKICAgICAqIFRoZSBVSSBpcyBkZWxpdmVyZWQgYXMgYSB7QGxpbmsgbW9kdWxlOmVuZ2luZS92aWV3L3VpZWxlbWVudH5VSUVsZW1lbnR9CiAgICAgKiB3cmFwcGVyIHdoaWNoIHJlbmRlcnMgRE9NIGJ1dHRvbnMgdGhhdCB1c2VycyBjYW4gdXNlIHRvIGluc2VydCBwYXJhZ3JhcGhzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2VuYWJsZVR5cGVBcm91bmRVSUluamVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2VuYWJsZVR5cGVBcm91bmRVSUluamVjdGlvbigpIHsKICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yOwogICAgICB2YXIgc2NoZW1hID0gZWRpdG9yLm1vZGVsLnNjaGVtYTsKICAgICAgdmFyIHQgPSBlZGl0b3IubG9jYWxlLnQ7CiAgICAgIHZhciBidXR0b25UaXRsZXMgPSB7CiAgICAgICAgYmVmb3JlOiB0KCdJbnNlcnQgcGFyYWdyYXBoIGJlZm9yZSBibG9jaycpLAogICAgICAgIGFmdGVyOiB0KCdJbnNlcnQgcGFyYWdyYXBoIGFmdGVyIGJsb2NrJykKICAgICAgfTsKICAgICAgZWRpdG9yLmVkaXRpbmcuZG93bmNhc3REaXNwYXRjaGVyLm9uKCdpbnNlcnQnLCBmdW5jdGlvbiAoZXZ0LCBkYXRhLCBjb252ZXJzaW9uQXBpKSB7CiAgICAgICAgdmFyIHZpZXdFbGVtZW50ID0gY29udmVyc2lvbkFwaS5tYXBwZXIudG9WaWV3RWxlbWVudChkYXRhLml0ZW0pOyAvLyBGaWx0ZXIgb3V0IG5vbi13aWRnZXRzIGFuZCBpbmxpbmUgd2lkZ2V0cy4KCiAgICAgICAgaWYgKGlzVHlwZUFyb3VuZFdpZGdldCh2aWV3RWxlbWVudCwgZGF0YS5pdGVtLCBzY2hlbWEpKSB7CiAgICAgICAgICBpbmplY3RVSUludG9XaWRnZXQoY29udmVyc2lvbkFwaS53cml0ZXIsIGJ1dHRvblRpdGxlcywgdmlld0VsZW1lbnQpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHByaW9yaXR5OiAnbG93JwogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogQnJpbmdzIHN1cHBvcnQgZm9yIHRoZSBmYWtlIGNhcmV0IHRoYXQgYXBwZWFycyB3aGVuIGVpdGhlcjoKICAgICAqCiAgICAgKiAqIHRoZSBzZWxlY3Rpb24gbW92ZXMgdG8gYSB3aWRnZXQgZnJvbSBhIHBvc2l0aW9uIG5leHQgdG8gaXQgdXNpbmcgYXJyb3cga2V5cywKICAgICAqICogdGhlIGFycm93IGtleSBpcyBwcmVzc2VkIHdoZW4gdGhlIHdpZGdldCBpcyBhbHJlYWR5IHNlbGVjdGVkLgogICAgICoKICAgICAqIFRoZSBmYWtlIGNhcmV0IGxldHMgdGhlIHVzZXIga25vdyB0aGF0IHRoZXkgY2FuIHN0YXJ0IHR5cGluZyBvciBqdXN0IHByZXNzCiAgICAgKiA8a2JkPkVudGVyPC9rYmQ+IHRvIGluc2VydCBhIHBhcmFncmFwaCBhdCB0aGUgcG9zaXRpb24gbmV4dCB0byBhIHdpZGdldCBhcyBzdWdnZXN0ZWQgYnkgdGhlIGZha2UgY2FyZXQuCiAgICAgKgogICAgICogVGhlIGZha2UgY2FyZXQgZGlzYXBwZWFycyB3aGVuIHRoZSB1c2VyIGNoYW5nZXMgdGhlIHNlbGVjdGlvbiBvciB0aGUgZWRpdG9yCiAgICAgKiBnZXRzIGJsdXJyZWQuCiAgICAgKgogICAgICogVGhlIHdob2xlIGlkZWEgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAxLiBBIHVzZXIgZG9lcyBvbmUgb2YgdGhlIDIgc2NlbmFyaW9zIGRlc2NyaWJlZCBhdCB0aGUgYmVnaW5uaW5nLgogICAgICogMi4gVGhlICJrZXlkb3duIiBsaXN0ZW5lciBpcyBleGVjdXRlZCBhbmQgdGhlIGRlY2lzaW9uIGlzIG1hZGUgd2hldGhlciB0byBzaG93IG9yIGhpZGUgdGhlIGZha2UgY2FyZXQuCiAgICAgKiAzLiBJZiBpdCBzaG91bGQgc2hvdyB1cCwgdGhlIGB3aWRnZXQtdHlwZS1hcm91bmRgIG1vZGVsIHNlbGVjdGlvbiBhdHRyaWJ1dGUgaXMgc2V0IGluZGljYXRpbmcKICAgICAqICAgIG9uIHdoaWNoIHNpZGUgb2YgdGhlIHdpZGdldCBpdCBzaG91bGQgYXBwZWFyLgogICAgICogNC4gVGhlIHNlbGVjdGlvbiBkaXNwYXRjaGVyIHJlYWN0cyB0byB0aGUgc2VsZWN0aW9uIGF0dHJpYnV0ZSBhbmQgc2V0cyBDU1MgY2xhc3NlcyByZXNwb25zaWJsZSBmb3IgdGhlCiAgICAgKiAgICBmYWtlIGNhcmV0IG9uIHRoZSB2aWV3IHdpZGdldC4KICAgICAqIDUuIElmIHRoZSBmYWtlIGNhcmV0IHNob3VsZCBkaXNhcHBlYXIsIHRoZSBzZWxlY3Rpb24gYXR0cmlidXRlIGlzIHJlbW92ZWQgYW5kIHRoZSBkaXNwYXRjaGVyCiAgICAgKiAgICBkb2VzIHRoZSBDU1MgY2xhc3MgY2xlYW4tdXAgaW4gdGhlIHZpZXcuCiAgICAgKiA2LiBBZGRpdGlvbmFsbHksIGBjaGFuZ2U6cmFuZ2VgIGFuZCBgRm9jdXNUcmFja2VyI2lzRm9jdXNlZGAgbGlzdGVuZXJzIGFsc28gcmVtb3ZlIHRoZSBzZWxlY3Rpb24KICAgICAqICAgIGF0dHJpYnV0ZSAodGhlIGZvcm1lciBhbHNvIHJlbW92ZXMgd2lkZ2V0IENTUyBjbGFzc2VzKS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9lbmFibGVUeXBlQXJvdW5kRmFrZUNhcmV0QWN0aXZhdGlvblVzaW5nS2V5Ym9hcmRBcnJvd3MiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9lbmFibGVUeXBlQXJvdW5kRmFrZUNhcmV0QWN0aXZhdGlvblVzaW5nS2V5Ym9hcmRBcnJvd3MoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yOwogICAgICB2YXIgbW9kZWwgPSBlZGl0b3IubW9kZWw7CiAgICAgIHZhciBtb2RlbFNlbGVjdGlvbiA9IG1vZGVsLmRvY3VtZW50LnNlbGVjdGlvbjsKICAgICAgdmFyIHNjaGVtYSA9IG1vZGVsLnNjaGVtYTsKICAgICAgdmFyIGVkaXRpbmdWaWV3ID0gZWRpdG9yLmVkaXRpbmcudmlldzsgLy8gVGhpcyBpcyB0aGUgbWFpbiBsaXN0ZW5lciByZXNwb25zaWJsZSBmb3IgdGhlIGZha2UgY2FyZXQuCiAgICAgIC8vIE5vdGU6IFRoZSBwcmlvcml0eSBtdXN0IHByZWNlZGUgdGhlIGRlZmF1bHQgV2lkZ2V0IGNsYXNzIGtleWRvd24gaGFuZGxlciAoImhpZ2giKS4KCiAgICAgIHRoaXMuX2xpc3RlblRvSWZFbmFibGVkKGVkaXRpbmdWaWV3LmRvY3VtZW50LCAnYXJyb3dLZXknLCBmdW5jdGlvbiAoZXZ0LCBkb21FdmVudERhdGEpIHsKICAgICAgICBfdGhpczMuX2hhbmRsZUFycm93S2V5UHJlc3MoZXZ0LCBkb21FdmVudERhdGEpOwogICAgICB9LCB7CiAgICAgICAgY29udGV4dDogW2lzV2lkZ2V0LCAnJHRleHQnXSwKICAgICAgICBwcmlvcml0eTogJ2hpZ2gnCiAgICAgIH0pOyAvLyBUaGlzIGxpc3RlbmVyIG1ha2VzIHN1cmUgdGhlIHdpZGdldCB0eXBlIGFyb3VuZCBzZWxlY3Rpb24gYXR0cmlidXRlIHdpbGwgYmUgZ29uZSBmcm9tIHRoZSBtb2RlbAogICAgICAvLyBzZWxlY3Rpb24gYXMgc29vbiBhcyB0aGUgbW9kZWwgcmFuZ2UgY2hhbmdlcy4gVGhpcyBhdHRyaWJ1dGUgb25seSBtYWtlcyBzZW5zZSB3aGVuIGEgd2lkZ2V0IGlzIHNlbGVjdGVkCiAgICAgIC8vIChhbmQgdGhlICJmYWtlIGhvcml6b250YWwgY2FyZXQiIGlzIHZpc2libGUpIHNvIHdoZW5ldmVyIHRoZSByYW5nZSBjaGFuZ2VzIChlLmcuIHNlbGVjdGlvbiBtb3ZlZCBzb21ld2hlcmUgZWxzZSksCiAgICAgIC8vIGxldCdzIGdldCByaWQgb2YgdGhlIGF0dHJpYnV0ZSBzbyB0aGF0IHRoZSBzZWxlY3Rpb24gZG93bmNhc3QgZGlzcGF0Y2hlciBpc24ndCBldmVuIGJvdGhlcmVkLgoKCiAgICAgIHRoaXMuX2xpc3RlblRvSWZFbmFibGVkKG1vZGVsU2VsZWN0aW9uLCAnY2hhbmdlOnJhbmdlJywgZnVuY3Rpb24gKGV2dCwgZGF0YSkgewogICAgICAgIC8vIERvIG5vdCByZXNldCB0aGUgc2VsZWN0aW9uIGF0dHJpYnV0ZSB3aGVuIHRoZSBjaGFuZ2Ugd2FzIGluZGlyZWN0LgogICAgICAgIGlmICghZGF0YS5kaXJlY3RDaGFuZ2UpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IC8vIEdldCByaWQgb2YgdGhlIHdpZGdldCB0eXBlIGFyb3VuZCBhdHRyaWJ1dGUgb2YgdGhlIHNlbGVjdGlvbiBvbiBldmVyeSBjaGFuZ2U6cmFuZ2UuCiAgICAgICAgLy8gSWYgdGhlIHJhbmdlIGNoYW5nZXMsIGl0IG1lYW5zIGZvciBzdXJlLCB0aGUgdXNlciBpcyBubyBsb25nZXIgaW4gdGhlIGFjdGl2ZSAoImZha2UgaG9yaXpvbnRhbCBjYXJldCIpIG1vZGUuCgoKICAgICAgICBlZGl0b3IubW9kZWwuY2hhbmdlKGZ1bmN0aW9uICh3cml0ZXIpIHsKICAgICAgICAgIHdyaXRlci5yZW1vdmVTZWxlY3Rpb25BdHRyaWJ1dGUoVFlQRV9BUk9VTkRfU0VMRUNUSU9OX0FUVFJJQlVURSk7CiAgICAgICAgfSk7CiAgICAgIH0pOyAvLyBHZXQgcmlkIG9mIHRoZSB3aWRnZXQgdHlwZSBhcm91bmQgYXR0cmlidXRlIG9mIHRoZSBzZWxlY3Rpb24gb24gZXZlcnkgZG9jdW1lbnQgY2hhbmdlCiAgICAgIC8vIHRoYXQgbWFrZXMgd2lkZ2V0IG5vdCBzZWxlY3RlZCBhbnkgbW9yZSAoaS5lLiB3aWRnZXQgd2FzIHJlbW92ZWQpLgoKCiAgICAgIHRoaXMuX2xpc3RlblRvSWZFbmFibGVkKG1vZGVsLmRvY3VtZW50LCAnY2hhbmdlOmRhdGEnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkTW9kZWxFbGVtZW50ID0gbW9kZWxTZWxlY3Rpb24uZ2V0U2VsZWN0ZWRFbGVtZW50KCk7CgogICAgICAgIGlmIChzZWxlY3RlZE1vZGVsRWxlbWVudCkgewogICAgICAgICAgdmFyIHNlbGVjdGVkVmlld0VsZW1lbnQgPSBlZGl0b3IuZWRpdGluZy5tYXBwZXIudG9WaWV3RWxlbWVudChzZWxlY3RlZE1vZGVsRWxlbWVudCk7CgogICAgICAgICAgaWYgKGlzVHlwZUFyb3VuZFdpZGdldChzZWxlY3RlZFZpZXdFbGVtZW50LCBzZWxlY3RlZE1vZGVsRWxlbWVudCwgc2NoZW1hKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBlZGl0b3IubW9kZWwuY2hhbmdlKGZ1bmN0aW9uICh3cml0ZXIpIHsKICAgICAgICAgIHdyaXRlci5yZW1vdmVTZWxlY3Rpb25BdHRyaWJ1dGUoVFlQRV9BUk9VTkRfU0VMRUNUSU9OX0FUVFJJQlVURSk7CiAgICAgICAgfSk7CiAgICAgIH0pOyAvLyBSZWFjdCB0byBjaGFuZ2VzIG9mIHRoZSBtb2RlbCBzZWxlY3Rpb24gYXR0cmlidXRlIG1hZGUgYnkgdGhlIGFycm93IGtleXMgbGlzdGVuZXIuCiAgICAgIC8vIElmIHRoZSBibG9jayB3aWRnZXQgaXMgc2VsZWN0ZWQgYW5kIHRoZSBhdHRyaWJ1dGUgY2hhbmdlcywgZG93bmNhc3QgdGhlIGF0dHJpYnV0ZSB0byBzcGVjaWFsCiAgICAgIC8vIENTUyBjbGFzc2VzIGFzc29jaWF0ZWQgd2l0aCB0aGUgYWN0aXZlICgiZmFrZSBob3Jpem9udGFsIGNhcmV0IikgbW9kZSBvZiB0aGUgd2lkZ2V0LgoKCiAgICAgIHRoaXMuX2xpc3RlblRvSWZFbmFibGVkKGVkaXRvci5lZGl0aW5nLmRvd25jYXN0RGlzcGF0Y2hlciwgJ3NlbGVjdGlvbicsIGZ1bmN0aW9uIChldnQsIGRhdGEsIGNvbnZlcnNpb25BcGkpIHsKICAgICAgICB2YXIgd3JpdGVyID0gY29udmVyc2lvbkFwaS53cml0ZXI7CgogICAgICAgIGlmIChfdGhpczMuX2N1cnJlbnRGYWtlQ2FyZXRNb2RlbEVsZW1lbnQpIHsKICAgICAgICAgIHZhciBfc2VsZWN0ZWRWaWV3RWxlbWVudCA9IGNvbnZlcnNpb25BcGkubWFwcGVyLnRvVmlld0VsZW1lbnQoX3RoaXMzLl9jdXJyZW50RmFrZUNhcmV0TW9kZWxFbGVtZW50KTsKCiAgICAgICAgICBpZiAoX3NlbGVjdGVkVmlld0VsZW1lbnQpIHsKICAgICAgICAgICAgLy8gR2V0IHJpZCBvZiBDU1MgY2xhc3NlcyBhc3NvY2lhdGVkIHdpdGggdGhlIGFjdGl2ZSAoImZha2UgaG9yaXpvbnRhbCBjYXJldCIpIG1vZGUgZnJvbSB0aGUgdmlldyB3aWRnZXQuCiAgICAgICAgICAgIHdyaXRlci5yZW1vdmVDbGFzcyhQT1NTSUJMRV9JTlNFUlRJT05fUE9TSVRJT05TLm1hcChwb3NpdGlvblRvV2lkZ2V0Q3NzQ2xhc3MpLCBfc2VsZWN0ZWRWaWV3RWxlbWVudCk7CiAgICAgICAgICAgIF90aGlzMy5fY3VycmVudEZha2VDYXJldE1vZGVsRWxlbWVudCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgc2VsZWN0ZWRNb2RlbEVsZW1lbnQgPSBkYXRhLnNlbGVjdGlvbi5nZXRTZWxlY3RlZEVsZW1lbnQoKTsKCiAgICAgICAgaWYgKCFzZWxlY3RlZE1vZGVsRWxlbWVudCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlbGVjdGVkVmlld0VsZW1lbnQgPSBjb252ZXJzaW9uQXBpLm1hcHBlci50b1ZpZXdFbGVtZW50KHNlbGVjdGVkTW9kZWxFbGVtZW50KTsKCiAgICAgICAgaWYgKCFpc1R5cGVBcm91bmRXaWRnZXQoc2VsZWN0ZWRWaWV3RWxlbWVudCwgc2VsZWN0ZWRNb2RlbEVsZW1lbnQsIHNjaGVtYSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB0eXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24gPSBnZXRUeXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24oZGF0YS5zZWxlY3Rpb24pOwoKICAgICAgICBpZiAoIXR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgd3JpdGVyLmFkZENsYXNzKHBvc2l0aW9uVG9XaWRnZXRDc3NDbGFzcyh0eXBlQXJvdW5kRmFrZUNhcmV0UG9zaXRpb24pLCBzZWxlY3RlZFZpZXdFbGVtZW50KTsgLy8gUmVtZW1iZXIgdGhlIHZpZXcgd2lkZ2V0IHRoYXQgZ290IHRoZSAiZmFrZS1jYXJldCIgQ1NTIGNsYXNzLiBUaGlzIGNsYXNzIHNob3VsZCBiZSByZW1vdmVkIEFTQVAgd2hlbiB0aGUKICAgICAgICAvLyBzZWxlY3Rpb24gY2hhbmdlcwoKICAgICAgICBfdGhpczMuX2N1cnJlbnRGYWtlQ2FyZXRNb2RlbEVsZW1lbnQgPSBzZWxlY3RlZE1vZGVsRWxlbWVudDsKICAgICAgfSk7CgogICAgICB0aGlzLl9saXN0ZW5Ub0lmRW5hYmxlZChlZGl0b3IudWkuZm9jdXNUcmFja2VyLCAnY2hhbmdlOmlzRm9jdXNlZCcsIGZ1bmN0aW9uIChldnQsIG5hbWUsIGlzRm9jdXNlZCkgewogICAgICAgIGlmICghaXNGb2N1c2VkKSB7CiAgICAgICAgICBlZGl0b3IubW9kZWwuY2hhbmdlKGZ1bmN0aW9uICh3cml0ZXIpIHsKICAgICAgICAgICAgd3JpdGVyLnJlbW92ZVNlbGVjdGlvbkF0dHJpYnV0ZShUWVBFX0FST1VORF9TRUxFQ1RJT05fQVRUUklCVVRFKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBmdW5jdGlvbiBwb3NpdGlvblRvV2lkZ2V0Q3NzQ2xhc3MocG9zaXRpb24pIHsKICAgICAgICByZXR1cm4gImNrLXdpZGdldF90eXBlLWFyb3VuZF9zaG93LWZha2UtY2FyZXRfIi5jb25jYXQocG9zaXRpb24pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEEgbGlzdGVuZXIgZXhlY3V0ZWQgb24gZWFjaCAia2V5ZG93biIgaW4gdGhlIHZpZXcgZG9jdW1lbnQsIGEgcGFydCBvZgogICAgICoge0BsaW5rICNfZW5hYmxlVHlwZUFyb3VuZEZha2VDYXJldEFjdGl2YXRpb25Vc2luZ0tleWJvYXJkQXJyb3dzfS4KICAgICAqCiAgICAgKiBJdCBkZWNpZGVzIHdoZXRoZXIgdGhlIGFycm93IGtleXByZXNzIHNob3VsZCBhY3RpdmF0ZSB0aGUgZmFrZSBjYXJldCBvciBub3QgKGFsc28gd2hldGhlciBpdCBzaG91bGQKICAgICAqIGJlIGRlYWN0aXZhdGVkKS4KICAgICAqCiAgICAgKiBUaGUgZmFrZSBjYXJldCBhY3RpdmF0aW9uIGlzIGRvbmUgYnkgc2V0dGluZyB0aGUgYHdpZGdldC10eXBlLWFyb3VuZGAgbW9kZWwgc2VsZWN0aW9uIGF0dHJpYnV0ZQogICAgICogaW4gdGhpcyBsaXN0ZW5lciwgYW5kIHN0b3BwaW5nIGFuZCBwcmV2ZW50aW5nIHRoZSBldmVudCB0aGF0IHdvdWxkIG5vcm1hbGx5IGJlIGhhbmRsZWQgYnkgdGhlIHdpZGdldAogICAgICogcGx1Z2luIHRoYXQgaXMgcmVzcG9uc2libGUgZm9yIHRoZSByZWd1bGFyIGtleWJvYXJkIG5hdmlnYXRpb24gbmVhci9hY3Jvc3MgYWxsIHdpZGdldHMgKHRoYXQKICAgICAqIGluY2x1ZGVzIGlubGluZSB3aWRnZXRzLCB3aGljaCBhcmUgaWdub3JlZCBieSB0aGUgd2lkZ2V0IHR5cGUgYXJvdW5kIHBsdWdpbikuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfaGFuZGxlQXJyb3dLZXlQcmVzcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2hhbmRsZUFycm93S2V5UHJlc3MoZXZ0LCBkb21FdmVudERhdGEpIHsKICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yOwogICAgICB2YXIgbW9kZWwgPSBlZGl0b3IubW9kZWw7CiAgICAgIHZhciBtb2RlbFNlbGVjdGlvbiA9IG1vZGVsLmRvY3VtZW50LnNlbGVjdGlvbjsKICAgICAgdmFyIHNjaGVtYSA9IG1vZGVsLnNjaGVtYTsKICAgICAgdmFyIGVkaXRpbmdWaWV3ID0gZWRpdG9yLmVkaXRpbmcudmlldzsKICAgICAgdmFyIGtleUNvZGUgPSBkb21FdmVudERhdGEua2V5Q29kZTsKICAgICAgdmFyIGlzRm9yd2FyZCA9IGlzRm9yd2FyZEFycm93S2V5Q29kZShrZXlDb2RlLCBlZGl0b3IubG9jYWxlLmNvbnRlbnRMYW5ndWFnZURpcmVjdGlvbik7CiAgICAgIHZhciBzZWxlY3RlZFZpZXdFbGVtZW50ID0gZWRpdGluZ1ZpZXcuZG9jdW1lbnQuc2VsZWN0aW9uLmdldFNlbGVjdGVkRWxlbWVudCgpOwogICAgICB2YXIgc2VsZWN0ZWRNb2RlbEVsZW1lbnQgPSBlZGl0b3IuZWRpdGluZy5tYXBwZXIudG9Nb2RlbEVsZW1lbnQoc2VsZWN0ZWRWaWV3RWxlbWVudCk7CiAgICAgIHZhciBzaG91bGRTdG9wQW5kUHJldmVudERlZmF1bHQ7IC8vIEhhbmRsZSBrZXlib2FyZCBuYXZpZ2F0aW9uIHdoZW4gYSB0eXBlLWFyb3VuZC1jb21wYXRpYmxlIHdpZGdldCBpcyBjdXJyZW50bHkgc2VsZWN0ZWQuCgogICAgICBpZiAoaXNUeXBlQXJvdW5kV2lkZ2V0KHNlbGVjdGVkVmlld0VsZW1lbnQsIHNlbGVjdGVkTW9kZWxFbGVtZW50LCBzY2hlbWEpKSB7CiAgICAgICAgc2hvdWxkU3RvcEFuZFByZXZlbnREZWZhdWx0ID0gdGhpcy5faGFuZGxlQXJyb3dLZXlQcmVzc09uU2VsZWN0ZWRXaWRnZXQoaXNGb3J3YXJkKTsKICAgICAgfSAvLyBIYW5kbGUga2V5Ym9hcmQgYXJyb3cgbmF2aWdhdGlvbiB3aGVuIHRoZSBzZWxlY3Rpb24gaXMgbmV4dCB0byBhIHR5cGUtYXJvdW5kLWNvbXBhdGlibGUgd2lkZ2V0CiAgICAgIC8vIGFuZCB0aGUgd2lkZ2V0IGlzIGFib3V0IHRvIGJlIHNlbGVjdGVkLgogICAgICBlbHNlIGlmIChtb2RlbFNlbGVjdGlvbi5pc0NvbGxhcHNlZCkgewogICAgICAgICAgc2hvdWxkU3RvcEFuZFByZXZlbnREZWZhdWx0ID0gdGhpcy5faGFuZGxlQXJyb3dLZXlQcmVzc1doZW5TZWxlY3Rpb25OZXh0VG9BV2lkZ2V0KGlzRm9yd2FyZCk7CiAgICAgICAgfQoKICAgICAgaWYgKHNob3VsZFN0b3BBbmRQcmV2ZW50RGVmYXVsdCkgewogICAgICAgIGRvbUV2ZW50RGF0YS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGV2dC5zdG9wKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogSGFuZGxlcyB0aGUga2V5Ym9hcmQgbmF2aWdhdGlvbiBvbiAia2V5ZG93biIgd2hlbiBhIHdpZGdldCBpcyBjdXJyZW50bHkgc2VsZWN0ZWQgYW5kIGFjdGl2YXRlcyBvciBkZWFjdGl2YXRlcwogICAgICogdGhlIGZha2UgY2FyZXQgZm9yIHRoYXQgd2lkZ2V0LCBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGB3aWRnZXQtdHlwZS1hcm91bmRgIG1vZGVsCiAgICAgKiBzZWxlY3Rpb24gYXR0cmlidXRlIGFuZCB0aGUgZGlyZWN0aW9uIG9mIHRoZSBwcmVzc2VkIGFycm93IGtleS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtCb29sZWFufSBpc0ZvcndhcmQgYHRydWVgIHdoZW4gdGhlIHByZXNzZWQgYXJyb3cga2V5IHdhcyByZXNwb25zaWJsZSBmb3IgdGhlIGZvcndhcmQgbW9kZWwgc2VsZWN0aW9uIG1vdmVtZW50CiAgICAgKiBhcyBpbiB7QGxpbmsgbW9kdWxlOnV0aWxzL2tleWJvYXJkfmlzRm9yd2FyZEFycm93S2V5Q29kZX0uCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgd2hlbiB0aGUga2V5cHJlc3Mgd2FzIGhhbmRsZWQgYW5kIG5vIG90aGVyIGtleWRvd24gbGlzdGVuZXIgb2YgdGhlIGVkaXRvciBzaG91bGQKICAgICAqIHByb2Nlc3MgdGhlIGV2ZW50IGFueSBmdXJ0aGVyLiBSZXR1cm5zIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9oYW5kbGVBcnJvd0tleVByZXNzT25TZWxlY3RlZFdpZGdldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2hhbmRsZUFycm93S2V5UHJlc3NPblNlbGVjdGVkV2lkZ2V0KGlzRm9yd2FyZCkgewogICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3I7CiAgICAgIHZhciBtb2RlbCA9IGVkaXRvci5tb2RlbDsKICAgICAgdmFyIG1vZGVsU2VsZWN0aW9uID0gbW9kZWwuZG9jdW1lbnQuc2VsZWN0aW9uOwogICAgICB2YXIgdHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uID0gZ2V0VHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uKG1vZGVsU2VsZWN0aW9uKTsKICAgICAgcmV0dXJuIG1vZGVsLmNoYW5nZShmdW5jdGlvbiAod3JpdGVyKSB7CiAgICAgICAgLy8gSWYgdGhlIGZha2UgY2FyZXQgaXMgZGlzcGxheWVkLi4uCiAgICAgICAgaWYgKHR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbikgewogICAgICAgICAgdmFyIGlzTGVhdmluZ1dpZGdldCA9IHR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbiA9PT0gKGlzRm9yd2FyZCA/ICdhZnRlcicgOiAnYmVmb3JlJyk7IC8vIElmIHRoZSBrZXlib2FyZCBhcnJvdyB3b3JrcyBhZ2FpbnN0IHRoZSB2YWx1ZSBvZiB0aGUgc2VsZWN0aW9uIGF0dHJpYnV0ZS4uLgogICAgICAgICAgLy8gdGhlbiByZW1vdmUgdGhlIHNlbGVjdGlvbiBhdHRyaWJ1dGUgYnV0IHByZXZlbnQgZGVmYXVsdCBET00gYWN0aW9ucwogICAgICAgICAgLy8gYW5kIGRvIG5vdCBsZXQgdGhlIFdpZGdldCBwbHVnaW4gbGlzdGVuZXIgbW92ZSB0aGUgc2VsZWN0aW9uLiBUaGlzIGJyaW5ncwogICAgICAgICAgLy8gdGhlIHdpZGdldCBiYWNrIHRvIHRoZSBzdGF0ZSwgZm9yIGluc3RhbmNlLCBsaWtlIGlmIHdhcyBzZWxlY3RlZCB1c2luZyB0aGUgbW91c2UuCiAgICAgICAgICAvLwogICAgICAgICAgLy8gKipOb3RlKio6IElmIGxlYXZpbmcgdGhlIHdpZGdldCB3aGVuIHRoZSBmYWtlIGNhcmV0IGlzIGFjdGl2ZSwgdGhlbiB0aGUgZGVmYXVsdAogICAgICAgICAgLy8gV2lkZ2V0IGhhbmRsZXIgd2lsbCBjaGFuZ2UgdGhlIHNlbGVjdGlvbiBhbmQsIGluIHR1cm4sIHRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IGRpc2NhcmQKICAgICAgICAgIC8vIHRoZSBzZWxlY3Rpb24gYXR0cmlidXRlLgoKICAgICAgICAgIGlmICghaXNMZWF2aW5nV2lkZ2V0KSB7CiAgICAgICAgICAgIHdyaXRlci5yZW1vdmVTZWxlY3Rpb25BdHRyaWJ1dGUoVFlQRV9BUk9VTkRfU0VMRUNUSU9OX0FUVFJJQlVURSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0gLy8gSWYgdGhlIGZha2UgY2FyZXQgd2Fzbid0IGRpc3BsYXllZCwgbGV0J3Mgc2V0IGl0IG5vdyBhY2NvcmRpbmcgdG8gdGhlIGRpcmVjdGlvbiBvZiB0aGUgYXJyb3cKICAgICAgICAvLyBrZXkgcHJlc3MuIFRoaXMgYWxzbyBtZWFucyB3ZSBjYW5ub3QgbGV0IHRoZSBXaWRnZXQgcGx1Z2luIGxpc3RlbmVyIG1vdmUgdGhlIHNlbGVjdGlvbi4KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgd3JpdGVyLnNldFNlbGVjdGlvbkF0dHJpYnV0ZShUWVBFX0FST1VORF9TRUxFQ1RJT05fQVRUUklCVVRFLCBpc0ZvcndhcmQgPyAnYWZ0ZXInIDogJ2JlZm9yZScpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogSGFuZGxlcyB0aGUga2V5Ym9hcmQgbmF2aWdhdGlvbiBvbiAia2V5ZG93biIgd2hlbiAqKm5vKiogd2lkZ2V0IGlzIHNlbGVjdGVkIGJ1dCB0aGUgc2VsZWN0aW9uIGlzICoqZGlyZWN0bHkqKiBuZXh0CiAgICAgKiB0byBvbmUgYW5kIHVwb24gdGhlIGZha2UgY2FyZXQgc2hvdWxkIGJlY29tZSBhY3RpdmUgZm9yIHRoaXMgd2lkZ2V0IHVwb24gYXJyb3cga2V5cHJlc3MKICAgICAqIChBS0EgZW50ZXJpbmcvc2VsZWN0aW5nIHRoZSB3aWRnZXQpLgogICAgICoKICAgICAqICoqTm90ZSoqOiBUaGlzIGNvZGUgbWlycm9ycyB0aGUgaW1wbGVtZW50YXRpb24gZnJvbSB0aGUgd2lkZ2V0IHBsdWdpbiBidXQgYWxzbyBhZGRzIHRoZSBzZWxlY3Rpb24gYXR0cmlidXRlLgogICAgICogVW5mb3J0dW5hdGVseSwgdGhlcmUgaXMgbm8gc2FmZSB3YXkgdG8gbGV0IHRoZSB3aWRnZXQgcGx1Z2luIGRvIHRoZSBzZWxlY3Rpb24gcGFydCBmaXJzdCBhbmQgdGhlbiBqdXN0IHNldCB0aGUKICAgICAqIHNlbGVjdGlvbiBhdHRyaWJ1dGUgaGVyZSBpbiB0aGUgd2lkZ2V0IHR5cGUgYXJvdW5kIHBsdWdpbi4gVGhpcyBpcyB3aHkgdGhpcyBjb2RlIG11c3QgZHVwbGljYXRlIHNvbWUgZnJvbSB0aGUgd2lkZ2V0IHBsdWdpbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtCb29sZWFufSBpc0ZvcndhcmQgYHRydWVgIHdoZW4gdGhlIHByZXNzZWQgYXJyb3cga2V5IHdhcyByZXNwb25zaWJsZSBmb3IgdGhlIGZvcndhcmQgbW9kZWwgc2VsZWN0aW9uIG1vdmVtZW50CiAgICAgKiBhcyBpbiB7QGxpbmsgbW9kdWxlOnV0aWxzL2tleWJvYXJkfmlzRm9yd2FyZEFycm93S2V5Q29kZX0uCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgd2hlbiB0aGUga2V5cHJlc3Mgd2FzIGhhbmRsZWQgYW5kIG5vIG90aGVyIGtleWRvd24gbGlzdGVuZXIgb2YgdGhlIGVkaXRvciBzaG91bGQKICAgICAqIHByb2Nlc3MgdGhlIGV2ZW50IGFueSBmdXJ0aGVyLiBSZXR1cm5zIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9oYW5kbGVBcnJvd0tleVByZXNzV2hlblNlbGVjdGlvbk5leHRUb0FXaWRnZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9oYW5kbGVBcnJvd0tleVByZXNzV2hlblNlbGVjdGlvbk5leHRUb0FXaWRnZXQoaXNGb3J3YXJkKSB7CiAgICAgIHZhciBlZGl0b3IgPSB0aGlzLmVkaXRvcjsKICAgICAgdmFyIG1vZGVsID0gZWRpdG9yLm1vZGVsOwogICAgICB2YXIgc2NoZW1hID0gbW9kZWwuc2NoZW1hOwogICAgICB2YXIgd2lkZ2V0UGx1Z2luID0gZWRpdG9yLnBsdWdpbnMuZ2V0KCdXaWRnZXQnKTsgLy8gVGhpcyBpcyB0aGUgd2lkZ2V0IHRoZSBzZWxlY3Rpb24gaXMgYWJvdXQgdG8gYmUgc2V0IG9uLgoKICAgICAgdmFyIG1vZGVsRWxlbWVudE5leHRUb1NlbGVjdGlvbiA9IHdpZGdldFBsdWdpbi5fZ2V0T2JqZWN0RWxlbWVudE5leHRUb1NlbGVjdGlvbihpc0ZvcndhcmQpOwoKICAgICAgdmFyIHZpZXdFbGVtZW50TmV4dFRvU2VsZWN0aW9uID0gZWRpdG9yLmVkaXRpbmcubWFwcGVyLnRvVmlld0VsZW1lbnQobW9kZWxFbGVtZW50TmV4dFRvU2VsZWN0aW9uKTsKCiAgICAgIGlmIChpc1R5cGVBcm91bmRXaWRnZXQodmlld0VsZW1lbnROZXh0VG9TZWxlY3Rpb24sIG1vZGVsRWxlbWVudE5leHRUb1NlbGVjdGlvbiwgc2NoZW1hKSkgewogICAgICAgIG1vZGVsLmNoYW5nZShmdW5jdGlvbiAod3JpdGVyKSB7CiAgICAgICAgICB3aWRnZXRQbHVnaW4uX3NldFNlbGVjdGlvbk92ZXJFbGVtZW50KG1vZGVsRWxlbWVudE5leHRUb1NlbGVjdGlvbik7CgogICAgICAgICAgd3JpdGVyLnNldFNlbGVjdGlvbkF0dHJpYnV0ZShUWVBFX0FST1VORF9TRUxFQ1RJT05fQVRUUklCVVRFLCBpc0ZvcndhcmQgPyAnYmVmb3JlJyA6ICdhZnRlcicpOwogICAgICAgIH0pOyAvLyBUaGUgY2hhbmdlKCkgYmxvY2sgYWJvdmUgZG9lcyB0aGUgc2FtZSBqb2IgYXMgdGhlIFdpZGdldCBwbHVnaW4uIFRoZSBldmVudCBjYW4KICAgICAgICAvLyBiZSBzYWZlbHkgY2FuY2VsZWQuCgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIFJlZ2lzdGVycyBhIGBtb3VzZWRvd25gIGxpc3RlbmVyIGZvciB0aGUgdmlldyBkb2N1bWVudCB3aGljaCBpbnRlcmNlcHRzIGV2ZW50cwogICAgICogY29taW5nIGZyb20gdGhlIHdpZGdldCB0eXBlIGFyb3VuZCBVSSwgd2hpY2ggaGFwcGVucyB3aGVuIGEgdXNlciBjbGlja3Mgb25lIG9mIHRoZSBidXR0b25zCiAgICAgKiB0aGF0IGluc2VydCBhIHBhcmFncmFwaCBuZXh0IHRvIGEgd2lkZ2V0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2VuYWJsZUluc2VydGluZ1BhcmFncmFwaHNPbkJ1dHRvbkNsaWNrIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZW5hYmxlSW5zZXJ0aW5nUGFyYWdyYXBoc09uQnV0dG9uQ2xpY2soKSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yOwogICAgICB2YXIgZWRpdGluZ1ZpZXcgPSBlZGl0b3IuZWRpdGluZy52aWV3OwoKICAgICAgdGhpcy5fbGlzdGVuVG9JZkVuYWJsZWQoZWRpdGluZ1ZpZXcuZG9jdW1lbnQsICdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZXZ0LCBkb21FdmVudERhdGEpIHsKICAgICAgICB2YXIgYnV0dG9uID0gZ2V0Q2xvc2VzdFR5cGVBcm91bmREb21CdXR0b24oZG9tRXZlbnREYXRhLmRvbVRhcmdldCk7CgogICAgICAgIGlmICghYnV0dG9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgYnV0dG9uUG9zaXRpb24gPSBnZXRUeXBlQXJvdW5kQnV0dG9uUG9zaXRpb24oYnV0dG9uKTsKICAgICAgICB2YXIgd2lkZ2V0Vmlld0VsZW1lbnQgPSBnZXRDbG9zZXN0V2lkZ2V0Vmlld0VsZW1lbnQoYnV0dG9uLCBlZGl0aW5nVmlldy5kb21Db252ZXJ0ZXIpOwogICAgICAgIHZhciB3aWRnZXRNb2RlbEVsZW1lbnQgPSBlZGl0b3IuZWRpdGluZy5tYXBwZXIudG9Nb2RlbEVsZW1lbnQod2lkZ2V0Vmlld0VsZW1lbnQpOwoKICAgICAgICBfdGhpczQuX2luc2VydFBhcmFncmFwaCh3aWRnZXRNb2RlbEVsZW1lbnQsIGJ1dHRvblBvc2l0aW9uKTsKCiAgICAgICAgZG9tRXZlbnREYXRhLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZ0LnN0b3AoKTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZXMgdGhlIDxrYmQ+RW50ZXI8L2tiZD4ga2V5IGxpc3RlbmVyIG9uIHRoZSB2aWV3IGRvY3VtZW50IHRoYXQgYWxsb3dzIHRoZSB1c2VyIHRvIGluc2VydCBhIHBhcmFncmFwaAogICAgICogbmVhciB0aGUgd2lkZ2V0IHdoZW4gZWl0aGVyOgogICAgICoKICAgICAqICogVGhlIGZha2UgY2FyZXQgd2FzIGZpcnN0IGFjdGl2YXRlZCB1c2luZyB0aGUgYXJyb3cga2V5cywKICAgICAqICogVGhlIGVudGlyZSB3aWRnZXQgaXMgc2VsZWN0ZWQgaW4gdGhlIG1vZGVsLgogICAgICoKICAgICAqIEluIHRoZSBmaXJzdCBjYXNlLCB0aGUgbmV3IHBhcmFncmFwaCBpcyBpbnNlcnRlZCBhY2NvcmRpbmcgdG8gdGhlIGB3aWRnZXQtdHlwZS1hcm91bmRgIHNlbGVjdGlvbgogICAgICogYXR0cmlidXRlIChzZWUge0BsaW5rICNfaGFuZGxlQXJyb3dLZXlQcmVzc30pLgogICAgICoKICAgICAqIEluIHRoZSBzZWNvbmQgY2FzZSwgdGhlIG5ldyBwYXJhZ3JhcGggaXMgaW5zZXJ0ZWQgYmFzZWQgb24gd2hldGhlciBhIHNvZnQgKDxrYmQ+U2hpZnQ8L2tiZD4rPGtiZD5FbnRlcjwva2JkPikga2V5c3Ryb2tlCiAgICAgKiB3YXMgcHJlc3NlZCBvciBub3QuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZW5hYmxlSW5zZXJ0aW5nUGFyYWdyYXBoc09uRW50ZXJLZXlwcmVzcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2VuYWJsZUluc2VydGluZ1BhcmFncmFwaHNPbkVudGVyS2V5cHJlc3MoKSB7CiAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yOwogICAgICB2YXIgc2VsZWN0aW9uID0gZWRpdG9yLm1vZGVsLmRvY3VtZW50LnNlbGVjdGlvbjsKICAgICAgdmFyIGVkaXRpbmdWaWV3ID0gZWRpdG9yLmVkaXRpbmcudmlldzsKCiAgICAgIHRoaXMuX2xpc3RlblRvSWZFbmFibGVkKGVkaXRpbmdWaWV3LmRvY3VtZW50LCAnZW50ZXInLCBmdW5jdGlvbiAoZXZ0LCBkb21FdmVudERhdGEpIHsKICAgICAgICAvLyBUaGlzIGV2ZW50IGNvdWxkIGJlIHRyaWdnZXJlZCBmcm9tIGluc2lkZSB0aGUgd2lkZ2V0IGJ1dCB3ZSBhcmUgaW50ZXJlc3RlZAogICAgICAgIC8vIG9ubHkgd2hlbiB0aGUgd2lkZ2V0IGlzIHNlbGVjdGVkIGl0c2VsZi4KICAgICAgICBpZiAoZXZ0LmV2ZW50UGhhc2UgIT0gJ2F0VGFyZ2V0JykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlbGVjdGVkTW9kZWxFbGVtZW50ID0gc2VsZWN0aW9uLmdldFNlbGVjdGVkRWxlbWVudCgpOwogICAgICAgIHZhciBzZWxlY3RlZFZpZXdFbGVtZW50ID0gZWRpdG9yLmVkaXRpbmcubWFwcGVyLnRvVmlld0VsZW1lbnQoc2VsZWN0ZWRNb2RlbEVsZW1lbnQpOwogICAgICAgIHZhciBzY2hlbWEgPSBlZGl0b3IubW9kZWwuc2NoZW1hOwogICAgICAgIHZhciB3YXNIYW5kbGVkOyAvLyBGaXJzdCBjaGVjayBpZiB0aGUgd2lkZ2V0IGlzIHNlbGVjdGVkIGFuZCB0aGVyZSdzIGEgdHlwZSBhcm91bmQgc2VsZWN0aW9uIGF0dHJpYnV0ZSBhc3NvY2lhdGVkCiAgICAgICAgLy8gd2l0aCB0aGUgZmFrZSBjYXJldCB0aGF0IHdvdWxkIHRlbGwgd2hlcmUgdG8gaW5zZXJ0IGEgbmV3IHBhcmFncmFwaC4KCiAgICAgICAgaWYgKF90aGlzNS5faW5zZXJ0UGFyYWdyYXBoQWNjb3JkaW5nVG9GYWtlQ2FyZXRQb3NpdGlvbigpKSB7CiAgICAgICAgICB3YXNIYW5kbGVkID0gdHJ1ZTsKICAgICAgICB9IC8vIFRoZW4sIGlmIHRoZXJlIGlzIG5vIHNlbGVjdGlvbiBhdHRyaWJ1dGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBmYWtlIGNhcmV0LCBjaGVjayBpZiB0aGUgd2lkZ2V0CiAgICAgICAgLy8gc2ltcGx5IGlzIHNlbGVjdGVkIGFuZCBjcmVhdGUgYSBuZXcgcGFyYWdyYXBoIGFjY29yZGluZyB0byB0aGUga2V5c3Ryb2tlIChTaGlmdCspRW50ZXIuCiAgICAgICAgZWxzZSBpZiAoaXNUeXBlQXJvdW5kV2lkZ2V0KHNlbGVjdGVkVmlld0VsZW1lbnQsIHNlbGVjdGVkTW9kZWxFbGVtZW50LCBzY2hlbWEpKSB7CiAgICAgICAgICAgIF90aGlzNS5faW5zZXJ0UGFyYWdyYXBoKHNlbGVjdGVkTW9kZWxFbGVtZW50LCBkb21FdmVudERhdGEuaXNTb2Z0ID8gJ2JlZm9yZScgOiAnYWZ0ZXInKTsKCiAgICAgICAgICAgIHdhc0hhbmRsZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICBpZiAod2FzSGFuZGxlZCkgewogICAgICAgICAgZG9tRXZlbnREYXRhLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICBldnQuc3RvcCgpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGNvbnRleHQ6IGlzV2lkZ2V0CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgKiBTaW1pbGFyIHRvIHRoZSB7QGxpbmsgI19lbmFibGVJbnNlcnRpbmdQYXJhZ3JhcGhzT25FbnRlcktleXByZXNzfSwgaXQgYWxsb3dzIHRoZSB1c2VyCiAgICAgKiB0byBpbnNlcnQgYSBwYXJhZ3JhcGggbmV4dCB0byBhIHdpZGdldCB3aGVuIHRoZSBmYWtlIGNhcmV0IHdhcyBhY3RpdmF0ZWQgdXNpbmcgYXJyb3cKICAgICAqIGtleXMgYnV0IGl0IHJlc3BvbmRzIHRvIHR5cGluZyBrZXlzdHJva2VzIGluc3RlYWQgb2YgPGtiZD5FbnRlcjwva2JkPi4KICAgICAqCiAgICAgKiAiVHlwaW5nIGtleXN0cm9rZXMiIGFyZSBrZXlzdHJva2VzIHRoYXQgaW5zZXJ0IG5ldyBjb250ZW50IGludG8gdGhlIGRvY3VtZW50LAogICAgICogZm9yIGluc3RhbmNlLCBsZXR0ZXJzICgiYSIpIG9yIG51bWJlcnMgKCI0IikuIFRoZSAia2V5ZG93biIgbGlzdGVuZXIgZW5hYmxlZCBieSB0aGlzIG1ldGhvZAogICAgICogd2lsbCBpbnNlcnQgYSBuZXcgcGFyYWdyYXBoIGFjY29yZGluZyB0byB0aGUgYHdpZGdldC10eXBlLWFyb3VuZGAgbW9kZWwgc2VsZWN0aW9uIGF0dHJpYnV0ZQogICAgICogYXMgdGhlIHVzZXIgc2ltcGx5IHN0YXJ0cyB0eXBpbmcsIHdoaWNoIGNyZWF0ZXMgdGhlIGltcHJlc3Npb24gdGhhdCB0aGUgZmFrZSBjYXJldAogICAgICogYmVoYXZlcyBsaWtlIGEgcmVhbCBvbmUgcmVuZGVyZWQgYnkgdGhlIGJyb3dzZXIgKEFLQSB5b3VyIHRleHQgYXBwZWFycyB3aGVyZSB0aGUgY2FyZXQgd2FzKS4KICAgICAqCiAgICAgKiAqKk5vdGUqKjogQXQgdGhlIG1vbWVudCB0aGlzIGxpc3RlbmVyIGNyZWF0ZXMgMiB1bmRvIHN0ZXBzOiBvbmUgZm9yIHRoZSBgaW5zZXJ0UGFyYWdyYXBoYCBjb21tYW5kCiAgICAgKiBhbmQgYW5vdGhlciBvbmUgZm9yIGFjdHVhbCB0eXBpbmcuIEl0IGlzIG5vdCBhIGRpc2FzdGVyIGJ1dCB0aGlzIG1heSBuZWVkIHRvIGJlIGZpeGVkCiAgICAgKiBzb29uZXIgb3IgbGF0ZXIuCiAgICAgKgogICAgICogTGVhcm4gbW9yZSBpbiB7QGxpbmsgbW9kdWxlOnR5cGluZy91dGlscy9pbmplY3R1bnNhZmVrZXlzdHJva2VzaGFuZGxpbmd9LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2VuYWJsZUluc2VydGluZ1BhcmFncmFwaHNPblR5cGluZ0tleXN0cm9rZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2VuYWJsZUluc2VydGluZ1BhcmFncmFwaHNPblR5cGluZ0tleXN0cm9rZSgpIHsKICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3I7CiAgICAgIHZhciBlZGl0aW5nVmlldyA9IGVkaXRvci5lZGl0aW5nLnZpZXc7CiAgICAgIHZhciBrZXlDb2Rlc0hhbmRsZWRTb21ld2hlcmVFbHNlID0gW2tleUNvZGVzLmVudGVyLCBrZXlDb2Rlcy5kZWxldGUsIGtleUNvZGVzLmJhY2tzcGFjZV07IC8vIE5vdGU6IFRoZSBwcmlvcml0eSBtdXN0IHByZWNlZGUgdGhlIGRlZmF1bHQgb2JzZXJ2ZXJzLgoKICAgICAgdGhpcy5fbGlzdGVuVG9JZkVuYWJsZWQoZWRpdGluZ1ZpZXcuZG9jdW1lbnQsICdrZXlkb3duJywgZnVuY3Rpb24gKGV2dCwgZG9tRXZlbnREYXRhKSB7CiAgICAgICAgLy8gRG9uJ3QgaGFuZGxlIGVudGVyL2JhY2tzcGFjZS9kZWxldGUgaGVyZS4gVGhleSBhcmUgaGFuZGxlZCBpbiBkZWRpY2F0ZWQgbGlzdGVuZXJzLgogICAgICAgIGlmICgha2V5Q29kZXNIYW5kbGVkU29tZXdoZXJlRWxzZS5pbmNsdWRlcyhkb21FdmVudERhdGEua2V5Q29kZSkgJiYgIWlzTm9uVHlwaW5nS2V5c3Ryb2tlKGRvbUV2ZW50RGF0YSkpIHsKICAgICAgICAgIF90aGlzNi5faW5zZXJ0UGFyYWdyYXBoQWNjb3JkaW5nVG9GYWtlQ2FyZXRQb3NpdGlvbigpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHByaW9yaXR5OiAnaGlnaCcKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIEl0IGNyZWF0ZXMgYSAiZGVsZXRlIiBldmVudCBsaXN0ZW5lciBvbiB0aGUgdmlldyBkb2N1bWVudCB0byBoYW5kbGUgY2FzZXMgd2hlbiB0aGUgPGtiZD5EZWxldGU8L2tiZD4gb3IgPGtiZD5CYWNrc3BhY2U8L2tiZD4KICAgICAqIGlzIHByZXNzZWQgYW5kIHRoZSBmYWtlIGNhcmV0IGlzIGN1cnJlbnRseSBhY3RpdmUuCiAgICAgKgogICAgICogVGhlIGZha2UgY2FyZXQgc2hvdWxkIGNyZWF0ZSBhbiBpbGx1c2lvbiBvZiBhIHJlYWwgYnJvd3NlciBjYXJldCBzbyB0aGF0IHdoZW4gaXQgYXBwZWFycyBiZWZvcmUgb3IgYWZ0ZXIKICAgICAqIGEgd2lkZ2V0LCBwcmVzc2luZyA8a2JkPkRlbGV0ZTwva2JkPiBvciA8a2JkPkJhY2tzcGFjZTwva2JkPiBzaG91bGQgcmVtb3ZlIGEgd2lkZ2V0IG9yIGRlbGV0ZSB0aGUgY29udGVudAogICAgICogYmVmb3JlIG9yIGFmdGVyIGEgd2lkZ2V0IChkZXBlbmRpbmcgb24gdGhlIGNvbnRlbnQgc3Vycm91bmRpbmcgdGhlIHdpZGdldCkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfZW5hYmxlRGVsZXRlSW50ZWdyYXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9lbmFibGVEZWxldGVJbnRlZ3JhdGlvbigpIHsKICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yOwogICAgICB2YXIgZWRpdGluZ1ZpZXcgPSBlZGl0b3IuZWRpdGluZy52aWV3OwogICAgICB2YXIgbW9kZWwgPSBlZGl0b3IubW9kZWw7CiAgICAgIHZhciBzY2hlbWEgPSBtb2RlbC5zY2hlbWE7CgogICAgICB0aGlzLl9saXN0ZW5Ub0lmRW5hYmxlZChlZGl0aW5nVmlldy5kb2N1bWVudCwgJ2RlbGV0ZScsIGZ1bmN0aW9uIChldnQsIGRvbUV2ZW50RGF0YSkgewogICAgICAgIC8vIFRoaXMgZXZlbnQgY291bGQgYmUgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHRoZSB3aWRnZXQgYnV0IHdlIGFyZSBpbnRlcmVzdGVkCiAgICAgICAgLy8gb25seSB3aGVuIHRoZSB3aWRnZXQgaXMgc2VsZWN0ZWQgaXRzZWxmLgogICAgICAgIGlmIChldnQuZXZlbnRQaGFzZSAhPSAnYXRUYXJnZXQnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uID0gZ2V0VHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uKG1vZGVsLmRvY3VtZW50LnNlbGVjdGlvbik7IC8vIFRoaXMgbGlzdGVuZXIgaGFuZGxlcyBvbmx5IHRoZXNlIGNhc2VzIHdoZW4gdGhlIGZha2UgY2FyZXQgaXMgYWN0aXZlLgoKICAgICAgICBpZiAoIXR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IGRvbUV2ZW50RGF0YS5kaXJlY3Rpb247CiAgICAgICAgdmFyIHNlbGVjdGVkTW9kZWxXaWRnZXQgPSBtb2RlbC5kb2N1bWVudC5zZWxlY3Rpb24uZ2V0U2VsZWN0ZWRFbGVtZW50KCk7CiAgICAgICAgdmFyIGlzRmFrZUNhcmV0QmVmb3JlID0gdHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uID09PSAnYmVmb3JlJzsKICAgICAgICB2YXIgaXNEZWxldGVGb3J3YXJkID0gZGlyZWN0aW9uID09ICdmb3J3YXJkJzsKICAgICAgICB2YXIgc2hvdWxkRGVsZXRlRW50aXJlV2lkZ2V0ID0gaXNGYWtlQ2FyZXRCZWZvcmUgPT09IGlzRGVsZXRlRm9yd2FyZDsKCiAgICAgICAgaWYgKHNob3VsZERlbGV0ZUVudGlyZVdpZGdldCkgewogICAgICAgICAgZWRpdG9yLmV4ZWN1dGUoJ2RlbGV0ZScsIHsKICAgICAgICAgICAgc2VsZWN0aW9uOiBtb2RlbC5jcmVhdGVTZWxlY3Rpb24oc2VsZWN0ZWRNb2RlbFdpZGdldCwgJ29uJykKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcmFuZ2UgPSBzY2hlbWEuZ2V0TmVhcmVzdFNlbGVjdGlvblJhbmdlKG1vZGVsLmNyZWF0ZVBvc2l0aW9uQXQoc2VsZWN0ZWRNb2RlbFdpZGdldCwgdHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uKSwgZGlyZWN0aW9uKTsgLy8gSWYgdGhlcmUgaXMgc29tZXdoZXJlIHRvIG1vdmUgc2VsZWN0aW9uIHRvLCB0aGVuIHRoZXJlIHdpbGwgYmUgc29tZXRoaW5nIHRvIGRlbGV0ZS4KCiAgICAgICAgICBpZiAocmFuZ2UpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHJhbmdlIGlzIE5PVCBjb2xsYXBzZWQsIHRoZW4gd2Uga25vdyB0aGF0IHRoZSByYW5nZSBjb250YWlucyBhbiBvYmplY3QgKHNlZSBnZXROZWFyZXN0U2VsZWN0aW9uUmFuZ2UoKSBkb2NzKS4KICAgICAgICAgICAgaWYgKCFyYW5nZS5pc0NvbGxhcHNlZCkgewogICAgICAgICAgICAgIG1vZGVsLmNoYW5nZShmdW5jdGlvbiAod3JpdGVyKSB7CiAgICAgICAgICAgICAgICB3cml0ZXIuc2V0U2VsZWN0aW9uKHJhbmdlKTsKICAgICAgICAgICAgICAgIGVkaXRvci5leGVjdXRlKGlzRGVsZXRlRm9yd2FyZCA/ICdkZWxldGVGb3J3YXJkJyA6ICdkZWxldGUnKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcHJvYmUgPSBtb2RlbC5jcmVhdGVTZWxlY3Rpb24ocmFuZ2Uuc3RhcnQpOwogICAgICAgICAgICAgIG1vZGVsLm1vZGlmeVNlbGVjdGlvbihwcm9iZSwgewogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiBkaXJlY3Rpb24KICAgICAgICAgICAgICB9KTsgLy8gSWYgdGhlIHJhbmdlIGlzIGNvbGxhcHNlZCwgbGV0J3Mgc2VlIGlmIGEgbm9uLWNvbGxhcHNlZCByYW5nZSBleGlzdHMgdGhhdCBjYW4gY291bGQgYmUgZGVsZXRlZC4KICAgICAgICAgICAgICAvLyBJZiBzdWNoIHJhbmdlIGV4aXN0cywgdXNlIHRoZSBlZGl0b3IgY29tbWFuZCBiZWNhdXNlIGl0IGl0IHNhZmUgZm9yIGNvbGxhYm9yYXRpb24gKGl0IG1lcmdlcyB3aGVyZSBpdCBjYW4pLgoKICAgICAgICAgICAgICBpZiAoIXByb2JlLmZvY3VzLmlzRXF1YWwocmFuZ2Uuc3RhcnQpKSB7CiAgICAgICAgICAgICAgICBtb2RlbC5jaGFuZ2UoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgICAgICAgICB3cml0ZXIuc2V0U2VsZWN0aW9uKHJhbmdlKTsKICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWN1dGUoaXNEZWxldGVGb3J3YXJkID8gJ2RlbGV0ZUZvcndhcmQnIDogJ2RlbGV0ZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSAvLyBJZiB0aGVyZSBpcyBubyBub24tY29sbGFwc2VkIHJhbmdlIHRvIGJlIGRlbGV0ZWQgdGhlbiB3ZSBhcmUgc3VyZSB0aGF0IHRoZXJlIGlzIGFuIGVtcHR5IGVsZW1lbnQKICAgICAgICAgICAgICAvLyBuZXh0IHRvIGEgd2lkZ2V0IHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuICJkZWxldGUiIGFuZCAiZGVsZXRlRm9yd2FyZCIgY29tbWFuZHMgY2Fubm90IGdldCByaWQgb2YgaXQKICAgICAgICAgICAgICAvLyBzbyBjYWxsaW5nIE1vZGVsI2RlbGV0ZUNvbnRlbnQgaGVyZSBtYW51YWxseS4KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlZXBlc3RFbXB0eVJhbmdlQW5jZXN0b3IgPSBnZXREZWVwZXN0RW1wdHlFbGVtZW50QW5jZXN0b3Ioc2NoZW1hLCByYW5nZS5zdGFydC5wYXJlbnQpOwogICAgICAgICAgICAgICAgICBtb2RlbC5kZWxldGVDb250ZW50KG1vZGVsLmNyZWF0ZVNlbGVjdGlvbihkZWVwZXN0RW1wdHlSYW5nZUFuY2VzdG9yLCAnb24nKSwgewogICAgICAgICAgICAgICAgICAgIGRvTm90QXV0b3BhcmFncmFwaDogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gLy8gSWYgc29tZSBjb250ZW50IHdhcyBkZWxldGVkLCBkb24ndCBsZXQgdGhlIGhhbmRsZXIgZnJvbSB0aGUgV2lkZ2V0IHBsdWdpbiBraWNrIGluLgogICAgICAgIC8vIElmIG5vdGhpbmcgd2FzIGRlbGV0ZWQsIHRoZW4gdGhlIGRlZmF1bHQgaGFuZGxlciB3aWxsIGhhdmUgbm90aGluZyB0byBkbyBhbnl3YXkuCgoKICAgICAgICBkb21FdmVudERhdGEucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldnQuc3RvcCgpOwogICAgICB9LCB7CiAgICAgICAgY29udGV4dDogaXNXaWRnZXQKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIEF0dGFjaGVzIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9tb2RlbH5Nb2RlbCNldmVudDppbnNlcnRDb250ZW50fSBldmVudCBsaXN0ZW5lciB0aGF0LCBmb3IgaW5zdGFuY2UsIGFsbG93cyB0aGUgdXNlciB0byBwYXN0ZQogICAgICogY29udGVudCBuZWFyIGEgd2lkZ2V0IHdoZW4gdGhlIGZha2UgY2FyZXQgaXMgZmlyc3QgYWN0aXZhdGVkIHVzaW5nIHRoZSBhcnJvdyBrZXlzLgogICAgICoKICAgICAqIFRoZSBjb250ZW50IGlzIGluc2VydGVkIGFjY29yZGluZyB0byB0aGUgYHdpZGdldC10eXBlLWFyb3VuZGAgc2VsZWN0aW9uIGF0dHJpYnV0ZSAoc2VlIHtAbGluayAjX2hhbmRsZUFycm93S2V5UHJlc3N9KS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9lbmFibGVJbnNlcnRDb250ZW50SW50ZWdyYXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9lbmFibGVJbnNlcnRDb250ZW50SW50ZWdyYXRpb24oKSB7CiAgICAgIHZhciBlZGl0b3IgPSB0aGlzLmVkaXRvcjsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5lZGl0b3IubW9kZWw7CiAgICAgIHZhciBkb2N1bWVudFNlbGVjdGlvbiA9IG1vZGVsLmRvY3VtZW50LnNlbGVjdGlvbjsKCiAgICAgIHRoaXMuX2xpc3RlblRvSWZFbmFibGVkKGVkaXRvci5tb2RlbCwgJ2luc2VydENvbnRlbnQnLCBmdW5jdGlvbiAoZXZ0LCBfcmVmKSB7CiAgICAgICAgdmFyIF9yZWYyID0gX3NsaWNlZFRvQXJyYXkoX3JlZiwgMiksCiAgICAgICAgICAgIGNvbnRlbnQgPSBfcmVmMlswXSwKICAgICAgICAgICAgc2VsZWN0YWJsZSA9IF9yZWYyWzFdOwoKICAgICAgICBpZiAoc2VsZWN0YWJsZSAmJiAhc2VsZWN0YWJsZS5pcygnZG9jdW1lbnRTZWxlY3Rpb24nKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbiA9IGdldFR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbihkb2N1bWVudFNlbGVjdGlvbik7CgogICAgICAgIGlmICghdHlwZUFyb3VuZEZha2VDYXJldFBvc2l0aW9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldnQuc3RvcCgpOwogICAgICAgIHJldHVybiBtb2RlbC5jaGFuZ2UoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgdmFyIHNlbGVjdGVkRWxlbWVudCA9IGRvY3VtZW50U2VsZWN0aW9uLmdldFNlbGVjdGVkRWxlbWVudCgpOwogICAgICAgICAgdmFyIHBvc2l0aW9uID0gbW9kZWwuY3JlYXRlUG9zaXRpb25BdChzZWxlY3RlZEVsZW1lbnQsIHR5cGVBcm91bmRGYWtlQ2FyZXRQb3NpdGlvbik7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd3JpdGVyLmNyZWF0ZVNlbGVjdGlvbihwb3NpdGlvbik7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gbW9kZWwuaW5zZXJ0Q29udGVudChjb250ZW50LCBzZWxlY3Rpb24pOwogICAgICAgICAgd3JpdGVyLnNldFNlbGVjdGlvbihzZWxlY3Rpb24pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9KTsKICAgICAgfSwgewogICAgICAgIHByaW9yaXR5OiAnaGlnaCcKICAgICAgfSk7CiAgICB9CiAgfV0sIFt7CiAgICBrZXk6ICJwbHVnaW5OYW1lIiwKICAgIGdldDoKICAgIC8qKgogICAgICogQGluaGVyaXREb2MKICAgICAqLwogICAgZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gJ1dpZGdldFR5cGVBcm91bmQnOwogICAgfQogICAgLyoqCiAgICAgKiBAaW5oZXJpdERvYwogICAgICovCgogIH0sIHsKICAgIGtleTogInJlcXVpcmVzIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gW0VudGVyLCBEZWxldGVdOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIFdpZGdldFR5cGVBcm91bmQ7Cn0oUGx1Z2luKTsgLy8gSW5qZWN0cyB0aGUgdHlwZSBhcm91bmQgVUkgaW50byBhIHZpZXcgd2lkZ2V0IGluc3RhbmNlLgovLwovLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9kb3duY2FzdHdyaXRlcn5Eb3duY2FzdFdyaXRlcn0gdmlld1dyaXRlcgovLyBAcGFyYW0ge09iamVjdC48U3RyaW5nLFN0cmluZz59IGJ1dHRvblRpdGxlcwovLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvdmlldy9lbGVtZW50fkVsZW1lbnR9IHdpZGdldFZpZXdFbGVtZW50CgoKZXhwb3J0IHsgV2lkZ2V0VHlwZUFyb3VuZCBhcyBkZWZhdWx0IH07CgpmdW5jdGlvbiBpbmplY3RVSUludG9XaWRnZXQodmlld1dyaXRlciwgYnV0dG9uVGl0bGVzLCB3aWRnZXRWaWV3RWxlbWVudCkgewogIHZhciB0eXBlQXJvdW5kV3JhcHBlciA9IHZpZXdXcml0ZXIuY3JlYXRlVUlFbGVtZW50KCdkaXYnLCB7CiAgICBjbGFzczogJ2NrIGNrLXJlc2V0X2FsbCBjay13aWRnZXRfX3R5cGUtYXJvdW5kJwogIH0sIGZ1bmN0aW9uIChkb21Eb2N1bWVudCkgewogICAgdmFyIHdyYXBwZXJEb21FbGVtZW50ID0gdGhpcy50b0RvbUVsZW1lbnQoZG9tRG9jdW1lbnQpOwogICAgaW5qZWN0QnV0dG9ucyh3cmFwcGVyRG9tRWxlbWVudCwgYnV0dG9uVGl0bGVzKTsKICAgIGluamVjdEZha2VDYXJldCh3cmFwcGVyRG9tRWxlbWVudCk7CiAgICByZXR1cm4gd3JhcHBlckRvbUVsZW1lbnQ7CiAgfSk7IC8vIEluamVjdCB0aGUgdHlwZSBhcm91bmQgd3JhcHBlciBpbnRvIHRoZSB3aWRnZXQncyB3cmFwcGVyLgoKICB2aWV3V3JpdGVyLmluc2VydCh2aWV3V3JpdGVyLmNyZWF0ZVBvc2l0aW9uQXQod2lkZ2V0Vmlld0VsZW1lbnQsICdlbmQnKSwgdHlwZUFyb3VuZFdyYXBwZXIpOwp9IC8vIEZZSTogTm90IHVzaW5nIHRoZSBJY29uVmlldyBjbGFzcyBiZWNhdXNlIGVhY2ggaW5zdGFuY2Ugd291bGQgbmVlZCB0byBiZSBkZXN0cm95ZWQgdG8gYXZvaWQgbWVtb3J5IGxlYWtzCi8vIGFuZCBpdCdzIHByZXR0eSBoYXJkIHRvIGZpZ3VyZSBvdXQgd2hlbiBhIHZpZXcgKHdpZGdldCkgaXMgZ29uZSBmb3IgZ29vZCBzbyBpdCdzIGNoZWFwZXIgdG8gdXNlIHJhdwovLyA8c3ZnPiBoZXJlLgovLwovLyBAcGFyYW0ge0hUTUxFbGVtZW50fSB3cmFwcGVyRG9tRWxlbWVudAovLyBAcGFyYW0ge09iamVjdC48U3RyaW5nLFN0cmluZz59IGJ1dHRvblRpdGxlcwoKCmZ1bmN0aW9uIGluamVjdEJ1dHRvbnMod3JhcHBlckRvbUVsZW1lbnQsIGJ1dHRvblRpdGxlcykgewogIHZhciBfaXRlcmF0b3IyID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoUE9TU0lCTEVfSU5TRVJUSU9OX1BPU0lUSU9OUyksCiAgICAgIF9zdGVwMjsKCiAgdHJ5IHsKICAgIGZvciAoX2l0ZXJhdG9yMi5zKCk7ICEoX3N0ZXAyID0gX2l0ZXJhdG9yMi5uKCkpLmRvbmU7KSB7CiAgICAgIHZhciBwb3NpdGlvbiA9IF9zdGVwMi52YWx1ZTsKICAgICAgdmFyIGJ1dHRvblRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHsKICAgICAgICB0YWc6ICdkaXYnLAogICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgIGNsYXNzOiBbJ2NrJywgJ2NrLXdpZGdldF9fdHlwZS1hcm91bmRfX2J1dHRvbicsICJjay13aWRnZXRfX3R5cGUtYXJvdW5kX19idXR0b25fIi5jb25jYXQocG9zaXRpb24pXSwKICAgICAgICAgIHRpdGxlOiBidXR0b25UaXRsZXNbcG9zaXRpb25dCiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogW3dyYXBwZXJEb21FbGVtZW50Lm93bmVyRG9jdW1lbnQuaW1wb3J0Tm9kZShSRVRVUk5fQVJST1dfSUNPTl9FTEVNRU5ULCB0cnVlKV0KICAgICAgfSk7CiAgICAgIHdyYXBwZXJEb21FbGVtZW50LmFwcGVuZENoaWxkKGJ1dHRvblRlbXBsYXRlLnJlbmRlcigpKTsKICAgIH0KICB9IGNhdGNoIChlcnIpIHsKICAgIF9pdGVyYXRvcjIuZShlcnIpOwogIH0gZmluYWxseSB7CiAgICBfaXRlcmF0b3IyLmYoKTsKICB9Cn0gLy8gQHBhcmFtIHtIVE1MRWxlbWVudH0gd3JhcHBlckRvbUVsZW1lbnQKCgpmdW5jdGlvbiBpbmplY3RGYWtlQ2FyZXQod3JhcHBlckRvbUVsZW1lbnQpIHsKICB2YXIgY2FyZXRUZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZSh7CiAgICB0YWc6ICdkaXYnLAogICAgYXR0cmlidXRlczogewogICAgICBjbGFzczogWydjaycsICdjay13aWRnZXRfX3R5cGUtYXJvdW5kX19mYWtlLWNhcmV0J10KICAgIH0KICB9KTsKICB3cmFwcGVyRG9tRWxlbWVudC5hcHBlbmRDaGlsZChjYXJldFRlbXBsYXRlLnJlbmRlcigpKTsKfSAvLyBSZXR1cm5zIHRoZSBhbmNlc3RvciBvZiBhbiBlbGVtZW50IGNsb3Nlc3QgdG8gdGhlIHJvb3Qgd2hpY2ggaXMgZW1wdHkuIEZvciBpbnN0YW5jZSwKLy8gZm9yIGA8YmF6PmA6Ci8vCi8vCQk8Zm9vPmFiYzxiYXI+PGJhej48L2Jhej48L2Jhcj48L2Zvbz4KLy8KLy8gaXQgcmV0dXJucyBgPGJhcj5gLgovLwovLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvc2NoZW1hflNjaGVtYX0gc2NoZW1hCi8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnR9IGVsZW1lbnQKLy8gQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50fG51bGx9CgoKZnVuY3Rpb24gZ2V0RGVlcGVzdEVtcHR5RWxlbWVudEFuY2VzdG9yKHNjaGVtYSwgZWxlbWVudCkgewogIHZhciBkZWVwZXN0RW1wdHlBbmNlc3RvciA9IGVsZW1lbnQ7CgogIHZhciBfaXRlcmF0b3IzID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoZWxlbWVudC5nZXRBbmNlc3RvcnMoewogICAgcGFyZW50Rmlyc3Q6IHRydWUKICB9KSksCiAgICAgIF9zdGVwMzsKCiAgdHJ5IHsKICAgIGZvciAoX2l0ZXJhdG9yMy5zKCk7ICEoX3N0ZXAzID0gX2l0ZXJhdG9yMy5uKCkpLmRvbmU7KSB7CiAgICAgIHZhciBhbmNlc3RvciA9IF9zdGVwMy52YWx1ZTsKCiAgICAgIGlmIChhbmNlc3Rvci5jaGlsZENvdW50ID4gMSB8fCBzY2hlbWEuaXNMaW1pdChhbmNlc3RvcikpIHsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgZGVlcGVzdEVtcHR5QW5jZXN0b3IgPSBhbmNlc3RvcjsKICAgIH0KICB9IGNhdGNoIChlcnIpIHsKICAgIF9pdGVyYXRvcjMuZShlcnIpOwogIH0gZmluYWxseSB7CiAgICBfaXRlcmF0b3IzLmYoKTsKICB9CgogIHJldHVybiBkZWVwZXN0RW1wdHlBbmNlc3RvcjsKfQ=="},{"version":3,"sources":["/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-widget/src/widgettypearound/widgettypearound.js"],"names":["Plugin","Template","Enter","Delete","isForwardArrowKeyCode","keyCodes","isTypeAroundWidget","getClosestTypeAroundDomButton","getTypeAroundButtonPosition","getClosestWidgetViewElement","getTypeAroundFakeCaretPosition","TYPE_AROUND_SELECTION_ATTRIBUTE","isNonTypingKeystroke","isWidget","returnIcon","POSSIBLE_INSERTION_POSITIONS","RETURN_ARROW_ICON_ELEMENT","DOMParser","parseFromString","firstChild","PLUGIN_DISABLED_EDITING_ROOT_CLASS","WidgetTypeAround","editor","_currentFakeCaretModelElement","editingView","editing","view","on","evt","data","isEnabled","change","writer","document","roots","root","removeClass","addClass","model","removeSelectionAttribute","_enableTypeAroundUIInjection","_enableInsertingParagraphsOnButtonClick","_enableInsertingParagraphsOnEnterKeypress","_enableInsertingParagraphsOnTypingKeystroke","_enableTypeAroundFakeCaretActivationUsingKeyboardArrows","_enableDeleteIntegration","_enableInsertContentIntegration","widgetModelElement","position","execute","createPositionAt","focus","scrollToTheSelection","emitter","event","callback","options","listenTo","modelSelection","selection","typeAroundFakeCaretPosition","selectedModelElement","getSelectedElement","_insertParagraph","schema","t","locale","buttonTitles","before","after","downcastDispatcher","conversionApi","viewElement","mapper","toViewElement","item","injectUIIntoWidget","priority","_listenToIfEnabled","domEventData","_handleArrowKeyPress","context","directChange","selectedViewElement","map","positionToWidgetCssClass","ui","focusTracker","name","isFocused","keyCode","isForward","contentLanguageDirection","toModelElement","shouldStopAndPreventDefault","_handleArrowKeyPressOnSelectedWidget","isCollapsed","_handleArrowKeyPressWhenSelectionNextToAWidget","preventDefault","stop","isLeavingWidget","setSelectionAttribute","widgetPlugin","plugins","get","modelElementNextToSelection","_getObjectElementNextToSelection","viewElementNextToSelection","_setSelectionOverElement","button","domTarget","buttonPosition","widgetViewElement","domConverter","eventPhase","wasHandled","_insertParagraphAccordingToFakeCaretPosition","isSoft","keyCodesHandledSomewhereElse","enter","delete","backspace","includes","direction","selectedModelWidget","isFakeCaretBefore","isDeleteForward","shouldDeleteEntireWidget","createSelection","range","getNearestSelectionRange","setSelection","probe","start","modifySelection","isEqual","deepestEmptyRangeAncestor","getDeepestEmptyElementAncestor","parent","deleteContent","doNotAutoparagraph","documentSelection","content","selectable","is","selectedElement","result","insertContent","viewWriter","typeAroundWrapper","createUIElement","class","domDocument","wrapperDomElement","toDomElement","injectButtons","injectFakeCaret","insert","buttonTemplate","tag","attributes","title","children","ownerDocument","importNode","appendChild","render","caretTemplate","element","deepestEmptyAncestor","getAncestors","parentFirst","ancestor","childCount","isLimit"],"mappings":"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","sourcesContent":["/**\n * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/* global DOMParser */\n\n/**\n * @module widget/widgettypearound\n */\n\nimport Plugin from '@ckeditor/ckeditor5-core/src/plugin';\nimport Template from '@ckeditor/ckeditor5-ui/src/template';\nimport Enter from '@ckeditor/ckeditor5-enter/src/enter';\nimport Delete from '@ckeditor/ckeditor5-typing/src/delete';\nimport {\n\tisForwardArrowKeyCode,\n\tkeyCodes\n} from '@ckeditor/ckeditor5-utils/src/keyboard';\n\nimport {\n\tisTypeAroundWidget,\n\tgetClosestTypeAroundDomButton,\n\tgetTypeAroundButtonPosition,\n\tgetClosestWidgetViewElement,\n\tgetTypeAroundFakeCaretPosition,\n\tTYPE_AROUND_SELECTION_ATTRIBUTE\n} from './utils';\n\nimport {\n\tisNonTypingKeystroke\n} from '@ckeditor/ckeditor5-typing/src/utils/injectunsafekeystrokeshandling';\n\nimport { isWidget } from '../utils';\n\nimport returnIcon from '../../theme/icons/return-arrow.svg';\nimport '../../theme/widgettypearound.css';\n\nconst POSSIBLE_INSERTION_POSITIONS = [ 'before', 'after' ];\n\n// Do the SVG parsing once and then clone the result <svg> DOM element for each new button.\nconst RETURN_ARROW_ICON_ELEMENT = new DOMParser().parseFromString( returnIcon, 'image/svg+xml' ).firstChild;\n\nconst PLUGIN_DISABLED_EDITING_ROOT_CLASS = 'ck-widget__type-around_disabled';\n\n/**\n * A plugin that allows users to type around widgets where normally it is impossible to place the caret due\n * to limitations of web browsers. These \"tight spots\" occur, for instance, before (or after) a widget being\n * the first (or last) child of its parent or between two block widgets.\n *\n * This plugin extends the {@link module:widget/widget~Widget `Widget`} plugin and injects the user interface\n * with two buttons into each widget instance in the editor. Each of the buttons can be clicked by the\n * user if the widget is next to the \"tight spot\". Once clicked, a paragraph is created with the selection anchored\n * in it so that users can type (or insert content, paste, etc.) straight away.\n *\n * @extends module:core/plugin~Plugin\n */\nexport default class WidgetTypeAround extends Plugin {\n\t/**\n\t * @inheritDoc\n\t */\n\tstatic get pluginName() {\n\t\treturn 'WidgetTypeAround';\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tstatic get requires() {\n\t\treturn [ Enter, Delete ];\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tconstructor( editor ) {\n\t\tsuper( editor );\n\n\t\t/**\n\t\t * A reference to the model widget element that has the fake caret active\n\t\t * on either side of it. It is later used to remove CSS classes associated with the fake caret\n\t\t * when the widget no longer needs it.\n\t\t *\n\t\t * @private\n\t\t * @member {module:engine/model/element~Element|null}\n\t\t */\n\t\tthis._currentFakeCaretModelElement = null;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tinit() {\n\t\tconst editor = this.editor;\n\t\tconst editingView = editor.editing.view;\n\n\t\t// Set a CSS class on the view editing root when the plugin is disabled so all the buttons\n\t\t// and lines visually disappear. All the interactions are disabled in individual plugin methods.\n\t\tthis.on( 'change:isEnabled', ( evt, data, isEnabled ) => {\n\t\t\teditingView.change( writer => {\n\t\t\t\tfor ( const root of editingView.document.roots ) {\n\t\t\t\t\tif ( isEnabled ) {\n\t\t\t\t\t\twriter.removeClass( PLUGIN_DISABLED_EDITING_ROOT_CLASS, root );\n\t\t\t\t\t} else {\n\t\t\t\t\t\twriter.addClass( PLUGIN_DISABLED_EDITING_ROOT_CLASS, root );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\n\t\t\tif ( !isEnabled ) {\n\t\t\t\teditor.model.change( writer => {\n\t\t\t\t\twriter.removeSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE );\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\tthis._enableTypeAroundUIInjection();\n\t\tthis._enableInsertingParagraphsOnButtonClick();\n\t\tthis._enableInsertingParagraphsOnEnterKeypress();\n\t\tthis._enableInsertingParagraphsOnTypingKeystroke();\n\t\tthis._enableTypeAroundFakeCaretActivationUsingKeyboardArrows();\n\t\tthis._enableDeleteIntegration();\n\t\tthis._enableInsertContentIntegration();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tdestroy() {\n\t\tthis._currentFakeCaretModelElement = null;\n\t}\n\n\t/**\n\t * Inserts a new paragraph next to a widget element with the selection anchored in it.\n\t *\n\t * **Note**: This method is heavily user-oriented and will both focus the editing view and scroll\n\t * the viewport to the selection in the inserted paragraph.\n\t *\n\t * @protected\n\t * @param {module:engine/model/element~Element} widgetModelElement The model widget element next to which a paragraph is inserted.\n\t * @param {'before'|'after'} position The position where the paragraph is inserted. Either `'before'` or `'after'` the widget.\n\t */\n\t_insertParagraph( widgetModelElement, position ) {\n\t\tconst editor = this.editor;\n\t\tconst editingView = editor.editing.view;\n\n\t\teditor.execute( 'insertParagraph', {\n\t\t\tposition: editor.model.createPositionAt( widgetModelElement, position )\n\t\t} );\n\n\t\teditingView.focus();\n\t\teditingView.scrollToTheSelection();\n\t}\n\n\t/**\n\t * A wrapper for the {@link module:utils/emittermixin~EmitterMixin#listenTo} method that executes the callbacks only\n\t * when the plugin {@link #isEnabled is enabled}.\n\t *\n\t * @private\n\t * @param {module:utils/emittermixin~Emitter} emitter The object that fires the event.\n\t * @param {String} event The name of the event.\n\t * @param {Function} callback The function to be called on event.\n\t * @param {Object} [options={}] Additional options.\n\t * @param {module:utils/priorities~PriorityString|Number} [options.priority='normal'] The priority of this event callback. The higher\n\t * the priority value the sooner the callback will be fired. Events having the same priority are called in the\n\t * order they were added.\n\t */\n\t_listenToIfEnabled( emitter, event, callback, options ) {\n\t\tthis.listenTo( emitter, event, ( ...args ) => {\n\t\t\t// Do not respond if the plugin is disabled.\n\t\t\tif ( this.isEnabled ) {\n\t\t\t\tcallback( ...args );\n\t\t\t}\n\t\t}, options );\n\t}\n\n\t/**\n\t * Similar to {@link #_insertParagraph}, this method inserts a paragraph except that it\n\t * does not expect a position. Instead, it performs the insertion next to a selected widget\n\t * according to the `widget-type-around` model selection attribute value (fake caret position).\n\t *\n\t * Because this method requires the `widget-type-around` attribute to be set,\n\t * the insertion can only happen when the widget's fake caret is active (e.g. activated\n\t * using the keyboard).\n\t *\n\t * @private\n\t * @returns {Boolean} Returns `true` when the paragraph was inserted (the attribute was present) and `false` otherwise.\n\t */\n\t_insertParagraphAccordingToFakeCaretPosition() {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst modelSelection = model.document.selection;\n\t\tconst typeAroundFakeCaretPosition = getTypeAroundFakeCaretPosition( modelSelection );\n\n\t\tif ( !typeAroundFakeCaretPosition ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst selectedModelElement = modelSelection.getSelectedElement();\n\n\t\tthis._insertParagraph( selectedModelElement, typeAroundFakeCaretPosition );\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Creates a listener in the editing conversion pipeline that injects the widget type around\n\t * UI into every single widget instance created in the editor.\n\t *\n\t * The UI is delivered as a {@link module:engine/view/uielement~UIElement}\n\t * wrapper which renders DOM buttons that users can use to insert paragraphs.\n\t *\n\t * @private\n\t */\n\t_enableTypeAroundUIInjection() {\n\t\tconst editor = this.editor;\n\t\tconst schema = editor.model.schema;\n\t\tconst t = editor.locale.t;\n\t\tconst buttonTitles = {\n\t\t\tbefore: t( 'Insert paragraph before block' ),\n\t\t\tafter: t( 'Insert paragraph after block' )\n\t\t};\n\n\t\teditor.editing.downcastDispatcher.on( 'insert', ( evt, data, conversionApi ) => {\n\t\t\tconst viewElement = conversionApi.mapper.toViewElement( data.item );\n\n\t\t\t// Filter out non-widgets and inline widgets.\n\t\t\tif ( isTypeAroundWidget( viewElement, data.item, schema ) ) {\n\t\t\t\tinjectUIIntoWidget( conversionApi.writer, buttonTitles, viewElement );\n\t\t\t}\n\t\t}, { priority: 'low' } );\n\t}\n\n\t/**\n\t * Brings support for the fake caret that appears when either:\n\t *\n\t * * the selection moves to a widget from a position next to it using arrow keys,\n\t * * the arrow key is pressed when the widget is already selected.\n\t *\n\t * The fake caret lets the user know that they can start typing or just press\n\t * <kbd>Enter</kbd> to insert a paragraph at the position next to a widget as suggested by the fake caret.\n\t *\n\t * The fake caret disappears when the user changes the selection or the editor\n\t * gets blurred.\n\t *\n\t * The whole idea is as follows:\n\t *\n\t * 1. A user does one of the 2 scenarios described at the beginning.\n\t * 2. The \"keydown\" listener is executed and the decision is made whether to show or hide the fake caret.\n\t * 3. If it should show up, the `widget-type-around` model selection attribute is set indicating\n\t *    on which side of the widget it should appear.\n\t * 4. The selection dispatcher reacts to the selection attribute and sets CSS classes responsible for the\n\t *    fake caret on the view widget.\n\t * 5. If the fake caret should disappear, the selection attribute is removed and the dispatcher\n\t *    does the CSS class clean-up in the view.\n\t * 6. Additionally, `change:range` and `FocusTracker#isFocused` listeners also remove the selection\n\t *    attribute (the former also removes widget CSS classes).\n\t *\n\t * @private\n\t */\n\t_enableTypeAroundFakeCaretActivationUsingKeyboardArrows() {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst modelSelection = model.document.selection;\n\t\tconst schema = model.schema;\n\t\tconst editingView = editor.editing.view;\n\n\t\t// This is the main listener responsible for the fake caret.\n\t\t// Note: The priority must precede the default Widget class keydown handler (\"high\").\n\t\tthis._listenToIfEnabled( editingView.document, 'arrowKey', ( evt, domEventData ) => {\n\t\t\tthis._handleArrowKeyPress( evt, domEventData );\n\t\t}, { context: [ isWidget, '$text' ], priority: 'high' } );\n\n\t\t// This listener makes sure the widget type around selection attribute will be gone from the model\n\t\t// selection as soon as the model range changes. This attribute only makes sense when a widget is selected\n\t\t// (and the \"fake horizontal caret\" is visible) so whenever the range changes (e.g. selection moved somewhere else),\n\t\t// let's get rid of the attribute so that the selection downcast dispatcher isn't even bothered.\n\t\tthis._listenToIfEnabled( modelSelection, 'change:range', ( evt, data ) => {\n\t\t\t// Do not reset the selection attribute when the change was indirect.\n\t\t\tif ( !data.directChange ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get rid of the widget type around attribute of the selection on every change:range.\n\t\t\t// If the range changes, it means for sure, the user is no longer in the active (\"fake horizontal caret\") mode.\n\t\t\teditor.model.change( writer => {\n\t\t\t\twriter.removeSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE );\n\t\t\t} );\n\t\t} );\n\n\t\t// Get rid of the widget type around attribute of the selection on every document change\n\t\t// that makes widget not selected any more (i.e. widget was removed).\n\t\tthis._listenToIfEnabled( model.document, 'change:data', () => {\n\t\t\tconst selectedModelElement = modelSelection.getSelectedElement();\n\n\t\t\tif ( selectedModelElement ) {\n\t\t\t\tconst selectedViewElement = editor.editing.mapper.toViewElement( selectedModelElement );\n\n\t\t\t\tif ( isTypeAroundWidget( selectedViewElement, selectedModelElement, schema ) ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\teditor.model.change( writer => {\n\t\t\t\twriter.removeSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE );\n\t\t\t} );\n\t\t} );\n\n\t\t// React to changes of the model selection attribute made by the arrow keys listener.\n\t\t// If the block widget is selected and the attribute changes, downcast the attribute to special\n\t\t// CSS classes associated with the active (\"fake horizontal caret\") mode of the widget.\n\t\tthis._listenToIfEnabled( editor.editing.downcastDispatcher, 'selection', ( evt, data, conversionApi ) => {\n\t\t\tconst writer = conversionApi.writer;\n\n\t\t\tif ( this._currentFakeCaretModelElement ) {\n\t\t\t\tconst selectedViewElement = conversionApi.mapper.toViewElement( this._currentFakeCaretModelElement );\n\n\t\t\t\tif ( selectedViewElement ) {\n\t\t\t\t\t// Get rid of CSS classes associated with the active (\"fake horizontal caret\") mode from the view widget.\n\t\t\t\t\twriter.removeClass( POSSIBLE_INSERTION_POSITIONS.map( positionToWidgetCssClass ), selectedViewElement );\n\n\t\t\t\t\tthis._currentFakeCaretModelElement = null;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst selectedModelElement = data.selection.getSelectedElement();\n\n\t\t\tif ( !selectedModelElement ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selectedViewElement = conversionApi.mapper.toViewElement( selectedModelElement );\n\n\t\t\tif ( !isTypeAroundWidget( selectedViewElement, selectedModelElement, schema ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst typeAroundFakeCaretPosition = getTypeAroundFakeCaretPosition( data.selection );\n\n\t\t\tif ( !typeAroundFakeCaretPosition ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twriter.addClass( positionToWidgetCssClass( typeAroundFakeCaretPosition ), selectedViewElement );\n\n\t\t\t// Remember the view widget that got the \"fake-caret\" CSS class. This class should be removed ASAP when the\n\t\t\t// selection changes\n\t\t\tthis._currentFakeCaretModelElement = selectedModelElement;\n\t\t} );\n\n\t\tthis._listenToIfEnabled( editor.ui.focusTracker, 'change:isFocused', ( evt, name, isFocused ) => {\n\t\t\tif ( !isFocused ) {\n\t\t\t\teditor.model.change( writer => {\n\t\t\t\t\twriter.removeSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE );\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\n\t\tfunction positionToWidgetCssClass( position ) {\n\t\t\treturn `ck-widget_type-around_show-fake-caret_${ position }`;\n\t\t}\n\t}\n\n\t/**\n\t * A listener executed on each \"keydown\" in the view document, a part of\n\t * {@link #_enableTypeAroundFakeCaretActivationUsingKeyboardArrows}.\n\t *\n\t * It decides whether the arrow keypress should activate the fake caret or not (also whether it should\n\t * be deactivated).\n\t *\n\t * The fake caret activation is done by setting the `widget-type-around` model selection attribute\n\t * in this listener, and stopping and preventing the event that would normally be handled by the widget\n\t * plugin that is responsible for the regular keyboard navigation near/across all widgets (that\n\t * includes inline widgets, which are ignored by the widget type around plugin).\n\t *\n\t * @private\n\t */\n\t_handleArrowKeyPress( evt, domEventData ) {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst modelSelection = model.document.selection;\n\t\tconst schema = model.schema;\n\t\tconst editingView = editor.editing.view;\n\n\t\tconst keyCode = domEventData.keyCode;\n\t\tconst isForward = isForwardArrowKeyCode( keyCode, editor.locale.contentLanguageDirection );\n\t\tconst selectedViewElement = editingView.document.selection.getSelectedElement();\n\t\tconst selectedModelElement = editor.editing.mapper.toModelElement( selectedViewElement );\n\t\tlet shouldStopAndPreventDefault;\n\n\t\t// Handle keyboard navigation when a type-around-compatible widget is currently selected.\n\t\tif ( isTypeAroundWidget( selectedViewElement, selectedModelElement, schema ) ) {\n\t\t\tshouldStopAndPreventDefault = this._handleArrowKeyPressOnSelectedWidget( isForward );\n\t\t}\n\t\t// Handle keyboard arrow navigation when the selection is next to a type-around-compatible widget\n\t\t// and the widget is about to be selected.\n\t\telse if ( modelSelection.isCollapsed ) {\n\t\t\tshouldStopAndPreventDefault = this._handleArrowKeyPressWhenSelectionNextToAWidget( isForward );\n\t\t}\n\n\t\tif ( shouldStopAndPreventDefault ) {\n\t\t\tdomEventData.preventDefault();\n\t\t\tevt.stop();\n\t\t}\n\t}\n\n\t/**\n\t * Handles the keyboard navigation on \"keydown\" when a widget is currently selected and activates or deactivates\n\t * the fake caret for that widget, depending on the current value of the `widget-type-around` model\n\t * selection attribute and the direction of the pressed arrow key.\n\t *\n\t * @private\n\t * @param {Boolean} isForward `true` when the pressed arrow key was responsible for the forward model selection movement\n\t * as in {@link module:utils/keyboard~isForwardArrowKeyCode}.\n\t * @returns {Boolean} Returns `true` when the keypress was handled and no other keydown listener of the editor should\n\t * process the event any further. Returns `false` otherwise.\n\t */\n\t_handleArrowKeyPressOnSelectedWidget( isForward ) {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst modelSelection = model.document.selection;\n\t\tconst typeAroundFakeCaretPosition = getTypeAroundFakeCaretPosition( modelSelection );\n\n\t\treturn model.change( writer => {\n\t\t\t// If the fake caret is displayed...\n\t\t\tif ( typeAroundFakeCaretPosition ) {\n\t\t\t\tconst isLeavingWidget = typeAroundFakeCaretPosition === ( isForward ? 'after' : 'before' );\n\n\t\t\t\t// If the keyboard arrow works against the value of the selection attribute...\n\t\t\t\t// then remove the selection attribute but prevent default DOM actions\n\t\t\t\t// and do not let the Widget plugin listener move the selection. This brings\n\t\t\t\t// the widget back to the state, for instance, like if was selected using the mouse.\n\t\t\t\t//\n\t\t\t\t// **Note**: If leaving the widget when the fake caret is active, then the default\n\t\t\t\t// Widget handler will change the selection and, in turn, this will automatically discard\n\t\t\t\t// the selection attribute.\n\t\t\t\tif ( !isLeavingWidget ) {\n\t\t\t\t\twriter.removeSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE );\n\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// If the fake caret wasn't displayed, let's set it now according to the direction of the arrow\n\t\t\t// key press. This also means we cannot let the Widget plugin listener move the selection.\n\t\t\telse {\n\t\t\t\twriter.setSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE, isForward ? 'after' : 'before' );\n\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t} );\n\t}\n\n\t/**\n\t * Handles the keyboard navigation on \"keydown\" when **no** widget is selected but the selection is **directly** next\n\t * to one and upon the fake caret should become active for this widget upon arrow keypress\n\t * (AKA entering/selecting the widget).\n\t *\n\t * **Note**: This code mirrors the implementation from the widget plugin but also adds the selection attribute.\n\t * Unfortunately, there is no safe way to let the widget plugin do the selection part first and then just set the\n\t * selection attribute here in the widget type around plugin. This is why this code must duplicate some from the widget plugin.\n\t *\n\t * @private\n\t * @param {Boolean} isForward `true` when the pressed arrow key was responsible for the forward model selection movement\n\t * as in {@link module:utils/keyboard~isForwardArrowKeyCode}.\n\t * @returns {Boolean} Returns `true` when the keypress was handled and no other keydown listener of the editor should\n\t * process the event any further. Returns `false` otherwise.\n\t */\n\t_handleArrowKeyPressWhenSelectionNextToAWidget( isForward ) {\n\t\tconst editor = this.editor;\n\t\tconst model = editor.model;\n\t\tconst schema = model.schema;\n\t\tconst widgetPlugin = editor.plugins.get( 'Widget' );\n\n\t\t// This is the widget the selection is about to be set on.\n\t\tconst modelElementNextToSelection = widgetPlugin._getObjectElementNextToSelection( isForward );\n\t\tconst viewElementNextToSelection = editor.editing.mapper.toViewElement( modelElementNextToSelection );\n\n\t\tif ( isTypeAroundWidget( viewElementNextToSelection, modelElementNextToSelection, schema ) ) {\n\t\t\tmodel.change( writer => {\n\t\t\t\twidgetPlugin._setSelectionOverElement( modelElementNextToSelection );\n\t\t\t\twriter.setSelectionAttribute( TYPE_AROUND_SELECTION_ATTRIBUTE, isForward ? 'before' : 'after' );\n\t\t\t} );\n\n\t\t\t// The change() block above does the same job as the Widget plugin. The event can\n\t\t\t// be safely canceled.\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Registers a `mousedown` listener for the view document which intercepts events\n\t * coming from the widget type around UI, which happens when a user clicks one of the buttons\n\t * that insert a paragraph next to a widget.\n\t *\n\t * @private\n\t */\n\t_enableInsertingParagraphsOnButtonClick() {\n\t\tconst editor = this.editor;\n\t\tconst editingView = editor.editing.view;\n\n\t\tthis._listenToIfEnabled( editingView.document, 'mousedown', ( evt, domEventData ) => {\n\t\t\tconst button = getClosestTypeAroundDomButton( domEventData.domTarget );\n\n\t\t\tif ( !button ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst buttonPosition = getTypeAroundButtonPosition( button );\n\t\t\tconst widgetViewElement = getClosestWidgetViewElement( button, editingView.domConverter );\n\t\t\tconst widgetModelElement = editor.editing.mapper.toModelElement( widgetViewElement );\n\n\t\t\tthis._insertParagraph( widgetModelElement, buttonPosition );\n\n\t\t\tdomEventData.preventDefault();\n\t\t\tevt.stop();\n\t\t} );\n\t}\n\n\t/**\n\t * Creates the <kbd>Enter</kbd> key listener on the view document that allows the user to insert a paragraph\n\t * near the widget when either:\n\t *\n\t * * The fake caret was first activated using the arrow keys,\n\t * * The entire widget is selected in the model.\n\t *\n\t * In the first case, the new paragraph is inserted according to the `widget-type-around` selection\n\t * attribute (see {@link #_handleArrowKeyPress}).\n\t *\n\t * In the second case, the new paragraph is inserted based on whether a soft (<kbd>Shift</kbd>+<kbd>Enter</kbd>) keystroke\n\t * was pressed or not.\n\t *\n\t * @private\n\t */\n\t_enableInsertingParagraphsOnEnterKeypress() {\n\t\tconst editor = this.editor;\n\t\tconst selection = editor.model.document.selection;\n\t\tconst editingView = editor.editing.view;\n\n\t\tthis._listenToIfEnabled( editingView.document, 'enter', ( evt, domEventData ) => {\n\t\t\t// This event could be triggered from inside the widget but we are interested\n\t\t\t// only when the widget is selected itself.\n\t\t\tif ( evt.eventPhase != 'atTarget' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selectedModelElement = selection.getSelectedElement();\n\t\t\tconst selectedViewElement = editor.editing.mapper.toViewElement( selectedModelElement );\n\n\t\t\tconst schema = editor.model.schema;\n\t\t\tlet wasHandled;\n\n\t\t\t// First check if the widget is selected and there's a type around selection attribute associated\n\t\t\t// with the fake caret that would tell where to insert a new paragraph.\n\t\t\tif ( this._insertParagraphAccordingToFakeCaretPosition() ) {\n\t\t\t\twasHandled = true;\n\t\t\t}\n\t\t\t// Then, if there is no selection attribute associated with the fake caret, check if the widget\n\t\t\t// simply is selected and create a new paragraph according to the keystroke (Shift+)Enter.\n\t\t\telse if ( isTypeAroundWidget( selectedViewElement, selectedModelElement, schema ) ) {\n\t\t\t\tthis._insertParagraph( selectedModelElement, domEventData.isSoft ? 'before' : 'after' );\n\n\t\t\t\twasHandled = true;\n\t\t\t}\n\n\t\t\tif ( wasHandled ) {\n\t\t\t\tdomEventData.preventDefault();\n\t\t\t\tevt.stop();\n\t\t\t}\n\t\t}, { context: isWidget } );\n\t}\n\n\t/**\n\t * Similar to the {@link #_enableInsertingParagraphsOnEnterKeypress}, it allows the user\n\t * to insert a paragraph next to a widget when the fake caret was activated using arrow\n\t * keys but it responds to typing keystrokes instead of <kbd>Enter</kbd>.\n\t *\n\t * \"Typing keystrokes\" are keystrokes that insert new content into the document,\n\t * for instance, letters (\"a\") or numbers (\"4\"). The \"keydown\" listener enabled by this method\n\t * will insert a new paragraph according to the `widget-type-around` model selection attribute\n\t * as the user simply starts typing, which creates the impression that the fake caret\n\t * behaves like a real one rendered by the browser (AKA your text appears where the caret was).\n\t *\n\t * **Note**: At the moment this listener creates 2 undo steps: one for the `insertParagraph` command\n\t * and another one for actual typing. It is not a disaster but this may need to be fixed\n\t * sooner or later.\n\t *\n\t * Learn more in {@link module:typing/utils/injectunsafekeystrokeshandling}.\n\t *\n\t * @private\n\t */\n\t_enableInsertingParagraphsOnTypingKeystroke() {\n\t\tconst editor = this.editor;\n\t\tconst editingView = editor.editing.view;\n\t\tconst keyCodesHandledSomewhereElse = [\n\t\t\tkeyCodes.enter,\n\t\t\tkeyCodes.delete,\n\t\t\tkeyCodes.backspace\n\t\t];\n\n\t\t// Note: The priority must precede the default observers.\n\t\tthis._listenToIfEnabled( editingView.document, 'keydown', ( evt, domEventData ) => {\n\t\t\t// Don't handle enter/backspace/delete here. They are handled in dedicated listeners.\n\t\t\tif ( !keyCodesHandledSomewhereElse.includes( domEventData.keyCode ) && !isNonTypingKeystroke( domEventData ) ) {\n\t\t\t\tthis._insertParagraphAccordingToFakeCaretPosition();\n\t\t\t}\n\t\t}, { priority: 'high' } );\n\t}\n\n\t/**\n\t * It creates a \"delete\" event listener on the view document to handle cases when the <kbd>Delete</kbd> or <kbd>Backspace</kbd>\n\t * is pressed and the fake caret is currently active.\n\t *\n\t * The fake caret should create an illusion of a real browser caret so that when it appears before or after\n\t * a widget, pressing <kbd>Delete</kbd> or <kbd>Backspace</kbd> should remove a widget or delete the content\n\t * before or after a widget (depending on the content surrounding the widget).\n\t *\n\t * @private\n\t */\n\t_enableDeleteIntegration() {\n\t\tconst editor = this.editor;\n\t\tconst editingView = editor.editing.view;\n\t\tconst model = editor.model;\n\t\tconst schema = model.schema;\n\n\t\tthis._listenToIfEnabled( editingView.document, 'delete', ( evt, domEventData ) => {\n\t\t\t// This event could be triggered from inside the widget but we are interested\n\t\t\t// only when the widget is selected itself.\n\t\t\tif ( evt.eventPhase != 'atTarget' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst typeAroundFakeCaretPosition = getTypeAroundFakeCaretPosition( model.document.selection );\n\n\t\t\t// This listener handles only these cases when the fake caret is active.\n\t\t\tif ( !typeAroundFakeCaretPosition ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst direction = domEventData.direction;\n\t\t\tconst selectedModelWidget = model.document.selection.getSelectedElement();\n\n\t\t\tconst isFakeCaretBefore = typeAroundFakeCaretPosition === 'before';\n\t\t\tconst isDeleteForward = direction == 'forward';\n\t\t\tconst shouldDeleteEntireWidget = isFakeCaretBefore === isDeleteForward;\n\n\t\t\tif ( shouldDeleteEntireWidget ) {\n\t\t\t\teditor.execute( 'delete', {\n\t\t\t\t\tselection: model.createSelection( selectedModelWidget, 'on' )\n\t\t\t\t} );\n\t\t\t} else {\n\t\t\t\tconst range = schema.getNearestSelectionRange(\n\t\t\t\t\tmodel.createPositionAt( selectedModelWidget, typeAroundFakeCaretPosition ),\n\t\t\t\t\tdirection\n\t\t\t\t);\n\n\t\t\t\t// If there is somewhere to move selection to, then there will be something to delete.\n\t\t\t\tif ( range ) {\n\t\t\t\t\t// If the range is NOT collapsed, then we know that the range contains an object (see getNearestSelectionRange() docs).\n\t\t\t\t\tif ( !range.isCollapsed ) {\n\t\t\t\t\t\tmodel.change( writer => {\n\t\t\t\t\t\t\twriter.setSelection( range );\n\t\t\t\t\t\t\teditor.execute( isDeleteForward ? 'deleteForward' : 'delete' );\n\t\t\t\t\t\t} );\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst probe = model.createSelection( range.start );\n\t\t\t\t\t\tmodel.modifySelection( probe, { direction } );\n\n\t\t\t\t\t\t// If the range is collapsed, let's see if a non-collapsed range exists that can could be deleted.\n\t\t\t\t\t\t// If such range exists, use the editor command because it it safe for collaboration (it merges where it can).\n\t\t\t\t\t\tif ( !probe.focus.isEqual( range.start ) ) {\n\t\t\t\t\t\t\tmodel.change( writer => {\n\t\t\t\t\t\t\t\twriter.setSelection( range );\n\t\t\t\t\t\t\t\teditor.execute( isDeleteForward ? 'deleteForward' : 'delete' );\n\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// If there is no non-collapsed range to be deleted then we are sure that there is an empty element\n\t\t\t\t\t\t// next to a widget that should be removed. \"delete\" and \"deleteForward\" commands cannot get rid of it\n\t\t\t\t\t\t// so calling Model#deleteContent here manually.\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tconst deepestEmptyRangeAncestor = getDeepestEmptyElementAncestor( schema, range.start.parent );\n\n\t\t\t\t\t\t\tmodel.deleteContent( model.createSelection( deepestEmptyRangeAncestor, 'on' ), {\n\t\t\t\t\t\t\t\tdoNotAutoparagraph: true\n\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// If some content was deleted, don't let the handler from the Widget plugin kick in.\n\t\t\t// If nothing was deleted, then the default handler will have nothing to do anyway.\n\t\t\tdomEventData.preventDefault();\n\t\t\tevt.stop();\n\t\t}, { context: isWidget } );\n\t}\n\n\t/**\n\t * Attaches the {@link module:engine/model/model~Model#event:insertContent} event listener that, for instance, allows the user to paste\n\t * content near a widget when the fake caret is first activated using the arrow keys.\n\t *\n\t * The content is inserted according to the `widget-type-around` selection attribute (see {@link #_handleArrowKeyPress}).\n\t *\n\t * @private\n\t */\n\t_enableInsertContentIntegration() {\n\t\tconst editor = this.editor;\n\t\tconst model = this.editor.model;\n\t\tconst documentSelection = model.document.selection;\n\n\t\tthis._listenToIfEnabled( editor.model, 'insertContent', ( evt, [ content, selectable ] ) => {\n\t\t\tif ( selectable && !selectable.is( 'documentSelection' ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst typeAroundFakeCaretPosition = getTypeAroundFakeCaretPosition( documentSelection );\n\n\t\t\tif ( !typeAroundFakeCaretPosition ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tevt.stop();\n\n\t\t\treturn model.change( writer => {\n\t\t\t\tconst selectedElement = documentSelection.getSelectedElement();\n\t\t\t\tconst position = model.createPositionAt( selectedElement, typeAroundFakeCaretPosition );\n\t\t\t\tconst selection = writer.createSelection( position );\n\n\t\t\t\tconst result = model.insertContent( content, selection );\n\n\t\t\t\twriter.setSelection( selection );\n\n\t\t\t\treturn result;\n\t\t\t} );\n\t\t}, { priority: 'high' } );\n\t}\n}\n\n// Injects the type around UI into a view widget instance.\n//\n// @param {module:engine/view/downcastwriter~DowncastWriter} viewWriter\n// @param {Object.<String,String>} buttonTitles\n// @param {module:engine/view/element~Element} widgetViewElement\nfunction injectUIIntoWidget( viewWriter, buttonTitles, widgetViewElement ) {\n\tconst typeAroundWrapper = viewWriter.createUIElement( 'div', {\n\t\tclass: 'ck ck-reset_all ck-widget__type-around'\n\t}, function( domDocument ) {\n\t\tconst wrapperDomElement = this.toDomElement( domDocument );\n\n\t\tinjectButtons( wrapperDomElement, buttonTitles );\n\t\tinjectFakeCaret( wrapperDomElement );\n\n\t\treturn wrapperDomElement;\n\t} );\n\n\t// Inject the type around wrapper into the widget's wrapper.\n\tviewWriter.insert( viewWriter.createPositionAt( widgetViewElement, 'end' ), typeAroundWrapper );\n}\n\n// FYI: Not using the IconView class because each instance would need to be destroyed to avoid memory leaks\n// and it's pretty hard to figure out when a view (widget) is gone for good so it's cheaper to use raw\n// <svg> here.\n//\n// @param {HTMLElement} wrapperDomElement\n// @param {Object.<String,String>} buttonTitles\nfunction injectButtons( wrapperDomElement, buttonTitles ) {\n\tfor ( const position of POSSIBLE_INSERTION_POSITIONS ) {\n\t\tconst buttonTemplate = new Template( {\n\t\t\ttag: 'div',\n\t\t\tattributes: {\n\t\t\t\tclass: [\n\t\t\t\t\t'ck',\n\t\t\t\t\t'ck-widget__type-around__button',\n\t\t\t\t\t`ck-widget__type-around__button_${ position }`\n\t\t\t\t],\n\t\t\t\ttitle: buttonTitles[ position ]\n\t\t\t},\n\t\t\tchildren: [\n\t\t\t\twrapperDomElement.ownerDocument.importNode( RETURN_ARROW_ICON_ELEMENT, true )\n\t\t\t]\n\t\t} );\n\n\t\twrapperDomElement.appendChild( buttonTemplate.render() );\n\t}\n}\n\n// @param {HTMLElement} wrapperDomElement\nfunction injectFakeCaret( wrapperDomElement ) {\n\tconst caretTemplate = new Template( {\n\t\ttag: 'div',\n\t\tattributes: {\n\t\t\tclass: [\n\t\t\t\t'ck',\n\t\t\t\t'ck-widget__type-around__fake-caret'\n\t\t\t]\n\t\t}\n\t} );\n\n\twrapperDomElement.appendChild( caretTemplate.render() );\n}\n\n// Returns the ancestor of an element closest to the root which is empty. For instance,\n// for `<baz>`:\n//\n//\t\t<foo>abc<bar><baz></baz></bar></foo>\n//\n// it returns `<bar>`.\n//\n// @param {module:engine/model/schema~Schema} schema\n// @param {module:engine/model/element~Element} element\n// @returns {module:engine/model/element~Element|null}\nfunction getDeepestEmptyElementAncestor( schema, element ) {\n\tlet deepestEmptyAncestor = element;\n\n\tfor ( const ancestor of element.getAncestors( { parentFirst: true } ) ) {\n\t\tif ( ancestor.childCount > 1 || schema.isLimit( ancestor ) ) {\n\t\t\tbreak;\n\t\t}\n\n\t\tdeepestEmptyAncestor = ancestor;\n\t}\n\n\treturn deepestEmptyAncestor;\n}\n"]}]}