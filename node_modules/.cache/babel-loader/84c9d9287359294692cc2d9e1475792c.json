{"remainingRequest":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js?{}!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/model/documentselection.js","dependencies":[{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/model/documentselection.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9zbGljZWRUb0FycmF5IGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vc2xpY2VkVG9BcnJheSI7CmltcG9ydCBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlciBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIiOwppbXBvcnQgX2Fzc2VydFRoaXNJbml0aWFsaXplZCBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2Fzc2VydFRoaXNJbml0aWFsaXplZCI7CmltcG9ydCBfZ2V0IGZyb20gIi9ob21lL2VrZWJlcmF0L1lhbmRleC5EaXNrL1Byb2plbGVyaW0vQmVuaW1Qcm9qZWxlcmltL3dlYnNpdGVtL3dlYnNpdGVtLXdlYi9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2luaGVyaXRzIjsKaW1wb3J0IF9jcmVhdGVTdXBlciBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NyZWF0ZVN1cGVyIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NyZWF0ZUNsYXNzIjsKaW1wb3J0ICJyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuYW5jaG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnN0YXJ0cy13aXRoLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubWFwLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zZXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zcGxpY2UuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5mcm9tLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5jbHVkZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuZXhlYy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5zcGxpdC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5maWx0ZXIuanMiOwoKLyoqCiAqIEBsaWNlbnNlIENvcHlyaWdodCAoYykgMjAwMy0yMDIxLCBDS1NvdXJjZSAtIEZyZWRlcmljbyBLbmFiYmVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBGb3IgbGljZW5zaW5nLCBzZWUgTElDRU5TRS5tZCBvciBodHRwczovL2NrZWRpdG9yLmNvbS9sZWdhbC9ja2VkaXRvci1vc3MtbGljZW5zZQogKi8KCi8qKgogKiBAbW9kdWxlIGVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbgogKi8KaW1wb3J0IG1peCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9taXgnOwppbXBvcnQgRW1pdHRlck1peGluIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2VtaXR0ZXJtaXhpbic7CmltcG9ydCBTZWxlY3Rpb24gZnJvbSAnLi9zZWxlY3Rpb24nOwppbXBvcnQgTGl2ZVJhbmdlIGZyb20gJy4vbGl2ZXJhbmdlJzsKaW1wb3J0IFRleHQgZnJvbSAnLi90ZXh0JzsKaW1wb3J0IFRleHRQcm94eSBmcm9tICcuL3RleHRwcm94eSc7CmltcG9ydCB0b01hcCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy90b21hcCc7CmltcG9ydCBDb2xsZWN0aW9uIGZyb20gJ0Bja2VkaXRvci9ja2VkaXRvcjUtdXRpbHMvc3JjL2NvbGxlY3Rpb24nOwppbXBvcnQgQ0tFZGl0b3JFcnJvciBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9ja2VkaXRvcmVycm9yJzsKaW1wb3J0IHVpZCBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy91aWQnOwp2YXIgc3RvcmVQcmVmaXggPSAnc2VsZWN0aW9uOic7Ci8qKgogKiBgRG9jdW1lbnRTZWxlY3Rpb25gIGlzIGEgc3BlY2lhbCBzZWxlY3Rpb24gd2hpY2ggaXMgdXNlZCBhcyB0aGUKICoge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnQjc2VsZWN0aW9uIGRvY3VtZW50J3Mgc2VsZWN0aW9ufS4KICogVGhlcmUgY2FuIGJlIG9ubHkgb25lIGluc3RhbmNlIG9mIGBEb2N1bWVudFNlbGVjdGlvbmAgcGVyIGRvY3VtZW50LgogKgogKiBEb2N1bWVudCBzZWxlY3Rpb24gY2FuIG9ubHkgYmUgY2hhbmdlZCBieSB1c2luZyB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlcn0gaW5zdGFuY2UKICogaW5zaWRlIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9tb2RlbH5Nb2RlbCNjaGFuZ2UgYGNoYW5nZSgpYH0gYmxvY2ssIGFzIGl0IHByb3ZpZGVzIGEgc2VjdXJlIHdheSB0byBtb2RpZnkgbW9kZWwuCiAqCiAqIGBEb2N1bWVudFNlbGVjdGlvbmAgaXMgYXV0b21hdGljYWxseSB1cGRhdGVkIHVwb24gY2hhbmdlcyBpbiB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnQgZG9jdW1lbnR9CiAqIHRvIGFsd2F5cyBjb250YWluIHZhbGlkIHJhbmdlcy4gSXRzIGF0dHJpYnV0ZXMgYXJlIGluaGVyaXRlZCBmcm9tIHRoZSB0ZXh0IHVubGVzcyBzZXQgZXhwbGljaXRseS4KICoKICogRGlmZmVyZW5jZXMgYmV0d2VlbiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9ufSBhbmQgYERvY3VtZW50U2VsZWN0aW9uYCBhcmU6CiAqICogdGhlcmUgaXMgYWx3YXlzIGEgcmFuZ2UgaW4gYERvY3VtZW50U2VsZWN0aW9uYCAtIGV2ZW4gaWYgbm8gcmFuZ2VzIHdlcmUgYWRkZWQgdGhlcmUgaXMgYSAiZGVmYXVsdCByYW5nZSIKICogcHJlc2VudCBpbiB0aGUgc2VsZWN0aW9uLAogKiAqIHJhbmdlcyBhZGRlZCB0byB0aGlzIHNlbGVjdGlvbiB1cGRhdGVzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGUgZG9jdW1lbnQgY2hhbmdlcywKICogKiBhdHRyaWJ1dGVzIG9mIGBEb2N1bWVudFNlbGVjdGlvbmAgYXJlIHVwZGF0ZWQgYXV0b21hdGljYWxseSBhY2NvcmRpbmcgdG8gc2VsZWN0aW9uIHJhbmdlcy4KICoKICogU2luY2UgYERvY3VtZW50U2VsZWN0aW9uYCB1c2VzIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2xpdmVyYW5nZX5MaXZlUmFuZ2UgbGl2ZSByYW5nZXN9CiAqIGFuZCBpcyB1cGRhdGVkIHdoZW4ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnQgZG9jdW1lbnR9CiAqIGNoYW5nZXMsIGl0IGNhbm5vdCBiZSBzZXQgb24ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvbm9kZX5Ob2RlIG5vZGVzfQogKiB0aGF0IGFyZSBpbnNpZGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRmcmFnbWVudH5Eb2N1bWVudEZyYWdtZW50IGRvY3VtZW50IGZyYWdtZW50fS4KICogSWYgeW91IG5lZWQgdG8gcmVwcmVzZW50IGEgc2VsZWN0aW9uIGluIGRvY3VtZW50IGZyYWdtZW50LAogKiB1c2Uge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbiBTZWxlY3Rpb24gY2xhc3N9IGluc3RlYWQuCiAqCiAqIEBtaXhlcyBtb2R1bGU6dXRpbHMvZW1pdHRlcm1peGlufkVtaXR0ZXJNaXhpbgogKi8KCnZhciBEb2N1bWVudFNlbGVjdGlvbiA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhbiBlbXB0eSBsaXZlIHNlbGVjdGlvbiBmb3IgZ2l2ZW4ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnR9LgogICAqCiAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50fSBkb2MgRG9jdW1lbnQgd2hpY2ggb3ducyB0aGlzIHNlbGVjdGlvbi4KICAgKi8KICBmdW5jdGlvbiBEb2N1bWVudFNlbGVjdGlvbihkb2MpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBEb2N1bWVudFNlbGVjdGlvbik7CgogICAgLyoqCiAgICAgKiBTZWxlY3Rpb24gdXNlZCBpbnRlcm5hbGx5IGJ5IHRoYXQgY2xhc3MgKGBEb2N1bWVudFNlbGVjdGlvbmAgaXMgYSBwcm94eSB0byB0aGF0IHNlbGVjdGlvbikuCiAgICAgKgogICAgICogQHByb3RlY3RlZAogICAgICovCiAgICB0aGlzLl9zZWxlY3Rpb24gPSBuZXcgTGl2ZVNlbGVjdGlvbihkb2MpOwoKICAgIHRoaXMuX3NlbGVjdGlvbi5kZWxlZ2F0ZSgnY2hhbmdlOnJhbmdlJykudG8odGhpcyk7CgogICAgdGhpcy5fc2VsZWN0aW9uLmRlbGVnYXRlKCdjaGFuZ2U6YXR0cmlidXRlJykudG8odGhpcyk7CgogICAgdGhpcy5fc2VsZWN0aW9uLmRlbGVnYXRlKCdjaGFuZ2U6bWFya2VyJykudG8odGhpcyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgd2hldGhlciB0aGUgc2VsZWN0aW9uIGlzIGNvbGxhcHNlZC4gU2VsZWN0aW9uIGlzIGNvbGxhcHNlZCB3aGVuIHRoZXJlIGlzIGV4YWN0bHkgb25lIHJhbmdlIHdoaWNoIGlzCiAgICogY29sbGFwc2VkLgogICAqCiAgICogQHJlYWRvbmx5CiAgICogQHR5cGUge0Jvb2xlYW59CiAgICovCgoKICBfY3JlYXRlQ2xhc3MoRG9jdW1lbnRTZWxlY3Rpb24sIFt7CiAgICBrZXk6ICJpc0NvbGxhcHNlZCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5pc0NvbGxhcHNlZDsKICAgIH0KICAgIC8qKgogICAgICogU2VsZWN0aW9uIGFuY2hvci4gQW5jaG9yIG1heSBiZSBkZXNjcmliZWQgYXMgYSBwb3NpdGlvbiB3aGVyZSB0aGUgbW9zdCByZWNlbnQgcGFydCBvZiB0aGUgc2VsZWN0aW9uIHN0YXJ0cy4KICAgICAqIFRvZ2V0aGVyIHdpdGgge0BsaW5rICNmb2N1c30gdGhleSBkZWZpbmUgdGhlIGRpcmVjdGlvbiBvZiBzZWxlY3Rpb24sIHdoaWNoIGlzIGltcG9ydGFudAogICAgICogd2hlbiBleHBhbmRpbmcvc2hyaW5raW5nIHNlbGVjdGlvbi4gQW5jaG9yIGlzIGFsd2F5cyB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZSNzdGFydCBzdGFydH0gb3IKICAgICAqIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlI2VuZCBlbmR9IHBvc2l0aW9uIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFkZGVkIHJhbmdlLgogICAgICoKICAgICAqIElzIHNldCB0byBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHNlZSAjZm9jdXMKICAgICAqIEByZWFkb25seQogICAgICogQHR5cGUge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb258bnVsbH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJhbmNob3IiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uYW5jaG9yOwogICAgfQogICAgLyoqCiAgICAgKiBTZWxlY3Rpb24gZm9jdXMuIEZvY3VzIGlzIGEgcG9zaXRpb24gd2hlcmUgdGhlIHNlbGVjdGlvbiBlbmRzLgogICAgICoKICAgICAqIElzIHNldCB0byBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHNlZSAjYW5jaG9yCiAgICAgKiBAcmVhZG9ubHkKICAgICAqIEB0eXBlIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufG51bGx9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZm9jdXMiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uZm9jdXM7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgbnVtYmVyIG9mIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICovCgogIH0sIHsKICAgIGtleTogInJhbmdlQ291bnQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24ucmFuZ2VDb3VudDsKICAgIH0KICAgIC8qKgogICAgICogRGVzY3JpYmVzIHdoZXRoZXIgYERvY3VtZW50c2VsZWN0aW9uYCBoYXMgb3duIHJhbmdlKHMpIHNldCwgb3IgaWYgaXQgaXMgZGVmYXVsdGVkIHRvCiAgICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudCNfZ2V0RGVmYXVsdFJhbmdlIGRvY3VtZW50J3MgZGVmYXVsdCByYW5nZX0uCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJoYXNPd25SYW5nZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5oYXNPd25SYW5nZTsKICAgIH0KICAgIC8qKgogICAgICogU3BlY2lmaWVzIHdoZXRoZXIgdGhlIHtAbGluayAjZm9jdXN9CiAgICAgKiBwcmVjZWRlcyB7QGxpbmsgI2FuY2hvcn0uCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJpc0JhY2t3YXJkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmlzQmFja3dhcmQ7CiAgICB9CiAgICAvKioKICAgICAqIERlc2NyaWJlcyB3aGV0aGVyIHRoZSBncmF2aXR5IGlzIG92ZXJyaWRkZW4gKHVzaW5nIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjb3ZlcnJpZGVTZWxlY3Rpb25HcmF2aXR5fSkgb3Igbm90LgogICAgICoKICAgICAqIE5vdGUgdGhhdCB0aGUgZ3Jhdml0eSByZW1haW5zIG92ZXJyaWRkZW4gYXMgbG9uZyBhcyB3aWxsIG5vdCBiZSByZXN0b3JlZCB0aGUgc2FtZSBudW1iZXIgb2YgdGltZXMgYXMgaXQgd2FzIG92ZXJyaWRkZW4uCiAgICAgKgogICAgICogQHJlYWRvbmx5CiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJpc0dyYXZpdHlPdmVycmlkZGVuIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmlzR3Jhdml0eU92ZXJyaWRkZW47CiAgICB9CiAgICAvKioKICAgICAqIEEgY29sbGVjdGlvbiBvZiBzZWxlY3Rpb24ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvbWFya2VyY29sbGVjdGlvbn5NYXJrZXIgbWFya2Vyc30uCiAgICAgKiBNYXJrZXIgaXMgYSBzZWxlY3Rpb24gbWFya2VyIHdoZW4gc2VsZWN0aW9uIHJhbmdlIGlzIGluc2lkZSB0aGUgbWFya2VyIHJhbmdlLgogICAgICoKICAgICAqICoqTm90ZSoqOiBPbmx5IG1hcmtlcnMgZnJvbSB7QGxpbmsgfkRvY3VtZW50U2VsZWN0aW9uI29ic2VydmVNYXJrZXJzIG9ic2VydmVkIG1hcmtlcnMgZ3JvdXBzfSBhcmUgY29sbGVjdGVkLgogICAgICoKICAgICAqIEByZWFkb25seQogICAgICogQHR5cGUge21vZHVsZTp1dGlscy9jb2xsZWN0aW9ufkNvbGxlY3Rpb259CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAibWFya2VycyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5tYXJrZXJzOwogICAgfQogICAgLyoqCiAgICAgKiBVc2VkIGZvciB0aGUgY29tcGF0aWJpbGl0eSB3aXRoIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9uI2lzRXF1YWx9IG1ldGhvZC4KICAgICAqCiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3JhbmdlcyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5fcmFuZ2VzOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFuIGl0ZXJhYmxlIHRoYXQgaXRlcmF0ZXMgb3ZlciBjb3BpZXMgb2Ygc2VsZWN0aW9uIHJhbmdlcy4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPG1vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2U+fQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFJhbmdlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0UmFuZ2VzKCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldFJhbmdlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSBmaXJzdCBwb3NpdGlvbiBpbiB0aGUgc2VsZWN0aW9uLgogICAgICogRmlyc3QgcG9zaXRpb24gaXMgdGhlIHBvc2l0aW9uIHRoYXQge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb24jaXNCZWZvcmUgaXMgYmVmb3JlfQogICAgICogYW55IG90aGVyIHBvc2l0aW9uIGluIHRoZSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogUmV0dXJucyBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb258bnVsbH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRGaXJzdFBvc2l0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGaXJzdFBvc2l0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldEZpcnN0UG9zaXRpb24oKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbGFzdCBwb3NpdGlvbiBpbiB0aGUgc2VsZWN0aW9uLgogICAgICogTGFzdCBwb3NpdGlvbiBpcyB0aGUgcG9zaXRpb24gdGhhdCB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbiNpc0FmdGVyIGlzIGFmdGVyfQogICAgICogYW55IG90aGVyIHBvc2l0aW9uIGluIHRoZSBzZWxlY3Rpb24uCiAgICAgKgogICAgICogUmV0dXJucyBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb258bnVsbH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRMYXN0UG9zaXRpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldExhc3RQb3NpdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5nZXRMYXN0UG9zaXRpb24oKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvcHkgb2YgdGhlIGZpcnN0IHJhbmdlIGluIHRoZSBzZWxlY3Rpb24uCiAgICAgKiBGaXJzdCByYW5nZSBpcyB0aGUgb25lIHdoaWNoIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlI3N0YXJ0IHN0YXJ0fSBwb3NpdGlvbgogICAgICoge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb24jaXNCZWZvcmUgaXMgYmVmb3JlfSBzdGFydCBwb3NpdGlvbiBvZiBhbGwgb3RoZXIgcmFuZ2VzCiAgICAgKiAobm90IHRvIGNvbmZ1c2Ugd2l0aCB0aGUgZmlyc3QgcmFuZ2UgYWRkZWQgdG8gdGhlIHNlbGVjdGlvbikuCiAgICAgKgogICAgICogUmV0dXJucyBgbnVsbGAgaWYgdGhlcmUgYXJlIG5vIHJhbmdlcyBpbiBzZWxlY3Rpb24uCiAgICAgKgogICAgICogQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V8bnVsbH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRGaXJzdFJhbmdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGaXJzdFJhbmdlKCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldEZpcnN0UmFuZ2UoKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGNvcHkgb2YgdGhlIGxhc3QgcmFuZ2UgaW4gdGhlIHNlbGVjdGlvbi4KICAgICAqIExhc3QgcmFuZ2UgaXMgdGhlIG9uZSB3aGljaCB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZSNlbmQgZW5kfSBwb3NpdGlvbgogICAgICoge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb24jaXNBZnRlciBpcyBhZnRlcn0gZW5kIHBvc2l0aW9uIG9mIGFsbCBvdGhlciByYW5nZXMgKG5vdCB0byBjb25mdXNlIHdpdGggdGhlIHJhbmdlIG1vc3QKICAgICAqIHJlY2VudGx5IGFkZGVkIHRvIHRoZSBzZWxlY3Rpb24pLgogICAgICoKICAgICAqIFJldHVybnMgYG51bGxgIGlmIHRoZXJlIGFyZSBubyByYW5nZXMgaW4gc2VsZWN0aW9uLgogICAgICoKICAgICAqIEByZXR1cm5zIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfG51bGx9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0TGFzdFJhbmdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRMYXN0UmFuZ2UoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uZ2V0TGFzdFJhbmdlKCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldHMgZWxlbWVudHMgb2YgdHlwZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zY2hlbWF+U2NoZW1hI2lzQmxvY2sgImJsb2NrIn0gdG91Y2hlZCBieSB0aGUgc2VsZWN0aW9uLgogICAgICoKICAgICAqIFRoaXMgbWV0aG9kJ3MgcmVzdWx0IGNhbiBiZSB1c2VkIGZvciBleGFtcGxlIHRvIGFwcGx5IGJsb2NrIHN0eWxpbmcgdG8gYWxsIGJsb2NrcyBjb3ZlcmVkIGJ5IHRoaXMgc2VsZWN0aW9uLgogICAgICoKICAgICAqICoqTm90ZToqKiBgZ2V0U2VsZWN0ZWRCbG9ja3MoKWAgcmV0dXJucyBibG9ja3MgdGhhdCBhcmUgbmVzdGVkIGluIG90aGVyIG5vbi1ibG9jayBlbGVtZW50cwogICAgICogYnV0IHdpbGwgbm90IHJldHVybiBibG9ja3MgbmVzdGVkIGluIG90aGVyIGJsb2Nrcy4KICAgICAqCiAgICAgKiBJbiB0aGlzIGNhc2UgdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIGV4YWN0bHkgYWxsIDMgcGFyYWdyYXBocyAobm90ZTogYDxibG9ja1F1b3RlPmAgaXMgbm90IGEgYmxvY2sgaXRzZWxmKToKICAgICAqCiAgICAgKgkJPHBhcmFncmFwaD5bYTwvcGFyYWdyYXBoPgogICAgICoJCTxibG9ja1F1b3RlPgogICAgICoJCQk8cGFyYWdyYXBoPmI8L3BhcmFncmFwaD4KICAgICAqCQk8L2Jsb2NrUXVvdGU+CiAgICAgKgkJPHBhcmFncmFwaD5jXWQ8L3BhcmFncmFwaD4KICAgICAqCiAgICAgKiBJbiB0aGlzIGNhc2UgdGhlIHBhcmFncmFwaCB3aWxsIGFsc28gYmUgcmV0dXJuZWQsIGRlc3BpdGUgdGhlIGNvbGxhcHNlZCBzZWxlY3Rpb246CiAgICAgKgogICAgICoJCTxwYXJhZ3JhcGg+W11hPC9wYXJhZ3JhcGg+CiAgICAgKgogICAgICogSW4gc3VjaCBhIHNjZW5hcmlvLCBob3dldmVyLCBvbmx5IGJsb2NrcyBBLCBCICYgRSB3aWxsIGJlIHJldHVybmVkIGFzIGJsb2NrcyBDICYgRCBhcmUgbmVzdGVkIGluIGJsb2NrIEI6CiAgICAgKgogICAgICoJCVs8YmxvY2tBPjwvYmxvY2tBPgogICAgICoJCTxibG9ja0I+CiAgICAgKgkJCTxibG9ja0M+PC9ibG9ja0M+CiAgICAgKgkJCTxibG9ja0Q+PC9ibG9ja0Q+CiAgICAgKgkJPC9ibG9ja0I+CiAgICAgKgkJPGJsb2NrRT48L2Jsb2NrRT5dCiAgICAgKgogICAgICogSWYgdGhlIHNlbGVjdGlvbiBpcyBpbnNpZGUgYSBibG9jayBhbGwgdGhlIGlubmVyIGJsb2NrcyAoQSAmIEIpIGFyZSByZXR1cm5lZDoKICAgICAqCiAgICAgKiAJCTxibG9jaz4KICAgICAqCQkJPGJsb2NrQT5bYTwvYmxvY2tBPgogICAgICogCQkJPGJsb2NrQj5iXTwvYmxvY2tCPgogICAgICogCQk8L2Jsb2NrPgogICAgICoKICAgICAqICoqU3BlY2lhbCBjYXNlKio6IElmIGEgc2VsZWN0aW9uIGVuZHMgYXQgdGhlIGJlZ2lubmluZyBvZiBhIGJsb2NrLCB0aGF0IGJsb2NrIGlzIG5vdCByZXR1cm5lZCBhcyBmcm9tIHVzZXIgcGVyc3BlY3RpdmUKICAgICAqIHRoaXMgYmxvY2sgd2Fzbid0IHNlbGVjdGVkLiBTZWUgWyM5ODRdKGh0dHBzOi8vZ2l0aHViLmNvbS9ja2VkaXRvci9ja2VkaXRvcjUtZW5naW5lL2lzc3Vlcy85ODQpIGZvciBtb3JlIGRldGFpbHMuCiAgICAgKgogICAgICoJCTxwYXJhZ3JhcGg+W2E8L3BhcmFncmFwaD4KICAgICAqCQk8cGFyYWdyYXBoPmI8L3BhcmFncmFwaD4KICAgICAqCQk8cGFyYWdyYXBoPl1jPC9wYXJhZ3JhcGg+IC8vIHRoaXMgYmxvY2sgd2lsbCBub3QgYmUgcmV0dXJuZWQKICAgICAqCiAgICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPG1vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50Pn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRTZWxlY3RlZEJsb2NrcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U2VsZWN0ZWRCbG9ja3MoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uZ2V0U2VsZWN0ZWRCbG9ja3MoKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgc2VsZWN0ZWQgZWxlbWVudC4ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZWxlbWVudH5FbGVtZW50IEVsZW1lbnR9IGlzIGNvbnNpZGVyZWQgYXMgc2VsZWN0ZWQgaWYgdGhlcmUgaXMgb25seQogICAgICogb25lIHJhbmdlIGluIHRoZSBzZWxlY3Rpb24sIGFuZCB0aGF0IHJhbmdlIGNvbnRhaW5zIGV4YWN0bHkgb25lIGVsZW1lbnQuCiAgICAgKiBSZXR1cm5zIGBudWxsYCBpZiB0aGVyZSBpcyBubyBzZWxlY3RlZCBlbGVtZW50LgogICAgICoKICAgICAqIEByZXR1cm5zIHttb2R1bGU6ZW5naW5lL21vZGVsL2VsZW1lbnR+RWxlbWVudHxudWxsfQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFNlbGVjdGVkRWxlbWVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U2VsZWN0ZWRFbGVtZW50KCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldFNlbGVjdGVkRWxlbWVudCgpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgc2VsZWN0aW9uIGNvbnRhaW5zIHRoZSBlbnRpcmUgY29udGVudCBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4gVGhpcyBtZWFucyB0aGF0IHNlbGVjdGlvbiBtdXN0IHN0YXJ0CiAgICAgKiBhdCBhIHBvc2l0aW9uIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9uI2lzVG91Y2hpbmcgdG91Y2hpbmd9IHRoZSBlbGVtZW50J3Mgc3RhcnQgYW5kIGVuZHMgYXQgcG9zaXRpb24KICAgICAqIHRvdWNoaW5nIHRoZSBlbGVtZW50J3MgZW5kLgogICAgICoKICAgICAqIEJ5IGRlZmF1bHQsIHRoaXMgbWV0aG9kIHdpbGwgY2hlY2sgd2hldGhlciB0aGUgZW50aXJlIGNvbnRlbnQgb2YgdGhlIHNlbGVjdGlvbidzIGN1cnJlbnQgcm9vdCBpcyBzZWxlY3RlZC4KICAgICAqIFVzZWZ1bCB0byBjaGVjayBpZiBlLmcuIHRoZSB1c2VyIGhhcyBqdXN0IHByZXNzZWQgPGtiZD5DdHJsPC9rYmQ+ICsgPGtiZD5BPC9rYmQ+LgogICAgICoKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnR9IFtlbGVtZW50PXRoaXMuYW5jaG9yLnJvb3RdCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjb250YWluc0VudGlyZUNvbnRlbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbnRhaW5zRW50aXJlQ29udGVudChlbGVtZW50KSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uY29udGFpbnNFbnRpcmVDb250ZW50KGVsZW1lbnQpOwogICAgfQogICAgLyoqCiAgICAgKiBVbmJpbmRzIGFsbCBldmVudHMgcHJldmlvdXNseSBib3VuZCBieSBkb2N1bWVudCBzZWxlY3Rpb24uCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZGVzdHJveSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdGhpcy5fc2VsZWN0aW9uLmRlc3Ryb3koKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIG92ZXIgdGhpcyBzZWxlY3Rpb24ncyBhdHRyaWJ1dGUga2V5cy4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPFN0cmluZz59CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0QXR0cmlidXRlS2V5cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QXR0cmlidXRlS2V5cygpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5nZXRBdHRyaWJ1dGVLZXlzKCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgaXRlcmFibGUgdGhhdCBpdGVyYXRlcyBvdmVyIHRoaXMgc2VsZWN0aW9uJ3MgYXR0cmlidXRlcy4KICAgICAqCiAgICAgKiBBdHRyaWJ1dGVzIGFyZSByZXR1cm5lZCBhcyBhcnJheXMgY29udGFpbmluZyB0d28gaXRlbXMuIEZpcnN0IG9uZSBpcyBhdHRyaWJ1dGUga2V5IGFuZCBzZWNvbmQgaXMgYXR0cmlidXRlIHZhbHVlLgogICAgICogVGhpcyBmb3JtYXQgaXMgYWNjZXB0ZWQgYnkgbmF0aXZlIGBNYXBgIG9iamVjdCBhbmQgYWxzbyBjYW4gYmUgcGFzc2VkIGluIGBOb2RlYCBjb25zdHJ1Y3Rvci4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPCo+fQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldEF0dHJpYnV0ZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEF0dHJpYnV0ZXMoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uZ2V0QXR0cmlidXRlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXRzIGFuIGF0dHJpYnV0ZSB2YWx1ZSBmb3IgZ2l2ZW4ga2V5IG9yIGB1bmRlZmluZWRgIGlmIHRoYXQgYXR0cmlidXRlIGlzIG5vdCBzZXQgb24gdGhlIHNlbGVjdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IEtleSBvZiBhdHRyaWJ1dGUgdG8gbG9vayBmb3IuCiAgICAgKiBAcmV0dXJucyB7Kn0gQXR0cmlidXRlIHZhbHVlIG9yIGB1bmRlZmluZWRgLgogICAgICovCgogIH0sIHsKICAgIGtleTogImdldEF0dHJpYnV0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QXR0cmlidXRlKGtleSkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uLmdldEF0dHJpYnV0ZShrZXkpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIHNlbGVjdGlvbiBoYXMgYW4gYXR0cmlidXRlIGZvciBnaXZlbiBrZXkuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBLZXkgb2YgYXR0cmlidXRlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge0Jvb2xlYW59IGB0cnVlYCBpZiBhdHRyaWJ1dGUgd2l0aCBnaXZlbiBrZXkgaXMgc2V0IG9uIHNlbGVjdGlvbiwgYGZhbHNlYCBvdGhlcndpc2UuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiaGFzQXR0cmlidXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBoYXNBdHRyaWJ1dGUoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24uaGFzQXR0cmlidXRlKGtleSk7CiAgICB9CiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBzZWxlY3Rpb24gYXR0cmlidXRlcyBhbmQgbWFya2VycyBhY2NvcmRpbmcgdG8gdGhlIGN1cnJlbnQgcG9zaXRpb24gaW4gdGhlIG1vZGVsLgogICAgICovCgogIH0sIHsKICAgIGtleTogInJlZnJlc2giLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlZnJlc2goKSB7CiAgICAgIHRoaXMuX3NlbGVjdGlvbi5fdXBkYXRlTWFya2VycygpOwoKICAgICAgdGhpcy5fc2VsZWN0aW9uLl91cGRhdGVBdHRyaWJ1dGVzKGZhbHNlKTsKICAgIH0KICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGEgbWFya2VyIGdyb3VwIHByZWZpeCBvciBhIG1hcmtlciBuYW1lIHRvIGJlIGNvbGxlY3RlZCBpbiB0aGUKICAgICAqIHtAbGluayB+RG9jdW1lbnRTZWxlY3Rpb24jbWFya2VycyBzZWxlY3Rpb24gbWFya2VycyBjb2xsZWN0aW9ufS4KICAgICAqCiAgICAgKiBTZWUgYWxzbyB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9tYXJrZXJjb2xsZWN0aW9ufk1hcmtlckNvbGxlY3Rpb24jZ2V0TWFya2Vyc0dyb3VwIGBNYXJrZXJDb2xsZWN0aW9uI2dldE1hcmtlcnNHcm91cCgpYH0uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IHByZWZpeE9yTmFtZSBUaGUgbWFya2VyIGdyb3VwIHByZWZpeCBvciBtYXJrZXIgbmFtZS4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJvYnNlcnZlTWFya2VycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb2JzZXJ2ZU1hcmtlcnMocHJlZml4T3JOYW1lKSB7CiAgICAgIHRoaXMuX3NlbGVjdGlvbi5vYnNlcnZlTWFya2VycyhwcmVmaXhPck5hbWUpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciB0aGlzIG9iamVjdCBpcyBvZiB0aGUgZ2l2ZW4gdHlwZS4KICAgICAqCiAgICAgKgkJc2VsZWN0aW9uLmlzKCAnc2VsZWN0aW9uJyApOyAvLyAtPiB0cnVlCiAgICAgKgkJc2VsZWN0aW9uLmlzKCAnZG9jdW1lbnRTZWxlY3Rpb24nICk7IC8vIC0+IHRydWUKICAgICAqCQlzZWxlY3Rpb24uaXMoICdtb2RlbDpzZWxlY3Rpb24nICk7IC8vIC0+IHRydWUKICAgICAqCQlzZWxlY3Rpb24uaXMoICdtb2RlbDpkb2N1bWVudFNlbGVjdGlvbicgKTsgLy8gLT4gdHJ1ZQogICAgICoKICAgICAqCQlzZWxlY3Rpb24uaXMoICd2aWV3OnNlbGVjdGlvbicgKTsgLy8gLT4gZmFsc2UKICAgICAqCQlzZWxlY3Rpb24uaXMoICdlbGVtZW50JyApOyAvLyAtPiBmYWxzZQogICAgICoJCXNlbGVjdGlvbi5pcyggJ25vZGUnICk7IC8vIC0+IGZhbHNlCiAgICAgKgogICAgICoge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvbm9kZX5Ob2RlI2lzIENoZWNrIHRoZSBlbnRpcmUgbGlzdCBvZiBtb2RlbCBvYmplY3RzfSB3aGljaCBpbXBsZW1lbnQgdGhlIGBpcygpYCBtZXRob2QuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqIEByZXR1cm5zIHtCb29sZWFufQogICAgICovCgogIH0sIHsKICAgIGtleTogImlzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpcyh0eXBlKSB7CiAgICAgIHJldHVybiB0eXBlID09PSAnc2VsZWN0aW9uJyB8fCB0eXBlID09ICdtb2RlbDpzZWxlY3Rpb24nIHx8IHR5cGUgPT0gJ2RvY3VtZW50U2VsZWN0aW9uJyB8fCB0eXBlID09ICdtb2RlbDpkb2N1bWVudFNlbGVjdGlvbic7CiAgICB9CiAgICAvKioKICAgICAqIE1vdmVzIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50c2VsZWN0aW9ufkRvY3VtZW50U2VsZWN0aW9uI2ZvY3VzfSB0byB0aGUgc3BlY2lmaWVkIGxvY2F0aW9uLgogICAgICogU2hvdWxkIGJlIHVzZWQgb25seSB3aXRoaW4gdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjc2V0U2VsZWN0aW9uRm9jdXN9IG1ldGhvZC4KICAgICAqCiAgICAgKiBUaGUgbG9jYXRpb24gY2FuIGJlIHNwZWNpZmllZCBpbiB0aGUgc2FtZSBmb3JtIGFzCiAgICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI2NyZWF0ZVBvc2l0aW9uQXQgd3JpdGVyLmNyZWF0ZVBvc2l0aW9uQXQoKX0gcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiBAc2VlIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNzZXRTZWxlY3Rpb25Gb2N1cwogICAgICogQHByb3RlY3RlZAogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL2l0ZW1+SXRlbXxtb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufSBpdGVtT3JQb3NpdGlvbgogICAgICogQHBhcmFtIHtOdW1iZXJ8J2VuZCd8J2JlZm9yZSd8J2FmdGVyJ30gW29mZnNldF0gT2Zmc2V0IG9yIG9uZSBvZiB0aGUgZmxhZ3MuIFVzZWQgb25seSB3aGVuCiAgICAgKiBmaXJzdCBwYXJhbWV0ZXIgaXMgYSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9pdGVtfkl0ZW0gbW9kZWwgaXRlbX0uCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3NldEZvY3VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfc2V0Rm9jdXMoaXRlbU9yUG9zaXRpb24sIG9mZnNldCkgewogICAgICB0aGlzLl9zZWxlY3Rpb24uc2V0Rm9jdXMoaXRlbU9yUG9zaXRpb24sIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgdGhpcyBzZWxlY3Rpb24ncyByYW5nZXMgYW5kIGRpcmVjdGlvbiB0byB0aGUgc3BlY2lmaWVkIGxvY2F0aW9uIGJhc2VkIG9uIHRoZSBnaXZlbgogICAgICoge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGFibGUgc2VsZWN0YWJsZX0uCiAgICAgKiBTaG91bGQgYmUgdXNlZCBvbmx5IHdpdGhpbiB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNzZXRTZWxlY3Rpb259IG1ldGhvZC4KICAgICAqCiAgICAgKiBAc2VlIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNzZXRTZWxlY3Rpb24KICAgICAqIEBwcm90ZWN0ZWQKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0YWJsZX0gc2VsZWN0YWJsZQogICAgICogQHBhcmFtIHtOdW1iZXJ8J2JlZm9yZSd8J2VuZCd8J2FmdGVyJ3wnb24nfCdpbid9IFtwbGFjZU9yT2Zmc2V0XSBTZXRzIHBsYWNlIG9yIG9mZnNldCBvZiB0aGUgc2VsZWN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXQogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5iYWNrd2FyZF0gU2V0cyB0aGlzIHNlbGVjdGlvbiBpbnN0YW5jZSB0byBiZSBiYWNrd2FyZC4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfc2V0VG8iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zZXRUbyhzZWxlY3RhYmxlLCBwbGFjZU9yT2Zmc2V0LCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX3NlbGVjdGlvbi5zZXRUbyhzZWxlY3RhYmxlLCBwbGFjZU9yT2Zmc2V0LCBvcHRpb25zKTsKICAgIH0KICAgIC8qKgogICAgICogU2V0cyBhdHRyaWJ1dGUgb24gdGhlIHNlbGVjdGlvbi4gSWYgYXR0cmlidXRlIHdpdGggdGhlIHNhbWUga2V5IGFscmVhZHkgaXMgc2V0LCBpdCdzIHZhbHVlIGlzIG92ZXJ3cml0dGVuLgogICAgICogU2hvdWxkIGJlIHVzZWQgb25seSB3aXRoaW4gdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjc2V0U2VsZWN0aW9uQXR0cmlidXRlfSBtZXRob2QuCiAgICAgKgogICAgICogQHNlZSBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIjc2V0U2VsZWN0aW9uQXR0cmlidXRlCiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IEtleSBvZiB0aGUgYXR0cmlidXRlIHRvIHNldC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgQXR0cmlidXRlIHZhbHVlLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9zZXRBdHRyaWJ1dGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSkgewogICAgICB0aGlzLl9zZWxlY3Rpb24uc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIGFuIGF0dHJpYnV0ZSB3aXRoIGdpdmVuIGtleSBmcm9tIHRoZSBzZWxlY3Rpb24uCiAgICAgKiBJZiB0aGUgZ2l2ZW4gYXR0cmlidXRlIHdhcyBzZXQgb24gdGhlIHNlbGVjdGlvbiwgZmlyZXMgdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb24jZXZlbnQ6Y2hhbmdlOnJhbmdlfQogICAgICogZXZlbnQgd2l0aCByZW1vdmVkIGF0dHJpYnV0ZSBrZXkuCiAgICAgKiBTaG91bGQgYmUgdXNlZCBvbmx5IHdpdGhpbiB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNyZW1vdmVTZWxlY3Rpb25BdHRyaWJ1dGV9IG1ldGhvZC4KICAgICAqCiAgICAgKiBAc2VlIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciNyZW1vdmVTZWxlY3Rpb25BdHRyaWJ1dGUKICAgICAqIEBwcm90ZWN0ZWQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgS2V5IG9mIHRoZSBhdHRyaWJ1dGUgdG8gcmVtb3ZlLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9yZW1vdmVBdHRyaWJ1dGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZW1vdmVBdHRyaWJ1dGUoa2V5KSB7CiAgICAgIHRoaXMuX3NlbGVjdGlvbi5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhbiBpdGVyYWJsZSB0aGF0IGl0ZXJhdGVzIHRocm91Z2ggYWxsIHNlbGVjdGlvbiBhdHRyaWJ1dGVzIHN0b3JlZCBpbiBjdXJyZW50IHNlbGVjdGlvbidzIHBhcmVudC4KICAgICAqCiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKiBAcmV0dXJucyB7SXRlcmFibGUuPCo+fQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9nZXRTdG9yZWRBdHRyaWJ1dGVzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0U3RvcmVkQXR0cmlidXRlcygpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbi5fZ2V0U3RvcmVkQXR0cmlidXRlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBUZW1wb3JhcmlseSBjaGFuZ2VzIHRoZSBncmF2aXR5IG9mIHRoZSBzZWxlY3Rpb24gZnJvbSB0aGUgbGVmdCB0byB0aGUgcmlnaHQuCiAgICAgKgogICAgICogVGhlIGdyYXZpdHkgZGVmaW5lcyBmcm9tIHdoaWNoIGRpcmVjdGlvbiB0aGUgc2VsZWN0aW9uIGluaGVyaXRzIGl0cyBhdHRyaWJ1dGVzLiBJZiBpdCdzIHRoZSBkZWZhdWx0IGxlZnQKICAgICAqIGdyYXZpdHksIHRoZSBzZWxlY3Rpb24gKGFmdGVyIGJlaW5nIG1vdmVkIGJ5IHRoZSB0aGUgdXNlcikgaW5oZXJpdHMgYXR0cmlidXRlcyBmcm9tIGl0cyBsZWZ0IGhhbmQgc2lkZS4KICAgICAqIFRoaXMgbWV0aG9kIGFsbG93cyB0byB0ZW1wb3JhcmlseSBvdmVycmlkZSB0aGlzIGJlaGF2aW9yIGJ5IGZvcmNpbmcgdGhlIGdyYXZpdHkgdG8gdGhlIHJpZ2h0LgogICAgICoKICAgICAqIEl0IHJldHVybnMgYW4gdW5pcXVlIGlkZW50aWZpZXIgd2hpY2ggaXMgcmVxdWlyZWQgdG8gcmVzdG9yZSB0aGUgZ3Jhdml0eS4gSXQgZ3VhcmFudGVlcyB0aGUgc3ltbWV0cnkKICAgICAqIG9mIHRoZSBwcm9jZXNzLgogICAgICoKICAgICAqIEBzZWUgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI292ZXJyaWRlU2VsZWN0aW9uR3Jhdml0eQogICAgICogQHByb3RlY3RlZAogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHVuaXF1ZSBpZCB3aGljaCBhbGxvd3MgcmVzdG9yaW5nIHRoZSBncmF2aXR5LgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9vdmVycmlkZUdyYXZpdHkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9vdmVycmlkZUdyYXZpdHkoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb24ub3ZlcnJpZGVHcmF2aXR5KCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlc3RvcmVzIHRoZSB7QGxpbmsgfkRvY3VtZW50U2VsZWN0aW9uI19vdmVycmlkZUdyYXZpdHkgb3ZlcnJpZGRlbiBncmF2aXR5fS4KICAgICAqCiAgICAgKiBSZXN0b3JpbmcgdGhlIGdyYXZpdHkgaXMgb25seSBwb3NzaWJsZSB1c2luZyB0aGUgdW5pcXVlIGlkZW50aWZpZXIgcmV0dXJuZWQgYnkKICAgICAqIHtAbGluayB+RG9jdW1lbnRTZWxlY3Rpb24jX292ZXJyaWRlR3Jhdml0eX0uIE5vdGUgdGhhdCB0aGUgZ3Jhdml0eSByZW1haW5zIG92ZXJyaWRkZW4gYXMgbG9uZyBhcyB3b24ndCBiZSByZXN0b3JlZAogICAgICogdGhlIHNhbWUgbnVtYmVyIG9mIHRpbWVzIGl0IHdhcyBvdmVycmlkZGVuLgogICAgICoKICAgICAqIEBzZWUgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI3Jlc3RvcmVTZWxlY3Rpb25HcmF2aXR5CiAgICAgKiBAcHJvdGVjdGVkCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdWlkIFRoZSB1bmlxdWUgaWQgcmV0dXJuZWQgYnkge0BsaW5rICNfb3ZlcnJpZGVHcmF2aXR5fS4KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfcmVzdG9yZUdyYXZpdHkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZXN0b3JlR3Jhdml0eSh1aWQpIHsKICAgICAgdGhpcy5fc2VsZWN0aW9uLnJlc3RvcmVHcmF2aXR5KHVpZCk7CiAgICB9CiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhbmQgcmV0dXJucyBhbiBhdHRyaWJ1dGUga2V5IGZvciBzZWxlY3Rpb24gYXR0cmlidXRlcyBzdG9yZSwgYmFzaW5nIG9uIG9yaWdpbmFsIGF0dHJpYnV0ZSBrZXkuCiAgICAgKgogICAgICogQHByb3RlY3RlZAogICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBBdHRyaWJ1dGUga2V5IHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBDb252ZXJ0ZWQgYXR0cmlidXRlIGtleSwgYXBwbGljYWJsZSBmb3Igc2VsZWN0aW9uIHN0b3JlLgogICAgICovCgogIH1dLCBbewogICAga2V5OiAiX2dldFN0b3JlQXR0cmlidXRlS2V5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0U3RvcmVBdHRyaWJ1dGVLZXkoa2V5KSB7CiAgICAgIHJldHVybiBzdG9yZVByZWZpeCArIGtleTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgdGhlIGdpdmVuIGF0dHJpYnV0ZSBrZXkgaXMgYW4gYXR0cmlidXRlIHN0b3JlZCBvbiBhbiBlbGVtZW50LgogICAgICoKICAgICAqIEBwcm90ZWN0ZWQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAqIEByZXR1cm5zIHtCb29sZWFufQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9pc1N0b3JlQXR0cmlidXRlS2V5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNTdG9yZUF0dHJpYnV0ZUtleShrZXkpIHsKICAgICAgcmV0dXJuIGtleS5zdGFydHNXaXRoKHN0b3JlUHJlZml4KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBEb2N1bWVudFNlbGVjdGlvbjsKfSgpOwoKZXhwb3J0IHsgRG9jdW1lbnRTZWxlY3Rpb24gYXMgZGVmYXVsdCB9OwptaXgoRG9jdW1lbnRTZWxlY3Rpb24sIEVtaXR0ZXJNaXhpbik7Ci8qKgogKiBGaXJlZCB3aGVuIHNlbGVjdGlvbiByYW5nZShzKSBjaGFuZ2VkLgogKgogKiBAZXZlbnQgY2hhbmdlOnJhbmdlCiAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlyZWN0Q2hhbmdlIEluIGNhc2Ugb2Yge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbn0gY2xhc3MgaXQgaXMgYWx3YXlzIHNldAogKiB0byBgdHJ1ZWAgd2hpY2ggaW5kaWNhdGVzIHRoYXQgdGhlIHNlbGVjdGlvbiBjaGFuZ2Ugd2FzIGNhdXNlZCBieSBhIGRpcmVjdCB1c2Ugb2Ygc2VsZWN0aW9uJ3MgQVBJLgogKiBUaGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb259LCBob3dldmVyLCBtYXkgY2hhbmdlIGJlY2F1c2UgaXRzIHBvc2l0aW9uCiAqIHdhcyBkaXJlY3RseSBjaGFuZ2VkIHRocm91Z2ggdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3dyaXRlcn5Xcml0ZXIgd3JpdGVyfSBvciBiZWNhdXNlIGl0cyBwb3NpdGlvbiB3YXMKICogY2hhbmdlZCBiZWNhdXNlIHRoZSBzdHJ1Y3R1cmUgb2YgdGhlIG1vZGVsIGhhcyBiZWVuIGNoYW5nZWQgKHdoaWNoIG1lYW5zIGFuIGluZGlyZWN0IGNoYW5nZSkuCiAqIFRoZSBpbmRpcmVjdCBjaGFuZ2UgZG9lcyBub3Qgb2NjdXIgaW4gY2FzZSBvZiBub3JtYWwgKGRldGFjaGVkKSBzZWxlY3Rpb25zIGJlY2F1c2UgdGhleSBhcmUgInN0YXRpYyIgKGFzICJub3QgbGl2ZSIpCiAqIHdoaWNoIG1lYW4gdGhhdCB0aGV5IGFyZSBub3QgdXBkYXRlZCBvbmNlIHRoZSBkb2N1bWVudCBjaGFuZ2VzLgogKi8KCi8qKgogKiBGaXJlZCB3aGVuIHNlbGVjdGlvbiBhdHRyaWJ1dGUgY2hhbmdlZC4KICoKICogQGV2ZW50IGNoYW5nZTphdHRyaWJ1dGUKICogQHBhcmFtIHtCb29sZWFufSBkaXJlY3RDaGFuZ2UgSW4gY2FzZSBvZiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0aW9ufSBjbGFzcyBpdCBpcyBhbHdheXMgc2V0CiAqIHRvIGB0cnVlYCB3aGljaCBpbmRpY2F0ZXMgdGhhdCB0aGUgc2VsZWN0aW9uIGNoYW5nZSB3YXMgY2F1c2VkIGJ5IGEgZGlyZWN0IHVzZSBvZiBzZWxlY3Rpb24ncyBBUEkuCiAqIFRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbn0sIGhvd2V2ZXIsIG1heSBjaGFuZ2UgYmVjYXVzZSBpdHMgYXR0cmlidXRlcwogKiB3ZXJlIGRpcmVjdGx5IGNoYW5nZWQgdGhyb3VnaCB0aGUge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvd3JpdGVyfldyaXRlciB3cml0ZXJ9IG9yIGJlY2F1c2UgaXRzIHBvc2l0aW9uIHdhcwogKiBjaGFuZ2VkIGluIHRoZSBtb2RlbCBhbmQgaXRzIGF0dHJpYnV0ZXMgd2VyZSByZWZyZXNoZWQgKHdoaWNoIG1lYW5zIGFuIGluZGlyZWN0IGNoYW5nZSkuCiAqIFRoZSBpbmRpcmVjdCBjaGFuZ2UgZG9lcyBub3Qgb2NjdXIgaW4gY2FzZSBvZiBub3JtYWwgKGRldGFjaGVkKSBzZWxlY3Rpb25zIGJlY2F1c2UgdGhleSBhcmUgInN0YXRpYyIgKGFzICJub3QgbGl2ZSIpCiAqIHdoaWNoIG1lYW4gdGhhdCB0aGV5IGFyZSBub3QgdXBkYXRlZCBvbmNlIHRoZSBkb2N1bWVudCBjaGFuZ2VzLgogKiBAcGFyYW0ge0FycmF5LjxTdHJpbmc+fSBhdHRyaWJ1dGVLZXlzIEFycmF5IGNvbnRhaW5pbmcga2V5cyBvZiBhdHRyaWJ1dGVzIHRoYXQgY2hhbmdlZC4KICovCgovKioKICogRmlyZWQgd2hlbiBzZWxlY3Rpb24gbWFya2VyKHMpIGNoYW5nZWQuCiAqCiAqIEBldmVudCBjaGFuZ2U6bWFya2VyCiAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlyZWN0Q2hhbmdlIFRoaXMgaXMgYWx3YXlzIHNldCB0byBgZmFsc2VgIGluIGNhc2Ugb2YgYGNoYW5nZTptYXJrZXJgIGV2ZW50IGFzIHRoZXJlIGlzIG5vIHBvc3NpYmlsaXR5CiAqIHRvIGNoYW5nZSBtYXJrZXJzIGRpcmVjdGx5IHRocm91Z2gge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb259IEFQSS4KICogU2VlIGFsc28ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb24jZXZlbnQ6Y2hhbmdlOnJhbmdlfSBhbmQKICoge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb24jZXZlbnQ6Y2hhbmdlOmF0dHJpYnV0ZX0uCiAqIEBwYXJhbSB7QXJyYXkuPG1vZHVsZTplbmdpbmUvbW9kZWwvbWFya2VyY29sbGVjdGlvbn5NYXJrZXI+fSBvbGRNYXJrZXJzIE1hcmtlcnMgaW4gd2hpY2ggdGhlIHNlbGVjdGlvbiB3YXMgYmVmb3JlIHRoZSBjaGFuZ2UuCiAqLwovLyBgTGl2ZVNlbGVjdGlvbmAgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5IHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50c2VsZWN0aW9ufkRvY3VtZW50U2VsZWN0aW9ufSBhbmQgc2hvdWxkbid0IGJlIHVzZWQgZGlyZWN0bHkuCi8vCi8vIExpdmVTZWxlY3Rpb25gIGlzIGF1dG9tYXRpY2FsbHkgdXBkYXRlZCB1cG9uIGNoYW5nZXMgaW4gdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50IGRvY3VtZW50fQovLyB0byBhbHdheXMgY29udGFpbiB2YWxpZCByYW5nZXMuIEl0cyBhdHRyaWJ1dGVzIGFyZSBpbmhlcml0ZWQgZnJvbSB0aGUgdGV4dCB1bmxlc3Mgc2V0IGV4cGxpY2l0bHkuCi8vCi8vIERpZmZlcmVuY2VzIGJldHdlZW4ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbn0gYW5kIGBMaXZlU2VsZWN0aW9uYCBhcmU6Ci8vICogdGhlcmUgaXMgYWx3YXlzIGEgcmFuZ2UgaW4gYExpdmVTZWxlY3Rpb25gIC0gZXZlbiBpZiBubyByYW5nZXMgd2VyZSBhZGRlZCB0aGVyZSBpcyBhICJkZWZhdWx0IHJhbmdlIgovLyBwcmVzZW50IGluIHRoZSBzZWxlY3Rpb24sCi8vICogcmFuZ2VzIGFkZGVkIHRvIHRoaXMgc2VsZWN0aW9uIHVwZGF0ZXMgYXV0b21hdGljYWxseSB3aGVuIHRoZSBkb2N1bWVudCBjaGFuZ2VzLAovLyAqIGF0dHJpYnV0ZXMgb2YgYExpdmVTZWxlY3Rpb25gIGFyZSB1cGRhdGVkIGF1dG9tYXRpY2FsbHkgYWNjb3JkaW5nIHRvIHNlbGVjdGlvbiByYW5nZXMuCi8vCi8vIEBleHRlbmRzIG1vZHVsZTplbmdpbmUvbW9kZWwvc2VsZWN0aW9uflNlbGVjdGlvbgovLwoKdmFyIExpdmVTZWxlY3Rpb24gPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9TZWxlY3Rpb24pIHsKICBfaW5oZXJpdHMoTGl2ZVNlbGVjdGlvbiwgX1NlbGVjdGlvbik7CgogIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoTGl2ZVNlbGVjdGlvbik7CgogIC8vIENyZWF0ZXMgYW4gZW1wdHkgbGl2ZSBzZWxlY3Rpb24gZm9yIGdpdmVuIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50fS4KICAvLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnR+RG9jdW1lbnR9IGRvYyBEb2N1bWVudCB3aGljaCBvd25zIHRoaXMgc2VsZWN0aW9uLgogIGZ1bmN0aW9uIExpdmVTZWxlY3Rpb24oZG9jKSB7CiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIExpdmVTZWxlY3Rpb24pOwoKICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcyk7IC8vIExpc3Qgb2Ygc2VsZWN0aW9uIG1hcmtlcnMuCiAgICAvLyBNYXJrZXIgaXMgYSBzZWxlY3Rpb24gbWFya2VyIHdoZW4gc2VsZWN0aW9uIHJhbmdlIGlzIGluc2lkZSB0aGUgbWFya2VyIHJhbmdlLgogICAgLy8KICAgIC8vIEB0eXBlIHttb2R1bGU6dXRpbHMvY29sbGVjdGlvbn5Db2xsZWN0aW9ufQoKICAgIF90aGlzLm1hcmtlcnMgPSBuZXcgQ29sbGVjdGlvbih7CiAgICAgIGlkUHJvcGVydHk6ICduYW1lJwogICAgfSk7IC8vIERvY3VtZW50IHdoaWNoIG93bnMgdGhpcyBzZWxlY3Rpb24uCiAgICAvLwogICAgLy8gQHByb3RlY3RlZAogICAgLy8gQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9tb2RlbC9tb2RlbH5Nb2RlbH0KCiAgICBfdGhpcy5fbW9kZWwgPSBkb2MubW9kZWw7IC8vIERvY3VtZW50IHdoaWNoIG93bnMgdGhpcyBzZWxlY3Rpb24uCiAgICAvLwogICAgLy8gQHByb3RlY3RlZAogICAgLy8gQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudH0KCiAgICBfdGhpcy5fZG9jdW1lbnQgPSBkb2M7IC8vIEtlZXBzIG1hcHBpbmcgb2YgYXR0cmlidXRlIG5hbWUgdG8gcHJpb3JpdHkgd2l0aCB3aGljaCB0aGUgYXR0cmlidXRlIGdvdCBtb2RpZmllZCAoYWRkZWQvY2hhbmdlZC9yZW1vdmVkKQogICAgLy8gbGFzdCB0aW1lLiBQb3NzaWJsZSB2YWx1ZXMgb2YgcHJpb3JpdHkgYXJlOiBgJ2xvdydgIGFuZCBgJ25vcm1hbCdgLgogICAgLy8KICAgIC8vIFByaW9yaXRpZXMgYXJlIHVzZWQgYnkgaW50ZXJuYWwgYExpdmVTZWxlY3Rpb25gIG1lY2hhbmlzbXMuIEFsbCBhdHRyaWJ1dGVzIHNldCB1c2luZyBgTGl2ZVNlbGVjdGlvbmAKICAgIC8vIGF0dHJpYnV0ZXMgQVBJIGFyZSBzZXQgd2l0aCBgJ25vcm1hbCdgIHByaW9yaXR5LgogICAgLy8KICAgIC8vIEBwcml2YXRlCiAgICAvLyBAbWVtYmVyIHtNYXB9IG1vZHVsZTplbmdpbmUvbW9kZWwvbGl2ZXNlbGVjdGlvbn5MaXZlU2VsZWN0aW9uI19hdHRyaWJ1dGVQcmlvcml0eQoKICAgIF90aGlzLl9hdHRyaWJ1dGVQcmlvcml0eSA9IG5ldyBNYXAoKTsgLy8gUG9zaXRpb24gdG8gd2hpY2ggdGhlIHNlbGVjdGlvbiBzaG91bGQgYmUgc2V0IGlmIHRoZSBsYXN0IHNlbGVjdGlvbiByYW5nZSB3YXMgbW92ZWQgdG8gdGhlIGdyYXZleWFyZC4KICAgIC8vIEBwcml2YXRlCiAgICAvLyBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufSBtb2R1bGU6ZW5naW5lL21vZGVsL2xpdmVzZWxlY3Rpb25+TGl2ZVNlbGVjdGlvbiNfc2VsZWN0aW9uUmVzdG9yZVBvc2l0aW9uCgogICAgX3RoaXMuX3NlbGVjdGlvblJlc3RvcmVQb3NpdGlvbiA9IG51bGw7IC8vIEZsYWcgdGhhdCBpbmZvcm1zIHdoZXRoZXIgdGhlIHNlbGVjdGlvbiByYW5nZXMgaGF2ZSBjaGFuZ2VkLiBJdCBpcyBjaGFuZ2VkIG9uIHRydWUgd2hlbiBgTGl2ZVJhbmdlI2NoYW5nZTpyYW5nZWAgZXZlbnQgaXMgZmlyZWQuCiAgICAvLyBAcHJpdmF0ZQogICAgLy8gQG1lbWJlciB7QXJyYXl9IG1vZHVsZTplbmdpbmUvbW9kZWwvbGl2ZXNlbGVjdGlvbn5MaXZlU2VsZWN0aW9uI19oYXNDaGFuZ2VkUmFuZ2UKCiAgICBfdGhpcy5faGFzQ2hhbmdlZFJhbmdlID0gZmFsc2U7IC8vIEVhY2ggb3ZlcnJpZGluZyBncmF2aXR5IGFkZHMgYW4gVUlEIHRvIHRoZSBzZXQgYW5kIGVhY2ggcmVtb3ZhbCByZW1vdmVzIGl0LgogICAgLy8gR3Jhdml0eSBpcyBvdmVycmlkZGVuIHdoZW4gdGhlcmUncyBhdCBsZWFzdCBvbmUgVUlEIGluIHRoZSBzZXQuCiAgICAvLyBHcmF2aXR5IGlzIHJlc3RvcmVkIHdoZW4gdGhlIHNldCBpcyBlbXB0eS4KICAgIC8vIFRoaXMgaXMgdG8gcHJldmVudCBjb25mbGljdHMgd2hlbiBncmF2aXR5IGlzIG92ZXJyaWRkZW4gYnkgbW9yZSB0aGFuIG9uZSBmZWF0dXJlIGF0IHRoZSBzYW1lIHRpbWUuCiAgICAvLyBAcHJpdmF0ZQogICAgLy8gQHR5cGUge1NldH0KCiAgICBfdGhpcy5fb3ZlcnJpZGRlbkdyYXZpdHlSZWdpc3RlciA9IG5ldyBTZXQoKTsgLy8gUHJlZml4ZXMgb2YgbWFya2VyIG5hbWVzIHRoYXQgc2hvdWxkIGFmZmVjdCBgTGl2ZVNlbGVjdGlvbiNtYXJrZXJzYCBjb2xsZWN0aW9uLgogICAgLy8gQHByaXZhdGUKICAgIC8vIEB0eXBlIHtTZXR9CgogICAgX3RoaXMuX29ic2VydmVkTWFya2VycyA9IG5ldyBTZXQoKTsgLy8gRW5zdXJlIHNlbGVjdGlvbiBpcyBjb3JyZWN0IGFmdGVyIGVhY2ggb3BlcmF0aW9uLgoKICAgIF90aGlzLmxpc3RlblRvKF90aGlzLl9tb2RlbCwgJ2FwcGx5T3BlcmF0aW9uJywgZnVuY3Rpb24gKGV2dCwgYXJncykgewogICAgICB2YXIgb3BlcmF0aW9uID0gYXJnc1swXTsKCiAgICAgIGlmICghb3BlcmF0aW9uLmlzRG9jdW1lbnRPcGVyYXRpb24gfHwgb3BlcmF0aW9uLnR5cGUgPT0gJ21hcmtlcicgfHwgb3BlcmF0aW9uLnR5cGUgPT0gJ3JlbmFtZScgfHwgb3BlcmF0aW9uLnR5cGUgPT0gJ25vb3AnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIEZpeCBzZWxlY3Rpb24gaWYgdGhlIGxhc3QgcmFuZ2Ugd2FzIHJlbW92ZWQgZnJvbSBpdCBhbmQgd2UgaGF2ZSBhIHBvc2l0aW9uIHRvIHdoaWNoIHdlIGNhbiByZXN0b3JlIHRoZSBzZWxlY3Rpb24uCgoKICAgICAgaWYgKF90aGlzLl9yYW5nZXMubGVuZ3RoID09IDAgJiYgX3RoaXMuX3NlbGVjdGlvblJlc3RvcmVQb3NpdGlvbikgewogICAgICAgIF90aGlzLl9maXhHcmF2ZXlhcmRTZWxlY3Rpb24oX3RoaXMuX3NlbGVjdGlvblJlc3RvcmVQb3NpdGlvbik7CiAgICAgIH0gLy8gIkZvcmdldCIgdGhlIHJlc3RvcmUgcG9zaXRpb24gZXZlbiBpZiBpdCB3YXMgbm90ICJ1c2VkIi4KCgogICAgICBfdGhpcy5fc2VsZWN0aW9uUmVzdG9yZVBvc2l0aW9uID0gbnVsbDsKCiAgICAgIGlmIChfdGhpcy5faGFzQ2hhbmdlZFJhbmdlKSB7CiAgICAgICAgX3RoaXMuX2hhc0NoYW5nZWRSYW5nZSA9IGZhbHNlOwoKICAgICAgICBfdGhpcy5maXJlKCdjaGFuZ2U6cmFuZ2UnLCB7CiAgICAgICAgICBkaXJlY3RDaGFuZ2U6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAgcHJpb3JpdHk6ICdsb3dlc3QnCiAgICB9KTsgLy8gRW5zdXJlIHNlbGVjdGlvbiBpcyBjb3JyZWN0IGFuZCB1cCB0byBkYXRlIGFmdGVyIGVhY2ggcmFuZ2UgY2hhbmdlLgoKCiAgICBfdGhpcy5vbignY2hhbmdlOnJhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2l0ZXJhdG9yID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoX3RoaXMuZ2V0UmFuZ2VzKCkpLAogICAgICAgICAgX3N0ZXA7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yLnMoKTsgIShfc3RlcCA9IF9pdGVyYXRvci5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgcmFuZ2UgPSBfc3RlcC52YWx1ZTsKCiAgICAgICAgICBpZiAoIV90aGlzLl9kb2N1bWVudC5fdmFsaWRhdGVTZWxlY3Rpb25SYW5nZShyYW5nZSkpIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFJhbmdlIGZyb20ge0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvZG9jdW1lbnRzZWxlY3Rpb25+RG9jdW1lbnRTZWxlY3Rpb24gZG9jdW1lbnQgc2VsZWN0aW9ufQogICAgICAgICAgICAgKiBzdGFydHMgb3IgZW5kcyBhdCBpbmNvcnJlY3QgcG9zaXRpb24uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBlcnJvciBkb2N1bWVudC1zZWxlY3Rpb24td3JvbmctcG9zaXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3JhbmdlflJhbmdlfSByYW5nZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhyb3cgbmV3IENLRWRpdG9yRXJyb3IoJ2RvY3VtZW50LXNlbGVjdGlvbi13cm9uZy1wb3NpdGlvbicsIF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCB7CiAgICAgICAgICAgICAgcmFuZ2U6IHJhbmdlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yLmUoZXJyKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBfaXRlcmF0b3IuZigpOwogICAgICB9CiAgICB9KTsgLy8gVXBkYXRlIG1hcmtlcnMgZGF0YSBzdG9yZWQgYnkgdGhlIHNlbGVjdGlvbiBhZnRlciBlYWNoIG1hcmtlciBjaGFuZ2UuCiAgICAvLyBUaGlzIGhhbmRsZXMgb25seSBtYXJrZXIgY2hhbmdlcyBkb25lIHRocm91Z2ggbWFya2VyIG9wZXJhdGlvbnMgKG5vdCBtb2RlbCB0cmVlIGNoYW5nZXMpLgoKCiAgICBfdGhpcy5saXN0ZW5UbyhfdGhpcy5fbW9kZWwubWFya2VycywgJ3VwZGF0ZScsIGZ1bmN0aW9uIChldnQsIG1hcmtlciwgb2xkUmFuZ2UsIG5ld1JhbmdlKSB7CiAgICAgIF90aGlzLl91cGRhdGVNYXJrZXIobWFya2VyLCBuZXdSYW5nZSk7CiAgICB9KTsgLy8gRW5zdXJlIHNlbGVjdGlvbiBpcyB1cCB0byBkYXRlIGFmdGVyIGVhY2ggY2hhbmdlIGJsb2NrLgoKCiAgICBfdGhpcy5saXN0ZW5UbyhfdGhpcy5fZG9jdW1lbnQsICdjaGFuZ2UnLCBmdW5jdGlvbiAoZXZ0LCBiYXRjaCkgewogICAgICBjbGVhckF0dHJpYnV0ZXNTdG9yZWRJbkVsZW1lbnQoX3RoaXMuX21vZGVsLCBiYXRjaCk7CiAgICB9KTsKCiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoTGl2ZVNlbGVjdGlvbiwgW3sKICAgIGtleTogImlzQ29sbGFwc2VkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgbGVuZ3RoID0gdGhpcy5fcmFuZ2VzLmxlbmd0aDsKICAgICAgcmV0dXJuIGxlbmd0aCA9PT0gMCA/IHRoaXMuX2RvY3VtZW50Ll9nZXREZWZhdWx0UmFuZ2UoKS5pc0NvbGxhcHNlZCA6IF9nZXQoX2dldFByb3RvdHlwZU9mKExpdmVTZWxlY3Rpb24ucHJvdG90eXBlKSwgImlzQ29sbGFwc2VkIiwgdGhpcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiYW5jaG9yIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2dldChfZ2V0UHJvdG90eXBlT2YoTGl2ZVNlbGVjdGlvbi5wcm90b3R5cGUpLCAiYW5jaG9yIiwgdGhpcykgfHwgdGhpcy5fZG9jdW1lbnQuX2dldERlZmF1bHRSYW5nZSgpLnN0YXJ0OwogICAgfQogIH0sIHsKICAgIGtleTogImZvY3VzIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gX2dldChfZ2V0UHJvdG90eXBlT2YoTGl2ZVNlbGVjdGlvbi5wcm90b3R5cGUpLCAiZm9jdXMiLCB0aGlzKSB8fCB0aGlzLl9kb2N1bWVudC5fZ2V0RGVmYXVsdFJhbmdlKCkuZW5kOwogICAgfQogIH0sIHsKICAgIGtleTogInJhbmdlQ291bnQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yYW5nZXMubGVuZ3RoID8gdGhpcy5fcmFuZ2VzLmxlbmd0aCA6IDE7CiAgICB9IC8vIERlc2NyaWJlcyB3aGV0aGVyIGBMaXZlU2VsZWN0aW9uYCBoYXMgb3duIHJhbmdlKHMpIHNldCwgb3IgaWYgaXQgaXMgZGVmYXVsdGVkIHRvCiAgICAvLyB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudH5Eb2N1bWVudCNfZ2V0RGVmYXVsdFJhbmdlIGRvY3VtZW50J3MgZGVmYXVsdCByYW5nZX0uCiAgICAvLwogICAgLy8gQHJlYWRvbmx5CiAgICAvLyBAdHlwZSB7Qm9vbGVhbn0KCiAgfSwgewogICAga2V5OiAiaGFzT3duUmFuZ2UiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yYW5nZXMubGVuZ3RoID4gMDsKICAgIH0gLy8gV2hlbiBzZXQgdG8gYHRydWVgIHRoZW4gc2VsZWN0aW9uIGF0dHJpYnV0ZXMgb24gbm9kZSBiZWZvcmUgdGhlIGNhcmV0IHdvbid0IGJlIHRha2VuCiAgICAvLyBpbnRvIGNvbnNpZGVyYXRpb24gd2hpbGUgdXBkYXRpbmcgc2VsZWN0aW9uIGF0dHJpYnV0ZXMuCiAgICAvLwogICAgLy8gQHByb3RlY3RlZAogICAgLy8gQHR5cGUge0Jvb2xlYW59CgogIH0sIHsKICAgIGtleTogImlzR3Jhdml0eU92ZXJyaWRkZW4iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAhIXRoaXMuX292ZXJyaWRkZW5HcmF2aXR5UmVnaXN0ZXIuc2l6ZTsKICAgIH0gLy8gVW5iaW5kcyBhbGwgZXZlbnRzIHByZXZpb3VzbHkgYm91bmQgYnkgbGl2ZSBzZWxlY3Rpb24uCgogIH0sIHsKICAgIGtleTogImRlc3Ryb3kiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fcmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmFuZ2VzW2ldLmRldGFjaCgpOwogICAgICB9CgogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRSYW5nZXMiLAogICAgdmFsdWU6IC8qI19fUFVSRV9fKi9yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBnZXRSYW5nZXMoKSB7CiAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBnZXRSYW5nZXMkKF9jb250ZXh0KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIGlmICghdGhpcy5fcmFuZ2VzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5kZWxlZ2F0ZVlpZWxkKF9nZXQoX2dldFByb3RvdHlwZU9mKExpdmVTZWxlY3Rpb24ucHJvdG90eXBlKSwgImdldFJhbmdlcyIsIHRoaXMpLmNhbGwodGhpcyksICJ0MCIsIDIpOwoKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSA2OwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSA2OwogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9kb2N1bWVudC5fZ2V0RGVmYXVsdFJhbmdlKCk7CgogICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIGdldFJhbmdlcywgdGhpcyk7CiAgICB9KQogIH0sIHsKICAgIGtleTogImdldEZpcnN0UmFuZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEZpcnN0UmFuZ2UoKSB7CiAgICAgIHJldHVybiBfZ2V0KF9nZXRQcm90b3R5cGVPZihMaXZlU2VsZWN0aW9uLnByb3RvdHlwZSksICJnZXRGaXJzdFJhbmdlIiwgdGhpcykuY2FsbCh0aGlzKSB8fCB0aGlzLl9kb2N1bWVudC5fZ2V0RGVmYXVsdFJhbmdlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0TGFzdFJhbmdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRMYXN0UmFuZ2UoKSB7CiAgICAgIHJldHVybiBfZ2V0KF9nZXRQcm90b3R5cGVPZihMaXZlU2VsZWN0aW9uLnByb3RvdHlwZSksICJnZXRMYXN0UmFuZ2UiLCB0aGlzKS5jYWxsKHRoaXMpIHx8IHRoaXMuX2RvY3VtZW50Ll9nZXREZWZhdWx0UmFuZ2UoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRUbyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VG8oc2VsZWN0YWJsZSwgb3B0aW9uc09yUGxhY2VPck9mZnNldCwgb3B0aW9ucykgewogICAgICBfZ2V0KF9nZXRQcm90b3R5cGVPZihMaXZlU2VsZWN0aW9uLnByb3RvdHlwZSksICJzZXRUbyIsIHRoaXMpLmNhbGwodGhpcywgc2VsZWN0YWJsZSwgb3B0aW9uc09yUGxhY2VPck9mZnNldCwgb3B0aW9ucyk7CgogICAgICB0aGlzLl91cGRhdGVBdHRyaWJ1dGVzKHRydWUpOwoKICAgICAgdGhpcy5fdXBkYXRlTWFya2VycygpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldEZvY3VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRGb2N1cyhpdGVtT3JQb3NpdGlvbiwgb2Zmc2V0KSB7CiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKExpdmVTZWxlY3Rpb24ucHJvdG90eXBlKSwgInNldEZvY3VzIiwgdGhpcykuY2FsbCh0aGlzLCBpdGVtT3JQb3NpdGlvbiwgb2Zmc2V0KTsKCiAgICAgIHRoaXMuX3VwZGF0ZUF0dHJpYnV0ZXModHJ1ZSk7CgogICAgICB0aGlzLl91cGRhdGVNYXJrZXJzKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0QXR0cmlidXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSkgewogICAgICBpZiAodGhpcy5fc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpKSB7CiAgICAgICAgLy8gRmlyZSBldmVudCB3aXRoIGV4YWN0IGRhdGEuCiAgICAgICAgdmFyIGF0dHJpYnV0ZUtleXMgPSBba2V5XTsKICAgICAgICB0aGlzLmZpcmUoJ2NoYW5nZTphdHRyaWJ1dGUnLCB7CiAgICAgICAgICBhdHRyaWJ1dGVLZXlzOiBhdHRyaWJ1dGVLZXlzLAogICAgICAgICAgZGlyZWN0Q2hhbmdlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW1vdmVBdHRyaWJ1dGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUF0dHJpYnV0ZShrZXkpIHsKICAgICAgaWYgKHRoaXMuX3JlbW92ZUF0dHJpYnV0ZShrZXkpKSB7CiAgICAgICAgLy8gRmlyZSBldmVudCB3aXRoIGV4YWN0IGRhdGEuCiAgICAgICAgdmFyIGF0dHJpYnV0ZUtleXMgPSBba2V5XTsKICAgICAgICB0aGlzLmZpcmUoJ2NoYW5nZTphdHRyaWJ1dGUnLCB7CiAgICAgICAgICBhdHRyaWJ1dGVLZXlzOiBhdHRyaWJ1dGVLZXlzLAogICAgICAgICAgZGlyZWN0Q2hhbmdlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJvdmVycmlkZUdyYXZpdHkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIG92ZXJyaWRlR3Jhdml0eSgpIHsKICAgICAgdmFyIG92ZXJyaWRlVWlkID0gdWlkKCk7IC8vIFJlbWVtYmVyIHRoYXQgYW5vdGhlciBvdmVycmlkaW5nIGhhcyBiZWVuIHJlcXVlc3RlZC4gSXQgd2lsbCBuZWVkIHRvIGJlIHJlbW92ZWQKICAgICAgLy8gYmVmb3JlIHRoZSBncmF2aXR5IGlzIHRvIGJlIHJlc3RvcmVkLgoKICAgICAgdGhpcy5fb3ZlcnJpZGRlbkdyYXZpdHlSZWdpc3Rlci5hZGQob3ZlcnJpZGVVaWQpOwoKICAgICAgaWYgKHRoaXMuX292ZXJyaWRkZW5HcmF2aXR5UmVnaXN0ZXIuc2l6ZSA9PT0gMSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUF0dHJpYnV0ZXModHJ1ZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBvdmVycmlkZVVpZDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZXN0b3JlR3Jhdml0eSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVzdG9yZUdyYXZpdHkodWlkKSB7CiAgICAgIGlmICghdGhpcy5fb3ZlcnJpZGRlbkdyYXZpdHlSZWdpc3Rlci5oYXModWlkKSkgewogICAgICAgIC8qKgogICAgICAgICAqIFJlc3RvcmluZyBncmF2aXR5IGZvciBhbiB1bmtub3duIFVJRCBpcyBub3QgcG9zc2libGUuIE1ha2Ugc3VyZSB5b3UgYXJlIHVzaW5nIGEgY29ycmVjdAogICAgICAgICAqIFVJRCBvYnRhaW5lZCBmcm9tIHRoZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC93cml0ZXJ+V3JpdGVyI292ZXJyaWRlU2VsZWN0aW9uR3Jhdml0eX0gdG8gcmVzdG9yZS4KICAgICAgICAgKgogICAgICAgICAqIEBlcnJvciBkb2N1bWVudC1zZWxlY3Rpb24tZ3Jhdml0eS13cm9uZy1yZXN0b3JlCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgcmV0dXJuZWQgYnkKICAgICAgICAgKiB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudHNlbGVjdGlvbn5Eb2N1bWVudFNlbGVjdGlvbiNfb3ZlcnJpZGVHcmF2aXR5fS4KICAgICAgICAgKi8KICAgICAgICB0aHJvdyBuZXcgQ0tFZGl0b3JFcnJvcignZG9jdW1lbnQtc2VsZWN0aW9uLWdyYXZpdHktd3JvbmctcmVzdG9yZScsIHRoaXMsIHsKICAgICAgICAgIHVpZDogdWlkCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMuX292ZXJyaWRkZW5HcmF2aXR5UmVnaXN0ZXIuZGVsZXRlKHVpZCk7IC8vIFJlc3RvcmUgZ3Jhdml0eSBvbmx5IHdoZW4gYWxsIG92ZXJyaWRpbmcgaGF2ZSBiZWVuIHJlc3RvcmVkLgoKCiAgICAgIGlmICghdGhpcy5pc0dyYXZpdHlPdmVycmlkZGVuKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlQXR0cmlidXRlcyh0cnVlKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIm9ic2VydmVNYXJrZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvYnNlcnZlTWFya2VycyhwcmVmaXhPck5hbWUpIHsKICAgICAgdGhpcy5fb2JzZXJ2ZWRNYXJrZXJzLmFkZChwcmVmaXhPck5hbWUpOwoKICAgICAgdGhpcy5fdXBkYXRlTWFya2VycygpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9wb3BSYW5nZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3BvcFJhbmdlKCkgewogICAgICB0aGlzLl9yYW5nZXMucG9wKCkuZGV0YWNoKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX3B1c2hSYW5nZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3B1c2hSYW5nZShyYW5nZSkgewogICAgICB2YXIgbGl2ZVJhbmdlID0gdGhpcy5fcHJlcGFyZVJhbmdlKHJhbmdlKTsgLy8gYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQgd2hlbiBnaXZlbiBgcmFuZ2VgIGlzIGluIGdyYXZleWFyZCByb290LgoKCiAgICAgIGlmIChsaXZlUmFuZ2UpIHsKICAgICAgICB0aGlzLl9yYW5nZXMucHVzaChsaXZlUmFuZ2UpOwogICAgICB9CiAgICB9IC8vIFByZXBhcmVzIGdpdmVuIHJhbmdlIHRvIGJlIGFkZGVkIHRvIHNlbGVjdGlvbi4gQ2hlY2tzIGlmIGl0IGlzIGNvcnJlY3QsCiAgICAvLyBjb252ZXJ0cyBpdCB0byB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC9saXZlcmFuZ2V+TGl2ZVJhbmdlIExpdmVSYW5nZX0KICAgIC8vIGFuZCBzZXRzIGxpc3RlbmVycyBsaXN0ZW5pbmcgdG8gdGhlIHJhbmdlJ3MgY2hhbmdlIGV2ZW50LgogICAgLy8KICAgIC8vIEBwcml2YXRlCiAgICAvLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V9IHJhbmdlCgogIH0sIHsKICAgIGtleTogIl9wcmVwYXJlUmFuZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9wcmVwYXJlUmFuZ2UocmFuZ2UpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB0aGlzLl9jaGVja1JhbmdlKHJhbmdlKTsKCiAgICAgIGlmIChyYW5nZS5yb290ID09IHRoaXMuX2RvY3VtZW50LmdyYXZleWFyZCkgewogICAgICAgIC8vIEBpZiBDS19ERUJVRyAvLyBjb25zb2xlLndhcm4oICdUcnlpbmcgdG8gYWRkIGEgUmFuZ2UgdGhhdCBpcyBpbiB0aGUgZ3JhdmV5YXJkIHJvb3QuIFJhbmdlIHJlamVjdGVkLicgKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsaXZlUmFuZ2UgPSBMaXZlUmFuZ2UuZnJvbVJhbmdlKHJhbmdlKTsgLy8gSWYgc2VsZWN0aW9uIHJhbmdlIGlzIG1vdmVkIHRvIHRoZSBncmF2ZXlhcmQgcmVtb3ZlIGl0IGZyb20gdGhlIHNlbGVjdGlvbiBvYmplY3QuCiAgICAgIC8vIEFsc28sIHNhdmUgc29tZSBkYXRhIHRoYXQgY2FuIGJlIHVzZWQgdG8gcmVzdG9yZSBzZWxlY3Rpb24gbGF0ZXIsIG9uIGBNb2RlbCNhcHBseU9wZXJhdGlvbmAgZXZlbnQuCgogICAgICBsaXZlUmFuZ2Uub24oJ2NoYW5nZTpyYW5nZScsIGZ1bmN0aW9uIChldnQsIG9sZFJhbmdlLCBkYXRhKSB7CiAgICAgICAgX3RoaXMyLl9oYXNDaGFuZ2VkUmFuZ2UgPSB0cnVlOwoKICAgICAgICBpZiAobGl2ZVJhbmdlLnJvb3QgPT0gX3RoaXMyLl9kb2N1bWVudC5ncmF2ZXlhcmQpIHsKICAgICAgICAgIF90aGlzMi5fc2VsZWN0aW9uUmVzdG9yZVBvc2l0aW9uID0gZGF0YS5kZWxldGlvblBvc2l0aW9uOwoKICAgICAgICAgIHZhciBpbmRleCA9IF90aGlzMi5fcmFuZ2VzLmluZGV4T2YobGl2ZVJhbmdlKTsKCiAgICAgICAgICBfdGhpczIuX3Jhbmdlcy5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICAgIGxpdmVSYW5nZS5kZXRhY2goKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbGl2ZVJhbmdlOwogICAgfQogIH0sIHsKICAgIGtleTogIl91cGRhdGVNYXJrZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlTWFya2VycygpIHsKICAgICAgaWYgKCF0aGlzLl9vYnNlcnZlZE1hcmtlcnMuc2l6ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIG1hcmtlcnMgPSBbXTsKICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKCiAgICAgIHZhciBfaXRlcmF0b3IyID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy5fbW9kZWwubWFya2VycyksCiAgICAgICAgICBfc3RlcDI7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yMi5zKCk7ICEoX3N0ZXAyID0gX2l0ZXJhdG9yMi5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX21hcmtlcjIgPSBfc3RlcDIudmFsdWU7CgogICAgICAgICAgdmFyIG1hcmtlckdyb3VwID0gX21hcmtlcjIubmFtZS5zcGxpdCgnOicsIDEpWzBdOwoKICAgICAgICAgIGlmICghdGhpcy5fb2JzZXJ2ZWRNYXJrZXJzLmhhcyhtYXJrZXJHcm91cCkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG1hcmtlclJhbmdlID0gX21hcmtlcjIuZ2V0UmFuZ2UoKTsKCiAgICAgICAgICB2YXIgX2l0ZXJhdG9yMyA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMuZ2V0UmFuZ2VzKCkpLAogICAgICAgICAgICAgIF9zdGVwMzsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvcjMucygpOyAhKF9zdGVwMyA9IF9pdGVyYXRvcjMubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciBzZWxlY3Rpb25SYW5nZSA9IF9zdGVwMy52YWx1ZTsKCiAgICAgICAgICAgICAgaWYgKG1hcmtlclJhbmdlLmNvbnRhaW5zUmFuZ2Uoc2VsZWN0aW9uUmFuZ2UsICFzZWxlY3Rpb25SYW5nZS5pc0NvbGxhcHNlZCkpIHsKICAgICAgICAgICAgICAgIG1hcmtlcnMucHVzaChfbWFya2VyMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yMy5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3IzLmYoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvcjIuZShlcnIpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIF9pdGVyYXRvcjIuZigpOwogICAgICB9CgogICAgICB2YXIgb2xkTWFya2VycyA9IEFycmF5LmZyb20odGhpcy5tYXJrZXJzKTsKCiAgICAgIGZvciAodmFyIF9pID0gMCwgX21hcmtlcnMgPSBtYXJrZXJzOyBfaSA8IF9tYXJrZXJzLmxlbmd0aDsgX2krKykgewogICAgICAgIHZhciBtYXJrZXIgPSBfbWFya2Vyc1tfaV07CgogICAgICAgIGlmICghdGhpcy5tYXJrZXJzLmhhcyhtYXJrZXIpKSB7CiAgICAgICAgICB0aGlzLm1hcmtlcnMuYWRkKG1hcmtlcik7CiAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAodmFyIF9pMiA9IDAsIF9BcnJheSRmcm9tID0gQXJyYXkuZnJvbSh0aGlzLm1hcmtlcnMpOyBfaTIgPCBfQXJyYXkkZnJvbS5sZW5ndGg7IF9pMisrKSB7CiAgICAgICAgdmFyIF9tYXJrZXIgPSBfQXJyYXkkZnJvbVtfaTJdOwoKICAgICAgICBpZiAoIW1hcmtlcnMuaW5jbHVkZXMoX21hcmtlcikpIHsKICAgICAgICAgIHRoaXMubWFya2Vycy5yZW1vdmUoX21hcmtlcik7CiAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgICAgdGhpcy5maXJlKCdjaGFuZ2U6bWFya2VyJywgewogICAgICAgICAgb2xkTWFya2Vyczogb2xkTWFya2VycywKICAgICAgICAgIGRpcmVjdENoYW5nZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIl91cGRhdGVNYXJrZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF91cGRhdGVNYXJrZXIobWFya2VyLCBtYXJrZXJSYW5nZSkgewogICAgICB2YXIgbWFya2VyR3JvdXAgPSBtYXJrZXIubmFtZS5zcGxpdCgnOicsIDEpWzBdOwoKICAgICAgaWYgKCF0aGlzLl9vYnNlcnZlZE1hcmtlcnMuaGFzKG1hcmtlckdyb3VwKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZE1hcmtlcnMgPSBBcnJheS5mcm9tKHRoaXMubWFya2Vycyk7CiAgICAgIHZhciBoYXNNYXJrZXIgPSB0aGlzLm1hcmtlcnMuaGFzKG1hcmtlcik7CgogICAgICBpZiAoIW1hcmtlclJhbmdlKSB7CiAgICAgICAgaWYgKGhhc01hcmtlcikgewogICAgICAgICAgdGhpcy5tYXJrZXJzLnJlbW92ZShtYXJrZXIpOwogICAgICAgICAgY2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjb250YWluZWQgPSBmYWxzZTsKCiAgICAgICAgdmFyIF9pdGVyYXRvcjQgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih0aGlzLmdldFJhbmdlcygpKSwKICAgICAgICAgICAgX3N0ZXA0OwoKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIChfaXRlcmF0b3I0LnMoKTsgIShfc3RlcDQgPSBfaXRlcmF0b3I0Lm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgdmFyIHNlbGVjdGlvblJhbmdlID0gX3N0ZXA0LnZhbHVlOwoKICAgICAgICAgICAgaWYgKG1hcmtlclJhbmdlLmNvbnRhaW5zUmFuZ2Uoc2VsZWN0aW9uUmFuZ2UsICFzZWxlY3Rpb25SYW5nZS5pc0NvbGxhcHNlZCkpIHsKICAgICAgICAgICAgICBjb250YWluZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBfaXRlcmF0b3I0LmUoZXJyKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgX2l0ZXJhdG9yNC5mKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udGFpbmVkICYmICFoYXNNYXJrZXIpIHsKICAgICAgICAgIHRoaXMubWFya2Vycy5hZGQobWFya2VyKTsKICAgICAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoIWNvbnRhaW5lZCAmJiBoYXNNYXJrZXIpIHsKICAgICAgICAgIHRoaXMubWFya2Vycy5yZW1vdmUobWFya2VyKTsKICAgICAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNoYW5nZWQpIHsKICAgICAgICB0aGlzLmZpcmUoJ2NoYW5nZTptYXJrZXInLCB7CiAgICAgICAgICBvbGRNYXJrZXJzOiBvbGRNYXJrZXJzLAogICAgICAgICAgZGlyZWN0Q2hhbmdlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICB9IC8vIFVwZGF0ZXMgdGhpcyBzZWxlY3Rpb24gYXR0cmlidXRlcyBhY2NvcmRpbmcgdG8gaXRzIHJhbmdlcyBhbmQgdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50fkRvY3VtZW50IG1vZGVsIGRvY3VtZW50fS4KICAgIC8vCiAgICAvLyBAcHJvdGVjdGVkCiAgICAvLyBAcGFyYW0ge0Jvb2xlYW59IGNsZWFyQWxsCiAgICAvLyBAZmlyZXMgY2hhbmdlOmF0dHJpYnV0ZQoKICB9LCB7CiAgICBrZXk6ICJfdXBkYXRlQXR0cmlidXRlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZUF0dHJpYnV0ZXMoY2xlYXJBbGwpIHsKICAgICAgdmFyIG5ld0F0dHJpYnV0ZXMgPSB0b01hcCh0aGlzLl9nZXRTdXJyb3VuZGluZ0F0dHJpYnV0ZXMoKSk7CiAgICAgIHZhciBvbGRBdHRyaWJ1dGVzID0gdG9NYXAodGhpcy5nZXRBdHRyaWJ1dGVzKCkpOwoKICAgICAgaWYgKGNsZWFyQWxsKSB7CiAgICAgICAgLy8gSWYgYGNsZWFyQWxsYCByZW1vdmUgYWxsIGF0dHJpYnV0ZXMgYW5kIHJlc2V0IHByaW9yaXRpZXMuCiAgICAgICAgdGhpcy5fYXR0cmlidXRlUHJpb3JpdHkgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fYXR0cnMgPSBuZXcgTWFwKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgbm90LCByZW1vdmUgb25seSBhdHRyaWJ1dGVzIGFkZGVkIHdpdGggYGxvd2AgcHJpb3JpdHkuCiAgICAgICAgdmFyIF9pdGVyYXRvcjUgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eSksCiAgICAgICAgICAgIF9zdGVwNTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoX2l0ZXJhdG9yNS5zKCk7ICEoX3N0ZXA1ID0gX2l0ZXJhdG9yNS5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgIHZhciBfc3RlcDUkdmFsdWUgPSBfc2xpY2VkVG9BcnJheShfc3RlcDUudmFsdWUsIDIpLAogICAgICAgICAgICAgICAga2V5ID0gX3N0ZXA1JHZhbHVlWzBdLAogICAgICAgICAgICAgICAgcHJpb3JpdHkgPSBfc3RlcDUkdmFsdWVbMV07CgogICAgICAgICAgICBpZiAocHJpb3JpdHkgPT0gJ2xvdycpIHsKICAgICAgICAgICAgICB0aGlzLl9hdHRycy5kZWxldGUoa2V5KTsKCiAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlUHJpb3JpdHkuZGVsZXRlKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvcjUuZShlcnIpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBfaXRlcmF0b3I1LmYoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuX3NldEF0dHJpYnV0ZXNUbyhuZXdBdHRyaWJ1dGVzKTsgLy8gTGV0J3MgZXZhbHVhdGUgd2hpY2ggYXR0cmlidXRlcyByZWFsbHkgY2hhbmdlZC4KCgogICAgICB2YXIgY2hhbmdlZCA9IFtdOyAvLyBGaXJzdCwgbG9vcCB0aHJvdWdoIGFsbCBhdHRyaWJ1dGVzIHRoYXQgYXJlIHNldCBvbiBzZWxlY3Rpb24gcmlnaHQgbm93LgogICAgICAvLyBDaGVjayB3aGljaCBvZiB0aGVtIGFyZSBkaWZmZXJlbnQgdGhhbiBvbGQgYXR0cmlidXRlcy4KCiAgICAgIHZhciBfaXRlcmF0b3I2ID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy5nZXRBdHRyaWJ1dGVzKCkpLAogICAgICAgICAgX3N0ZXA2OwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKF9pdGVyYXRvcjYucygpOyAhKF9zdGVwNiA9IF9pdGVyYXRvcjYubigpKS5kb25lOykgewogICAgICAgICAgdmFyIF9zdGVwNiR2YWx1ZSA9IF9zbGljZWRUb0FycmF5KF9zdGVwNi52YWx1ZSwgMiksCiAgICAgICAgICAgICAgbmV3S2V5ID0gX3N0ZXA2JHZhbHVlWzBdLAogICAgICAgICAgICAgIG5ld1ZhbHVlID0gX3N0ZXA2JHZhbHVlWzFdOwoKICAgICAgICAgIGlmICghb2xkQXR0cmlidXRlcy5oYXMobmV3S2V5KSB8fCBvbGRBdHRyaWJ1dGVzLmdldChuZXdLZXkpICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICBjaGFuZ2VkLnB1c2gobmV3S2V5KTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIFRoZW4sIGNoZWNrIHdoaWNoIG9mIG9sZCBhdHRyaWJ1dGVzIGdvdCByZW1vdmVkLgoKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yNi5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yNi5mKCk7CiAgICAgIH0KCiAgICAgIHZhciBfaXRlcmF0b3I3ID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIob2xkQXR0cmlidXRlcyksCiAgICAgICAgICBfc3RlcDc7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yNy5zKCk7ICEoX3N0ZXA3ID0gX2l0ZXJhdG9yNy5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX3N0ZXA3JHZhbHVlID0gX3NsaWNlZFRvQXJyYXkoX3N0ZXA3LnZhbHVlLCAxKSwKICAgICAgICAgICAgICBvbGRLZXkgPSBfc3RlcDckdmFsdWVbMF07CgogICAgICAgICAgaWYgKCF0aGlzLmhhc0F0dHJpYnV0ZShvbGRLZXkpKSB7CiAgICAgICAgICAgIGNoYW5nZWQucHVzaChvbGRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0gLy8gRmlyZSBldmVudCB3aXRoIGV4YWN0IGRhdGEgKGZpcmUgb25seSBpZiBhbnl0aGluZyBjaGFuZ2VkKS4KCiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIF9pdGVyYXRvcjcuZShlcnIpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIF9pdGVyYXRvcjcuZigpOwogICAgICB9CgogICAgICBpZiAoY2hhbmdlZC5sZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy5maXJlKCdjaGFuZ2U6YXR0cmlidXRlJywgewogICAgICAgICAgYXR0cmlidXRlS2V5czogY2hhbmdlZCwKICAgICAgICAgIGRpcmVjdENoYW5nZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfSAvLyBJbnRlcm5hbCBtZXRob2QgZm9yIHNldHRpbmcgYExpdmVTZWxlY3Rpb25gIGF0dHJpYnV0ZS4gU3VwcG9ydHMgYXR0cmlidXRlIHByaW9yaXRpZXMgKHRocm91Z2ggYGRpcmVjdENoYW5nZWAKICAgIC8vIHBhcmFtZXRlcikuCiAgICAvLwogICAgLy8gQHByaXZhdGUKICAgIC8vIEBwYXJhbSB7U3RyaW5nfSBrZXkgQXR0cmlidXRlIGtleS4KICAgIC8vIEBwYXJhbSB7Kn0gdmFsdWUgQXR0cmlidXRlIHZhbHVlLgogICAgLy8gQHBhcmFtIHtCb29sZWFufSBbZGlyZWN0Q2hhbmdlPXRydWVdIGB0cnVlYCBpZiB0aGUgY2hhbmdlIGlzIGNhdXNlZCBieSBgU2VsZWN0aW9uYCBBUEksIGBmYWxzZWAgaWYgY2hhbmdlCiAgICAvLyBpcyBjYXVzZWQgYnkgYEJhdGNoYCBBUEkuCiAgICAvLyBAcmV0dXJucyB7Qm9vbGVhbn0gV2hldGhlciB2YWx1ZSBoYXMgY2hhbmdlZC4KCiAgfSwgewogICAga2V5OiAiX3NldEF0dHJpYnV0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NldEF0dHJpYnV0ZShrZXksIHZhbHVlKSB7CiAgICAgIHZhciBkaXJlY3RDaGFuZ2UgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgICAgIHZhciBwcmlvcml0eSA9IGRpcmVjdENoYW5nZSA/ICdub3JtYWwnIDogJ2xvdyc7CgogICAgICBpZiAocHJpb3JpdHkgPT0gJ2xvdycgJiYgdGhpcy5fYXR0cmlidXRlUHJpb3JpdHkuZ2V0KGtleSkgPT0gJ25vcm1hbCcpIHsKICAgICAgICAvLyBQcmlvcml0eSB0b28gbG93LgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIG9sZFZhbHVlID0gX2dldChfZ2V0UHJvdG90eXBlT2YoTGl2ZVNlbGVjdGlvbi5wcm90b3R5cGUpLCAiZ2V0QXR0cmlidXRlIiwgdGhpcykuY2FsbCh0aGlzLCBrZXkpOyAvLyBEb24ndCBkbyBhbnl0aGluZyBpZiB2YWx1ZSBoYXMgbm90IGNoYW5nZWQuCgoKICAgICAgaWYgKG9sZFZhbHVlID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdGhpcy5fYXR0cnMuc2V0KGtleSwgdmFsdWUpOyAvLyBVcGRhdGUgcHJpb3JpdGllcyBtYXAuCgoKICAgICAgdGhpcy5fYXR0cmlidXRlUHJpb3JpdHkuc2V0KGtleSwgcHJpb3JpdHkpOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IC8vIEludGVybmFsIG1ldGhvZCBmb3IgcmVtb3ZpbmcgYExpdmVTZWxlY3Rpb25gIGF0dHJpYnV0ZS4gU3VwcG9ydHMgYXR0cmlidXRlIHByaW9yaXRpZXMgKHRocm91Z2ggYGRpcmVjdENoYW5nZWAKICAgIC8vIHBhcmFtZXRlcikuCiAgICAvLwogICAgLy8gTk9URTogRXZlbiBpZiBhdHRyaWJ1dGUgaXMgbm90IHByZXNlbnQgaW4gdGhlIHNlbGVjdGlvbiBidXQgaXMgcHJvdmlkZWQgdG8gdGhpcyBtZXRob2QsIGl0J3MgcHJpb3JpdHkgd2lsbAogICAgLy8gYmUgY2hhbmdlZCBhY2NvcmRpbmcgdG8gYGRpcmVjdENoYW5nZWAgcGFyYW1ldGVyLgogICAgLy8KICAgIC8vIEBwcml2YXRlCiAgICAvLyBAcGFyYW0ge1N0cmluZ30ga2V5IEF0dHJpYnV0ZSBrZXkuCiAgICAvLyBAcGFyYW0ge0Jvb2xlYW59IFtkaXJlY3RDaGFuZ2U9dHJ1ZV0gYHRydWVgIGlmIHRoZSBjaGFuZ2UgaXMgY2F1c2VkIGJ5IGBTZWxlY3Rpb25gIEFQSSwgYGZhbHNlYCBpZiBjaGFuZ2UKICAgIC8vIGlzIGNhdXNlZCBieSBgQmF0Y2hgIEFQSS4KICAgIC8vIEByZXR1cm5zIHtCb29sZWFufSBXaGV0aGVyIGF0dHJpYnV0ZSB3YXMgcmVtb3ZlZC4gTWF5IG5vdCBiZSB0cnVlIGlmIHN1Y2ggYXR0cmlidXRlcyBkaWRuJ3QgZXhpc3Qgb3IgdGhlCiAgICAvLyBleGlzdGluZyBhdHRyaWJ1dGUgaGFkIGhpZ2hlciBwcmlvcml0eS4KCiAgfSwgewogICAga2V5OiAiX3JlbW92ZUF0dHJpYnV0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3JlbW92ZUF0dHJpYnV0ZShrZXkpIHsKICAgICAgdmFyIGRpcmVjdENoYW5nZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogdHJ1ZTsKICAgICAgdmFyIHByaW9yaXR5ID0gZGlyZWN0Q2hhbmdlID8gJ25vcm1hbCcgOiAnbG93JzsKCiAgICAgIGlmIChwcmlvcml0eSA9PSAnbG93JyAmJiB0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eS5nZXQoa2V5KSA9PSAnbm9ybWFsJykgewogICAgICAgIC8vIFByaW9yaXR5IHRvbyBsb3cuCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vIFVwZGF0ZSBwcmlvcml0aWVzIG1hcC4KCgogICAgICB0aGlzLl9hdHRyaWJ1dGVQcmlvcml0eS5zZXQoa2V5LCBwcmlvcml0eSk7IC8vIERvbid0IGRvIGFueXRoaW5nIGlmIHZhbHVlIGhhcyBub3QgY2hhbmdlZC4KCgogICAgICBpZiAoIV9nZXQoX2dldFByb3RvdHlwZU9mKExpdmVTZWxlY3Rpb24ucHJvdG90eXBlKSwgImhhc0F0dHJpYnV0ZSIsIHRoaXMpLmNhbGwodGhpcywga2V5KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdGhpcy5fYXR0cnMuZGVsZXRlKGtleSk7CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gLy8gSW50ZXJuYWwgbWV0aG9kIGZvciBzZXR0aW5nIG11bHRpcGxlIGBMaXZlU2VsZWN0aW9uYCBhdHRyaWJ1dGVzLiBTdXBwb3J0cyBhdHRyaWJ1dGUgcHJpb3JpdGllcyAodGhyb3VnaAogICAgLy8gYGRpcmVjdENoYW5nZWAgcGFyYW1ldGVyKS4KICAgIC8vCiAgICAvLyBAcHJpdmF0ZQogICAgLy8gQHBhcmFtIHtNYXAuPFN0cmluZywqPn0gYXR0cnMgSXRlcmFibGUgb2JqZWN0IGNvbnRhaW5pbmcgYXR0cmlidXRlcyB0byBiZSBzZXQuCiAgICAvLyBAcmV0dXJucyB7U2V0LjxTdHJpbmc+fSBDaGFuZ2VkIGF0dHJpYnV0ZSBrZXlzLgoKICB9LCB7CiAgICBrZXk6ICJfc2V0QXR0cmlidXRlc1RvIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfc2V0QXR0cmlidXRlc1RvKGF0dHJzKSB7CiAgICAgIHZhciBjaGFuZ2VkID0gbmV3IFNldCgpOwoKICAgICAgdmFyIF9pdGVyYXRvcjggPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih0aGlzLmdldEF0dHJpYnV0ZXMoKSksCiAgICAgICAgICBfc3RlcDg7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yOC5zKCk7ICEoX3N0ZXA4ID0gX2l0ZXJhdG9yOC5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX3N0ZXA4JHZhbHVlID0gX3NsaWNlZFRvQXJyYXkoX3N0ZXA4LnZhbHVlLCAyKSwKICAgICAgICAgICAgICBvbGRLZXkgPSBfc3RlcDgkdmFsdWVbMF0sCiAgICAgICAgICAgICAgb2xkVmFsdWUgPSBfc3RlcDgkdmFsdWVbMV07CgogICAgICAgICAgLy8gRG8gbm90IHJlbW92ZSBhdHRyaWJ1dGUgaWYgYXR0cmlidXRlIHdpdGggc2FtZSBrZXkgYW5kIHZhbHVlIGlzIGFib3V0IHRvIGJlIHNldC4KICAgICAgICAgIGlmIChhdHRycy5nZXQob2xkS2V5KSA9PT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IC8vIEFsbCByZXN0IGF0dHJpYnV0ZXMgd2lsbCBiZSByZW1vdmVkIHNvIGNoYW5nZWQgYXR0cmlidXRlcyB3b24ndCBjaGFuZ2UgLgoKCiAgICAgICAgICB0aGlzLl9yZW1vdmVBdHRyaWJ1dGUob2xkS2V5LCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBfaXRlcmF0b3I4LmUoZXJyKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBfaXRlcmF0b3I4LmYoKTsKICAgICAgfQoKICAgICAgdmFyIF9pdGVyYXRvcjkgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihhdHRycyksCiAgICAgICAgICBfc3RlcDk7CgogICAgICB0cnkgewogICAgICAgIGZvciAoX2l0ZXJhdG9yOS5zKCk7ICEoX3N0ZXA5ID0gX2l0ZXJhdG9yOS5uKCkpLmRvbmU7KSB7CiAgICAgICAgICB2YXIgX3N0ZXA5JHZhbHVlID0gX3NsaWNlZFRvQXJyYXkoX3N0ZXA5LnZhbHVlLCAyKSwKICAgICAgICAgICAgICBrZXkgPSBfc3RlcDkkdmFsdWVbMF0sCiAgICAgICAgICAgICAgdmFsdWUgPSBfc3RlcDkkdmFsdWVbMV07CgogICAgICAgICAgLy8gQXR0cmlidXRlIG1heSBub3QgYmUgc2V0IGJlY2F1c2Ugb2YgYXR0cmlidXRlcyBvciBiZWNhdXNlIHNhbWUga2V5L3ZhbHVlIGlzIGFscmVhZHkgYWRkZWQuCiAgICAgICAgICB2YXIgZ290QWRkZWQgPSB0aGlzLl9zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSwgZmFsc2UpOwoKICAgICAgICAgIGlmIChnb3RBZGRlZCkgewogICAgICAgICAgICBjaGFuZ2VkLmFkZChrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yOS5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yOS5mKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSAvLyBSZXR1cm5zIGFuIGl0ZXJhYmxlIHRoYXQgaXRlcmF0ZXMgdGhyb3VnaCBhbGwgc2VsZWN0aW9uIGF0dHJpYnV0ZXMgc3RvcmVkIGluIGN1cnJlbnQgc2VsZWN0aW9uJ3MgcGFyZW50LgogICAgLy8KICAgIC8vIEBwcm90ZWN0ZWQKICAgIC8vIEByZXR1cm5zIHtJdGVyYWJsZS48Kj59CgogIH0sIHsKICAgIGtleTogIl9nZXRTdG9yZWRBdHRyaWJ1dGVzIiwKICAgIHZhbHVlOgogICAgLyojX19QVVJFX18qLwogICAgcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2dldFN0b3JlZEF0dHJpYnV0ZXMoKSB7CiAgICAgIHZhciBzZWxlY3Rpb25QYXJlbnQsIF9pdGVyYXRvcjEwLCBfc3RlcDEwLCBrZXksIHJlYWxLZXk7CgogICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2dldFN0b3JlZEF0dHJpYnV0ZXMkKF9jb250ZXh0MikgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIHNlbGVjdGlvblBhcmVudCA9IHRoaXMuZ2V0Rmlyc3RQb3NpdGlvbigpLnBhcmVudDsKCiAgICAgICAgICAgICAgaWYgKCEodGhpcy5pc0NvbGxhcHNlZCAmJiBzZWxlY3Rpb25QYXJlbnQuaXNFbXB0eSkpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF9pdGVyYXRvcjEwID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoc2VsZWN0aW9uUGFyZW50LmdldEF0dHJpYnV0ZUtleXMoKSk7CiAgICAgICAgICAgICAgX2NvbnRleHQyLnByZXYgPSAzOwoKICAgICAgICAgICAgICBfaXRlcmF0b3IxMC5zKCk7CgogICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgaWYgKChfc3RlcDEwID0gX2l0ZXJhdG9yMTAubigpKS5kb25lKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBrZXkgPSBfc3RlcDEwLnZhbHVlOwoKICAgICAgICAgICAgICBpZiAoIWtleS5zdGFydHNXaXRoKHN0b3JlUHJlZml4KSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAxMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmVhbEtleSA9IGtleS5zdWJzdHIoc3RvcmVQcmVmaXgubGVuZ3RoKTsKICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDExOwogICAgICAgICAgICAgIHJldHVybiBbcmVhbEtleSwgc2VsZWN0aW9uUGFyZW50LmdldEF0dHJpYnV0ZShrZXkpXTsKCiAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSA1OwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDE4OwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICBfY29udGV4dDIucHJldiA9IDE1OwogICAgICAgICAgICAgIF9jb250ZXh0Mi50MCA9IF9jb250ZXh0MlsiY2F0Y2giXSgzKTsKCiAgICAgICAgICAgICAgX2l0ZXJhdG9yMTAuZShfY29udGV4dDIudDApOwoKICAgICAgICAgICAgY2FzZSAxODoKICAgICAgICAgICAgICBfY29udGV4dDIucHJldiA9IDE4OwoKICAgICAgICAgICAgICBfaXRlcmF0b3IxMC5mKCk7CgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuZmluaXNoKDE4KTsKCiAgICAgICAgICAgIGNhc2UgMjE6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfZ2V0U3RvcmVkQXR0cmlidXRlcywgdGhpcywgW1szLCAxNSwgMTgsIDIxXV0pOwogICAgfSkgLy8gQ2hlY2tzIG1vZGVsIHRleHQgbm9kZXMgdGhhdCBhcmUgY2xvc2VzdCB0byB0aGUgc2VsZWN0aW9uJ3MgZmlyc3QgcG9zaXRpb24gYW5kIHJldHVybnMgYXR0cmlidXRlcyBvZiBmaXJzdAogICAgLy8gZm91bmQgZWxlbWVudC4gSWYgdGhlcmUgYXJlIG5vIHRleHQgbm9kZXMgaW4gc2VsZWN0aW9uJ3MgZmlyc3QgcG9zaXRpb24gcGFyZW50LCBpdCByZXR1cm5zIHNlbGVjdGlvbgogICAgLy8gYXR0cmlidXRlcyBzdG9yZWQgaW4gdGhhdCBwYXJlbnQuCiAgICAvLwogICAgLy8gQHByaXZhdGUKICAgIC8vIEByZXR1cm5zIHtJdGVyYWJsZS48Kj59IENvbGxlY3Rpb24gb2YgYXR0cmlidXRlcy4KCiAgfSwgewogICAga2V5OiAiX2dldFN1cnJvdW5kaW5nQXR0cmlidXRlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFN1cnJvdW5kaW5nQXR0cmlidXRlcygpIHsKICAgICAgdmFyIHBvc2l0aW9uID0gdGhpcy5nZXRGaXJzdFBvc2l0aW9uKCk7CiAgICAgIHZhciBzY2hlbWEgPSB0aGlzLl9tb2RlbC5zY2hlbWE7CiAgICAgIHZhciBhdHRycyA9IG51bGw7CgogICAgICBpZiAoIXRoaXMuaXNDb2xsYXBzZWQpIHsKICAgICAgICAvLyAxLiBJZiBzZWxlY3Rpb24gaXMgYSByYW5nZS4uLgogICAgICAgIHZhciByYW5nZSA9IHRoaXMuZ2V0Rmlyc3RSYW5nZSgpOyAvLyAuLi5sb29rIGZvciBhIGZpcnN0IGNoYXJhY3RlciBub2RlIGluIHRoYXQgcmFuZ2UgYW5kIHRha2UgYXR0cmlidXRlcyBmcm9tIGl0LgoKICAgICAgICB2YXIgX2l0ZXJhdG9yMTEgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihyYW5nZSksCiAgICAgICAgICAgIF9zdGVwMTE7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKF9pdGVyYXRvcjExLnMoKTsgIShfc3RlcDExID0gX2l0ZXJhdG9yMTEubigpKS5kb25lOykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBfc3RlcDExLnZhbHVlOwoKICAgICAgICAgICAgLy8gSWYgdGhlIGl0ZW0gaXMgYW4gb2JqZWN0LCB3ZSBkb24ndCB3YW50IHRvIGdldCBhdHRyaWJ1dGVzIGZyb20gaXRzIGNoaWxkcmVuLgogICAgICAgICAgICBpZiAodmFsdWUuaXRlbS5pcygnZWxlbWVudCcpICYmIHNjaGVtYS5pc09iamVjdCh2YWx1ZS5pdGVtKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodmFsdWUudHlwZSA9PSAndGV4dCcpIHsKICAgICAgICAgICAgICBhdHRycyA9IHZhbHVlLml0ZW0uZ2V0QXR0cmlidXRlcygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBfaXRlcmF0b3IxMS5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvcjExLmYoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gMi4gSWYgdGhlIHNlbGVjdGlvbiBpcyBhIGNhcmV0IG9yIHRoZSByYW5nZSBkb2VzIG5vdCBjb250YWluIGEgY2hhcmFjdGVyIG5vZGUuLi4KICAgICAgICB2YXIgbm9kZUJlZm9yZSA9IHBvc2l0aW9uLnRleHROb2RlID8gcG9zaXRpb24udGV4dE5vZGUgOiBwb3NpdGlvbi5ub2RlQmVmb3JlOwogICAgICAgIHZhciBub2RlQWZ0ZXIgPSBwb3NpdGlvbi50ZXh0Tm9kZSA/IHBvc2l0aW9uLnRleHROb2RlIDogcG9zaXRpb24ubm9kZUFmdGVyOyAvLyBXaGVuIGdyYXZpdHkgaXMgb3ZlcnJpZGRlbiB0aGVuIGRvbid0IHRha2Ugbm9kZSBiZWZvcmUgaW50byBjb25zaWRlcmF0aW9uLgoKICAgICAgICBpZiAoIXRoaXMuaXNHcmF2aXR5T3ZlcnJpZGRlbikgewogICAgICAgICAgLy8gLi4ubG9vayBhdCB0aGUgbm9kZSBiZWZvcmUgY2FyZXQgYW5kIHRha2UgYXR0cmlidXRlcyBmcm9tIGl0IGlmIGl0IGlzIGEgY2hhcmFjdGVyIG5vZGUuCiAgICAgICAgICBhdHRycyA9IGdldEF0dHJzSWZDaGFyYWN0ZXIobm9kZUJlZm9yZSk7CiAgICAgICAgfSAvLyAzLiBJZiBub3QsIGxvb2sgYXQgdGhlIG5vZGUgYWZ0ZXIgY2FyZXQuLi4KCgogICAgICAgIGlmICghYXR0cnMpIHsKICAgICAgICAgIGF0dHJzID0gZ2V0QXR0cnNJZkNoYXJhY3Rlcihub2RlQWZ0ZXIpOwogICAgICAgIH0gLy8gNC4gSWYgbm90LCB0cnkgdG8gZmluZCB0aGUgZmlyc3QgY2hhcmFjdGVyIG9uIHRoZSBsZWZ0LCB0aGF0IGlzIGluIHRoZSBzYW1lIG5vZGUuCiAgICAgICAgLy8gV2hlbiBncmF2aXR5IGlzIG92ZXJyaWRkZW4gdGhlbiBkb24ndCB0YWtlIG5vZGUgYmVmb3JlIGludG8gY29uc2lkZXJhdGlvbi4KCgogICAgICAgIGlmICghdGhpcy5pc0dyYXZpdHlPdmVycmlkZGVuICYmICFhdHRycykgewogICAgICAgICAgdmFyIG5vZGUgPSBub2RlQmVmb3JlOwoKICAgICAgICAgIHdoaWxlIChub2RlICYmICFzY2hlbWEuaXNJbmxpbmUobm9kZSkgJiYgIWF0dHJzKSB7CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgICAgYXR0cnMgPSBnZXRBdHRyc0lmQ2hhcmFjdGVyKG5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0gLy8gNS4gSWYgbm90IGZvdW5kLCB0cnkgdG8gZmluZCB0aGUgZmlyc3QgY2hhcmFjdGVyIG9uIHRoZSByaWdodCwgdGhhdCBpcyBpbiB0aGUgc2FtZSBub2RlLgoKCiAgICAgICAgaWYgKCFhdHRycykgewogICAgICAgICAgdmFyIF9ub2RlID0gbm9kZUFmdGVyOwoKICAgICAgICAgIHdoaWxlIChfbm9kZSAmJiAhc2NoZW1hLmlzSW5saW5lKF9ub2RlKSAmJiAhYXR0cnMpIHsKICAgICAgICAgICAgX25vZGUgPSBfbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgYXR0cnMgPSBnZXRBdHRyc0lmQ2hhcmFjdGVyKF9ub2RlKTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIDYuIElmIG5vdCBmb3VuZCwgc2VsZWN0aW9uIHNob3VsZCByZXRyaWV2ZSBhdHRyaWJ1dGVzIGZyb20gcGFyZW50LgoKCiAgICAgICAgaWYgKCFhdHRycykgewogICAgICAgICAgYXR0cnMgPSB0aGlzLl9nZXRTdG9yZWRBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gYXR0cnM7CiAgICB9IC8vIEZpeGVzIHRoZSBzZWxlY3Rpb24gYWZ0ZXIgYWxsIGl0cyByYW5nZXMgZ290IHJlbW92ZWQuCiAgICAvLwogICAgLy8gQHByaXZhdGUKICAgIC8vIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbn0gZGVsZXRpb25Qb3NpdGlvbiBQb3NpdGlvbiB3aGVyZSB0aGUgZGVsZXRpb24gaGFwcGVuZWQuCgogIH0sIHsKICAgIGtleTogIl9maXhHcmF2ZXlhcmRTZWxlY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9maXhHcmF2ZXlhcmRTZWxlY3Rpb24oZGVsZXRpb25Qb3NpdGlvbikgewogICAgICAvLyBGaW5kIGEgcmFuZ2UgdGhhdCBpcyBhIGNvcnJlY3Qgc2VsZWN0aW9uIHJhbmdlIGFuZCBpcyBjbG9zZXN0IHRvIHRoZSBwb3NpdGlvbiB3aGVyZSB0aGUgZGVsZXRpb24gaGFwcGVuZWQuCiAgICAgIHZhciBzZWxlY3Rpb25SYW5nZSA9IHRoaXMuX21vZGVsLnNjaGVtYS5nZXROZWFyZXN0U2VsZWN0aW9uUmFuZ2UoZGVsZXRpb25Qb3NpdGlvbik7IC8vIElmIG5lYXJlc3QgdmFsaWQgc2VsZWN0aW9uIHJhbmdlIGhhcyBiZWVuIGZvdW5kIC0gYWRkIGl0IGluIHRoZSBwbGFjZSBvZiBvbGQgcmFuZ2UuCgoKICAgICAgaWYgKHNlbGVjdGlvblJhbmdlKSB7CiAgICAgICAgLy8gQ2hlY2sgdGhlIHJhbmdlLCBjb252ZXJ0IGl0IHRvIGxpdmUgcmFuZ2UsIGJpbmQgZXZlbnRzLCBldGMuCiAgICAgICAgdGhpcy5fcHVzaFJhbmdlKHNlbGVjdGlvblJhbmdlKTsKICAgICAgfSAvLyBJZiBuZWFyZXN0IHZhbGlkIHNlbGVjdGlvbiByYW5nZSBjYW5ub3QgYmUgZm91bmQgZG9uJ3QgYWRkIGFueSByYW5nZS4gU2VsZWN0aW9uIHdpbGwgYmUgc2V0IHRvIHRoZSBkZWZhdWx0IHJhbmdlLgoKICAgIH0KICB9XSk7CgogIHJldHVybiBMaXZlU2VsZWN0aW9uOwp9KFNlbGVjdGlvbik7IC8vIEhlbHBlciBmdW5jdGlvbiBmb3Ige0BsaW5rIG1vZHVsZTplbmdpbmUvbW9kZWwvbGl2ZXNlbGVjdGlvbn5MaXZlU2VsZWN0aW9uI191cGRhdGVBdHRyaWJ1dGVzfS4KLy8KLy8gSXQgdGFrZXMgbW9kZWwgaXRlbSwgY2hlY2tzIHdoZXRoZXIgaXQgaXMgYSB0ZXh0IG5vZGUgKG9yIHRleHQgcHJveHkpIGFuZCwgaWYgc28sIHJldHVybnMgaXQncyBhdHRyaWJ1dGVzLiBJZiBub3QsIHJldHVybnMgYG51bGxgLgovLwovLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvaXRlbX5JdGVtfG51bGx9ICBub2RlCi8vIEByZXR1cm5zIHtCb29sZWFufQoKCmZ1bmN0aW9uIGdldEF0dHJzSWZDaGFyYWN0ZXIobm9kZSkgewogIGlmIChub2RlIGluc3RhbmNlb2YgVGV4dFByb3h5IHx8IG5vZGUgaW5zdGFuY2VvZiBUZXh0KSB7CiAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGVzKCk7CiAgfQoKICByZXR1cm4gbnVsbDsKfSAvLyBSZW1vdmVzIHNlbGVjdGlvbiBhdHRyaWJ1dGVzIGZyb20gZWxlbWVudCB3aGljaCBpcyBub3QgZW1wdHkgYW55bW9yZS4KLy8KLy8gQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL21vZGVsfk1vZGVsfSBtb2RlbAovLyBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvYmF0Y2h+QmF0Y2h9IGJhdGNoCgoKZnVuY3Rpb24gY2xlYXJBdHRyaWJ1dGVzU3RvcmVkSW5FbGVtZW50KG1vZGVsLCBiYXRjaCkgewogIHZhciBkaWZmZXIgPSBtb2RlbC5kb2N1bWVudC5kaWZmZXI7CgogIHZhciBfaXRlcmF0b3IxMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKGRpZmZlci5nZXRDaGFuZ2VzKCkpLAogICAgICBfc3RlcDEyOwoKICB0cnkgewogICAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AoKSB7CiAgICAgIHZhciBlbnRyeSA9IF9zdGVwMTIudmFsdWU7CgogICAgICBpZiAoZW50cnkudHlwZSAhPSAnaW5zZXJ0JykgewogICAgICAgIHJldHVybiAiY29udGludWUiOwogICAgICB9CgogICAgICB2YXIgY2hhbmdlUGFyZW50ID0gZW50cnkucG9zaXRpb24ucGFyZW50OwogICAgICB2YXIgaXNOb0xvbmdlckVtcHR5ID0gZW50cnkubGVuZ3RoID09PSBjaGFuZ2VQYXJlbnQubWF4T2Zmc2V0OwoKICAgICAgaWYgKGlzTm9Mb25nZXJFbXB0eSkgewogICAgICAgIG1vZGVsLmVucXVldWVDaGFuZ2UoYmF0Y2gsIGZ1bmN0aW9uICh3cml0ZXIpIHsKICAgICAgICAgIHZhciBzdG9yZWRBdHRyaWJ1dGVzID0gQXJyYXkuZnJvbShjaGFuZ2VQYXJlbnQuZ2V0QXR0cmlidXRlS2V5cygpKS5maWx0ZXIoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4ga2V5LnN0YXJ0c1dpdGgoc3RvcmVQcmVmaXgpOwogICAgICAgICAgfSk7CgogICAgICAgICAgdmFyIF9pdGVyYXRvcjEzID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIoc3RvcmVkQXR0cmlidXRlcyksCiAgICAgICAgICAgICAgX3N0ZXAxMzsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvcjEzLnMoKTsgIShfc3RlcDEzID0gX2l0ZXJhdG9yMTMubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBfc3RlcDEzLnZhbHVlOwogICAgICAgICAgICAgIHdyaXRlci5yZW1vdmVBdHRyaWJ1dGUoa2V5LCBjaGFuZ2VQYXJlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yMTMuZShlcnIpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgX2l0ZXJhdG9yMTMuZigpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIGZvciAoX2l0ZXJhdG9yMTIucygpOyAhKF9zdGVwMTIgPSBfaXRlcmF0b3IxMi5uKCkpLmRvbmU7KSB7CiAgICAgIHZhciBfcmV0ID0gX2xvb3AoKTsKCiAgICAgIGlmIChfcmV0ID09PSAiY29udGludWUiKSBjb250aW51ZTsKICAgIH0KICB9IGNhdGNoIChlcnIpIHsKICAgIF9pdGVyYXRvcjEyLmUoZXJyKTsKICB9IGZpbmFsbHkgewogICAgX2l0ZXJhdG9yMTIuZigpOwogIH0KfQ=="},{"version":3,"sources":["/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/model/documentselection.js"],"names":["mix","EmitterMixin","Selection","LiveRange","Text","TextProxy","toMap","Collection","CKEditorError","uid","storePrefix","DocumentSelection","doc","_selection","LiveSelection","delegate","to","isCollapsed","anchor","focus","rangeCount","hasOwnRange","isBackward","isGravityOverridden","markers","_ranges","getRanges","getFirstPosition","getLastPosition","getFirstRange","getLastRange","getSelectedBlocks","getSelectedElement","element","containsEntireContent","destroy","getAttributeKeys","getAttributes","key","getAttribute","hasAttribute","_updateMarkers","_updateAttributes","prefixOrName","observeMarkers","type","itemOrPosition","offset","setFocus","selectable","placeOrOffset","options","setTo","value","setAttribute","removeAttribute","_getStoredAttributes","overrideGravity","restoreGravity","startsWith","idProperty","_model","model","_document","_attributePriority","Map","_selectionRestorePosition","_hasChangedRange","_overriddenGravityRegister","Set","_observedMarkers","listenTo","evt","args","operation","isDocumentOperation","length","_fixGraveyardSelection","fire","directChange","priority","on","range","_validateSelectionRange","marker","oldRange","newRange","_updateMarker","batch","clearAttributesStoredInElement","_getDefaultRange","start","end","size","i","detach","stopListening","optionsOrPlaceOrOffset","_setAttribute","attributeKeys","_removeAttribute","overrideUid","add","has","delete","pop","liveRange","_prepareRange","push","_checkRange","root","graveyard","fromRange","data","deletionPosition","index","indexOf","splice","changed","markerGroup","name","split","markerRange","getRange","selectionRange","containsRange","oldMarkers","Array","from","includes","remove","hasMarker","contained","clearAll","newAttributes","_getSurroundingAttributes","oldAttributes","_attrs","_setAttributesTo","newKey","newValue","get","oldKey","oldValue","set","attrs","gotAdded","selectionParent","parent","isEmpty","realKey","substr","position","schema","item","is","isObject","nodeBefore","textNode","nodeAfter","getAttrsIfCharacter","node","isInline","previousSibling","nextSibling","getNearestSelectionRange","_pushRange","differ","document","getChanges","entry","changeParent","isNoLongerEmpty","maxOffset","enqueueChange","writer","storedAttributes","filter"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA,OAAOA,GAAP,MAAgB,mCAAhB;AACA,OAAOC,YAAP,MAAyB,4CAAzB;AAEA,OAAOC,SAAP,MAAsB,aAAtB;AACA,OAAOC,SAAP,MAAsB,aAAtB;AACA,OAAOC,IAAP,MAAiB,QAAjB;AACA,OAAOC,SAAP,MAAsB,aAAtB;AACA,OAAOC,KAAP,MAAkB,qCAAlB;AACA,OAAOC,UAAP,MAAuB,0CAAvB;AACA,OAAOC,aAAP,MAA0B,6CAA1B;AACA,OAAOC,GAAP,MAAgB,mCAAhB;AAEA,IAAMC,WAAW,GAAG,YAApB;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;IACqBC,iB;AACpB;AACD;AACA;AACA;AACA;AACC,6BAAaC,GAAb,EAAmB;AAAA;;AAClB;AACF;AACA;AACA;AACA;AACE,SAAKC,UAAL,GAAkB,IAAIC,aAAJ,CAAmBF,GAAnB,CAAlB;;AAEA,SAAKC,UAAL,CAAgBE,QAAhB,CAA0B,cAA1B,EAA2CC,EAA3C,CAA+C,IAA/C;;AACA,SAAKH,UAAL,CAAgBE,QAAhB,CAA0B,kBAA1B,EAA+CC,EAA/C,CAAmD,IAAnD;;AACA,SAAKH,UAAL,CAAgBE,QAAhB,CAA0B,eAA1B,EAA4CC,EAA5C,CAAgD,IAAhD;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;;SACC,eAAkB;AACjB,aAAO,KAAKH,UAAL,CAAgBI,WAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;SACC,eAAa;AACZ,aAAO,KAAKJ,UAAL,CAAgBK,MAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;SACC,eAAY;AACX,aAAO,KAAKL,UAAL,CAAgBM,KAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;SACC,eAAiB;AAChB,aAAO,KAAKN,UAAL,CAAgBO,UAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;SACC,eAAkB;AACjB,aAAO,KAAKP,UAAL,CAAgBQ,WAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;SACC,eAAiB;AAChB,aAAO,KAAKR,UAAL,CAAgBS,UAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;;SACC,eAA0B;AACzB,aAAO,KAAKT,UAAL,CAAgBU,mBAAvB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;SACC,eAAc;AACb,aAAO,KAAKV,UAAL,CAAgBW,OAAvB;AACA;AAED;AACD;AACA;AACA;AACA;;;;SACC,eAAc;AACb,aAAO,KAAKX,UAAL,CAAgBY,OAAvB;AACA;AAED;AACD;AACA;AACA;AACA;;;;WACC,qBAAY;AACX,aAAO,KAAKZ,UAAL,CAAgBa,SAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,4BAAmB;AAClB,aAAO,KAAKb,UAAL,CAAgBc,gBAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,2BAAkB;AACjB,aAAO,KAAKd,UAAL,CAAgBe,eAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,yBAAgB;AACf,aAAO,KAAKf,UAAL,CAAgBgB,aAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,wBAAe;AACd,aAAO,KAAKhB,UAAL,CAAgBiB,YAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,6BAAoB;AACnB,aAAO,KAAKjB,UAAL,CAAgBkB,iBAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;WACC,8BAAqB;AACpB,aAAO,KAAKlB,UAAL,CAAgBmB,kBAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,+BAAuBC,OAAvB,EAAiC;AAChC,aAAO,KAAKpB,UAAL,CAAgBqB,qBAAhB,CAAuCD,OAAvC,CAAP;AACA;AAED;AACD;AACA;;;;WACC,mBAAU;AACT,WAAKpB,UAAL,CAAgBsB,OAAhB;AACA;AAED;AACD;AACA;AACA;AACA;;;;WACC,4BAAmB;AAClB,aAAO,KAAKtB,UAAL,CAAgBuB,gBAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,yBAAgB;AACf,aAAO,KAAKvB,UAAL,CAAgBwB,aAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,sBAAcC,GAAd,EAAoB;AACnB,aAAO,KAAKzB,UAAL,CAAgB0B,YAAhB,CAA8BD,GAA9B,CAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,sBAAcA,GAAd,EAAoB;AACnB,aAAO,KAAKzB,UAAL,CAAgB2B,YAAhB,CAA8BF,GAA9B,CAAP;AACA;AAED;AACD;AACA;;;;WACC,mBAAU;AACT,WAAKzB,UAAL,CAAgB4B,cAAhB;;AACA,WAAK5B,UAAL,CAAgB6B,iBAAhB,CAAmC,KAAnC;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,wBAAgBC,YAAhB,EAA+B;AAC9B,WAAK9B,UAAL,CAAgB+B,cAAhB,CAAgCD,YAAhC;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,YAAIE,IAAJ,EAAW;AACV,aAAOA,IAAI,KAAK,WAAT,IACNA,IAAI,IAAI,iBADF,IAENA,IAAI,IAAI,mBAFF,IAGNA,IAAI,IAAI,yBAHT;AAIA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,mBAAWC,cAAX,EAA2BC,MAA3B,EAAoC;AACnC,WAAKlC,UAAL,CAAgBmC,QAAhB,CAA0BF,cAA1B,EAA0CC,MAA1C;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,gBAAQE,UAAR,EAAoBC,aAApB,EAAmCC,OAAnC,EAA6C;AAC5C,WAAKtC,UAAL,CAAgBuC,KAAhB,CAAuBH,UAAvB,EAAmCC,aAAnC,EAAkDC,OAAlD;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,uBAAeb,GAAf,EAAoBe,KAApB,EAA4B;AAC3B,WAAKxC,UAAL,CAAgByC,YAAhB,CAA8BhB,GAA9B,EAAmCe,KAAnC;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,0BAAkBf,GAAlB,EAAwB;AACvB,WAAKzB,UAAL,CAAgB0C,eAAhB,CAAiCjB,GAAjC;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,gCAAuB;AACtB,aAAO,KAAKzB,UAAL,CAAgB2C,oBAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,4BAAmB;AAClB,aAAO,KAAK3C,UAAL,CAAgB4C,eAAhB,EAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,yBAAiBhD,GAAjB,EAAuB;AACtB,WAAKI,UAAL,CAAgB6C,cAAhB,CAAgCjD,GAAhC;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;WACC,+BAA8B6B,GAA9B,EAAoC;AACnC,aAAO5B,WAAW,GAAG4B,GAArB;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;WACC,8BAA6BA,GAA7B,EAA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","sourcesContent":["/**\n * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/**\n * @module engine/model/documentselection\n */\n\nimport mix from '@ckeditor/ckeditor5-utils/src/mix';\nimport EmitterMixin from '@ckeditor/ckeditor5-utils/src/emittermixin';\n\nimport Selection from './selection';\nimport LiveRange from './liverange';\nimport Text from './text';\nimport TextProxy from './textproxy';\nimport toMap from '@ckeditor/ckeditor5-utils/src/tomap';\nimport Collection from '@ckeditor/ckeditor5-utils/src/collection';\nimport CKEditorError from '@ckeditor/ckeditor5-utils/src/ckeditorerror';\nimport uid from '@ckeditor/ckeditor5-utils/src/uid';\n\nconst storePrefix = 'selection:';\n\n/**\n * `DocumentSelection` is a special selection which is used as the\n * {@link module:engine/model/document~Document#selection document's selection}.\n * There can be only one instance of `DocumentSelection` per document.\n *\n * Document selection can only be changed by using the {@link module:engine/model/writer~Writer} instance\n * inside the {@link module:engine/model/model~Model#change `change()`} block, as it provides a secure way to modify model.\n *\n * `DocumentSelection` is automatically updated upon changes in the {@link module:engine/model/document~Document document}\n * to always contain valid ranges. Its attributes are inherited from the text unless set explicitly.\n *\n * Differences between {@link module:engine/model/selection~Selection} and `DocumentSelection` are:\n * * there is always a range in `DocumentSelection` - even if no ranges were added there is a \"default range\"\n * present in the selection,\n * * ranges added to this selection updates automatically when the document changes,\n * * attributes of `DocumentSelection` are updated automatically according to selection ranges.\n *\n * Since `DocumentSelection` uses {@link module:engine/model/liverange~LiveRange live ranges}\n * and is updated when {@link module:engine/model/document~Document document}\n * changes, it cannot be set on {@link module:engine/model/node~Node nodes}\n * that are inside {@link module:engine/model/documentfragment~DocumentFragment document fragment}.\n * If you need to represent a selection in document fragment,\n * use {@link module:engine/model/selection~Selection Selection class} instead.\n *\n * @mixes module:utils/emittermixin~EmitterMixin\n */\nexport default class DocumentSelection {\n\t/**\n\t * Creates an empty live selection for given {@link module:engine/model/document~Document}.\n\t *\n\t * @param {module:engine/model/document~Document} doc Document which owns this selection.\n\t */\n\tconstructor( doc ) {\n\t\t/**\n\t\t * Selection used internally by that class (`DocumentSelection` is a proxy to that selection).\n\t\t *\n\t\t * @protected\n\t\t */\n\t\tthis._selection = new LiveSelection( doc );\n\n\t\tthis._selection.delegate( 'change:range' ).to( this );\n\t\tthis._selection.delegate( 'change:attribute' ).to( this );\n\t\tthis._selection.delegate( 'change:marker' ).to( this );\n\t}\n\n\t/**\n\t * Returns whether the selection is collapsed. Selection is collapsed when there is exactly one range which is\n\t * collapsed.\n\t *\n\t * @readonly\n\t * @type {Boolean}\n\t */\n\tget isCollapsed() {\n\t\treturn this._selection.isCollapsed;\n\t}\n\n\t/**\n\t * Selection anchor. Anchor may be described as a position where the most recent part of the selection starts.\n\t * Together with {@link #focus} they define the direction of selection, which is important\n\t * when expanding/shrinking selection. Anchor is always {@link module:engine/model/range~Range#start start} or\n\t * {@link module:engine/model/range~Range#end end} position of the most recently added range.\n\t *\n\t * Is set to `null` if there are no ranges in selection.\n\t *\n\t * @see #focus\n\t * @readonly\n\t * @type {module:engine/model/position~Position|null}\n\t */\n\tget anchor() {\n\t\treturn this._selection.anchor;\n\t}\n\n\t/**\n\t * Selection focus. Focus is a position where the selection ends.\n\t *\n\t * Is set to `null` if there are no ranges in selection.\n\t *\n\t * @see #anchor\n\t * @readonly\n\t * @type {module:engine/model/position~Position|null}\n\t */\n\tget focus() {\n\t\treturn this._selection.focus;\n\t}\n\n\t/**\n\t * Returns number of ranges in selection.\n\t *\n\t * @readonly\n\t * @type {Number}\n\t */\n\tget rangeCount() {\n\t\treturn this._selection.rangeCount;\n\t}\n\n\t/**\n\t * Describes whether `Documentselection` has own range(s) set, or if it is defaulted to\n\t * {@link module:engine/model/document~Document#_getDefaultRange document's default range}.\n\t *\n\t * @readonly\n\t * @type {Boolean}\n\t */\n\tget hasOwnRange() {\n\t\treturn this._selection.hasOwnRange;\n\t}\n\n\t/**\n\t * Specifies whether the {@link #focus}\n\t * precedes {@link #anchor}.\n\t *\n\t * @readonly\n\t * @type {Boolean}\n\t */\n\tget isBackward() {\n\t\treturn this._selection.isBackward;\n\t}\n\n\t/**\n\t * Describes whether the gravity is overridden (using {@link module:engine/model/writer~Writer#overrideSelectionGravity}) or not.\n\t *\n\t * Note that the gravity remains overridden as long as will not be restored the same number of times as it was overridden.\n\t *\n\t * @readonly\n\t * @returns {Boolean}\n\t */\n\tget isGravityOverridden() {\n\t\treturn this._selection.isGravityOverridden;\n\t}\n\n\t/**\n\t * A collection of selection {@link module:engine/model/markercollection~Marker markers}.\n\t * Marker is a selection marker when selection range is inside the marker range.\n\t *\n\t * **Note**: Only markers from {@link ~DocumentSelection#observeMarkers observed markers groups} are collected.\n\t *\n\t * @readonly\n\t * @type {module:utils/collection~Collection}\n\t */\n\tget markers() {\n\t\treturn this._selection.markers;\n\t}\n\n\t/**\n\t * Used for the compatibility with the {@link module:engine/model/selection~Selection#isEqual} method.\n\t *\n\t * @protected\n\t */\n\tget _ranges() {\n\t\treturn this._selection._ranges;\n\t}\n\n\t/**\n\t * Returns an iterable that iterates over copies of selection ranges.\n\t *\n\t * @returns {Iterable.<module:engine/model/range~Range>}\n\t */\n\tgetRanges() {\n\t\treturn this._selection.getRanges();\n\t}\n\n\t/**\n\t * Returns the first position in the selection.\n\t * First position is the position that {@link module:engine/model/position~Position#isBefore is before}\n\t * any other position in the selection.\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/position~Position|null}\n\t */\n\tgetFirstPosition() {\n\t\treturn this._selection.getFirstPosition();\n\t}\n\n\t/**\n\t * Returns the last position in the selection.\n\t * Last position is the position that {@link module:engine/model/position~Position#isAfter is after}\n\t * any other position in the selection.\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/position~Position|null}\n\t */\n\tgetLastPosition() {\n\t\treturn this._selection.getLastPosition();\n\t}\n\n\t/**\n\t * Returns a copy of the first range in the selection.\n\t * First range is the one which {@link module:engine/model/range~Range#start start} position\n\t * {@link module:engine/model/position~Position#isBefore is before} start position of all other ranges\n\t * (not to confuse with the first range added to the selection).\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/range~Range|null}\n\t */\n\tgetFirstRange() {\n\t\treturn this._selection.getFirstRange();\n\t}\n\n\t/**\n\t * Returns a copy of the last range in the selection.\n\t * Last range is the one which {@link module:engine/model/range~Range#end end} position\n\t * {@link module:engine/model/position~Position#isAfter is after} end position of all other ranges (not to confuse with the range most\n\t * recently added to the selection).\n\t *\n\t * Returns `null` if there are no ranges in selection.\n\t *\n\t * @returns {module:engine/model/range~Range|null}\n\t */\n\tgetLastRange() {\n\t\treturn this._selection.getLastRange();\n\t}\n\n\t/**\n\t * Gets elements of type {@link module:engine/model/schema~Schema#isBlock \"block\"} touched by the selection.\n\t *\n\t * This method's result can be used for example to apply block styling to all blocks covered by this selection.\n\t *\n\t * **Note:** `getSelectedBlocks()` returns blocks that are nested in other non-block elements\n\t * but will not return blocks nested in other blocks.\n\t *\n\t * In this case the function will return exactly all 3 paragraphs (note: `<blockQuote>` is not a block itself):\n\t *\n\t *\t\t<paragraph>[a</paragraph>\n\t *\t\t<blockQuote>\n\t *\t\t\t<paragraph>b</paragraph>\n\t *\t\t</blockQuote>\n\t *\t\t<paragraph>c]d</paragraph>\n\t *\n\t * In this case the paragraph will also be returned, despite the collapsed selection:\n\t *\n\t *\t\t<paragraph>[]a</paragraph>\n\t *\n\t * In such a scenario, however, only blocks A, B & E will be returned as blocks C & D are nested in block B:\n\t *\n\t *\t\t[<blockA></blockA>\n\t *\t\t<blockB>\n\t *\t\t\t<blockC></blockC>\n\t *\t\t\t<blockD></blockD>\n\t *\t\t</blockB>\n\t *\t\t<blockE></blockE>]\n\t *\n\t * If the selection is inside a block all the inner blocks (A & B) are returned:\n\t *\n\t * \t\t<block>\n\t *\t\t\t<blockA>[a</blockA>\n\t * \t\t\t<blockB>b]</blockB>\n\t * \t\t</block>\n\t *\n\t * **Special case**: If a selection ends at the beginning of a block, that block is not returned as from user perspective\n\t * this block wasn't selected. See [#984](https://github.com/ckeditor/ckeditor5-engine/issues/984) for more details.\n\t *\n\t *\t\t<paragraph>[a</paragraph>\n\t *\t\t<paragraph>b</paragraph>\n\t *\t\t<paragraph>]c</paragraph> // this block will not be returned\n\t *\n\t * @returns {Iterable.<module:engine/model/element~Element>}\n\t */\n\tgetSelectedBlocks() {\n\t\treturn this._selection.getSelectedBlocks();\n\t}\n\n\t/**\n\t * Returns the selected element. {@link module:engine/model/element~Element Element} is considered as selected if there is only\n\t * one range in the selection, and that range contains exactly one element.\n\t * Returns `null` if there is no selected element.\n\t *\n\t * @returns {module:engine/model/element~Element|null}\n\t */\n\tgetSelectedElement() {\n\t\treturn this._selection.getSelectedElement();\n\t}\n\n\t/**\n\t * Checks whether the selection contains the entire content of the given element. This means that selection must start\n\t * at a position {@link module:engine/model/position~Position#isTouching touching} the element's start and ends at position\n\t * touching the element's end.\n\t *\n\t * By default, this method will check whether the entire content of the selection's current root is selected.\n\t * Useful to check if e.g. the user has just pressed <kbd>Ctrl</kbd> + <kbd>A</kbd>.\n\t *\n\t * @param {module:engine/model/element~Element} [element=this.anchor.root]\n\t * @returns {Boolean}\n\t */\n\tcontainsEntireContent( element ) {\n\t\treturn this._selection.containsEntireContent( element );\n\t}\n\n\t/**\n\t * Unbinds all events previously bound by document selection.\n\t */\n\tdestroy() {\n\t\tthis._selection.destroy();\n\t}\n\n\t/**\n\t * Returns iterable that iterates over this selection's attribute keys.\n\t *\n\t * @returns {Iterable.<String>}\n\t */\n\tgetAttributeKeys() {\n\t\treturn this._selection.getAttributeKeys();\n\t}\n\n\t/**\n\t * Returns iterable that iterates over this selection's attributes.\n\t *\n\t * Attributes are returned as arrays containing two items. First one is attribute key and second is attribute value.\n\t * This format is accepted by native `Map` object and also can be passed in `Node` constructor.\n\t *\n\t * @returns {Iterable.<*>}\n\t */\n\tgetAttributes() {\n\t\treturn this._selection.getAttributes();\n\t}\n\n\t/**\n\t * Gets an attribute value for given key or `undefined` if that attribute is not set on the selection.\n\t *\n\t * @param {String} key Key of attribute to look for.\n\t * @returns {*} Attribute value or `undefined`.\n\t */\n\tgetAttribute( key ) {\n\t\treturn this._selection.getAttribute( key );\n\t}\n\n\t/**\n\t * Checks if the selection has an attribute for given key.\n\t *\n\t * @param {String} key Key of attribute to check.\n\t * @returns {Boolean} `true` if attribute with given key is set on selection, `false` otherwise.\n\t */\n\thasAttribute( key ) {\n\t\treturn this._selection.hasAttribute( key );\n\t}\n\n\t/**\n\t * Refreshes selection attributes and markers according to the current position in the model.\n\t */\n\trefresh() {\n\t\tthis._selection._updateMarkers();\n\t\tthis._selection._updateAttributes( false );\n\t}\n\n\t/**\n\t * Registers a marker group prefix or a marker name to be collected in the\n\t * {@link ~DocumentSelection#markers selection markers collection}.\n\t *\n\t * See also {@link module:engine/model/markercollection~MarkerCollection#getMarkersGroup `MarkerCollection#getMarkersGroup()`}.\n\t *\n\t * @param {String} prefixOrName The marker group prefix or marker name.\n\t */\n\tobserveMarkers( prefixOrName ) {\n\t\tthis._selection.observeMarkers( prefixOrName );\n\t}\n\n\t/**\n\t * Checks whether this object is of the given type.\n\t *\n\t *\t\tselection.is( 'selection' ); // -> true\n\t *\t\tselection.is( 'documentSelection' ); // -> true\n\t *\t\tselection.is( 'model:selection' ); // -> true\n\t *\t\tselection.is( 'model:documentSelection' ); // -> true\n\t *\n\t *\t\tselection.is( 'view:selection' ); // -> false\n\t *\t\tselection.is( 'element' ); // -> false\n\t *\t\tselection.is( 'node' ); // -> false\n\t *\n\t * {@link module:engine/model/node~Node#is Check the entire list of model objects} which implement the `is()` method.\n\t *\n\t * @param {String} type\n\t * @returns {Boolean}\n\t */\n\tis( type ) {\n\t\treturn type === 'selection' ||\n\t\t\ttype == 'model:selection' ||\n\t\t\ttype == 'documentSelection' ||\n\t\t\ttype == 'model:documentSelection';\n\t}\n\n\t/**\n\t * Moves {@link module:engine/model/documentselection~DocumentSelection#focus} to the specified location.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#setSelectionFocus} method.\n\t *\n\t * The location can be specified in the same form as\n\t * {@link module:engine/model/writer~Writer#createPositionAt writer.createPositionAt()} parameters.\n\t *\n\t * @see module:engine/model/writer~Writer#setSelectionFocus\n\t * @protected\n\t * @param {module:engine/model/item~Item|module:engine/model/position~Position} itemOrPosition\n\t * @param {Number|'end'|'before'|'after'} [offset] Offset or one of the flags. Used only when\n\t * first parameter is a {@link module:engine/model/item~Item model item}.\n\t */\n\t_setFocus( itemOrPosition, offset ) {\n\t\tthis._selection.setFocus( itemOrPosition, offset );\n\t}\n\n\t/**\n\t * Sets this selection's ranges and direction to the specified location based on the given\n\t * {@link module:engine/model/selection~Selectable selectable}.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#setSelection} method.\n\t *\n\t * @see module:engine/model/writer~Writer#setSelection\n\t * @protected\n\t * @param {module:engine/model/selection~Selectable} selectable\n\t * @param {Number|'before'|'end'|'after'|'on'|'in'} [placeOrOffset] Sets place or offset of the selection.\n\t * @param {Object} [options]\n\t * @param {Boolean} [options.backward] Sets this selection instance to be backward.\n\t */\n\t_setTo( selectable, placeOrOffset, options ) {\n\t\tthis._selection.setTo( selectable, placeOrOffset, options );\n\t}\n\n\t/**\n\t * Sets attribute on the selection. If attribute with the same key already is set, it's value is overwritten.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#setSelectionAttribute} method.\n\t *\n\t * @see module:engine/model/writer~Writer#setSelectionAttribute\n\t * @protected\n\t * @param {String} key Key of the attribute to set.\n\t * @param {*} value Attribute value.\n\t */\n\t_setAttribute( key, value ) {\n\t\tthis._selection.setAttribute( key, value );\n\t}\n\n\t/**\n\t * Removes an attribute with given key from the selection.\n\t * If the given attribute was set on the selection, fires the {@link module:engine/model/selection~Selection#event:change:range}\n\t * event with removed attribute key.\n\t * Should be used only within the {@link module:engine/model/writer~Writer#removeSelectionAttribute} method.\n\t *\n\t * @see module:engine/model/writer~Writer#removeSelectionAttribute\n\t * @protected\n\t * @param {String} key Key of the attribute to remove.\n\t */\n\t_removeAttribute( key ) {\n\t\tthis._selection.removeAttribute( key );\n\t}\n\n\t/**\n\t * Returns an iterable that iterates through all selection attributes stored in current selection's parent.\n\t *\n\t * @protected\n\t * @returns {Iterable.<*>}\n\t */\n\t_getStoredAttributes() {\n\t\treturn this._selection._getStoredAttributes();\n\t}\n\n\t/**\n\t * Temporarily changes the gravity of the selection from the left to the right.\n\t *\n\t * The gravity defines from which direction the selection inherits its attributes. If it's the default left\n\t * gravity, the selection (after being moved by the the user) inherits attributes from its left hand side.\n\t * This method allows to temporarily override this behavior by forcing the gravity to the right.\n\t *\n\t * It returns an unique identifier which is required to restore the gravity. It guarantees the symmetry\n\t * of the process.\n\t *\n\t * @see module:engine/model/writer~Writer#overrideSelectionGravity\n\t * @protected\n\t * @returns {String} The unique id which allows restoring the gravity.\n\t */\n\t_overrideGravity() {\n\t\treturn this._selection.overrideGravity();\n\t}\n\n\t/**\n\t * Restores the {@link ~DocumentSelection#_overrideGravity overridden gravity}.\n\t *\n\t * Restoring the gravity is only possible using the unique identifier returned by\n\t * {@link ~DocumentSelection#_overrideGravity}. Note that the gravity remains overridden as long as won't be restored\n\t * the same number of times it was overridden.\n\t *\n\t * @see module:engine/model/writer~Writer#restoreSelectionGravity\n\t * @protected\n\t * @param {String} uid The unique id returned by {@link #_overrideGravity}.\n\t */\n\t_restoreGravity( uid ) {\n\t\tthis._selection.restoreGravity( uid );\n\t}\n\n\t/**\n\t * Generates and returns an attribute key for selection attributes store, basing on original attribute key.\n\t *\n\t * @protected\n\t * @param {String} key Attribute key to convert.\n\t * @returns {String} Converted attribute key, applicable for selection store.\n\t */\n\tstatic _getStoreAttributeKey( key ) {\n\t\treturn storePrefix + key;\n\t}\n\n\t/**\n\t * Checks whether the given attribute key is an attribute stored on an element.\n\t *\n\t * @protected\n\t * @param {String} key\n\t * @returns {Boolean}\n\t */\n\tstatic _isStoreAttributeKey( key ) {\n\t\treturn key.startsWith( storePrefix );\n\t}\n}\n\nmix( DocumentSelection, EmitterMixin );\n\n/**\n * Fired when selection range(s) changed.\n *\n * @event change:range\n * @param {Boolean} directChange In case of {@link module:engine/model/selection~Selection} class it is always set\n * to `true` which indicates that the selection change was caused by a direct use of selection's API.\n * The {@link module:engine/model/documentselection~DocumentSelection}, however, may change because its position\n * was directly changed through the {@link module:engine/model/writer~Writer writer} or because its position was\n * changed because the structure of the model has been changed (which means an indirect change).\n * The indirect change does not occur in case of normal (detached) selections because they are \"static\" (as \"not live\")\n * which mean that they are not updated once the document changes.\n */\n\n/**\n * Fired when selection attribute changed.\n *\n * @event change:attribute\n * @param {Boolean} directChange In case of {@link module:engine/model/selection~Selection} class it is always set\n * to `true` which indicates that the selection change was caused by a direct use of selection's API.\n * The {@link module:engine/model/documentselection~DocumentSelection}, however, may change because its attributes\n * were directly changed through the {@link module:engine/model/writer~Writer writer} or because its position was\n * changed in the model and its attributes were refreshed (which means an indirect change).\n * The indirect change does not occur in case of normal (detached) selections because they are \"static\" (as \"not live\")\n * which mean that they are not updated once the document changes.\n * @param {Array.<String>} attributeKeys Array containing keys of attributes that changed.\n */\n\n/**\n * Fired when selection marker(s) changed.\n *\n * @event change:marker\n * @param {Boolean} directChange This is always set to `false` in case of `change:marker` event as there is no possibility\n * to change markers directly through {@link module:engine/model/documentselection~DocumentSelection} API.\n * See also {@link module:engine/model/documentselection~DocumentSelection#event:change:range} and\n * {@link module:engine/model/documentselection~DocumentSelection#event:change:attribute}.\n * @param {Array.<module:engine/model/markercollection~Marker>} oldMarkers Markers in which the selection was before the change.\n */\n\n// `LiveSelection` is used internally by {@link module:engine/model/documentselection~DocumentSelection} and shouldn't be used directly.\n//\n// LiveSelection` is automatically updated upon changes in the {@link module:engine/model/document~Document document}\n// to always contain valid ranges. Its attributes are inherited from the text unless set explicitly.\n//\n// Differences between {@link module:engine/model/selection~Selection} and `LiveSelection` are:\n// * there is always a range in `LiveSelection` - even if no ranges were added there is a \"default range\"\n// present in the selection,\n// * ranges added to this selection updates automatically when the document changes,\n// * attributes of `LiveSelection` are updated automatically according to selection ranges.\n//\n// @extends module:engine/model/selection~Selection\n//\nclass LiveSelection extends Selection {\n\t// Creates an empty live selection for given {@link module:engine/model/document~Document}.\n\t// @param {module:engine/model/document~Document} doc Document which owns this selection.\n\tconstructor( doc ) {\n\t\tsuper();\n\n\t\t// List of selection markers.\n\t\t// Marker is a selection marker when selection range is inside the marker range.\n\t\t//\n\t\t// @type {module:utils/collection~Collection}\n\t\tthis.markers = new Collection( { idProperty: 'name' } );\n\n\t\t// Document which owns this selection.\n\t\t//\n\t\t// @protected\n\t\t// @member {module:engine/model/model~Model}\n\t\tthis._model = doc.model;\n\n\t\t// Document which owns this selection.\n\t\t//\n\t\t// @protected\n\t\t// @member {module:engine/model/document~Document}\n\t\tthis._document = doc;\n\n\t\t// Keeps mapping of attribute name to priority with which the attribute got modified (added/changed/removed)\n\t\t// last time. Possible values of priority are: `'low'` and `'normal'`.\n\t\t//\n\t\t// Priorities are used by internal `LiveSelection` mechanisms. All attributes set using `LiveSelection`\n\t\t// attributes API are set with `'normal'` priority.\n\t\t//\n\t\t// @private\n\t\t// @member {Map} module:engine/model/liveselection~LiveSelection#_attributePriority\n\t\tthis._attributePriority = new Map();\n\n\t\t// Position to which the selection should be set if the last selection range was moved to the graveyard.\n\t\t// @private\n\t\t// @member {module:engine/model/position~Position} module:engine/model/liveselection~LiveSelection#_selectionRestorePosition\n\t\tthis._selectionRestorePosition = null;\n\n\t\t// Flag that informs whether the selection ranges have changed. It is changed on true when `LiveRange#change:range` event is fired.\n\t\t// @private\n\t\t// @member {Array} module:engine/model/liveselection~LiveSelection#_hasChangedRange\n\t\tthis._hasChangedRange = false;\n\n\t\t// Each overriding gravity adds an UID to the set and each removal removes it.\n\t\t// Gravity is overridden when there's at least one UID in the set.\n\t\t// Gravity is restored when the set is empty.\n\t\t// This is to prevent conflicts when gravity is overridden by more than one feature at the same time.\n\t\t// @private\n\t\t// @type {Set}\n\t\tthis._overriddenGravityRegister = new Set();\n\n\t\t// Prefixes of marker names that should affect `LiveSelection#markers` collection.\n\t\t// @private\n\t\t// @type {Set}\n\t\tthis._observedMarkers = new Set();\n\n\t\t// Ensure selection is correct after each operation.\n\t\tthis.listenTo( this._model, 'applyOperation', ( evt, args ) => {\n\t\t\tconst operation = args[ 0 ];\n\n\t\t\tif ( !operation.isDocumentOperation || operation.type == 'marker' || operation.type == 'rename' || operation.type == 'noop' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Fix selection if the last range was removed from it and we have a position to which we can restore the selection.\n\t\t\tif ( this._ranges.length == 0 && this._selectionRestorePosition ) {\n\t\t\t\tthis._fixGraveyardSelection( this._selectionRestorePosition );\n\t\t\t}\n\n\t\t\t// \"Forget\" the restore position even if it was not \"used\".\n\t\t\tthis._selectionRestorePosition = null;\n\n\t\t\tif ( this._hasChangedRange ) {\n\t\t\t\tthis._hasChangedRange = false;\n\t\t\t\tthis.fire( 'change:range', { directChange: false } );\n\t\t\t}\n\t\t}, { priority: 'lowest' } );\n\n\t\t// Ensure selection is correct and up to date after each range change.\n\t\tthis.on( 'change:range', () => {\n\t\t\tfor ( const range of this.getRanges() ) {\n\t\t\t\tif ( !this._document._validateSelectionRange( range ) ) {\n\t\t\t\t\t/**\n\t\t\t\t\t * Range from {@link module:engine/model/documentselection~DocumentSelection document selection}\n\t\t\t\t\t * starts or ends at incorrect position.\n\t\t\t\t\t *\n\t\t\t\t\t * @error document-selection-wrong-position\n\t\t\t\t\t * @param {module:engine/model/range~Range} range\n\t\t\t\t\t */\n\t\t\t\t\tthrow new CKEditorError(\n\t\t\t\t\t\t'document-selection-wrong-position',\n\t\t\t\t\t\tthis,\n\t\t\t\t\t\t{ range }\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\n\t\t// Update markers data stored by the selection after each marker change.\n\t\t// This handles only marker changes done through marker operations (not model tree changes).\n\t\tthis.listenTo( this._model.markers, 'update', ( evt, marker, oldRange, newRange ) => {\n\t\t\tthis._updateMarker( marker, newRange );\n\t\t} );\n\n\t\t// Ensure selection is up to date after each change block.\n\t\tthis.listenTo( this._document, 'change', ( evt, batch ) => {\n\t\t\tclearAttributesStoredInElement( this._model, batch );\n\t\t} );\n\t}\n\n\tget isCollapsed() {\n\t\tconst length = this._ranges.length;\n\n\t\treturn length === 0 ? this._document._getDefaultRange().isCollapsed : super.isCollapsed;\n\t}\n\n\tget anchor() {\n\t\treturn super.anchor || this._document._getDefaultRange().start;\n\t}\n\n\tget focus() {\n\t\treturn super.focus || this._document._getDefaultRange().end;\n\t}\n\n\tget rangeCount() {\n\t\treturn this._ranges.length ? this._ranges.length : 1;\n\t}\n\n\t// Describes whether `LiveSelection` has own range(s) set, or if it is defaulted to\n\t// {@link module:engine/model/document~Document#_getDefaultRange document's default range}.\n\t//\n\t// @readonly\n\t// @type {Boolean}\n\tget hasOwnRange() {\n\t\treturn this._ranges.length > 0;\n\t}\n\n\t// When set to `true` then selection attributes on node before the caret won't be taken\n\t// into consideration while updating selection attributes.\n\t//\n\t// @protected\n\t// @type {Boolean}\n\tget isGravityOverridden() {\n\t\treturn !!this._overriddenGravityRegister.size;\n\t}\n\n\t// Unbinds all events previously bound by live selection.\n\tdestroy() {\n\t\tfor ( let i = 0; i < this._ranges.length; i++ ) {\n\t\t\tthis._ranges[ i ].detach();\n\t\t}\n\n\t\tthis.stopListening();\n\t}\n\n\t* getRanges() {\n\t\tif ( this._ranges.length ) {\n\t\t\tyield* super.getRanges();\n\t\t} else {\n\t\t\tyield this._document._getDefaultRange();\n\t\t}\n\t}\n\n\tgetFirstRange() {\n\t\treturn super.getFirstRange() || this._document._getDefaultRange();\n\t}\n\n\tgetLastRange() {\n\t\treturn super.getLastRange() || this._document._getDefaultRange();\n\t}\n\n\tsetTo( selectable, optionsOrPlaceOrOffset, options ) {\n\t\tsuper.setTo( selectable, optionsOrPlaceOrOffset, options );\n\t\tthis._updateAttributes( true );\n\t\tthis._updateMarkers();\n\t}\n\n\tsetFocus( itemOrPosition, offset ) {\n\t\tsuper.setFocus( itemOrPosition, offset );\n\t\tthis._updateAttributes( true );\n\t\tthis._updateMarkers();\n\t}\n\n\tsetAttribute( key, value ) {\n\t\tif ( this._setAttribute( key, value ) ) {\n\t\t\t// Fire event with exact data.\n\t\t\tconst attributeKeys = [ key ];\n\t\t\tthis.fire( 'change:attribute', { attributeKeys, directChange: true } );\n\t\t}\n\t}\n\n\tremoveAttribute( key ) {\n\t\tif ( this._removeAttribute( key ) ) {\n\t\t\t// Fire event with exact data.\n\t\t\tconst attributeKeys = [ key ];\n\t\t\tthis.fire( 'change:attribute', { attributeKeys, directChange: true } );\n\t\t}\n\t}\n\n\toverrideGravity() {\n\t\tconst overrideUid = uid();\n\n\t\t// Remember that another overriding has been requested. It will need to be removed\n\t\t// before the gravity is to be restored.\n\t\tthis._overriddenGravityRegister.add( overrideUid );\n\n\t\tif ( this._overriddenGravityRegister.size === 1 ) {\n\t\t\tthis._updateAttributes( true );\n\t\t}\n\n\t\treturn overrideUid;\n\t}\n\n\trestoreGravity( uid ) {\n\t\tif ( !this._overriddenGravityRegister.has( uid ) ) {\n\t\t\t/**\n\t\t\t * Restoring gravity for an unknown UID is not possible. Make sure you are using a correct\n\t\t\t * UID obtained from the {@link module:engine/model/writer~Writer#overrideSelectionGravity} to restore.\n\t\t\t *\n\t\t\t * @error document-selection-gravity-wrong-restore\n\t\t\t * @param {String} uid The unique identifier returned by\n\t\t\t * {@link module:engine/model/documentselection~DocumentSelection#_overrideGravity}.\n\t\t\t */\n\t\t\tthrow new CKEditorError(\n\t\t\t\t'document-selection-gravity-wrong-restore',\n\t\t\t\tthis,\n\t\t\t\t{ uid }\n\t\t\t);\n\t\t}\n\n\t\tthis._overriddenGravityRegister.delete( uid );\n\n\t\t// Restore gravity only when all overriding have been restored.\n\t\tif ( !this.isGravityOverridden ) {\n\t\t\tthis._updateAttributes( true );\n\t\t}\n\t}\n\n\tobserveMarkers( prefixOrName ) {\n\t\tthis._observedMarkers.add( prefixOrName );\n\t\tthis._updateMarkers();\n\t}\n\n\t_popRange() {\n\t\tthis._ranges.pop().detach();\n\t}\n\n\t_pushRange( range ) {\n\t\tconst liveRange = this._prepareRange( range );\n\n\t\t// `undefined` is returned when given `range` is in graveyard root.\n\t\tif ( liveRange ) {\n\t\t\tthis._ranges.push( liveRange );\n\t\t}\n\t}\n\n\t// Prepares given range to be added to selection. Checks if it is correct,\n\t// converts it to {@link module:engine/model/liverange~LiveRange LiveRange}\n\t// and sets listeners listening to the range's change event.\n\t//\n\t// @private\n\t// @param {module:engine/model/range~Range} range\n\t_prepareRange( range ) {\n\t\tthis._checkRange( range );\n\n\t\tif ( range.root == this._document.graveyard ) {\n\t\t\t// @if CK_DEBUG // console.warn( 'Trying to add a Range that is in the graveyard root. Range rejected.' );\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst liveRange = LiveRange.fromRange( range );\n\n\t\t// If selection range is moved to the graveyard remove it from the selection object.\n\t\t// Also, save some data that can be used to restore selection later, on `Model#applyOperation` event.\n\t\tliveRange.on( 'change:range', ( evt, oldRange, data ) => {\n\t\t\tthis._hasChangedRange = true;\n\n\t\t\tif ( liveRange.root == this._document.graveyard ) {\n\t\t\t\tthis._selectionRestorePosition = data.deletionPosition;\n\n\t\t\t\tconst index = this._ranges.indexOf( liveRange );\n\t\t\t\tthis._ranges.splice( index, 1 );\n\t\t\t\tliveRange.detach();\n\t\t\t}\n\t\t} );\n\n\t\treturn liveRange;\n\t}\n\n\t_updateMarkers() {\n\t\tif ( !this._observedMarkers.size ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst markers = [];\n\t\tlet changed = false;\n\n\t\tfor ( const marker of this._model.markers ) {\n\t\t\tconst markerGroup = marker.name.split( ':', 1 )[ 0 ];\n\n\t\t\tif ( !this._observedMarkers.has( markerGroup ) ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst markerRange = marker.getRange();\n\n\t\t\tfor ( const selectionRange of this.getRanges() ) {\n\t\t\t\tif ( markerRange.containsRange( selectionRange, !selectionRange.isCollapsed ) ) {\n\t\t\t\t\tmarkers.push( marker );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst oldMarkers = Array.from( this.markers );\n\n\t\tfor ( const marker of markers ) {\n\t\t\tif ( !this.markers.has( marker ) ) {\n\t\t\t\tthis.markers.add( marker );\n\n\t\t\t\tchanged = true;\n\t\t\t}\n\t\t}\n\n\t\tfor ( const marker of Array.from( this.markers ) ) {\n\t\t\tif ( !markers.includes( marker ) ) {\n\t\t\t\tthis.markers.remove( marker );\n\n\t\t\t\tchanged = true;\n\t\t\t}\n\t\t}\n\n\t\tif ( changed ) {\n\t\t\tthis.fire( 'change:marker', { oldMarkers, directChange: false } );\n\t\t}\n\t}\n\n\t_updateMarker( marker, markerRange ) {\n\t\tconst markerGroup = marker.name.split( ':', 1 )[ 0 ];\n\n\t\tif ( !this._observedMarkers.has( markerGroup ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet changed = false;\n\n\t\tconst oldMarkers = Array.from( this.markers );\n\t\tconst hasMarker = this.markers.has( marker );\n\n\t\tif ( !markerRange ) {\n\t\t\tif ( hasMarker ) {\n\t\t\t\tthis.markers.remove( marker );\n\t\t\t\tchanged = true;\n\t\t\t}\n\t\t} else {\n\t\t\tlet contained = false;\n\n\t\t\tfor ( const selectionRange of this.getRanges() ) {\n\t\t\t\tif ( markerRange.containsRange( selectionRange, !selectionRange.isCollapsed ) ) {\n\t\t\t\t\tcontained = true;\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ( contained && !hasMarker ) {\n\t\t\t\tthis.markers.add( marker );\n\n\t\t\t\tchanged = true;\n\t\t\t} else if ( !contained && hasMarker ) {\n\t\t\t\tthis.markers.remove( marker );\n\n\t\t\t\tchanged = true;\n\t\t\t}\n\t\t}\n\n\t\tif ( changed ) {\n\t\t\tthis.fire( 'change:marker', { oldMarkers, directChange: false } );\n\t\t}\n\t}\n\n\t// Updates this selection attributes according to its ranges and the {@link module:engine/model/document~Document model document}.\n\t//\n\t// @protected\n\t// @param {Boolean} clearAll\n\t// @fires change:attribute\n\t_updateAttributes( clearAll ) {\n\t\tconst newAttributes = toMap( this._getSurroundingAttributes() );\n\t\tconst oldAttributes = toMap( this.getAttributes() );\n\n\t\tif ( clearAll ) {\n\t\t\t// If `clearAll` remove all attributes and reset priorities.\n\t\t\tthis._attributePriority = new Map();\n\t\t\tthis._attrs = new Map();\n\t\t} else {\n\t\t\t// If not, remove only attributes added with `low` priority.\n\t\t\tfor ( const [ key, priority ] of this._attributePriority ) {\n\t\t\t\tif ( priority == 'low' ) {\n\t\t\t\t\tthis._attrs.delete( key );\n\t\t\t\t\tthis._attributePriority.delete( key );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._setAttributesTo( newAttributes );\n\n\t\t// Let's evaluate which attributes really changed.\n\t\tconst changed = [];\n\n\t\t// First, loop through all attributes that are set on selection right now.\n\t\t// Check which of them are different than old attributes.\n\t\tfor ( const [ newKey, newValue ] of this.getAttributes() ) {\n\t\t\tif ( !oldAttributes.has( newKey ) || oldAttributes.get( newKey ) !== newValue ) {\n\t\t\t\tchanged.push( newKey );\n\t\t\t}\n\t\t}\n\n\t\t// Then, check which of old attributes got removed.\n\t\tfor ( const [ oldKey ] of oldAttributes ) {\n\t\t\tif ( !this.hasAttribute( oldKey ) ) {\n\t\t\t\tchanged.push( oldKey );\n\t\t\t}\n\t\t}\n\n\t\t// Fire event with exact data (fire only if anything changed).\n\t\tif ( changed.length > 0 ) {\n\t\t\tthis.fire( 'change:attribute', { attributeKeys: changed, directChange: false } );\n\t\t}\n\t}\n\n\t// Internal method for setting `LiveSelection` attribute. Supports attribute priorities (through `directChange`\n\t// parameter).\n\t//\n\t// @private\n\t// @param {String} key Attribute key.\n\t// @param {*} value Attribute value.\n\t// @param {Boolean} [directChange=true] `true` if the change is caused by `Selection` API, `false` if change\n\t// is caused by `Batch` API.\n\t// @returns {Boolean} Whether value has changed.\n\t_setAttribute( key, value, directChange = true ) {\n\t\tconst priority = directChange ? 'normal' : 'low';\n\n\t\tif ( priority == 'low' && this._attributePriority.get( key ) == 'normal' ) {\n\t\t\t// Priority too low.\n\t\t\treturn false;\n\t\t}\n\n\t\tconst oldValue = super.getAttribute( key );\n\n\t\t// Don't do anything if value has not changed.\n\t\tif ( oldValue === value ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._attrs.set( key, value );\n\n\t\t// Update priorities map.\n\t\tthis._attributePriority.set( key, priority );\n\n\t\treturn true;\n\t}\n\n\t// Internal method for removing `LiveSelection` attribute. Supports attribute priorities (through `directChange`\n\t// parameter).\n\t//\n\t// NOTE: Even if attribute is not present in the selection but is provided to this method, it's priority will\n\t// be changed according to `directChange` parameter.\n\t//\n\t// @private\n\t// @param {String} key Attribute key.\n\t// @param {Boolean} [directChange=true] `true` if the change is caused by `Selection` API, `false` if change\n\t// is caused by `Batch` API.\n\t// @returns {Boolean} Whether attribute was removed. May not be true if such attributes didn't exist or the\n\t// existing attribute had higher priority.\n\t_removeAttribute( key, directChange = true ) {\n\t\tconst priority = directChange ? 'normal' : 'low';\n\n\t\tif ( priority == 'low' && this._attributePriority.get( key ) == 'normal' ) {\n\t\t\t// Priority too low.\n\t\t\treturn false;\n\t\t}\n\n\t\t// Update priorities map.\n\t\tthis._attributePriority.set( key, priority );\n\n\t\t// Don't do anything if value has not changed.\n\t\tif ( !super.hasAttribute( key ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._attrs.delete( key );\n\n\t\treturn true;\n\t}\n\n\t// Internal method for setting multiple `LiveSelection` attributes. Supports attribute priorities (through\n\t// `directChange` parameter).\n\t//\n\t// @private\n\t// @param {Map.<String,*>} attrs Iterable object containing attributes to be set.\n\t// @returns {Set.<String>} Changed attribute keys.\n\t_setAttributesTo( attrs ) {\n\t\tconst changed = new Set();\n\n\t\tfor ( const [ oldKey, oldValue ] of this.getAttributes() ) {\n\t\t\t// Do not remove attribute if attribute with same key and value is about to be set.\n\t\t\tif ( attrs.get( oldKey ) === oldValue ) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// All rest attributes will be removed so changed attributes won't change .\n\t\t\tthis._removeAttribute( oldKey, false );\n\t\t}\n\n\t\tfor ( const [ key, value ] of attrs ) {\n\t\t\t// Attribute may not be set because of attributes or because same key/value is already added.\n\t\t\tconst gotAdded = this._setAttribute( key, value, false );\n\n\t\t\tif ( gotAdded ) {\n\t\t\t\tchanged.add( key );\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t}\n\n\t// Returns an iterable that iterates through all selection attributes stored in current selection's parent.\n\t//\n\t// @protected\n\t// @returns {Iterable.<*>}\n\t* _getStoredAttributes() {\n\t\tconst selectionParent = this.getFirstPosition().parent;\n\n\t\tif ( this.isCollapsed && selectionParent.isEmpty ) {\n\t\t\tfor ( const key of selectionParent.getAttributeKeys() ) {\n\t\t\t\tif ( key.startsWith( storePrefix ) ) {\n\t\t\t\t\tconst realKey = key.substr( storePrefix.length );\n\n\t\t\t\t\tyield [ realKey, selectionParent.getAttribute( key ) ];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Checks model text nodes that are closest to the selection's first position and returns attributes of first\n\t// found element. If there are no text nodes in selection's first position parent, it returns selection\n\t// attributes stored in that parent.\n\t//\n\t// @private\n\t// @returns {Iterable.<*>} Collection of attributes.\n\t_getSurroundingAttributes() {\n\t\tconst position = this.getFirstPosition();\n\t\tconst schema = this._model.schema;\n\n\t\tlet attrs = null;\n\n\t\tif ( !this.isCollapsed ) {\n\t\t\t// 1. If selection is a range...\n\t\t\tconst range = this.getFirstRange();\n\n\t\t\t// ...look for a first character node in that range and take attributes from it.\n\t\t\tfor ( const value of range ) {\n\t\t\t\t// If the item is an object, we don't want to get attributes from its children.\n\t\t\t\tif ( value.item.is( 'element' ) && schema.isObject( value.item ) ) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif ( value.type == 'text' ) {\n\t\t\t\t\tattrs = value.item.getAttributes();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// 2. If the selection is a caret or the range does not contain a character node...\n\n\t\t\tconst nodeBefore = position.textNode ? position.textNode : position.nodeBefore;\n\t\t\tconst nodeAfter = position.textNode ? position.textNode : position.nodeAfter;\n\n\t\t\t// When gravity is overridden then don't take node before into consideration.\n\t\t\tif ( !this.isGravityOverridden ) {\n\t\t\t\t// ...look at the node before caret and take attributes from it if it is a character node.\n\t\t\t\tattrs = getAttrsIfCharacter( nodeBefore );\n\t\t\t}\n\n\t\t\t// 3. If not, look at the node after caret...\n\t\t\tif ( !attrs ) {\n\t\t\t\tattrs = getAttrsIfCharacter( nodeAfter );\n\t\t\t}\n\n\t\t\t// 4. If not, try to find the first character on the left, that is in the same node.\n\t\t\t// When gravity is overridden then don't take node before into consideration.\n\t\t\tif ( !this.isGravityOverridden && !attrs ) {\n\t\t\t\tlet node = nodeBefore;\n\n\t\t\t\twhile ( node && !schema.isInline( node ) && !attrs ) {\n\t\t\t\t\tnode = node.previousSibling;\n\t\t\t\t\tattrs = getAttrsIfCharacter( node );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 5. If not found, try to find the first character on the right, that is in the same node.\n\t\t\tif ( !attrs ) {\n\t\t\t\tlet node = nodeAfter;\n\n\t\t\t\twhile ( node && !schema.isInline( node ) && !attrs ) {\n\t\t\t\t\tnode = node.nextSibling;\n\t\t\t\t\tattrs = getAttrsIfCharacter( node );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 6. If not found, selection should retrieve attributes from parent.\n\t\t\tif ( !attrs ) {\n\t\t\t\tattrs = this._getStoredAttributes();\n\t\t\t}\n\t\t}\n\n\t\treturn attrs;\n\t}\n\n\t// Fixes the selection after all its ranges got removed.\n\t//\n\t// @private\n\t// @param {module:engine/model/position~Position} deletionPosition Position where the deletion happened.\n\t_fixGraveyardSelection( deletionPosition ) {\n\t\t// Find a range that is a correct selection range and is closest to the position where the deletion happened.\n\t\tconst selectionRange = this._model.schema.getNearestSelectionRange( deletionPosition );\n\n\t\t// If nearest valid selection range has been found - add it in the place of old range.\n\t\tif ( selectionRange ) {\n\t\t\t// Check the range, convert it to live range, bind events, etc.\n\t\t\tthis._pushRange( selectionRange );\n\t\t}\n\t\t// If nearest valid selection range cannot be found don't add any range. Selection will be set to the default range.\n\t}\n}\n\n// Helper function for {@link module:engine/model/liveselection~LiveSelection#_updateAttributes}.\n//\n// It takes model item, checks whether it is a text node (or text proxy) and, if so, returns it's attributes. If not, returns `null`.\n//\n// @param {module:engine/model/item~Item|null}  node\n// @returns {Boolean}\nfunction getAttrsIfCharacter( node ) {\n\tif ( node instanceof TextProxy || node instanceof Text ) {\n\t\treturn node.getAttributes();\n\t}\n\n\treturn null;\n}\n\n// Removes selection attributes from element which is not empty anymore.\n//\n// @param {module:engine/model/model~Model} model\n// @param {module:engine/model/batch~Batch} batch\nfunction clearAttributesStoredInElement( model, batch ) {\n\tconst differ = model.document.differ;\n\n\tfor ( const entry of differ.getChanges() ) {\n\t\tif ( entry.type != 'insert' ) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst changeParent = entry.position.parent;\n\t\tconst isNoLongerEmpty = entry.length === changeParent.maxOffset;\n\n\t\tif ( isNoLongerEmpty ) {\n\t\t\tmodel.enqueueChange( batch, writer => {\n\t\t\t\tconst storedAttributes = Array.from( changeParent.getAttributeKeys() )\n\t\t\t\t\t.filter( key => key.startsWith( storePrefix ) );\n\n\t\t\t\tfor ( const key of storedAttributes ) {\n\t\t\t\t\twriter.removeAttribute( key, changeParent );\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n}\n"]}]}