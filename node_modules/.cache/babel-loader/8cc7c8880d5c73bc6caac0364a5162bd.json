{"remainingRequest":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js?{}!/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/model/utils/insertcontent.js","dependencies":[{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/model/utils/insertcontent.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-dev-webpack-plugin/lib/translatesourceloader.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICIvaG9tZS9la2ViZXJhdC9ZYW5kZXguRGlzay9Qcm9qZWxlcmltL0JlbmltUHJvamVsZXJpbS93ZWJzaXRlbS93ZWJzaXRlbS13ZWIvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NyZWF0ZUNsYXNzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLmFuY2hvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zZXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZnJvbS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnNwbGl0LmpzIjsKCi8qKgogKiBAbGljZW5zZSBDb3B5cmlnaHQgKGMpIDIwMDMtMjAyMSwgQ0tTb3VyY2UgLSBGcmVkZXJpY28gS25hYmJlbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogRm9yIGxpY2Vuc2luZywgc2VlIExJQ0VOU0UubWQgb3IgaHR0cHM6Ly9ja2VkaXRvci5jb20vbGVnYWwvY2tlZGl0b3Itb3NzLWxpY2Vuc2UKICovCgovKioKICogQG1vZHVsZSBlbmdpbmUvbW9kZWwvdXRpbHMvaW5zZXJ0Y29udGVudAogKi8KaW1wb3J0IFBvc2l0aW9uIGZyb20gJy4uL3Bvc2l0aW9uJzsKaW1wb3J0IExpdmVQb3NpdGlvbiBmcm9tICcuLi9saXZlcG9zaXRpb24nOwppbXBvcnQgRWxlbWVudCBmcm9tICcuLi9lbGVtZW50JzsKaW1wb3J0IFJhbmdlIGZyb20gJy4uL3JhbmdlJzsKaW1wb3J0IERvY3VtZW50U2VsZWN0aW9uIGZyb20gJy4uL2RvY3VtZW50c2VsZWN0aW9uJzsKaW1wb3J0IFNlbGVjdGlvbiBmcm9tICcuLi9zZWxlY3Rpb24nOwppbXBvcnQgQ0tFZGl0b3JFcnJvciBmcm9tICdAY2tlZGl0b3IvY2tlZGl0b3I1LXV0aWxzL3NyYy9ja2VkaXRvcmVycm9yJzsKLyoqCiAqIEluc2VydHMgY29udGVudCBpbnRvIHRoZSBlZGl0b3IgKHNwZWNpZmllZCBzZWxlY3Rpb24pIGFzIG9uZSB3b3VsZCBleHBlY3QgdGhlIHBhc3RlIGZ1bmN0aW9uYWxpdHkgdG8gd29yay4KICoKICogSXQgdGFrZXMgY2FyZSBvZiByZW1vdmluZyB0aGUgc2VsZWN0ZWQgY29udGVudCwgc3BsaXR0aW5nIGVsZW1lbnRzIChpZiBuZWVkZWQpLCBpbnNlcnRpbmcgZWxlbWVudHMgYW5kIG1lcmdpbmcgZWxlbWVudHMgYXBwcm9wcmlhdGVseS4KICoKICogU29tZSBleGFtcGxlczoKICoKICogCQk8cD54XjwvcD4gKyA8cD55PC9wPiA9PiA8cD54PC9wPjxwPnk8L3A+ID0+IDxwPnh5W108L3A+CiAqIAkJPHA+eF55PC9wPiArIDxwPno8L3A+ID0+IDxwPng8L3A+XjxwPnk8L3A+ICsgPHA+ejwvcD4gPT4gPHA+eDwvcD48cD56PC9wPjxwPnk8L3A+ID0+IDxwPnh6W115PC9wPgogKiAJCTxwPnheeTwvcD4gKyA8aW1nIC8+ID0+IDxwPng8L3A+XjxwPnk8L3A+ICsgPGltZyAvPiA9PiA8cD54PC9wPjxpbWcgLz48cD55PC9wPgogKiAJCTxwPng8L3A+PHA+XjwvcD48cD56PC9wPiArIDxwPnk8L3A+ID0+IDxwPng8L3A+PHA+eVtdPC9wPjxwPno8L3A+IChubyBtZXJnaW5nKQogKiAJCTxwPng8L3A+WzxpbWcgLz5dPHA+ejwvcD4gKyA8cD55PC9wPiA9PiA8cD54PC9wPl48cD56PC9wPiArIDxwPnk8L3A+ID0+IDxwPng8L3A+PHA+eVtdPC9wPjxwPno8L3A+CiAqCiAqIElmIGFuIGluc3RhbmNlIG9mIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL3NlbGVjdGlvbn5TZWxlY3Rpb259IGlzIHBhc3NlZCBhcyBgc2VsZWN0YWJsZWAgaXQgd2lsbCBiZSBtb2RpZmllZAogKiB0byB0aGUgaW5zZXJ0aW9uIHNlbGVjdGlvbiAoZXF1YWwgdG8gYSByYW5nZSB0byBiZSBzZWxlY3RlZCBhZnRlciBpbnNlcnRpb24pLgogKgogKiBJZiBgc2VsZWN0YWJsZWAgaXMgbm90IHBhc3NlZCwgdGhlIGNvbnRlbnQgd2lsbCBiZSBpbnNlcnRlZCB1c2luZyB0aGUgY3VycmVudCBzZWxlY3Rpb24gb2YgdGhlIG1vZGVsIGRvY3VtZW50LgogKgogKiAqKk5vdGU6KiogVXNlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL21vZGVsfk1vZGVsI2luc2VydENvbnRlbnR9IGluc3RlYWQgb2YgdGhpcyBmdW5jdGlvbi4KICogVGhpcyBmdW5jdGlvbiBpcyBvbmx5IGV4cG9zZWQgdG8gYmUgcmV1c2FibGUgaW4gYWxnb3JpdGhtcyB3aGljaCBjaGFuZ2UgdGhlIHtAbGluayBtb2R1bGU6ZW5naW5lL21vZGVsL21vZGVsfk1vZGVsI2luc2VydENvbnRlbnR9CiAqIG1ldGhvZCdzIGJlaGF2aW9yLgogKgogKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvbW9kZWx+TW9kZWx9IG1vZGVsIFRoZSBtb2RlbCBpbiBjb250ZXh0IG9mIHdoaWNoIHRoZSBpbnNlcnRpb24KICogc2hvdWxkIGJlIHBlcmZvcm1lZC4KICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL2RvY3VtZW50ZnJhZ21lbnR+RG9jdW1lbnRGcmFnbWVudHxtb2R1bGU6ZW5naW5lL21vZGVsL2l0ZW1+SXRlbX0gY29udGVudCBUaGUgY29udGVudCB0byBpbnNlcnQuCiAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9zZWxlY3Rpb25+U2VsZWN0YWJsZX0gW3NlbGVjdGFibGU9bW9kZWwuZG9jdW1lbnQuc2VsZWN0aW9uXQogKiBTZWxlY3Rpb24gaW50byB3aGljaCB0aGUgY29udGVudCBzaG91bGQgYmUgaW5zZXJ0ZWQuCiAqIEBwYXJhbSB7TnVtYmVyfCdiZWZvcmUnfCdlbmQnfCdhZnRlcid8J29uJ3wnaW4nfSBbcGxhY2VPck9mZnNldF0gU2V0cyBwbGFjZSBvciBvZmZzZXQgb2YgdGhlIHNlbGVjdGlvbi4KICogQHJldHVybnMge21vZHVsZTplbmdpbmUvbW9kZWwvcmFuZ2V+UmFuZ2V9IFJhbmdlIHdoaWNoIGNvbnRhaW5zIGFsbCB0aGUgcGVyZm9ybWVkIGNoYW5nZXMuIFRoaXMgaXMgYSByYW5nZSB0aGF0LCBpZiByZW1vdmVkLAogKiB3b3VsZCByZXR1cm4gdGhlIG1vZGVsIHRvIHRoZSBzdGF0ZSBiZWZvcmUgdGhlIGluc2VydGlvbi4gSWYgbm8gY2hhbmdlcyB3ZXJlIHByZWZvcm1lZCBieSBgaW5zZXJ0Q29udGVudGAsIHJldHVybnMgYSByYW5nZSBjb2xsYXBzZWQKICogYXQgdGhlIGluc2VydGlvbiBwb3NpdGlvbi4KICovCgpleHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBpbnNlcnRDb250ZW50KG1vZGVsLCBjb250ZW50LCBzZWxlY3RhYmxlLCBwbGFjZU9yT2Zmc2V0KSB7CiAgcmV0dXJuIG1vZGVsLmNoYW5nZShmdW5jdGlvbiAod3JpdGVyKSB7CiAgICB2YXIgc2VsZWN0aW9uOwoKICAgIGlmICghc2VsZWN0YWJsZSkgewogICAgICBzZWxlY3Rpb24gPSBtb2RlbC5kb2N1bWVudC5zZWxlY3Rpb247CiAgICB9IGVsc2UgaWYgKHNlbGVjdGFibGUgaW5zdGFuY2VvZiBTZWxlY3Rpb24gfHwgc2VsZWN0YWJsZSBpbnN0YW5jZW9mIERvY3VtZW50U2VsZWN0aW9uKSB7CiAgICAgIHNlbGVjdGlvbiA9IHNlbGVjdGFibGU7CiAgICB9IGVsc2UgewogICAgICBzZWxlY3Rpb24gPSB3cml0ZXIuY3JlYXRlU2VsZWN0aW9uKHNlbGVjdGFibGUsIHBsYWNlT3JPZmZzZXQpOwogICAgfQoKICAgIGlmICghc2VsZWN0aW9uLmlzQ29sbGFwc2VkKSB7CiAgICAgIG1vZGVsLmRlbGV0ZUNvbnRlbnQoc2VsZWN0aW9uLCB7CiAgICAgICAgZG9Ob3RBdXRvcGFyYWdyYXBoOiB0cnVlCiAgICAgIH0pOwogICAgfQoKICAgIHZhciBpbnNlcnRpb24gPSBuZXcgSW5zZXJ0aW9uKG1vZGVsLCB3cml0ZXIsIHNlbGVjdGlvbi5hbmNob3IpOwogICAgdmFyIG5vZGVzVG9JbnNlcnQ7CgogICAgaWYgKGNvbnRlbnQuaXMoJ2RvY3VtZW50RnJhZ21lbnQnKSkgewogICAgICBub2Rlc1RvSW5zZXJ0ID0gY29udGVudC5nZXRDaGlsZHJlbigpOwogICAgfSBlbHNlIHsKICAgICAgbm9kZXNUb0luc2VydCA9IFtjb250ZW50XTsKICAgIH0KCiAgICBpbnNlcnRpb24uaGFuZGxlTm9kZXMobm9kZXNUb0luc2VydCk7CiAgICB2YXIgbmV3UmFuZ2UgPSBpbnNlcnRpb24uZ2V0U2VsZWN0aW9uUmFuZ2UoKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgogICAgaWYgKG5ld1JhbmdlKSB7CiAgICAgIGlmIChzZWxlY3Rpb24gaW5zdGFuY2VvZiBEb2N1bWVudFNlbGVjdGlvbikgewogICAgICAgIHdyaXRlci5zZXRTZWxlY3Rpb24obmV3UmFuZ2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGVjdGlvbi5zZXRUbyhuZXdSYW5nZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7Ly8gV2UgYXJlIG5vdCB0ZXN0aW5nIGVsc2UgYmVjYXVzZSBpdCdzIGEgc2FmZSBjaGVjayBmb3IgdW5wcmVkaWN0YWJsZSBlZGdlIGNhc2VzOgogICAgICAvLyBhbiBpbnNlcnRpb24gd2l0aG91dCBwcm9wZXIgcmFuZ2UgdG8gc2VsZWN0LgogICAgICAvLwogICAgICAvLyBAaWYgQ0tfREVCVUcgLy8gY29uc29sZS53YXJuKCAnQ2Fubm90IGRldGVybWluZSBhIHByb3BlciBzZWxlY3Rpb24gcmFuZ2UgYWZ0ZXIgaW5zZXJ0aW9uLicgKTsKICAgIH0KCiAgICB2YXIgYWZmZWN0ZWRSYW5nZSA9IGluc2VydGlvbi5nZXRBZmZlY3RlZFJhbmdlKCkgfHwgbW9kZWwuY3JlYXRlUmFuZ2Uoc2VsZWN0aW9uLmFuY2hvcik7CiAgICBpbnNlcnRpb24uZGVzdHJveSgpOwogICAgcmV0dXJuIGFmZmVjdGVkUmFuZ2U7CiAgfSk7Cn0KLyoqCiAqIFV0aWxpdHkgY2xhc3MgZm9yIHBlcmZvcm1pbmcgY29udGVudCBpbnNlcnRpb24uCiAqCiAqIEBwcml2YXRlCiAqLwoKdmFyIEluc2VydGlvbiA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gSW5zZXJ0aW9uKG1vZGVsLCB3cml0ZXIsIHBvc2l0aW9uKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSW5zZXJ0aW9uKTsKCiAgICAvKioKICAgICAqIFRoZSBtb2RlbCBpbiBjb250ZXh0IG9mIHdoaWNoIHRoZSBpbnNlcnRpb24gc2hvdWxkIGJlIHBlcmZvcm1lZC4KICAgICAqCiAgICAgKiBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL21vZGVsfk1vZGVsfSAjbW9kZWwKICAgICAqLwogICAgdGhpcy5tb2RlbCA9IG1vZGVsOwogICAgLyoqCiAgICAgKiBCYXRjaCB0byB3aGljaCBvcGVyYXRpb25zIHdpbGwgYmUgYWRkZWQuCiAgICAgKgogICAgICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9jb250cm9sbGVyL3dyaXRlcn5CYXRjaH0gI3dyaXRlcgogICAgICovCgogICAgdGhpcy53cml0ZXIgPSB3cml0ZXI7CiAgICAvKioKICAgICAqIFRoZSBwb3NpdGlvbiBhdCB3aGljaCAob3IgbmVhciB3aGljaCkgdGhlIG5leHQgbm9kZSB3aWxsIGJlIGluc2VydGVkLgogICAgICoKICAgICAqIEBtZW1iZXIge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb259ICNwb3NpdGlvbgogICAgICovCgogICAgdGhpcy5wb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgLyoqCiAgICAgKiBFbGVtZW50cyB3aXRoIHdoaWNoIHRoZSBpbnNlcnRlZCBlbGVtZW50cyBjYW4gYmUgbWVyZ2VkLgogICAgICoKICAgICAqCQk8cD54XjwvcD48cD55PC9wPiArIDxwPno8L3A+IChjYW4gbWVyZ2UgdG8gPHA+eDwvcD4pCiAgICAgKgkJPHA+eDwvcD48cD5eeTwvcD4gKyA8cD56PC9wPiAoY2FuIG1lcmdlIHRvIDxwPnk8L3A+KQogICAgICoJCTxwPnheeTwvcD4gKyA8cD56PC9wPiAoY2FuIG1lcmdlIHRvIDxwPnh5PC9wPiB3aGljaCB3aWxsIGJlIHNwbGl0IGR1cmluZyB0aGUgYWN0aW9uLAogICAgICoJCQkJCQkJCXNvIGJvdGggaXRzIHBpZWNlcyB3aWxsIGJlIGFkZGVkIHRvIHRoaXMgc2V0KQogICAgICoKICAgICAqCiAgICAgKiBAbWVtYmVyIHtTZXR9ICNjYW5NZXJnZVdpdGgKICAgICAqLwoKICAgIHRoaXMuY2FuTWVyZ2VXaXRoID0gbmV3IFNldChbdGhpcy5wb3NpdGlvbi5wYXJlbnRdKTsKICAgIC8qKgogICAgICogU2NoZW1hIG9mIHRoZSBtb2RlbC4KICAgICAqCiAgICAgKiBAbWVtYmVyIHttb2R1bGU6ZW5naW5lL21vZGVsL3NjaGVtYX5TY2hlbWF9ICNzY2hlbWEKICAgICAqLwoKICAgIHRoaXMuc2NoZW1hID0gbW9kZWwuc2NoZW1hOwogICAgLyoqCiAgICAgKiBUaGUgdGVtcG9yYXJ5IERvY3VtZW50RnJhZ21lbnQgdXNlZCBmb3IgZ3JvdXBpbmcgbXVsdGlwbGUgbm9kZXMgZm9yIHNpbmdsZSBpbnNlcnQgb3BlcmF0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9kb2N1bWVudGZyYWdtZW50fkRvY3VtZW50RnJhZ21lbnR9CiAgICAgKi8KCiAgICB0aGlzLl9kb2N1bWVudEZyYWdtZW50ID0gd3JpdGVyLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgIC8qKgogICAgICogVGhlIGN1cnJlbnQgcG9zaXRpb24gaW4gdGhlIHRlbXBvcmFyeSBEb2N1bWVudEZyYWdtZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9wb3NpdGlvbn5Qb3NpdGlvbn0KICAgICAqLwoKICAgIHRoaXMuX2RvY3VtZW50RnJhZ21lbnRQb3NpdGlvbiA9IHdyaXRlci5jcmVhdGVQb3NpdGlvbkF0KHRoaXMuX2RvY3VtZW50RnJhZ21lbnQsIDApOwogICAgLyoqCiAgICAgKiBUaGUgcmVmZXJlbmNlIHRvIHRoZSBmaXJzdCBpbnNlcnRlZCBub2RlLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9ub2Rlfk5vZGV9CiAgICAgKi8KCiAgICB0aGlzLl9maXJzdE5vZGUgPSBudWxsOwogICAgLyoqCiAgICAgKiBUaGUgcmVmZXJlbmNlIHRvIHRoZSBsYXN0IGluc2VydGVkIG5vZGUuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEB0eXBlIHttb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZX0KICAgICAqLwoKICAgIHRoaXMuX2xhc3ROb2RlID0gbnVsbDsKICAgIC8qKgogICAgICogVGhlIHJlZmVyZW5jZSB0byB0aGUgbGFzdCBhdXRvIHBhcmFncmFwaCBub2RlLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9ub2Rlfk5vZGV9CiAgICAgKi8KCiAgICB0aGlzLl9sYXN0QXV0b1BhcmFncmFwaCA9IG51bGw7CiAgICAvKioKICAgICAqIFRoZSBhcnJheSBvZiBub2RlcyB0aGF0IHNob3VsZCBiZSBjbGVhbmVkIG9mIG5vdCBhbGxvd2VkIGF0dHJpYnV0ZXMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEB0eXBlIHtBcnJheS48bW9kdWxlOmVuZ2luZS9tb2RlbC9ub2Rlfk5vZGU+fQogICAgICovCgogICAgdGhpcy5fZmlsdGVyQXR0cmlidXRlc09mID0gW107CiAgICAvKioKICAgICAqIEJlZ2lubmluZyBvZiB0aGUgYWZmZWN0ZWQgcmFuZ2UuIFNlZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC91dGlscy9pbnNlcnRjb250ZW50fkluc2VydGlvbiNnZXRBZmZlY3RlZFJhbmdlfS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9tb2RlbC9saXZlcG9zaXRpb25+TGl2ZVBvc2l0aW9ufG51bGx9ICNfYWZmZWN0ZWRTdGFydAogICAgICovCgogICAgdGhpcy5fYWZmZWN0ZWRTdGFydCA9IG51bGw7CiAgICAvKioKICAgICAqIEVuZCBvZiB0aGUgYWZmZWN0ZWQgcmFuZ2UuIFNlZSB7QGxpbmsgbW9kdWxlOmVuZ2luZS9tb2RlbC91dGlscy9pbnNlcnRjb250ZW50fkluc2VydGlvbiNnZXRBZmZlY3RlZFJhbmdlfS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQG1lbWJlciB7bW9kdWxlOmVuZ2luZS9tb2RlbC9saXZlcG9zaXRpb25+TGl2ZVBvc2l0aW9ufG51bGx9ICNfYWZmZWN0ZWRFbmQKICAgICAqLwoKICAgIHRoaXMuX2FmZmVjdGVkRW5kID0gbnVsbDsKICB9CiAgLyoqCiAgICogSGFuZGxlcyBpbnNlcnRpb24gb2YgYSBzZXQgb2Ygbm9kZXMuCiAgICoKICAgKiBAcGFyYW0ge0l0ZXJhYmxlLjxtb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZT59IG5vZGVzIE5vZGVzIHRvIGluc2VydC4KICAgKi8KCgogIF9jcmVhdGVDbGFzcyhJbnNlcnRpb24sIFt7CiAgICBrZXk6ICJoYW5kbGVOb2RlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gaGFuZGxlTm9kZXMobm9kZXMpIHsKICAgICAgZm9yICh2YXIgX2kgPSAwLCBfQXJyYXkkZnJvbSA9IEFycmF5LmZyb20obm9kZXMpOyBfaSA8IF9BcnJheSRmcm9tLmxlbmd0aDsgX2krKykgewogICAgICAgIHZhciBub2RlID0gX0FycmF5JGZyb21bX2ldOwoKICAgICAgICB0aGlzLl9oYW5kbGVOb2RlKG5vZGUpOwogICAgICB9IC8vIEluc2VydCBub2RlcyBjb2xsZWN0ZWQgaW4gdGVtcG9yYXJ5IERvY3VtZW50RnJhZ21lbnQuCgoKICAgICAgdGhpcy5faW5zZXJ0UGFydGlhbEZyYWdtZW50KCk7IC8vIElmIHRoZXJlIHdhcyBhbiBhdXRvIHBhcmFncmFwaCB0aGVuIHdlIG1pZ2h0IG5lZWQgdG8gYWRqdXN0IHRoZSBlbmQgb2YgaW5zZXJ0aW9uLgoKCiAgICAgIGlmICh0aGlzLl9sYXN0QXV0b1BhcmFncmFwaCkgewogICAgICAgIHRoaXMuX3VwZGF0ZUxhc3ROb2RlRnJvbUF1dG9QYXJhZ3JhcGgodGhpcy5fbGFzdEF1dG9QYXJhZ3JhcGgpOwogICAgICB9IC8vIEFmdGVyIHRoZSBjb250ZW50IHdhcyBpbnNlcnRlZCB3ZSBtYXkgdHJ5IHRvIG1lcmdlIGl0IHdpdGggaXRzIG5leHQgc2libGluZyBpZiB0aGUgc2VsZWN0aW9uIHdhcyBpbiBpdCBpbml0aWFsbHkuCiAgICAgIC8vIE1lcmdpbmcgd2l0aCB0aGUgcHJldmlvdXMgc2libGluZyB3YXMgcGVyZm9ybWVkIGp1c3QgYWZ0ZXIgaW5zZXJ0aW5nIHRoZSBmaXJzdCBub2RlIHRvIHRoZSBkb2N1bWVudC4KCgogICAgICB0aGlzLl9tZXJnZU9uUmlnaHQoKTsgLy8gVE1QIHRoaXMgd2lsbCBiZWNvbWUgYSBwb3N0LWZpeGVyLgoKCiAgICAgIHRoaXMuc2NoZW1hLnJlbW92ZURpc2FsbG93ZWRBdHRyaWJ1dGVzKHRoaXMuX2ZpbHRlckF0dHJpYnV0ZXNPZiwgdGhpcy53cml0ZXIpOwogICAgICB0aGlzLl9maWx0ZXJBdHRyaWJ1dGVzT2YgPSBbXTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyB0aGUgbGFzdCBub2RlIGFmdGVyIHRoZSBhdXRvIHBhcmFncmFwaGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZX0gbm9kZSBUaGUgbGFzdCBhdXRvIHBhcmFncmFwaGluZyBub2RlLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl91cGRhdGVMYXN0Tm9kZUZyb21BdXRvUGFyYWdyYXBoIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlTGFzdE5vZGVGcm9tQXV0b1BhcmFncmFwaChub2RlKSB7CiAgICAgIHZhciBwb3NpdGlvbkFmdGVyTGFzdE5vZGUgPSB0aGlzLndyaXRlci5jcmVhdGVQb3NpdGlvbkFmdGVyKHRoaXMuX2xhc3ROb2RlKTsKICAgICAgdmFyIHBvc2l0aW9uQWZ0ZXJOb2RlID0gdGhpcy53cml0ZXIuY3JlYXRlUG9zaXRpb25BZnRlcihub2RlKTsgLy8gSWYgdGhlIHJlYWwgZW5kIHdhcyBhZnRlciB0aGUgbGFzdCBhdXRvIHBhcmFncmFwaCB0aGVuIHVwZGF0ZSByZWxldmFudCBwcm9wZXJ0aWVzLgoKICAgICAgaWYgKHBvc2l0aW9uQWZ0ZXJOb2RlLmlzQWZ0ZXIocG9zaXRpb25BZnRlckxhc3ROb2RlKSkgewogICAgICAgIHRoaXMuX2xhc3ROb2RlID0gbm9kZTsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICAgICAgaWYgKHRoaXMucG9zaXRpb24ucGFyZW50ICE9IG5vZGUgfHwgIXRoaXMucG9zaXRpb24uaXNBdEVuZCkgewogICAgICAgICAgLy8gQWxnb3JpdGhtJ3MgY29ycmVjdG5lc3MgY2hlY2suIFdlIHNob3VsZCBuZXZlciBlbmQgdXAgaGVyZSBidXQgaXQncyBnb29kIHRvIGtub3cgdGhhdCB3ZSBkaWQuCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50IHRoZSBpbnNlcnRpb24gcG9zaXRpb24gc2hvdWxkIGJlIGF0IHRoZSBlbmQgb2YgdGhlIGxhc3QgYXV0byBwYXJhZ3JhcGguCiAgICAgICAgICAvLyBOb3RlOiBUaGlzIGVycm9yIGlzIGRvY3VtZW50ZWQgaW4gb3RoZXIgcGxhY2UgaW4gdGhpcyBmaWxlLgogICAgICAgICAgdGhyb3cgbmV3IENLRWRpdG9yRXJyb3IoJ2luc2VydGNvbnRlbnQtaW52YWxpZC1pbnNlcnRpb24tcG9zaXRpb24nLCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbkFmdGVyTm9kZTsKCiAgICAgICAgdGhpcy5fc2V0QWZmZWN0ZWRCb3VuZGFyaWVzKHRoaXMucG9zaXRpb24pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgcmFuZ2UgdG8gYmUgc2VsZWN0ZWQgYWZ0ZXIgaW5zZXJ0aW9uLgogICAgICogUmV0dXJucyBgbnVsbGAgaWYgdGhlcmUgaXMgbm8gdmFsaWQgcmFuZ2UgdG8gc2VsZWN0IGFmdGVyIGluc2VydGlvbi4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7bW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZXxudWxsfQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFNlbGVjdGlvblJhbmdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRTZWxlY3Rpb25SYW5nZSgpIHsKICAgICAgaWYgKHRoaXMubm9kZVRvU2VsZWN0KSB7CiAgICAgICAgcmV0dXJuIFJhbmdlLl9jcmVhdGVPbih0aGlzLm5vZGVUb1NlbGVjdCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLm1vZGVsLnNjaGVtYS5nZXROZWFyZXN0U2VsZWN0aW9uUmFuZ2UodGhpcy5wb3NpdGlvbik7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYSByYW5nZSB3aGljaCBjb250YWlucyBhbGwgdGhlIHBlcmZvcm1lZCBjaGFuZ2VzLiBUaGlzIGlzIGEgcmFuZ2UgdGhhdCwgaWYgcmVtb3ZlZCwgd291bGQgcmV0dXJuIHRoZSBtb2RlbCB0byB0aGUgc3RhdGUKICAgICAqIGJlZm9yZSB0aGUgaW5zZXJ0aW9uLiBSZXR1cm5zIGBudWxsYCBpZiBubyBjaGFuZ2VzIHdlcmUgZG9uZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7bW9kdWxlOmVuZ2luZS9tb2RlbC9yYW5nZX5SYW5nZXxudWxsfQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldEFmZmVjdGVkUmFuZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEFmZmVjdGVkUmFuZ2UoKSB7CiAgICAgIGlmICghdGhpcy5fYWZmZWN0ZWRTdGFydCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IFJhbmdlKHRoaXMuX2FmZmVjdGVkU3RhcnQsIHRoaXMuX2FmZmVjdGVkRW5kKTsKICAgIH0KICAgIC8qKgogICAgICogRGVzdHJveXMgYEluc2VydGlvbmAgaW5zdGFuY2UuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZGVzdHJveSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgaWYgKHRoaXMuX2FmZmVjdGVkU3RhcnQpIHsKICAgICAgICB0aGlzLl9hZmZlY3RlZFN0YXJ0LmRldGFjaCgpOwogICAgICB9CgogICAgICBpZiAodGhpcy5fYWZmZWN0ZWRFbmQpIHsKICAgICAgICB0aGlzLl9hZmZlY3RlZEVuZC5kZXRhY2goKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBIYW5kbGVzIGluc2VydGlvbiBvZiBhIHNpbmdsZSBub2RlLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvbm9kZX5Ob2RlfSBub2RlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2hhbmRsZU5vZGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9oYW5kbGVOb2RlKG5vZGUpIHsKICAgICAgLy8gTGV0J3MgaGFuZGxlIG9iamVjdCBpbiBhIHNwZWNpYWwgd2F5LgogICAgICAvLyAqIFRoZXkgc2hvdWxkIG5ldmVyIGJlIG1lcmdlZCB3aXRoIG90aGVyIGVsZW1lbnRzLgogICAgICAvLyAqIElmIHRoZXkgYXJlIG5vdCBhbGxvd2VkIGluIGFueSBvZiB0aGUgc2VsZWN0aW9uIGFuY2VzdG9ycywgdGhleSBjb3VsZCBiZSBlaXRoZXIgYXV0b3BhcmFncmFwaGVkIG9yIHRvdGFsbHkgcmVtb3ZlZC4KICAgICAgaWYgKHRoaXMuc2NoZW1hLmlzT2JqZWN0KG5vZGUpKSB7CiAgICAgICAgdGhpcy5faGFuZGxlT2JqZWN0KG5vZGUpOwoKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gVHJ5IHRvIGZpbmQgYSBwbGFjZSBmb3IgdGhlIGdpdmVuIG5vZGUuCiAgICAgIC8vIENoZWNrIGlmIGEgbm9kZSBjYW4gYmUgaW5zZXJ0ZWQgaW4gdGhlIGdpdmVuIHBvc2l0aW9uIG9yIGl0IHdvdWxkIGJlIGFjY2VwdGVkIGlmIGEgcGFyYWdyYXBoIHdvdWxkIGJlIGluc2VydGVkLgogICAgICAvLyBJbnNlcnRzIHRoZSBhdXRvIHBhcmFncmFwaCBpZiBpdCB3b3VsZCBhbGxvdyBmb3IgaW5zZXJ0aW9uLgoKCiAgICAgIHZhciBpc0FsbG93ZWQgPSB0aGlzLl9jaGVja0FuZEF1dG9QYXJhZ3JhcGhUb0FsbG93ZWRQb3NpdGlvbihub2RlKTsKCiAgICAgIGlmICghaXNBbGxvd2VkKSB7CiAgICAgICAgLy8gU3BsaXQgdGhlIHBvc2l0aW9uLnBhcmVudCdzIGJyYW5jaCB1cCB0byBhIHBvaW50IHdoZXJlIHRoZSBub2RlIGNhbiBiZSBpbnNlcnRlZC4KICAgICAgICAvLyBJZiBpdCBpc24ndCBhbGxvd2VkIGluIHRoZSB3aG9sZSBicmFuY2gsIHRoZW4gb2YgY291cnNlIGRvbid0IHNwbGl0IGFueXRoaW5nLgogICAgICAgIGlzQWxsb3dlZCA9IHRoaXMuX2NoZWNrQW5kU3BsaXRUb0FsbG93ZWRQb3NpdGlvbihub2RlKTsKCiAgICAgICAgaWYgKCFpc0FsbG93ZWQpIHsKICAgICAgICAgIHRoaXMuX2hhbmRsZURpc2FsbG93ZWROb2RlKG5vZGUpOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gLy8gQWRkIG5vZGUgdG8gdGhlIGN1cnJlbnQgdGVtcG9yYXJ5IERvY3VtZW50RnJhZ21lbnQuCgoKICAgICAgdGhpcy5fYXBwZW5kVG9GcmFnbWVudChub2RlKTsgLy8gU3RvcmUgdGhlIGZpcnN0IGFuZCBsYXN0IG5vZGVzIGZvciBlYXN5IGFjY2VzcyBmb3IgbWVyZ2luZyB3aXRoIHNpYmxpbmcgbm9kZXMuCgoKICAgICAgaWYgKCF0aGlzLl9maXJzdE5vZGUpIHsKICAgICAgICB0aGlzLl9maXJzdE5vZGUgPSBub2RlOwogICAgICB9CgogICAgICB0aGlzLl9sYXN0Tm9kZSA9IG5vZGU7CiAgICB9CiAgICAvKioKICAgICAqIEluc2VydHMgdGhlIHRlbXBvcmFyeSBEb2N1bWVudEZyYWdtZW50IGludG8gdGhlIG1vZGVsLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2luc2VydFBhcnRpYWxGcmFnbWVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2luc2VydFBhcnRpYWxGcmFnbWVudCgpIHsKICAgICAgaWYgKHRoaXMuX2RvY3VtZW50RnJhZ21lbnQuaXNFbXB0eSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxpdmVQb3NpdGlvbiA9IExpdmVQb3NpdGlvbi5mcm9tUG9zaXRpb24odGhpcy5wb3NpdGlvbiwgJ3RvTmV4dCcpOwoKICAgICAgdGhpcy5fc2V0QWZmZWN0ZWRCb3VuZGFyaWVzKHRoaXMucG9zaXRpb24pOyAvLyBJZiB0aGUgdmVyeSBmaXJzdCBub2RlIG9mIHRoZSB3aG9sZSBpbnNlcnRpb24gcHJvY2VzcyBpcyBpbnNlcnRlZCwgaW5zZXJ0IGl0IHNlcGFyYXRlbHkgZm9yIE9UIHJlYXNvbnMgKHVuZG8pLgogICAgICAvLyBOb3RlOiB0aGVyZSBjYW4gYmUgbXVsdGlwbGUgY2FsbHMgdG8gYF9pbnNlcnRQYXJ0aWFsRnJhZ21lbnQoKWAgZHVyaW5nIG9uZSBpbnNlcnRpb24gcHJvY2Vzcy4KICAgICAgLy8gTm90ZTogb25seSB0aGUgdmVyeSBmaXJzdCBub2RlIGNhbiBiZSBtZXJnZWQgc28gd2UgaGF2ZSB0byBkbyBzZXBhcmF0ZSBvcGVyYXRpb24gb25seSBmb3IgaXQuCgoKICAgICAgaWYgKHRoaXMuX2RvY3VtZW50RnJhZ21lbnQuZ2V0Q2hpbGQoMCkgPT0gdGhpcy5fZmlyc3ROb2RlKSB7CiAgICAgICAgdGhpcy53cml0ZXIuaW5zZXJ0KHRoaXMuX2ZpcnN0Tm9kZSwgdGhpcy5wb3NpdGlvbik7IC8vIFdlIG11c3QgbWVyZ2UgdGhlIGZpcnN0IG5vZGUganVzdCBhZnRlciBpbnNlcnRpbmcgaXQgdG8gYXZvaWQgcHJvYmxlbXMgd2l0aCBPVC4KICAgICAgICAvLyAoU2VlOiBodHRwczovL2dpdGh1Yi5jb20vY2tlZGl0b3IvY2tlZGl0b3I1L3B1bGwvODc3MyNpc3N1ZWNvbW1lbnQtNzYwOTQ1NjUyKS4KCiAgICAgICAgdGhpcy5fbWVyZ2VPbkxlZnQoKTsKCiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IGxpdmVQb3NpdGlvbi50b1Bvc2l0aW9uKCk7CiAgICAgIH0gLy8gSW5zZXJ0IHRoZSByZW1haW5pbmcgbm9kZXMgZnJvbSBkb2N1bWVudCBmcmFnbWVudC4KCgogICAgICBpZiAoIXRoaXMuX2RvY3VtZW50RnJhZ21lbnQuaXNFbXB0eSkgewogICAgICAgIHRoaXMud3JpdGVyLmluc2VydCh0aGlzLl9kb2N1bWVudEZyYWdtZW50LCB0aGlzLnBvc2l0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy5fZG9jdW1lbnRGcmFnbWVudFBvc2l0aW9uID0gdGhpcy53cml0ZXIuY3JlYXRlUG9zaXRpb25BdCh0aGlzLl9kb2N1bWVudEZyYWdtZW50LCAwKTsKICAgICAgdGhpcy5wb3NpdGlvbiA9IGxpdmVQb3NpdGlvbi50b1Bvc2l0aW9uKCk7CiAgICAgIGxpdmVQb3NpdGlvbi5kZXRhY2goKTsKICAgIH0KICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnR9IG5vZGUgVGhlIG9iamVjdCBlbGVtZW50LgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9oYW5kbGVPYmplY3QiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9oYW5kbGVPYmplY3Qobm9kZSkgewogICAgICAvLyBUcnkgZmluZGluZyBpdCBhIHBsYWNlIGluIHRoZSB0cmVlLgogICAgICBpZiAodGhpcy5fY2hlY2tBbmRTcGxpdFRvQWxsb3dlZFBvc2l0aW9uKG5vZGUpKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kVG9GcmFnbWVudChub2RlKTsKICAgICAgfSAvLyBUcnkgYXV0b3BhcmFncmFwaGluZy4KICAgICAgZWxzZSB7CiAgICAgICAgICB0aGlzLl90cnlBdXRvcGFyYWdyYXBoaW5nKG5vZGUpOwogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9ub2Rlfk5vZGV9IG5vZGUgVGhlIGRpc2FsbG93ZWQgbm9kZSB3aGljaCBuZWVkcyB0byBiZSBoYW5kbGVkLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9oYW5kbGVEaXNhbGxvd2VkTm9kZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2hhbmRsZURpc2FsbG93ZWROb2RlKG5vZGUpIHsKICAgICAgLy8gSWYgdGhlIG5vZGUgaXMgYW4gZWxlbWVudCwgdHJ5IGluc2VydGluZyBpdHMgY2hpbGRyZW4gKHN0cmlwIHRoZSBwYXJlbnQpLgogICAgICBpZiAobm9kZS5pcygnZWxlbWVudCcpKSB7CiAgICAgICAgdGhpcy5oYW5kbGVOb2Rlcyhub2RlLmdldENoaWxkcmVuKCkpOwogICAgICB9IC8vIElmIHRleHQgaXMgbm90IGFsbG93ZWQsIHRyeSBhdXRvcGFyYWdyYXBoaW5nIGl0LgogICAgICBlbHNlIHsKICAgICAgICAgIHRoaXMuX3RyeUF1dG9wYXJhZ3JhcGhpbmcobm9kZSk7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBBcHBlbmQgYSBub2RlIHRvIHRoZSB0ZW1wb3JhcnkgRG9jdW1lbnRGcmFnbWVudC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZX0gbm9kZSBUaGUgbm9kZSB0byBpbnNlcnQuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2FwcGVuZFRvRnJhZ21lbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9hcHBlbmRUb0ZyYWdtZW50KG5vZGUpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICghdGhpcy5zY2hlbWEuY2hlY2tDaGlsZCh0aGlzLnBvc2l0aW9uLCBub2RlKSkgewogICAgICAgIC8vIEFsZ29yaXRobSdzIGNvcnJlY3RuZXNzIGNoZWNrLiBXZSBzaG91bGQgbmV2ZXIgZW5kIHVwIGhlcmUgYnV0IGl0J3MgZ29vZCB0byBrbm93IHRoYXQgd2UgZGlkLgogICAgICAgIC8vIE5vdGUgdGhhdCBpdCB3b3VsZCBvZnRlbiBiZSBhIHNpbGVudCBpc3N1ZSBpZiB3ZSBpbnNlcnQgbm9kZSBpbiBhIHBsYWNlIHdoZXJlIGl0J3Mgbm90IGFsbG93ZWQuCgogICAgICAgIC8qKgogICAgICAgICAqIEdpdmVuIG5vZGUgY2Fubm90IGJlIGluc2VydGVkIG9uIHRoZSBnaXZlbiBwb3NpdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBlcnJvciBpbnNlcnRjb250ZW50LXdyb25nLXBvc2l0aW9uCiAgICAgICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZX0gbm9kZSBOb2RlIHRvIGluc2VydC4KICAgICAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvcG9zaXRpb25+UG9zaXRpb259IHBvc2l0aW9uIFBvc2l0aW9uIHRvIGluc2VydCB0aGUgbm9kZSBhdC4KICAgICAgICAgKi8KICAgICAgICB0aHJvdyBuZXcgQ0tFZGl0b3JFcnJvcignaW5zZXJ0Y29udGVudC13cm9uZy1wb3NpdGlvbicsIHRoaXMsIHsKICAgICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgICBwb3NpdGlvbjogdGhpcy5wb3NpdGlvbgogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLndyaXRlci5pbnNlcnQobm9kZSwgdGhpcy5fZG9jdW1lbnRGcmFnbWVudFBvc2l0aW9uKTsKICAgICAgdGhpcy5fZG9jdW1lbnRGcmFnbWVudFBvc2l0aW9uID0gdGhpcy5fZG9jdW1lbnRGcmFnbWVudFBvc2l0aW9uLmdldFNoaWZ0ZWRCeShub2RlLm9mZnNldFNpemUpOyAvLyBUaGUgbGFzdCBpbnNlcnRlZCBvYmplY3Qgc2hvdWxkIGJlIHNlbGVjdGVkIGJlY2F1c2Ugd2UgY2FuJ3QgcHV0IGEgY29sbGFwc2VkIHNlbGVjdGlvbiBhZnRlciBpdC4KCiAgICAgIGlmICh0aGlzLnNjaGVtYS5pc09iamVjdChub2RlKSAmJiAhdGhpcy5zY2hlbWEuY2hlY2tDaGlsZCh0aGlzLnBvc2l0aW9uLCAnJHRleHQnKSkgewogICAgICAgIHRoaXMubm9kZVRvU2VsZWN0ID0gbm9kZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm5vZGVUb1NlbGVjdCA9IG51bGw7CiAgICAgIH0KCiAgICAgIHRoaXMuX2ZpbHRlckF0dHJpYnV0ZXNPZi5wdXNoKG5vZGUpOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIGBfYWZmZWN0ZWRTdGFydGAgYW5kIGBfYWZmZWN0ZWRFbmRgIHRvIHRoZSBnaXZlbiBgcG9zaXRpb25gLiBTaG91bGQgYmUgdXNlZCBiZWZvcmUgYSBjaGFuZ2UgaXMgZG9uZSBkdXJpbmcgaW5zZXJ0aW9uIHByb2Nlc3MgdG8KICAgICAqIG1hcmsgdGhlIGFmZmVjdGVkIHJhbmdlLgogICAgICoKICAgICAqIFRoaXMgbWV0aG9kIGlzIHVzZWQgYmVmb3JlIGluc2VydGluZyBhIG5vZGUgb3Igc3BsaXR0aW5nIGEgcGFyZW50IG5vZGUuIGBfYWZmZWN0ZWRTdGFydGAgYW5kIGBfYWZmZWN0ZWRFbmRgIGFyZSBhbHNvIGNoYW5nZWQKICAgICAqIGR1cmluZyBtZXJnaW5nLCBidXQgdGhlIGxvZ2ljIHRoZXJlIGlzIG1vcmUgY29tcGxpY2F0ZWQgc28gaXQgaXMgbGVmdCBvdXQgb2YgdGhpcyBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL3Bvc2l0aW9uflBvc2l0aW9ufSBwb3NpdGlvbgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9zZXRBZmZlY3RlZEJvdW5kYXJpZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zZXRBZmZlY3RlZEJvdW5kYXJpZXMocG9zaXRpb24pIHsKICAgICAgLy8gU2V0IGFmZmVjdGVkIGJvdW5kYXJpZXMgc3RpY2tpbmVzcyBzbyB0aGF0IHRob3NlIHBvc2l0aW9uIHdpbGwgImV4cGFuZCIgd2hlbiBzb21ldGhpbmcgaXMgaW5zZXJ0ZWQgaW4gYmV0d2VlbiB0aGVtOgogICAgICAvLyA8cGFyYWdyYXBoPkZvb11bYmFyPC9wYXJhZ3JhcGg+IC0+IDxwYXJhZ3JhcGg+Rm9vXXh4W2JhcjwvcGFyYWdyYXBoPgogICAgICAvLyBUaGlzIGlzIHdoeSBpdCBjYW5ub3QgYmUgYSByYW5nZSBidXQgdHdvIHNlcGFyYXRlIHBvc2l0aW9ucy4KICAgICAgaWYgKCF0aGlzLl9hZmZlY3RlZFN0YXJ0KSB7CiAgICAgICAgdGhpcy5fYWZmZWN0ZWRTdGFydCA9IExpdmVQb3NpdGlvbi5mcm9tUG9zaXRpb24ocG9zaXRpb24sICd0b1ByZXZpb3VzJyk7CiAgICAgIH0gLy8gSWYgYF9hZmZlY3RlZEVuZGAgaXMgYmVmb3JlIHRoZSBuZXcgYm91bmRhcnkgcG9zaXRpb24sIGV4cGFuZCBgX2FmZmVjdGVkRW5kYC4gVGhpcyBjYW4gaGFwcGVuIGlmIGZpcnN0IGluc2VydGVkIG5vZGUgd2FzCiAgICAgIC8vIGluc2VydGVkIGludG8gdGhlIHBhcmVudCBidXQgdGhlIG5leHQgbm9kZSBpcyBtb3ZlZC1vdXQgb2YgdGhhdCBwYXJlbnQ6CiAgICAgIC8vICgxKSA8cGFyYWdyYXBoPkZvb11bPC9wYXJhZ3JhcGg+IC0+IDxwYXJhZ3JhcGg+Rm9vXXh4WzwvcGFyYWdyYXBoPgogICAgICAvLyAoMikgPHBhcmFncmFwaD5Gb29deHhbPC9wYXJhZ3JhcGg+IC0+IDxwYXJhZ3JhcGg+Rm9vXXh4PC9wYXJhZ3JhcGg+PHdpZGdldD48L3dpZGdldD5bCgoKICAgICAgaWYgKCF0aGlzLl9hZmZlY3RlZEVuZCB8fCB0aGlzLl9hZmZlY3RlZEVuZC5pc0JlZm9yZShwb3NpdGlvbikpIHsKICAgICAgICBpZiAodGhpcy5fYWZmZWN0ZWRFbmQpIHsKICAgICAgICAgIHRoaXMuX2FmZmVjdGVkRW5kLmRldGFjaCgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fYWZmZWN0ZWRFbmQgPSBMaXZlUG9zaXRpb24uZnJvbVBvc2l0aW9uKHBvc2l0aW9uLCAndG9OZXh0Jyk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogTWVyZ2VzIHRoZSBwcmV2aW91cyBzaWJsaW5nIG9mIHRoZSBmaXJzdCBub2RlIGlmIGl0IHNob3VsZCBiZSBtZXJnZWQuCiAgICAgKgogICAgICogQWZ0ZXIgdGhlIGNvbnRlbnQgd2FzIGluc2VydGVkIHdlIG1heSB0cnkgdG8gbWVyZ2UgaXQgd2l0aCBpdHMgc2libGluZ3MuCiAgICAgKiBUaGlzIHNob3VsZCBoYXBwZW4gb25seSBpZiB0aGUgc2VsZWN0aW9uIHdhcyBpbiB0aG9zZSBlbGVtZW50cyBpbml0aWFsbHkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfbWVyZ2VPbkxlZnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9tZXJnZU9uTGVmdCgpIHsKICAgICAgdmFyIG5vZGUgPSB0aGlzLl9maXJzdE5vZGU7CgogICAgICBpZiAoIShub2RlIGluc3RhbmNlb2YgRWxlbWVudCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5fY2FuTWVyZ2VMZWZ0KG5vZGUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbWVyZ2VQb3NMZWZ0ID0gTGl2ZVBvc2l0aW9uLl9jcmVhdGVCZWZvcmUobm9kZSk7CgogICAgICBtZXJnZVBvc0xlZnQuc3RpY2tpbmVzcyA9ICd0b05leHQnOwogICAgICB2YXIgbGl2ZVBvc2l0aW9uID0gTGl2ZVBvc2l0aW9uLmZyb21Qb3NpdGlvbih0aGlzLnBvc2l0aW9uLCAndG9OZXh0Jyk7IC8vIElmIGBfYWZmZWN0ZWRTdGFydGAgaXMgc2FtZXMgYXMgbWVyZ2UgcG9zaXRpb24sIGl0IG1lYW5zIHRoYXQgdGhlIGVsZW1lbnQgIm1hcmtlZCIgYnkgYF9hZmZlY3RlZFN0YXJ0YCBpcyBnb2luZyB0byBiZQogICAgICAvLyByZW1vdmVkIGFuZCBpdHMgY29udGVudHMgd2lsbCBiZSBtb3ZlZC4gVGhpcyB3b24ndCB0cmFuc2Zvcm0gYExpdmVQb3NpdGlvbmAgc28gYF9hZmZlY3RlZFN0YXJ0YCBuZWVkcyB0byBiZSBtb3ZlZAogICAgICAvLyBieSBoYW5kIHRvIHByb3Blcmx5IHJlZmxlY3QgYWZmZWN0ZWQgcmFuZ2UuIChEdWUgdG8gYF9hZmZlY3RlZFN0YXJ0YCBhbmQgYF9hZmZlY3RlZEVuZGAgc3RpY2tpbmVzcywgdGhlICJyYW5nZSIgaXMKICAgICAgLy8gc2hvd24gYXMgYF1bYCkuCiAgICAgIC8vCiAgICAgIC8vIEV4YW1wbGUgLSBpbnNlcnQgYDxwYXJhZ3JhcGg+QWJjPC9wYXJhZ3JhcGg+PHBhcmFncmFwaD5YeXo8L3BhcmFncmFwaD5gIGF0IHRoZSBlbmQgb2YgYDxwYXJhZ3JhcGg+Rm9vXjwvcGFyYWdyYXBoPmA6CiAgICAgIC8vCiAgICAgIC8vIDxwYXJhZ3JhcGg+Rm9vPC9wYXJhZ3JhcGg+PHBhcmFncmFwaD5CYXI8L3BhcmFncmFwaD4gICAtLT4KICAgICAgLy8gPHBhcmFncmFwaD5Gb288L3BhcmFncmFwaD5dPHBhcmFncmFwaD5BYmM8L3BhcmFncmFwaD48cGFyYWdyYXBoPlh5ejwvcGFyYWdyYXBoPls8cGFyYWdyYXBoPkJhcjwvcGFyYWdyYXBoPiAgIC0tPgogICAgICAvLyA8cGFyYWdyYXBoPkZvb11BYmM8L3BhcmFncmFwaD48cGFyYWdyYXBoPlh5ejwvcGFyYWdyYXBoPls8cGFyYWdyYXBoPkJhcjwvcGFyYWdyYXBoPgogICAgICAvLwogICAgICAvLyBOb3RlLCB0aGF0IGlmIHdlIGFyZSBoZXJlIHRoZW4gc29tZXRoaW5nIG11c3QgaGF2ZSBiZWVuIGluc2VydGVkLCBzbyBgX2FmZmVjdGVkU3RhcnRgIGFuZCBgX2FmZmVjdGVkRW5kYCBoYXZlIHRvIGJlIHNldC4KCiAgICAgIGlmICh0aGlzLl9hZmZlY3RlZFN0YXJ0LmlzRXF1YWwobWVyZ2VQb3NMZWZ0KSkgewogICAgICAgIHRoaXMuX2FmZmVjdGVkU3RhcnQuZGV0YWNoKCk7CgogICAgICAgIHRoaXMuX2FmZmVjdGVkU3RhcnQgPSBMaXZlUG9zaXRpb24uX2NyZWF0ZUF0KG1lcmdlUG9zTGVmdC5ub2RlQmVmb3JlLCAnZW5kJywgJ3RvUHJldmlvdXMnKTsKICAgICAgfSAvLyBXZSBuZWVkIHRvIHVwZGF0ZSB0aGUgcmVmZXJlbmNlcyB0byB0aGUgZmlyc3QgYW5kIGxhc3Qgbm9kZXMgaWYgdGhleSB3aWxsIGJlIG1lcmdlZCBpbnRvIHRoZSBwcmV2aW91cyBzaWJsaW5nIG5vZGUKICAgICAgLy8gYmVjYXVzZSB0aGUgcmVmZXJlbmNlIHdvdWxkIHBvaW50IHRvIHRoZSByZW1vdmVkIG5vZGUuCiAgICAgIC8vCiAgICAgIC8vIDxwPkFeQTwvcD4gKyA8cD5YPC9wPgogICAgICAvLwogICAgICAvLyA8cD5BPC9wPl48cD5BPC9wPgogICAgICAvLyA8cD5BPC9wPjxwPlg8L3A+PHA+QTwvcD4KICAgICAgLy8gPHA+QVg8L3A+PHA+QTwvcD4KICAgICAgLy8gPHA+QVhBPC9wPgoKCiAgICAgIGlmICh0aGlzLl9maXJzdE5vZGUgPT09IHRoaXMuX2xhc3ROb2RlKSB7CiAgICAgICAgdGhpcy5fZmlyc3ROb2RlID0gbWVyZ2VQb3NMZWZ0Lm5vZGVCZWZvcmU7CiAgICAgICAgdGhpcy5fbGFzdE5vZGUgPSBtZXJnZVBvc0xlZnQubm9kZUJlZm9yZTsKICAgICAgfQoKICAgICAgdGhpcy53cml0ZXIubWVyZ2UobWVyZ2VQb3NMZWZ0KTsgLy8gSWYgb25seSBvbmUgZWxlbWVudCAodGhlIG1lcmdlZCBvbmUpIGlzIGluIHRoZSAiYWZmZWN0ZWQgcmFuZ2UiLCBhbHNvIG1vdmUgdGhlIGFmZmVjdGVkIHJhbmdlIGVuZCBhcHByb3ByaWF0ZWx5LgogICAgICAvLwogICAgICAvLyBFeGFtcGxlIC0gaW5zZXJ0IGA8cGFyYWdyYXBoPkFiYzwvcGFyYWdyYXBoPmAgYXQgdGhlIG9mIGA8cGFyYWdyYXBoPkZvb148L3BhcmFncmFwaD5gOgogICAgICAvLwogICAgICAvLyA8cGFyYWdyYXBoPkZvbzwvcGFyYWdyYXBoPjxwYXJhZ3JhcGg+QmFyPC9wYXJhZ3JhcGg+ICAgLS0+CiAgICAgIC8vIDxwYXJhZ3JhcGg+Rm9vPC9wYXJhZ3JhcGg+XTxwYXJhZ3JhcGg+QWJjPC9wYXJhZ3JhcGg+WzxwYXJhZ3JhcGg+QmFyPC9wYXJhZ3JhcGg+ICAgLS0+CiAgICAgIC8vIDxwYXJhZ3JhcGg+Rm9vXUFiYzwvcGFyYWdyYXBoPls8cGFyYWdyYXBoPkJhcjwvcGFyYWdyYXBoPiAgIC0tPgogICAgICAvLyA8cGFyYWdyYXBoPkZvb11BYmNbPC9wYXJhZ3JhcGg+PHBhcmFncmFwaD5CYXI8L3BhcmFncmFwaD4KCiAgICAgIGlmIChtZXJnZVBvc0xlZnQuaXNFcXVhbCh0aGlzLl9hZmZlY3RlZEVuZCkgJiYgdGhpcy5fZmlyc3ROb2RlID09PSB0aGlzLl9sYXN0Tm9kZSkgewogICAgICAgIHRoaXMuX2FmZmVjdGVkRW5kLmRldGFjaCgpOwoKICAgICAgICB0aGlzLl9hZmZlY3RlZEVuZCA9IExpdmVQb3NpdGlvbi5fY3JlYXRlQXQobWVyZ2VQb3NMZWZ0Lm5vZGVCZWZvcmUsICdlbmQnLCAndG9OZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMucG9zaXRpb24gPSBsaXZlUG9zaXRpb24udG9Qb3NpdGlvbigpOwogICAgICBsaXZlUG9zaXRpb24uZGV0YWNoKCk7IC8vIEFmdGVyIG1lcmdlIGVsZW1lbnRzIHRoYXQgd2VyZSBtYXJrZWQgYnkgX2luc2VydCgpIHRvIGJlIGZpbHRlcmVkIG1pZ2h0IGJlIGdvbmUgc28KICAgICAgLy8gd2UgbmVlZCB0byBtYXJrIHRoZSBuZXcgY29udGFpbmVyLgoKICAgICAgdGhpcy5fZmlsdGVyQXR0cmlidXRlc09mLnB1c2godGhpcy5wb3NpdGlvbi5wYXJlbnQpOwoKICAgICAgbWVyZ2VQb3NMZWZ0LmRldGFjaCgpOwogICAgfQogICAgLyoqCiAgICAgKiBNZXJnZXMgdGhlIG5leHQgc2libGluZyBvZiB0aGUgbGFzdCBub2RlIGlmIGl0IHNob3VsZCBiZSBtZXJnZWQuCiAgICAgKgogICAgICogQWZ0ZXIgdGhlIGNvbnRlbnQgd2FzIGluc2VydGVkIHdlIG1heSB0cnkgdG8gbWVyZ2UgaXQgd2l0aCBpdHMgc2libGluZ3MuCiAgICAgKiBUaGlzIHNob3VsZCBoYXBwZW4gb25seSBpZiB0aGUgc2VsZWN0aW9uIHdhcyBpbiB0aG9zZSBlbGVtZW50cyBpbml0aWFsbHkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJfbWVyZ2VPblJpZ2h0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfbWVyZ2VPblJpZ2h0KCkgewogICAgICB2YXIgbm9kZSA9IHRoaXMuX2xhc3ROb2RlOwoKICAgICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIEVsZW1lbnQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuX2Nhbk1lcmdlUmlnaHQobm9kZSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBtZXJnZVBvc1JpZ2h0ID0gTGl2ZVBvc2l0aW9uLl9jcmVhdGVBZnRlcihub2RlKTsKCiAgICAgIG1lcmdlUG9zUmlnaHQuc3RpY2tpbmVzcyA9ICd0b05leHQnOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICAgIGlmICghdGhpcy5wb3NpdGlvbi5pc0VxdWFsKG1lcmdlUG9zUmlnaHQpKSB7CiAgICAgICAgLy8gQWxnb3JpdGhtJ3MgY29ycmVjdG5lc3MgY2hlY2suIFdlIHNob3VsZCBuZXZlciBlbmQgdXAgaGVyZSBidXQgaXQncyBnb29kIHRvIGtub3cgdGhhdCB3ZSBkaWQuCiAgICAgICAgLy8gQXQgdGhpcyBwb2ludCB0aGUgaW5zZXJ0aW9uIHBvc2l0aW9uIHNob3VsZCBiZSBhZnRlciB0aGUgbm9kZSB3ZSdsbCBtZXJnZS4gSWYgaXQgaXNuJ3QsCiAgICAgICAgLy8gaXQgc2hvdWxkIG5lZWQgdG8gYmUgc2VjdXJlZCBhcyBpbiB0aGUgbGVmdCBtZXJnZSBjYXNlLgoKICAgICAgICAvKioKICAgICAgICAgKiBBbiBpbnRlcm5hbCBlcnJvciBvY2N1cnJlZCB3aGVuIG1lcmdpbmcgaW5zZXJ0ZWQgY29udGVudCB3aXRoIGl0cyBzaWJsaW5ncy4KICAgICAgICAgKiBUaGUgaW5zZXJ0aW9uIHBvc2l0aW9uIHNob3VsZCBlcXVhbCB0aGUgbWVyZ2UgcG9zaXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBJZiB5b3UgZW5jb3VudGVyZWQgdGhpcyBlcnJvciwgcmVwb3J0IGl0IGJhY2sgdG8gdGhlIENLRWRpdG9yIDUgdGVhbQogICAgICAgICAqIHdpdGggYXMgbWFueSBkZXRhaWxzIGFzIHBvc3NpYmxlIHJlZ2FyZGluZyB0aGUgY29udGVudCBiZWluZyBpbnNlcnRlZCBhbmQgdGhlIGluc2VydGlvbiBwb3NpdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBlcnJvciBpbnNlcnRjb250ZW50LWludmFsaWQtaW5zZXJ0aW9uLXBvc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgdGhyb3cgbmV3IENLRWRpdG9yRXJyb3IoJ2luc2VydGNvbnRlbnQtaW52YWxpZC1pbnNlcnRpb24tcG9zaXRpb24nLCB0aGlzKTsKICAgICAgfSAvLyBNb3ZlIHRoZSBwb3NpdGlvbiB0byB0aGUgcHJldmlvdXMgbm9kZSwgc28gaXQgaXNuJ3QgbW92ZWQgdG8gdGhlIGdyYXZleWFyZCBvbiBtZXJnZS4KICAgICAgLy8gPHA+eDwvcD5bXTxwPnk8L3A+ID0+IDxwPnhbXTwvcD48cD55PC9wPgoKCiAgICAgIHRoaXMucG9zaXRpb24gPSBQb3NpdGlvbi5fY3JlYXRlQXQobWVyZ2VQb3NSaWdodC5ub2RlQmVmb3JlLCAnZW5kJyk7IC8vIEV4cGxhbmF0aW9uIG9mIHNldHRpbmcgcG9zaXRpb24gc3RpY2tpbmVzcyB0byBgJ3RvUHJldmlvdXMnYDoKICAgICAgLy8gT0s6ICA8cD54eFtdPC9wPiArIDxwPnl5PC9wPiA9PiA8cD54eFtdeXk8L3A+ICh3aGVuIHN0aWNrcyB0byBwcmV2aW91cykKICAgICAgLy8gTk9LOiA8cD54eFtdPC9wPiArIDxwPnl5PC9wPiA9PiA8cD54eHl5W108L3A+ICh3aGVuIHN0aWNrcyB0byBuZXh0KQoKICAgICAgdmFyIGxpdmVQb3NpdGlvbiA9IExpdmVQb3NpdGlvbi5mcm9tUG9zaXRpb24odGhpcy5wb3NpdGlvbiwgJ3RvUHJldmlvdXMnKTsgLy8gU2VlIGNvbW1lbnQgaW4gYF9tZXJnZU9uTGVmdCgpYCBvbiBtb3ZpbmcgYF9hZmZlY3RlZFN0YXJ0YC4KCiAgICAgIGlmICh0aGlzLl9hZmZlY3RlZEVuZC5pc0VxdWFsKG1lcmdlUG9zUmlnaHQpKSB7CiAgICAgICAgdGhpcy5fYWZmZWN0ZWRFbmQuZGV0YWNoKCk7CgogICAgICAgIHRoaXMuX2FmZmVjdGVkRW5kID0gTGl2ZVBvc2l0aW9uLl9jcmVhdGVBdChtZXJnZVBvc1JpZ2h0Lm5vZGVCZWZvcmUsICdlbmQnLCAndG9OZXh0Jyk7CiAgICAgIH0gLy8gV2UgbmVlZCB0byB1cGRhdGUgdGhlIHJlZmVyZW5jZXMgdG8gdGhlIGZpcnN0IGFuZCBsYXN0IG5vZGVzIGlmIHRoZXkgd2lsbCBiZSBtZXJnZWQgaW50byB0aGUgcHJldmlvdXMgc2libGluZyBub2RlCiAgICAgIC8vIGJlY2F1c2UgdGhlIHJlZmVyZW5jZSB3b3VsZCBwb2ludCB0byB0aGUgcmVtb3ZlZCBub2RlLgogICAgICAvLwogICAgICAvLyA8cD5BXkE8L3A+ICsgPHA+WDwvcD4KICAgICAgLy8KICAgICAgLy8gPHA+QTwvcD5ePHA+QTwvcD4KICAgICAgLy8gPHA+QTwvcD48cD5YPC9wPjxwPkE8L3A+CiAgICAgIC8vIDxwPkFYPC9wPjxwPkE8L3A+CiAgICAgIC8vIDxwPkFYQTwvcD4KCgogICAgICBpZiAodGhpcy5fZmlyc3ROb2RlID09PSB0aGlzLl9sYXN0Tm9kZSkgewogICAgICAgIHRoaXMuX2ZpcnN0Tm9kZSA9IG1lcmdlUG9zUmlnaHQubm9kZUJlZm9yZTsKICAgICAgICB0aGlzLl9sYXN0Tm9kZSA9IG1lcmdlUG9zUmlnaHQubm9kZUJlZm9yZTsKICAgICAgfQoKICAgICAgdGhpcy53cml0ZXIubWVyZ2UobWVyZ2VQb3NSaWdodCk7IC8vIFNlZSBjb21tZW50IGluIGBfbWVyZ2VPbkxlZnQoKWAgb24gbW92aW5nIGBfYWZmZWN0ZWRTdGFydGAuCgogICAgICBpZiAobWVyZ2VQb3NSaWdodC5nZXRTaGlmdGVkQnkoLTEpLmlzRXF1YWwodGhpcy5fYWZmZWN0ZWRTdGFydCkgJiYgdGhpcy5fZmlyc3ROb2RlID09PSB0aGlzLl9sYXN0Tm9kZSkgewogICAgICAgIHRoaXMuX2FmZmVjdGVkU3RhcnQuZGV0YWNoKCk7CgogICAgICAgIHRoaXMuX2FmZmVjdGVkU3RhcnQgPSBMaXZlUG9zaXRpb24uX2NyZWF0ZUF0KG1lcmdlUG9zUmlnaHQubm9kZUJlZm9yZSwgMCwgJ3RvUHJldmlvdXMnKTsKICAgICAgfQoKICAgICAgdGhpcy5wb3NpdGlvbiA9IGxpdmVQb3NpdGlvbi50b1Bvc2l0aW9uKCk7CiAgICAgIGxpdmVQb3NpdGlvbi5kZXRhY2goKTsgLy8gQWZ0ZXIgbWVyZ2UgZWxlbWVudHMgdGhhdCB3ZXJlIG1hcmtlZCBieSBfaW5zZXJ0KCkgdG8gYmUgZmlsdGVyZWQgbWlnaHQgYmUgZ29uZSBzbwogICAgICAvLyB3ZSBuZWVkIHRvIG1hcmsgdGhlIG5ldyBjb250YWluZXIuCgogICAgICB0aGlzLl9maWx0ZXJBdHRyaWJ1dGVzT2YucHVzaCh0aGlzLnBvc2l0aW9uLnBhcmVudCk7CgogICAgICBtZXJnZVBvc1JpZ2h0LmRldGFjaCgpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVja3Mgd2hldGhlciBzcGVjaWZpZWQgbm9kZSBjYW4gYmUgbWVyZ2VkIHdpdGggcHJldmlvdXMgc2libGluZyBlbGVtZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvbm9kZX5Ob2RlfSBub2RlIFRoZSBub2RlIHdoaWNoIGNvdWxkIHBvdGVudGlhbGx5IGJlIG1lcmdlZC4KICAgICAqIEByZXR1cm5zIHtCb29sZWFufQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9jYW5NZXJnZUxlZnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jYW5NZXJnZUxlZnQobm9kZSkgewogICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gbm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgIHJldHVybiBwcmV2aW91c1NpYmxpbmcgaW5zdGFuY2VvZiBFbGVtZW50ICYmIHRoaXMuY2FuTWVyZ2VXaXRoLmhhcyhwcmV2aW91c1NpYmxpbmcpICYmIHRoaXMubW9kZWwuc2NoZW1hLmNoZWNrTWVyZ2UocHJldmlvdXNTaWJsaW5nLCBub2RlKTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgc3BlY2lmaWVkIG5vZGUgY2FuIGJlIG1lcmdlZCB3aXRoIG5leHQgc2libGluZyBlbGVtZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvbm9kZX5Ob2RlfSBub2RlIFRoZSBub2RlIHdoaWNoIGNvdWxkIHBvdGVudGlhbGx5IGJlIG1lcmdlZC4KICAgICAqIEByZXR1cm5zIHtCb29sZWFufQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9jYW5NZXJnZVJpZ2h0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2FuTWVyZ2VSaWdodChub2RlKSB7CiAgICAgIHZhciBuZXh0U2libGluZyA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgIHJldHVybiBuZXh0U2libGluZyBpbnN0YW5jZW9mIEVsZW1lbnQgJiYgdGhpcy5jYW5NZXJnZVdpdGguaGFzKG5leHRTaWJsaW5nKSAmJiB0aGlzLm1vZGVsLnNjaGVtYS5jaGVja01lcmdlKG5vZGUsIG5leHRTaWJsaW5nKTsKICAgIH0KICAgIC8qKgogICAgICogVHJpZXMgd3JhcHBpbmcgdGhlIG5vZGUgaW4gYSBuZXcgcGFyYWdyYXBoIGFuZCBpbnNlcnRpbmcgaXQgdGhpcyB3YXkuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9ub2Rlfk5vZGV9IG5vZGUgVGhlIG5vZGUgd2hpY2ggbmVlZHMgdG8gYmUgYXV0b3BhcmFncmFwaGVkLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl90cnlBdXRvcGFyYWdyYXBoaW5nIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfdHJ5QXV0b3BhcmFncmFwaGluZyhub2RlKSB7CiAgICAgIHZhciBwYXJhZ3JhcGggPSB0aGlzLndyaXRlci5jcmVhdGVFbGVtZW50KCdwYXJhZ3JhcGgnKTsgLy8gRG8gbm90IGF1dG9wYXJhZ3JhcGggaWYgdGhlIHBhcmFncmFwaCB3b24ndCBiZSBhbGxvd2VkIHRoZXJlLAogICAgICAvLyBjYXVzZSB0aGF0IHdvdWxkIGxlYWQgdG8gYW4gaW5maW5pdGUgbG9vcC4gVGhlIHBhcmFncmFwaCB3b3VsZCBiZSByZWplY3RlZCBpbgogICAgICAvLyB0aGUgbmV4dCBfaGFuZGxlTm9kZSgpIGNhbGwgYW5kIHdlJ2QgYmUgaGVyZSBhZ2Fpbi4KCiAgICAgIGlmICh0aGlzLl9nZXRBbGxvd2VkSW4ocGFyYWdyYXBoLCB0aGlzLnBvc2l0aW9uLnBhcmVudCkgJiYgdGhpcy5zY2hlbWEuY2hlY2tDaGlsZChwYXJhZ3JhcGgsIG5vZGUpKSB7CiAgICAgICAgcGFyYWdyYXBoLl9hcHBlbmRDaGlsZChub2RlKTsKCiAgICAgICAgdGhpcy5faGFuZGxlTm9kZShwYXJhZ3JhcGgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBpZiBhIG5vZGUgY2FuIGJlIGluc2VydGVkIGluIHRoZSBnaXZlbiBwb3NpdGlvbiBvciBpdCB3b3VsZCBiZSBhY2NlcHRlZCBpZiBhIHBhcmFncmFwaCB3b3VsZCBiZSBpbnNlcnRlZC4KICAgICAqIEl0IGFsc28gaGFuZGxlcyBpbnNlcnRpbmcgdGhlIHBhcmFncmFwaC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZX0gbm9kZSBUaGUgbm9kZS4KICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBXaGV0aGVyIGFuIGFsbG93ZWQgcG9zaXRpb24gd2FzIGZvdW5kLgogICAgICogYGZhbHNlYCBpcyByZXR1cm5lZCBpZiB0aGUgbm9kZSBpc24ndCBhbGxvd2VkIGF0IHRoZSBjdXJyZW50IHBvc2l0aW9uIG9yIGluIGF1dG8gcGFyYWdyYXBoLCBgdHJ1ZWAgaWYgd2FzLgogICAgICovCgogIH0sIHsKICAgIGtleTogIl9jaGVja0FuZEF1dG9QYXJhZ3JhcGhUb0FsbG93ZWRQb3NpdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoZWNrQW5kQXV0b1BhcmFncmFwaFRvQWxsb3dlZFBvc2l0aW9uKG5vZGUpIHsKICAgICAgaWYgKHRoaXMuc2NoZW1hLmNoZWNrQ2hpbGQodGhpcy5wb3NpdGlvbi5wYXJlbnQsIG5vZGUpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gLy8gRG8gbm90IGF1dG8gcGFyYWdyYXBoIGlmIHRoZSBwYXJhZ3JhcGggd29uJ3QgYmUgYWxsb3dlZCB0aGVyZSwKICAgICAgLy8gY2F1c2UgdGhhdCB3b3VsZCBsZWFkIHRvIGFuIGluZmluaXRlIGxvb3AuIFRoZSBwYXJhZ3JhcGggd291bGQgYmUgcmVqZWN0ZWQgaW4KICAgICAgLy8gdGhlIG5leHQgX2hhbmRsZU5vZGUoKSBjYWxsIGFuZCB3ZSdkIGJlIGhlcmUgYWdhaW4uCgoKICAgICAgaWYgKCF0aGlzLnNjaGVtYS5jaGVja0NoaWxkKHRoaXMucG9zaXRpb24ucGFyZW50LCAncGFyYWdyYXBoJykgfHwgIXRoaXMuc2NoZW1hLmNoZWNrQ2hpbGQoJ3BhcmFncmFwaCcsIG5vZGUpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vIEluc2VydCBub2RlcyBjb2xsZWN0ZWQgaW4gdGVtcG9yYXJ5IERvY3VtZW50RnJhZ21lbnQgaWYgdGhlIHBvc2l0aW9uIHBhcmVudCBuZWVkcyBjaGFuZ2UgdG8gcHJvY2VzcyBmdXJ0aGVyIG5vZGVzLgoKCiAgICAgIHRoaXMuX2luc2VydFBhcnRpYWxGcmFnbWVudCgpOyAvLyBJbnNlcnQgYSBwYXJhZ3JhcGggYW5kIG1vdmUgaW5zZXJ0aW9uIHBvc2l0aW9uIHRvIGl0LgoKCiAgICAgIHZhciBwYXJhZ3JhcGggPSB0aGlzLndyaXRlci5jcmVhdGVFbGVtZW50KCdwYXJhZ3JhcGgnKTsKICAgICAgdGhpcy53cml0ZXIuaW5zZXJ0KHBhcmFncmFwaCwgdGhpcy5wb3NpdGlvbik7CgogICAgICB0aGlzLl9zZXRBZmZlY3RlZEJvdW5kYXJpZXModGhpcy5wb3NpdGlvbik7CgogICAgICB0aGlzLl9sYXN0QXV0b1BhcmFncmFwaCA9IHBhcmFncmFwaDsKICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMud3JpdGVyLmNyZWF0ZVBvc2l0aW9uQXQocGFyYWdyYXBoLCAwKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge21vZHVsZTplbmdpbmUvbW9kZWwvbm9kZX5Ob2RlfSBub2RlCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gV2hldGhlciBhbiBhbGxvd2VkIHBvc2l0aW9uIHdhcyBmb3VuZC4KICAgICAqIGBmYWxzZWAgaXMgcmV0dXJuZWQgaWYgdGhlIG5vZGUgaXNuJ3QgYWxsb3dlZCBhdCBhbnkgcG9zaXRpb24gdXAgaW4gdGhlIHRyZWUsIGB0cnVlYCBpZiB3YXMuCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX2NoZWNrQW5kU3BsaXRUb0FsbG93ZWRQb3NpdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoZWNrQW5kU3BsaXRUb0FsbG93ZWRQb3NpdGlvbihub2RlKSB7CiAgICAgIHZhciBhbGxvd2VkSW4gPSB0aGlzLl9nZXRBbGxvd2VkSW4obm9kZSwgdGhpcy5wb3NpdGlvbi5wYXJlbnQpOwoKICAgICAgaWYgKCFhbGxvd2VkSW4pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy8gSW5zZXJ0IG5vZGVzIGNvbGxlY3RlZCBpbiB0ZW1wb3JhcnkgRG9jdW1lbnRGcmFnbWVudCBpZiB0aGUgcG9zaXRpb24gcGFyZW50IG5lZWRzIGNoYW5nZSB0byBwcm9jZXNzIGZ1cnRoZXIgbm9kZXMuCgoKICAgICAgaWYgKGFsbG93ZWRJbiAhPSB0aGlzLnBvc2l0aW9uLnBhcmVudCkgewogICAgICAgIHRoaXMuX2luc2VydFBhcnRpYWxGcmFnbWVudCgpOwogICAgICB9CgogICAgICB3aGlsZSAoYWxsb3dlZEluICE9IHRoaXMucG9zaXRpb24ucGFyZW50KSB7CiAgICAgICAgLy8gSWYgYSBwYXJlbnQgd2hpY2ggd2UnZCBuZWVkIHRvIGxlYXZlIGlzIGEgbGltaXQgZWxlbWVudCwgYnJlYWsuCiAgICAgICAgaWYgKHRoaXMuc2NoZW1hLmlzTGltaXQodGhpcy5wb3NpdGlvbi5wYXJlbnQpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wb3NpdGlvbi5pc0F0U3RhcnQpIHsKICAgICAgICAgIC8vIElmIGluc2VydGlvbiBwb3NpdGlvbiBpcyBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBwYXJlbnQsIG1vdmUgaXQgb3V0IGluc3RlYWQgb2Ygc3BsaXR0aW5nLgogICAgICAgICAgLy8gPHA+XkZvbzwvcD4gLT4gXjxwPkZvbzwvcD4KICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnBvc2l0aW9uLnBhcmVudDsKICAgICAgICAgIHRoaXMucG9zaXRpb24gPSB0aGlzLndyaXRlci5jcmVhdGVQb3NpdGlvbkJlZm9yZShwYXJlbnQpOyAvLyBTcGVjaWFsIGNhc2Ug4oCTIHBhcmVudCBpcyBlbXB0eSAoPHA+XjwvcD4pLgogICAgICAgICAgLy8KICAgICAgICAgIC8vIDEuIHBhcmVudC5pc0VtcHR5CiAgICAgICAgICAvLyBXZSBjYW4gcmVtb3ZlIHRoZSBlbGVtZW50IGFmdGVyIG1vdmluZyBpbnNlcnRpb24gcG9zaXRpb24gb3V0IG9mIGl0LgogICAgICAgICAgLy8KICAgICAgICAgIC8vIDIuIHBhcmVudC5wYXJlbnQgPT09IGFsbG93ZWRJbgogICAgICAgICAgLy8gSG93ZXZlciBwYXJlbnQgc2hvdWxkIHJlbWFpbiBpbiBwbGFjZSB3aGVuIGFsbG93ZWQgZWxlbWVudCBpcyBhYm92ZSBsaW1pdCBlbGVtZW50IGluIGRvY3VtZW50IHRyZWUuCiAgICAgICAgICAvLyBGb3IgZXhhbXBsZSB0aGVyZSBzaG91bGRuJ3QgYmUgYWxsb3dlZCB0byByZW1vdmUgZW1wdHkgcGFyYWdyYXBoIGZyb20gdGFibGVDZWxsLCB3aGVuIGlzIHBhc3RlZAogICAgICAgICAgLy8gY29udGVudCBhbGxvd2VkIGluICRyb290LgoKICAgICAgICAgIGlmIChwYXJlbnQuaXNFbXB0eSAmJiBwYXJlbnQucGFyZW50ID09PSBhbGxvd2VkSW4pIHsKICAgICAgICAgICAgdGhpcy53cml0ZXIucmVtb3ZlKHBhcmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnBvc2l0aW9uLmlzQXRFbmQpIHsKICAgICAgICAgIC8vIElmIGluc2VydGlvbiBwb3NpdGlvbiBpcyBhdCB0aGUgZW5kIG9mIHRoZSBwYXJlbnQsIG1vdmUgaXQgb3V0IGluc3RlYWQgb2Ygc3BsaXR0aW5nLgogICAgICAgICAgLy8gPHA+Rm9vXjwvcD4gLT4gPHA+Rm9vPC9wPl4KICAgICAgICAgIHRoaXMucG9zaXRpb24gPSB0aGlzLndyaXRlci5jcmVhdGVQb3NpdGlvbkFmdGVyKHRoaXMucG9zaXRpb24ucGFyZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHRlbXBQb3MgPSB0aGlzLndyaXRlci5jcmVhdGVQb3NpdGlvbkFmdGVyKHRoaXMucG9zaXRpb24ucGFyZW50KTsKCiAgICAgICAgICB0aGlzLl9zZXRBZmZlY3RlZEJvdW5kYXJpZXModGhpcy5wb3NpdGlvbik7CgogICAgICAgICAgdGhpcy53cml0ZXIuc3BsaXQodGhpcy5wb3NpdGlvbik7CiAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gdGVtcFBvczsKICAgICAgICAgIHRoaXMuY2FuTWVyZ2VXaXRoLmFkZCh0aGlzLnBvc2l0aW9uLm5vZGVBZnRlcik7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgZWxlbWVudCBpbiB3aGljaCB0aGUgZ2l2ZW4gbm9kZSBpcyBhbGxvd2VkLiBJdCBjaGVja3MgdGhlIHBhc3NlZCBlbGVtZW50IGFuZCBhbGwgaXRzIGFuY2VzdG9ycy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHttb2R1bGU6ZW5naW5lL21vZGVsL25vZGV+Tm9kZX0gbm9kZSBUaGUgbm9kZSB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7bW9kdWxlOmVuZ2luZS9tb2RlbC9lbGVtZW50fkVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgaW4gd2hpY2ggdGhlIG5vZGUncyBjb3JyZWN0bmVzcyBzaG91bGQgYmUgY2hlY2tlZC4KICAgICAqIEByZXR1cm5zIHttb2R1bGU6ZW5naW5lL21vZGVsL2VsZW1lbnR+RWxlbWVudHxudWxsfQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9nZXRBbGxvd2VkSW4iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRBbGxvd2VkSW4obm9kZSwgZWxlbWVudCkgewogICAgICBpZiAodGhpcy5zY2hlbWEuY2hlY2tDaGlsZChlbGVtZW50LCBub2RlKSkgewogICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICB9CgogICAgICBpZiAoZWxlbWVudC5wYXJlbnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0QWxsb3dlZEluKG5vZGUsIGVsZW1lbnQucGFyZW50KTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gSW5zZXJ0aW9uOwp9KCk7"},{"version":3,"sources":["/home/ekeberat/Yandex.Disk/Projelerim/BenimProjelerim/websitem/websitem-web/node_modules/@ckeditor/ckeditor5-engine/src/model/utils/insertcontent.js"],"names":["Position","LivePosition","Element","Range","DocumentSelection","Selection","CKEditorError","insertContent","model","content","selectable","placeOrOffset","change","writer","selection","document","createSelection","isCollapsed","deleteContent","doNotAutoparagraph","insertion","Insertion","anchor","nodesToInsert","is","getChildren","handleNodes","newRange","getSelectionRange","setSelection","setTo","affectedRange","getAffectedRange","createRange","destroy","position","canMergeWith","Set","parent","schema","_documentFragment","createDocumentFragment","_documentFragmentPosition","createPositionAt","_firstNode","_lastNode","_lastAutoParagraph","_filterAttributesOf","_affectedStart","_affectedEnd","nodes","Array","from","node","_handleNode","_insertPartialFragment","_updateLastNodeFromAutoParagraph","_mergeOnRight","removeDisallowedAttributes","positionAfterLastNode","createPositionAfter","positionAfterNode","isAfter","isAtEnd","_setAffectedBoundaries","nodeToSelect","_createOn","getNearestSelectionRange","detach","isObject","_handleObject","isAllowed","_checkAndAutoParagraphToAllowedPosition","_checkAndSplitToAllowedPosition","_handleDisallowedNode","_appendToFragment","isEmpty","livePosition","fromPosition","getChild","insert","_mergeOnLeft","toPosition","_tryAutoparagraphing","checkChild","getShiftedBy","offsetSize","push","isBefore","_canMergeLeft","mergePosLeft","_createBefore","stickiness","isEqual","_createAt","nodeBefore","merge","_canMergeRight","mergePosRight","_createAfter","previousSibling","has","checkMerge","nextSibling","paragraph","createElement","_getAllowedIn","_appendChild","allowedIn","isLimit","isAtStart","createPositionBefore","remove","tempPos","split","add","nodeAfter","element"],"mappings":";;;;;;;;;;;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA,OAAOA,QAAP,MAAqB,aAArB;AACA,OAAOC,YAAP,MAAyB,iBAAzB;AACA,OAAOC,OAAP,MAAoB,YAApB;AACA,OAAOC,KAAP,MAAkB,UAAlB;AACA,OAAOC,iBAAP,MAA8B,sBAA9B;AACA,OAAOC,SAAP,MAAsB,cAAtB;AACA,OAAOC,aAAP,MAA0B,6CAA1B;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,eAAe,SAASC,aAAT,CAAwBC,KAAxB,EAA+BC,OAA/B,EAAwCC,UAAxC,EAAoDC,aAApD,EAAoE;AAClF,SAAOH,KAAK,CAACI,MAAN,CAAc,UAAAC,MAAM,EAAI;AAC9B,QAAIC,SAAJ;;AAEA,QAAK,CAACJ,UAAN,EAAmB;AAClBI,MAAAA,SAAS,GAAGN,KAAK,CAACO,QAAN,CAAeD,SAA3B;AACA,KAFD,MAEO,IAAKJ,UAAU,YAAYL,SAAtB,IAAmCK,UAAU,YAAYN,iBAA9D,EAAkF;AACxFU,MAAAA,SAAS,GAAGJ,UAAZ;AACA,KAFM,MAEA;AACNI,MAAAA,SAAS,GAAGD,MAAM,CAACG,eAAP,CAAwBN,UAAxB,EAAoCC,aAApC,CAAZ;AACA;;AAED,QAAK,CAACG,SAAS,CAACG,WAAhB,EAA8B;AAC7BT,MAAAA,KAAK,CAACU,aAAN,CAAqBJ,SAArB,EAAgC;AAAEK,QAAAA,kBAAkB,EAAE;AAAtB,OAAhC;AACA;;AAED,QAAMC,SAAS,GAAG,IAAIC,SAAJ,CAAeb,KAAf,EAAsBK,MAAtB,EAA8BC,SAAS,CAACQ,MAAxC,CAAlB;AAEA,QAAIC,aAAJ;;AAEA,QAAKd,OAAO,CAACe,EAAR,CAAY,kBAAZ,CAAL,EAAwC;AACvCD,MAAAA,aAAa,GAAGd,OAAO,CAACgB,WAAR,EAAhB;AACA,KAFD,MAEO;AACNF,MAAAA,aAAa,GAAG,CAAEd,OAAF,CAAhB;AACA;;AAEDW,IAAAA,SAAS,CAACM,WAAV,CAAuBH,aAAvB;AAEA,QAAMI,QAAQ,GAAGP,SAAS,CAACQ,iBAAV,EAAjB;AAEA;;AACA,QAAKD,QAAL,EAAgB;AACf,UAAKb,SAAS,YAAYV,iBAA1B,EAA8C;AAC7CS,QAAAA,MAAM,CAACgB,YAAP,CAAqBF,QAArB;AACA,OAFD,MAEO;AACNb,QAAAA,SAAS,CAACgB,KAAV,CAAiBH,QAAjB;AACA;AACD,KAND,MAMO,CACN;AACA;AACA;AACA;AACA;;AAED,QAAMI,aAAa,GAAGX,SAAS,CAACY,gBAAV,MAAgCxB,KAAK,CAACyB,WAAN,CAAmBnB,SAAS,CAACQ,MAA7B,CAAtD;AAEAF,IAAAA,SAAS,CAACc,OAAV;AAEA,WAAOH,aAAP;AACA,GAhDM,CAAP;AAiDA;AAED;AACA;AACA;AACA;AACA;;IACMV,S;AACL,qBAAab,KAAb,EAAoBK,MAApB,EAA4BsB,QAA5B,EAAuC;AAAA;;AACtC;AACF;AACA;AACA;AACA;AACE,SAAK3B,KAAL,GAAaA,KAAb;AAEA;AACF;AACA;AACA;AACA;;AACE,SAAKK,MAAL,GAAcA,MAAd;AAEA;AACF;AACA;AACA;AACA;;AACE,SAAKsB,QAAL,GAAgBA,QAAhB;AAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACE,SAAKC,YAAL,GAAoB,IAAIC,GAAJ,CAAS,CAAE,KAAKF,QAAL,CAAcG,MAAhB,CAAT,CAApB;AAEA;AACF;AACA;AACA;AACA;;AACE,SAAKC,MAAL,GAAc/B,KAAK,CAAC+B,MAApB;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,iBAAL,GAAyB3B,MAAM,CAAC4B,sBAAP,EAAzB;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,yBAAL,GAAiC7B,MAAM,CAAC8B,gBAAP,CAAyB,KAAKH,iBAA9B,EAAiD,CAAjD,CAAjC;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKI,UAAL,GAAkB,IAAlB;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,SAAL,GAAiB,IAAjB;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,kBAAL,GAA0B,IAA1B;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,mBAAL,GAA2B,EAA3B;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,cAAL,GAAsB,IAAtB;AAEA;AACF;AACA;AACA;AACA;AACA;;AACE,SAAKC,YAAL,GAAoB,IAApB;AACA;AAED;AACD;AACA;AACA;AACA;;;;;WACC,qBAAaC,KAAb,EAAqB;AACpB,qCAAoBC,KAAK,CAACC,IAAN,CAAYF,KAAZ,CAApB,iCAA0C;AAApC,YAAMG,IAAI,kBAAV;;AACL,aAAKC,WAAL,CAAkBD,IAAlB;AACA,OAHmB,CAKpB;;;AACA,WAAKE,sBAAL,GANoB,CAQpB;;;AACA,UAAK,KAAKT,kBAAV,EAA+B;AAC9B,aAAKU,gCAAL,CAAuC,KAAKV,kBAA5C;AACA,OAXmB,CAapB;AACA;;;AACA,WAAKW,aAAL,GAfoB,CAiBpB;;;AACA,WAAKlB,MAAL,CAAYmB,0BAAZ,CAAwC,KAAKX,mBAA7C,EAAkE,KAAKlC,MAAvE;AACA,WAAKkC,mBAAL,GAA2B,EAA3B;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,0CAAkCM,IAAlC,EAAyC;AACxC,UAAMM,qBAAqB,GAAG,KAAK9C,MAAL,CAAY+C,mBAAZ,CAAiC,KAAKf,SAAtC,CAA9B;AACA,UAAMgB,iBAAiB,GAAG,KAAKhD,MAAL,CAAY+C,mBAAZ,CAAiCP,IAAjC,CAA1B,CAFwC,CAIxC;;AACA,UAAKQ,iBAAiB,CAACC,OAAlB,CAA2BH,qBAA3B,CAAL,EAA0D;AACzD,aAAKd,SAAL,GAAiBQ,IAAjB;AAEA;;AACA,YAAK,KAAKlB,QAAL,CAAcG,MAAd,IAAwBe,IAAxB,IAAgC,CAAC,KAAKlB,QAAL,CAAc4B,OAApD,EAA8D;AAC7D;AACA;AACA;AACA,gBAAM,IAAIzD,aAAJ,CAAmB,0CAAnB,EAA+D,IAA/D,CAAN;AACA;;AAED,aAAK6B,QAAL,GAAgB0B,iBAAhB;;AACA,aAAKG,sBAAL,CAA6B,KAAK7B,QAAlC;AACA;AACD;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,6BAAoB;AACnB,UAAK,KAAK8B,YAAV,EAAyB;AACxB,eAAO9D,KAAK,CAAC+D,SAAN,CAAiB,KAAKD,YAAtB,CAAP;AACA;;AAED,aAAO,KAAKzD,KAAL,CAAW+B,MAAX,CAAkB4B,wBAAlB,CAA4C,KAAKhC,QAAjD,CAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,4BAAmB;AAClB,UAAK,CAAC,KAAKa,cAAX,EAA4B;AAC3B,eAAO,IAAP;AACA;;AAED,aAAO,IAAI7C,KAAJ,CAAW,KAAK6C,cAAhB,EAAgC,KAAKC,YAArC,CAAP;AACA;AAED;AACD;AACA;;;;WACC,mBAAU;AACT,UAAK,KAAKD,cAAV,EAA2B;AAC1B,aAAKA,cAAL,CAAoBoB,MAApB;AACA;;AAED,UAAK,KAAKnB,YAAV,EAAyB;AACxB,aAAKA,YAAL,CAAkBmB,MAAlB;AACA;AACD;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,qBAAaf,IAAb,EAAoB;AACnB;AACA;AACA;AACA,UAAK,KAAKd,MAAL,CAAY8B,QAAZ,CAAsBhB,IAAtB,CAAL,EAAoC;AACnC,aAAKiB,aAAL,CAAoBjB,IAApB;;AAEA;AACA,OARkB,CAUnB;AAEA;AACA;;;AACA,UAAIkB,SAAS,GAAG,KAAKC,uCAAL,CAA8CnB,IAA9C,CAAhB;;AAEA,UAAK,CAACkB,SAAN,EAAkB;AACjB;AACA;AACAA,QAAAA,SAAS,GAAG,KAAKE,+BAAL,CAAsCpB,IAAtC,CAAZ;;AAEA,YAAK,CAACkB,SAAN,EAAkB;AACjB,eAAKG,qBAAL,CAA4BrB,IAA5B;;AAEA;AACA;AACD,OA1BkB,CA4BnB;;;AACA,WAAKsB,iBAAL,CAAwBtB,IAAxB,EA7BmB,CA+BnB;;;AACA,UAAK,CAAC,KAAKT,UAAX,EAAwB;AACvB,aAAKA,UAAL,GAAkBS,IAAlB;AACA;;AAED,WAAKR,SAAL,GAAiBQ,IAAjB;AACA;AAED;AACD;AACA;AACA;AACA;;;;WACC,kCAAyB;AACxB,UAAK,KAAKb,iBAAL,CAAuBoC,OAA5B,EAAsC;AACrC;AACA;;AAED,UAAMC,YAAY,GAAG5E,YAAY,CAAC6E,YAAb,CAA2B,KAAK3C,QAAhC,EAA0C,QAA1C,CAArB;;AAEA,WAAK6B,sBAAL,CAA6B,KAAK7B,QAAlC,EAPwB,CASxB;AACA;AACA;;;AACA,UAAK,KAAKK,iBAAL,CAAuBuC,QAAvB,CAAiC,CAAjC,KAAwC,KAAKnC,UAAlD,EAA+D;AAC9D,aAAK/B,MAAL,CAAYmE,MAAZ,CAAoB,KAAKpC,UAAzB,EAAqC,KAAKT,QAA1C,EAD8D,CAG9D;AACA;;AACA,aAAK8C,YAAL;;AAEA,aAAK9C,QAAL,GAAgB0C,YAAY,CAACK,UAAb,EAAhB;AACA,OApBuB,CAsBxB;;;AACA,UAAK,CAAC,KAAK1C,iBAAL,CAAuBoC,OAA7B,EAAuC;AACtC,aAAK/D,MAAL,CAAYmE,MAAZ,CAAoB,KAAKxC,iBAAzB,EAA4C,KAAKL,QAAjD;AACA;;AAED,WAAKO,yBAAL,GAAiC,KAAK7B,MAAL,CAAY8B,gBAAZ,CAA8B,KAAKH,iBAAnC,EAAsD,CAAtD,CAAjC;AAEA,WAAKL,QAAL,GAAgB0C,YAAY,CAACK,UAAb,EAAhB;AACAL,MAAAA,YAAY,CAACT,MAAb;AACA;AAED;AACD;AACA;AACA;;;;WACC,uBAAef,IAAf,EAAsB;AACrB;AACA,UAAK,KAAKoB,+BAAL,CAAsCpB,IAAtC,CAAL,EAAoD;AACnD,aAAKsB,iBAAL,CAAwBtB,IAAxB;AACA,OAFD,CAGA;AAHA,WAIK;AACJ,eAAK8B,oBAAL,CAA2B9B,IAA3B;AACA;AACD;AAED;AACD;AACA;AACA;;;;WACC,+BAAuBA,IAAvB,EAA8B;AAC7B;AACA,UAAKA,IAAI,CAAC7B,EAAL,CAAS,SAAT,CAAL,EAA4B;AAC3B,aAAKE,WAAL,CAAkB2B,IAAI,CAAC5B,WAAL,EAAlB;AACA,OAFD,CAGA;AAHA,WAIK;AACJ,eAAK0D,oBAAL,CAA2B9B,IAA3B;AACA;AACD;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,2BAAmBA,IAAnB,EAA0B;AACzB;AACA,UAAK,CAAC,KAAKd,MAAL,CAAY6C,UAAZ,CAAwB,KAAKjD,QAA7B,EAAuCkB,IAAvC,CAAN,EAAsD;AACrD;AACA;;AAEA;AACH;AACA;AACA;AACA;AACA;AACA;AACG,cAAM,IAAI/C,aAAJ,CACL,8BADK,EAEL,IAFK,EAGL;AAAE+C,UAAAA,IAAI,EAAJA,IAAF;AAAQlB,UAAAA,QAAQ,EAAE,KAAKA;AAAvB,SAHK,CAAN;AAKA;;AAED,WAAKtB,MAAL,CAAYmE,MAAZ,CAAoB3B,IAApB,EAA0B,KAAKX,yBAA/B;AACA,WAAKA,yBAAL,GAAiC,KAAKA,yBAAL,CAA+B2C,YAA/B,CAA6ChC,IAAI,CAACiC,UAAlD,CAAjC,CArByB,CAuBzB;;AACA,UAAK,KAAK/C,MAAL,CAAY8B,QAAZ,CAAsBhB,IAAtB,KAAgC,CAAC,KAAKd,MAAL,CAAY6C,UAAZ,CAAwB,KAAKjD,QAA7B,EAAuC,OAAvC,CAAtC,EAAyF;AACxF,aAAK8B,YAAL,GAAoBZ,IAApB;AACA,OAFD,MAEO;AACN,aAAKY,YAAL,GAAoB,IAApB;AACA;;AAED,WAAKlB,mBAAL,CAAyBwC,IAAzB,CAA+BlC,IAA/B;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,gCAAwBlB,QAAxB,EAAmC;AAClC;AACA;AACA;AACA,UAAK,CAAC,KAAKa,cAAX,EAA4B;AAC3B,aAAKA,cAAL,GAAsB/C,YAAY,CAAC6E,YAAb,CAA2B3C,QAA3B,EAAqC,YAArC,CAAtB;AACA,OANiC,CAQlC;AACA;AACA;AACA;;;AACA,UAAK,CAAC,KAAKc,YAAN,IAAsB,KAAKA,YAAL,CAAkBuC,QAAlB,CAA4BrD,QAA5B,CAA3B,EAAoE;AACnE,YAAK,KAAKc,YAAV,EAAyB;AACxB,eAAKA,YAAL,CAAkBmB,MAAlB;AACA;;AAED,aAAKnB,YAAL,GAAoBhD,YAAY,CAAC6E,YAAb,CAA2B3C,QAA3B,EAAqC,QAArC,CAApB;AACA;AACD;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,wBAAe;AACd,UAAMkB,IAAI,GAAG,KAAKT,UAAlB;;AAEA,UAAK,EAAGS,IAAI,YAAYnD,OAAnB,CAAL,EAAoC;AACnC;AACA;;AAED,UAAK,CAAC,KAAKuF,aAAL,CAAoBpC,IAApB,CAAN,EAAmC;AAClC;AACA;;AAED,UAAMqC,YAAY,GAAGzF,YAAY,CAAC0F,aAAb,CAA4BtC,IAA5B,CAArB;;AACAqC,MAAAA,YAAY,CAACE,UAAb,GAA0B,QAA1B;AAEA,UAAMf,YAAY,GAAG5E,YAAY,CAAC6E,YAAb,CAA2B,KAAK3C,QAAhC,EAA0C,QAA1C,CAArB,CAdc,CAgBd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,UAAK,KAAKa,cAAL,CAAoB6C,OAApB,CAA6BH,YAA7B,CAAL,EAAmD;AAClD,aAAK1C,cAAL,CAAoBoB,MAApB;;AACA,aAAKpB,cAAL,GAAsB/C,YAAY,CAAC6F,SAAb,CAAwBJ,YAAY,CAACK,UAArC,EAAiD,KAAjD,EAAwD,YAAxD,CAAtB;AACA,OA/Ba,CAiCd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,UAAK,KAAKnD,UAAL,KAAoB,KAAKC,SAA9B,EAA0C;AACzC,aAAKD,UAAL,GAAkB8C,YAAY,CAACK,UAA/B;AACA,aAAKlD,SAAL,GAAiB6C,YAAY,CAACK,UAA9B;AACA;;AAED,WAAKlF,MAAL,CAAYmF,KAAZ,CAAmBN,YAAnB,EA/Cc,CAiDd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,UAAKA,YAAY,CAACG,OAAb,CAAsB,KAAK5C,YAA3B,KAA6C,KAAKL,UAAL,KAAoB,KAAKC,SAA3E,EAAuF;AACtF,aAAKI,YAAL,CAAkBmB,MAAlB;;AACA,aAAKnB,YAAL,GAAoBhD,YAAY,CAAC6F,SAAb,CAAwBJ,YAAY,CAACK,UAArC,EAAiD,KAAjD,EAAwD,QAAxD,CAApB;AACA;;AAED,WAAK5D,QAAL,GAAgB0C,YAAY,CAACK,UAAb,EAAhB;AACAL,MAAAA,YAAY,CAACT,MAAb,GA/Dc,CAiEd;AACA;;AACA,WAAKrB,mBAAL,CAAyBwC,IAAzB,CAA+B,KAAKpD,QAAL,CAAcG,MAA7C;;AAEAoD,MAAAA,YAAY,CAACtB,MAAb;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,yBAAgB;AACf,UAAMf,IAAI,GAAG,KAAKR,SAAlB;;AAEA,UAAK,EAAGQ,IAAI,YAAYnD,OAAnB,CAAL,EAAoC;AACnC;AACA;;AAED,UAAK,CAAC,KAAK+F,cAAL,CAAqB5C,IAArB,CAAN,EAAoC;AACnC;AACA;;AAED,UAAM6C,aAAa,GAAGjG,YAAY,CAACkG,YAAb,CAA2B9C,IAA3B,CAAtB;;AACA6C,MAAAA,aAAa,CAACN,UAAd,GAA2B,QAA3B;AAEA;;AACA,UAAK,CAAC,KAAKzD,QAAL,CAAc0D,OAAd,CAAuBK,aAAvB,CAAN,EAA+C;AAC9C;AACA;AACA;;AACA;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACG,cAAM,IAAI5F,aAAJ,CAAmB,0CAAnB,EAA+D,IAA/D,CAAN;AACA,OA7Bc,CA+Bf;AACA;;;AACA,WAAK6B,QAAL,GAAgBnC,QAAQ,CAAC8F,SAAT,CAAoBI,aAAa,CAACH,UAAlC,EAA8C,KAA9C,CAAhB,CAjCe,CAmCf;AACA;AACA;;AACA,UAAMlB,YAAY,GAAG5E,YAAY,CAAC6E,YAAb,CAA2B,KAAK3C,QAAhC,EAA0C,YAA1C,CAArB,CAtCe,CAwCf;;AACA,UAAK,KAAKc,YAAL,CAAkB4C,OAAlB,CAA2BK,aAA3B,CAAL,EAAkD;AACjD,aAAKjD,YAAL,CAAkBmB,MAAlB;;AACA,aAAKnB,YAAL,GAAoBhD,YAAY,CAAC6F,SAAb,CAAwBI,aAAa,CAACH,UAAtC,EAAkD,KAAlD,EAAyD,QAAzD,CAApB;AACA,OA5Cc,CA8Cf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,UAAK,KAAKnD,UAAL,KAAoB,KAAKC,SAA9B,EAA0C;AACzC,aAAKD,UAAL,GAAkBsD,aAAa,CAACH,UAAhC;AACA,aAAKlD,SAAL,GAAiBqD,aAAa,CAACH,UAA/B;AACA;;AAED,WAAKlF,MAAL,CAAYmF,KAAZ,CAAmBE,aAAnB,EA5De,CA8Df;;AACA,UAAKA,aAAa,CAACb,YAAd,CAA4B,CAAC,CAA7B,EAAiCQ,OAAjC,CAA0C,KAAK7C,cAA/C,KAAmE,KAAKJ,UAAL,KAAoB,KAAKC,SAAjG,EAA6G;AAC5G,aAAKG,cAAL,CAAoBoB,MAApB;;AACA,aAAKpB,cAAL,GAAsB/C,YAAY,CAAC6F,SAAb,CAAwBI,aAAa,CAACH,UAAtC,EAAkD,CAAlD,EAAqD,YAArD,CAAtB;AACA;;AAED,WAAK5D,QAAL,GAAgB0C,YAAY,CAACK,UAAb,EAAhB;AACAL,MAAAA,YAAY,CAACT,MAAb,GArEe,CAuEf;AACA;;AACA,WAAKrB,mBAAL,CAAyBwC,IAAzB,CAA+B,KAAKpD,QAAL,CAAcG,MAA7C;;AAEA4D,MAAAA,aAAa,CAAC9B,MAAd;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;WACC,uBAAef,IAAf,EAAsB;AACrB,UAAM+C,eAAe,GAAG/C,IAAI,CAAC+C,eAA7B;AAEA,aAASA,eAAe,YAAYlG,OAA7B,IACN,KAAKkC,YAAL,CAAkBiE,GAAlB,CAAuBD,eAAvB,CADM,IAEN,KAAK5F,KAAL,CAAW+B,MAAX,CAAkB+D,UAAlB,CAA8BF,eAA9B,EAA+C/C,IAA/C,CAFD;AAGA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;;;;WACC,wBAAgBA,IAAhB,EAAuB;AACtB,UAAMkD,WAAW,GAAGlD,IAAI,CAACkD,WAAzB;AAEA,aAASA,WAAW,YAAYrG,OAAzB,IACN,KAAKkC,YAAL,CAAkBiE,GAAlB,CAAuBE,WAAvB,CADM,IAEN,KAAK/F,KAAL,CAAW+B,MAAX,CAAkB+D,UAAlB,CAA8BjD,IAA9B,EAAoCkD,WAApC,CAFD;AAGA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,8BAAsBlD,IAAtB,EAA6B;AAC5B,UAAMmD,SAAS,GAAG,KAAK3F,MAAL,CAAY4F,aAAZ,CAA2B,WAA3B,CAAlB,CAD4B,CAG5B;AACA;AACA;;AACA,UAAK,KAAKC,aAAL,CAAoBF,SAApB,EAA+B,KAAKrE,QAAL,CAAcG,MAA7C,KAAyD,KAAKC,MAAL,CAAY6C,UAAZ,CAAwBoB,SAAxB,EAAmCnD,IAAnC,CAA9D,EAA0G;AACzGmD,QAAAA,SAAS,CAACG,YAAV,CAAwBtD,IAAxB;;AACA,aAAKC,WAAL,CAAkBkD,SAAlB;AACA;AACD;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,iDAAyCnD,IAAzC,EAAgD;AAC/C,UAAK,KAAKd,MAAL,CAAY6C,UAAZ,CAAwB,KAAKjD,QAAL,CAAcG,MAAtC,EAA8Ce,IAA9C,CAAL,EAA4D;AAC3D,eAAO,IAAP;AACA,OAH8C,CAK/C;AACA;AACA;;;AACA,UAAK,CAAC,KAAKd,MAAL,CAAY6C,UAAZ,CAAwB,KAAKjD,QAAL,CAAcG,MAAtC,EAA8C,WAA9C,CAAD,IAAgE,CAAC,KAAKC,MAAL,CAAY6C,UAAZ,CAAwB,WAAxB,EAAqC/B,IAArC,CAAtE,EAAoH;AACnH,eAAO,KAAP;AACA,OAV8C,CAY/C;;;AACA,WAAKE,sBAAL,GAb+C,CAe/C;;;AACA,UAAMiD,SAAS,GAAG,KAAK3F,MAAL,CAAY4F,aAAZ,CAA2B,WAA3B,CAAlB;AAEA,WAAK5F,MAAL,CAAYmE,MAAZ,CAAoBwB,SAApB,EAA+B,KAAKrE,QAApC;;AACA,WAAK6B,sBAAL,CAA6B,KAAK7B,QAAlC;;AAEA,WAAKW,kBAAL,GAA0B0D,SAA1B;AACA,WAAKrE,QAAL,GAAgB,KAAKtB,MAAL,CAAY8B,gBAAZ,CAA8B6D,SAA9B,EAAyC,CAAzC,CAAhB;AAEA,aAAO,IAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;;;;WACC,yCAAiCnD,IAAjC,EAAwC;AACvC,UAAMuD,SAAS,GAAG,KAAKF,aAAL,CAAoBrD,IAApB,EAA0B,KAAKlB,QAAL,CAAcG,MAAxC,CAAlB;;AAEA,UAAK,CAACsE,SAAN,EAAkB;AACjB,eAAO,KAAP;AACA,OALsC,CAOvC;;;AACA,UAAKA,SAAS,IAAI,KAAKzE,QAAL,CAAcG,MAAhC,EAAyC;AACxC,aAAKiB,sBAAL;AACA;;AAED,aAAQqD,SAAS,IAAI,KAAKzE,QAAL,CAAcG,MAAnC,EAA4C;AAC3C;AACA,YAAK,KAAKC,MAAL,CAAYsE,OAAZ,CAAqB,KAAK1E,QAAL,CAAcG,MAAnC,CAAL,EAAmD;AAClD,iBAAO,KAAP;AACA;;AAED,YAAK,KAAKH,QAAL,CAAc2E,SAAnB,EAA+B;AAC9B;AACA;AACA,cAAMxE,MAAM,GAAG,KAAKH,QAAL,CAAcG,MAA7B;AAEA,eAAKH,QAAL,GAAgB,KAAKtB,MAAL,CAAYkG,oBAAZ,CAAkCzE,MAAlC,CAAhB,CAL8B,CAO9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,cAAKA,MAAM,CAACsC,OAAP,IAAkBtC,MAAM,CAACA,MAAP,KAAkBsE,SAAzC,EAAqD;AACpD,iBAAK/F,MAAL,CAAYmG,MAAZ,CAAoB1E,MAApB;AACA;AACD,SAnBD,MAmBO,IAAK,KAAKH,QAAL,CAAc4B,OAAnB,EAA6B;AACnC;AACA;AACA,eAAK5B,QAAL,GAAgB,KAAKtB,MAAL,CAAY+C,mBAAZ,CAAiC,KAAKzB,QAAL,CAAcG,MAA/C,CAAhB;AACA,SAJM,MAIA;AACN,cAAM2E,OAAO,GAAG,KAAKpG,MAAL,CAAY+C,mBAAZ,CAAiC,KAAKzB,QAAL,CAAcG,MAA/C,CAAhB;;AAEA,eAAK0B,sBAAL,CAA6B,KAAK7B,QAAlC;;AACA,eAAKtB,MAAL,CAAYqG,KAAZ,CAAmB,KAAK/E,QAAxB;AAEA,eAAKA,QAAL,GAAgB8E,OAAhB;AAEA,eAAK7E,YAAL,CAAkB+E,GAAlB,CAAuB,KAAKhF,QAAL,CAAciF,SAArC;AACA;AACD;;AAED,aAAO,IAAP;AACA;AAED;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACC,uBAAe/D,IAAf,EAAqBgE,OAArB,EAA+B;AAC9B,UAAK,KAAK9E,MAAL,CAAY6C,UAAZ,CAAwBiC,OAAxB,EAAiChE,IAAjC,CAAL,EAA+C;AAC9C,eAAOgE,OAAP;AACA;;AAED,UAAKA,OAAO,CAAC/E,MAAb,EAAsB;AACrB,eAAO,KAAKoE,aAAL,CAAoBrD,IAApB,EAA0BgE,OAAO,CAAC/E,MAAlC,CAAP;AACA;;AAED,aAAO,IAAP;AACA","sourcesContent":["/**\n * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.\n * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license\n */\n\n/**\n * @module engine/model/utils/insertcontent\n */\n\nimport Position from '../position';\nimport LivePosition from '../liveposition';\nimport Element from '../element';\nimport Range from '../range';\nimport DocumentSelection from '../documentselection';\nimport Selection from '../selection';\nimport CKEditorError from '@ckeditor/ckeditor5-utils/src/ckeditorerror';\n\n/**\n * Inserts content into the editor (specified selection) as one would expect the paste functionality to work.\n *\n * It takes care of removing the selected content, splitting elements (if needed), inserting elements and merging elements appropriately.\n *\n * Some examples:\n *\n * \t\t<p>x^</p> + <p>y</p> => <p>x</p><p>y</p> => <p>xy[]</p>\n * \t\t<p>x^y</p> + <p>z</p> => <p>x</p>^<p>y</p> + <p>z</p> => <p>x</p><p>z</p><p>y</p> => <p>xz[]y</p>\n * \t\t<p>x^y</p> + <img /> => <p>x</p>^<p>y</p> + <img /> => <p>x</p><img /><p>y</p>\n * \t\t<p>x</p><p>^</p><p>z</p> + <p>y</p> => <p>x</p><p>y[]</p><p>z</p> (no merging)\n * \t\t<p>x</p>[<img />]<p>z</p> + <p>y</p> => <p>x</p>^<p>z</p> + <p>y</p> => <p>x</p><p>y[]</p><p>z</p>\n *\n * If an instance of {@link module:engine/model/selection~Selection} is passed as `selectable` it will be modified\n * to the insertion selection (equal to a range to be selected after insertion).\n *\n * If `selectable` is not passed, the content will be inserted using the current selection of the model document.\n *\n * **Note:** Use {@link module:engine/model/model~Model#insertContent} instead of this function.\n * This function is only exposed to be reusable in algorithms which change the {@link module:engine/model/model~Model#insertContent}\n * method's behavior.\n *\n * @param {module:engine/model/model~Model} model The model in context of which the insertion\n * should be performed.\n * @param {module:engine/model/documentfragment~DocumentFragment|module:engine/model/item~Item} content The content to insert.\n * @param {module:engine/model/selection~Selectable} [selectable=model.document.selection]\n * Selection into which the content should be inserted.\n * @param {Number|'before'|'end'|'after'|'on'|'in'} [placeOrOffset] Sets place or offset of the selection.\n * @returns {module:engine/model/range~Range} Range which contains all the performed changes. This is a range that, if removed,\n * would return the model to the state before the insertion. If no changes were preformed by `insertContent`, returns a range collapsed\n * at the insertion position.\n */\nexport default function insertContent( model, content, selectable, placeOrOffset ) {\n\treturn model.change( writer => {\n\t\tlet selection;\n\n\t\tif ( !selectable ) {\n\t\t\tselection = model.document.selection;\n\t\t} else if ( selectable instanceof Selection || selectable instanceof DocumentSelection ) {\n\t\t\tselection = selectable;\n\t\t} else {\n\t\t\tselection = writer.createSelection( selectable, placeOrOffset );\n\t\t}\n\n\t\tif ( !selection.isCollapsed ) {\n\t\t\tmodel.deleteContent( selection, { doNotAutoparagraph: true } );\n\t\t}\n\n\t\tconst insertion = new Insertion( model, writer, selection.anchor );\n\n\t\tlet nodesToInsert;\n\n\t\tif ( content.is( 'documentFragment' ) ) {\n\t\t\tnodesToInsert = content.getChildren();\n\t\t} else {\n\t\t\tnodesToInsert = [ content ];\n\t\t}\n\n\t\tinsertion.handleNodes( nodesToInsert );\n\n\t\tconst newRange = insertion.getSelectionRange();\n\n\t\t/* istanbul ignore else */\n\t\tif ( newRange ) {\n\t\t\tif ( selection instanceof DocumentSelection ) {\n\t\t\t\twriter.setSelection( newRange );\n\t\t\t} else {\n\t\t\t\tselection.setTo( newRange );\n\t\t\t}\n\t\t} else {\n\t\t\t// We are not testing else because it's a safe check for unpredictable edge cases:\n\t\t\t// an insertion without proper range to select.\n\t\t\t//\n\t\t\t// @if CK_DEBUG // console.warn( 'Cannot determine a proper selection range after insertion.' );\n\t\t}\n\n\t\tconst affectedRange = insertion.getAffectedRange() || model.createRange( selection.anchor );\n\n\t\tinsertion.destroy();\n\n\t\treturn affectedRange;\n\t} );\n}\n\n/**\n * Utility class for performing content insertion.\n *\n * @private\n */\nclass Insertion {\n\tconstructor( model, writer, position ) {\n\t\t/**\n\t\t * The model in context of which the insertion should be performed.\n\t\t *\n\t\t * @member {module:engine/model~Model} #model\n\t\t */\n\t\tthis.model = model;\n\n\t\t/**\n\t\t * Batch to which operations will be added.\n\t\t *\n\t\t * @member {module:engine/controller/writer~Batch} #writer\n\t\t */\n\t\tthis.writer = writer;\n\n\t\t/**\n\t\t * The position at which (or near which) the next node will be inserted.\n\t\t *\n\t\t * @member {module:engine/model/position~Position} #position\n\t\t */\n\t\tthis.position = position;\n\n\t\t/**\n\t\t * Elements with which the inserted elements can be merged.\n\t\t *\n\t\t *\t\t<p>x^</p><p>y</p> + <p>z</p> (can merge to <p>x</p>)\n\t\t *\t\t<p>x</p><p>^y</p> + <p>z</p> (can merge to <p>y</p>)\n\t\t *\t\t<p>x^y</p> + <p>z</p> (can merge to <p>xy</p> which will be split during the action,\n\t\t *\t\t\t\t\t\t\t\tso both its pieces will be added to this set)\n\t\t *\n\t\t *\n\t\t * @member {Set} #canMergeWith\n\t\t */\n\t\tthis.canMergeWith = new Set( [ this.position.parent ] );\n\n\t\t/**\n\t\t * Schema of the model.\n\t\t *\n\t\t * @member {module:engine/model/schema~Schema} #schema\n\t\t */\n\t\tthis.schema = model.schema;\n\n\t\t/**\n\t\t * The temporary DocumentFragment used for grouping multiple nodes for single insert operation.\n\t\t *\n\t\t * @private\n\t\t * @type {module:engine/model/documentfragment~DocumentFragment}\n\t\t */\n\t\tthis._documentFragment = writer.createDocumentFragment();\n\n\t\t/**\n\t\t * The current position in the temporary DocumentFragment.\n\t\t *\n\t\t * @private\n\t\t * @type {module:engine/model/position~Position}\n\t\t */\n\t\tthis._documentFragmentPosition = writer.createPositionAt( this._documentFragment, 0 );\n\n\t\t/**\n\t\t * The reference to the first inserted node.\n\t\t *\n\t\t * @private\n\t\t * @type {module:engine/model/node~Node}\n\t\t */\n\t\tthis._firstNode = null;\n\n\t\t/**\n\t\t * The reference to the last inserted node.\n\t\t *\n\t\t * @private\n\t\t * @type {module:engine/model/node~Node}\n\t\t */\n\t\tthis._lastNode = null;\n\n\t\t/**\n\t\t * The reference to the last auto paragraph node.\n\t\t *\n\t\t * @private\n\t\t * @type {module:engine/model/node~Node}\n\t\t */\n\t\tthis._lastAutoParagraph = null;\n\n\t\t/**\n\t\t * The array of nodes that should be cleaned of not allowed attributes.\n\t\t *\n\t\t * @private\n\t\t * @type {Array.<module:engine/model/node~Node>}\n\t\t */\n\t\tthis._filterAttributesOf = [];\n\n\t\t/**\n\t\t * Beginning of the affected range. See {@link module:engine/model/utils/insertcontent~Insertion#getAffectedRange}.\n\t\t *\n\t\t * @private\n\t\t * @member {module:engine/model/liveposition~LivePosition|null} #_affectedStart\n\t\t */\n\t\tthis._affectedStart = null;\n\n\t\t/**\n\t\t * End of the affected range. See {@link module:engine/model/utils/insertcontent~Insertion#getAffectedRange}.\n\t\t *\n\t\t * @private\n\t\t * @member {module:engine/model/liveposition~LivePosition|null} #_affectedEnd\n\t\t */\n\t\tthis._affectedEnd = null;\n\t}\n\n\t/**\n\t * Handles insertion of a set of nodes.\n\t *\n\t * @param {Iterable.<module:engine/model/node~Node>} nodes Nodes to insert.\n\t */\n\thandleNodes( nodes ) {\n\t\tfor ( const node of Array.from( nodes ) ) {\n\t\t\tthis._handleNode( node );\n\t\t}\n\n\t\t// Insert nodes collected in temporary DocumentFragment.\n\t\tthis._insertPartialFragment();\n\n\t\t// If there was an auto paragraph then we might need to adjust the end of insertion.\n\t\tif ( this._lastAutoParagraph ) {\n\t\t\tthis._updateLastNodeFromAutoParagraph( this._lastAutoParagraph );\n\t\t}\n\n\t\t// After the content was inserted we may try to merge it with its next sibling if the selection was in it initially.\n\t\t// Merging with the previous sibling was performed just after inserting the first node to the document.\n\t\tthis._mergeOnRight();\n\n\t\t// TMP this will become a post-fixer.\n\t\tthis.schema.removeDisallowedAttributes( this._filterAttributesOf, this.writer );\n\t\tthis._filterAttributesOf = [];\n\t}\n\n\t/**\n\t * Updates the last node after the auto paragraphing.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The last auto paragraphing node.\n\t */\n\t_updateLastNodeFromAutoParagraph( node ) {\n\t\tconst positionAfterLastNode = this.writer.createPositionAfter( this._lastNode );\n\t\tconst positionAfterNode = this.writer.createPositionAfter( node );\n\n\t\t// If the real end was after the last auto paragraph then update relevant properties.\n\t\tif ( positionAfterNode.isAfter( positionAfterLastNode ) ) {\n\t\t\tthis._lastNode = node;\n\n\t\t\t/* istanbul ignore if */\n\t\t\tif ( this.position.parent != node || !this.position.isAtEnd ) {\n\t\t\t\t// Algorithm's correctness check. We should never end up here but it's good to know that we did.\n\t\t\t\t// At this point the insertion position should be at the end of the last auto paragraph.\n\t\t\t\t// Note: This error is documented in other place in this file.\n\t\t\t\tthrow new CKEditorError( 'insertcontent-invalid-insertion-position', this );\n\t\t\t}\n\n\t\t\tthis.position = positionAfterNode;\n\t\t\tthis._setAffectedBoundaries( this.position );\n\t\t}\n\t}\n\n\t/**\n\t * Returns range to be selected after insertion.\n\t * Returns `null` if there is no valid range to select after insertion.\n\t *\n\t * @returns {module:engine/model/range~Range|null}\n\t */\n\tgetSelectionRange() {\n\t\tif ( this.nodeToSelect ) {\n\t\t\treturn Range._createOn( this.nodeToSelect );\n\t\t}\n\n\t\treturn this.model.schema.getNearestSelectionRange( this.position );\n\t}\n\n\t/**\n\t * Returns a range which contains all the performed changes. This is a range that, if removed, would return the model to the state\n\t * before the insertion. Returns `null` if no changes were done.\n\t *\n\t * @returns {module:engine/model/range~Range|null}\n\t */\n\tgetAffectedRange() {\n\t\tif ( !this._affectedStart ) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn new Range( this._affectedStart, this._affectedEnd );\n\t}\n\n\t/**\n\t * Destroys `Insertion` instance.\n\t */\n\tdestroy() {\n\t\tif ( this._affectedStart ) {\n\t\t\tthis._affectedStart.detach();\n\t\t}\n\n\t\tif ( this._affectedEnd ) {\n\t\t\tthis._affectedEnd.detach();\n\t\t}\n\t}\n\n\t/**\n\t * Handles insertion of a single node.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node\n\t */\n\t_handleNode( node ) {\n\t\t// Let's handle object in a special way.\n\t\t// * They should never be merged with other elements.\n\t\t// * If they are not allowed in any of the selection ancestors, they could be either autoparagraphed or totally removed.\n\t\tif ( this.schema.isObject( node ) ) {\n\t\t\tthis._handleObject( node );\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Try to find a place for the given node.\n\n\t\t// Check if a node can be inserted in the given position or it would be accepted if a paragraph would be inserted.\n\t\t// Inserts the auto paragraph if it would allow for insertion.\n\t\tlet isAllowed = this._checkAndAutoParagraphToAllowedPosition( node );\n\n\t\tif ( !isAllowed ) {\n\t\t\t// Split the position.parent's branch up to a point where the node can be inserted.\n\t\t\t// If it isn't allowed in the whole branch, then of course don't split anything.\n\t\t\tisAllowed = this._checkAndSplitToAllowedPosition( node );\n\n\t\t\tif ( !isAllowed ) {\n\t\t\t\tthis._handleDisallowedNode( node );\n\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// Add node to the current temporary DocumentFragment.\n\t\tthis._appendToFragment( node );\n\n\t\t// Store the first and last nodes for easy access for merging with sibling nodes.\n\t\tif ( !this._firstNode ) {\n\t\t\tthis._firstNode = node;\n\t\t}\n\n\t\tthis._lastNode = node;\n\t}\n\n\t/**\n\t * Inserts the temporary DocumentFragment into the model.\n\t *\n\t * @private\n\t */\n\t_insertPartialFragment() {\n\t\tif ( this._documentFragment.isEmpty ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst livePosition = LivePosition.fromPosition( this.position, 'toNext' );\n\n\t\tthis._setAffectedBoundaries( this.position );\n\n\t\t// If the very first node of the whole insertion process is inserted, insert it separately for OT reasons (undo).\n\t\t// Note: there can be multiple calls to `_insertPartialFragment()` during one insertion process.\n\t\t// Note: only the very first node can be merged so we have to do separate operation only for it.\n\t\tif ( this._documentFragment.getChild( 0 ) == this._firstNode ) {\n\t\t\tthis.writer.insert( this._firstNode, this.position );\n\n\t\t\t// We must merge the first node just after inserting it to avoid problems with OT.\n\t\t\t// (See: https://github.com/ckeditor/ckeditor5/pull/8773#issuecomment-760945652).\n\t\t\tthis._mergeOnLeft();\n\n\t\t\tthis.position = livePosition.toPosition();\n\t\t}\n\n\t\t// Insert the remaining nodes from document fragment.\n\t\tif ( !this._documentFragment.isEmpty ) {\n\t\t\tthis.writer.insert( this._documentFragment, this.position );\n\t\t}\n\n\t\tthis._documentFragmentPosition = this.writer.createPositionAt( this._documentFragment, 0 );\n\n\t\tthis.position = livePosition.toPosition();\n\t\tlivePosition.detach();\n\t}\n\n\t/**\n\t * @private\n\t * @param {module:engine/model/element~Element} node The object element.\n\t */\n\t_handleObject( node ) {\n\t\t// Try finding it a place in the tree.\n\t\tif ( this._checkAndSplitToAllowedPosition( node ) ) {\n\t\t\tthis._appendToFragment( node );\n\t\t}\n\t\t// Try autoparagraphing.\n\t\telse {\n\t\t\tthis._tryAutoparagraphing( node );\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t * @param {module:engine/model/node~Node} node The disallowed node which needs to be handled.\n\t */\n\t_handleDisallowedNode( node ) {\n\t\t// If the node is an element, try inserting its children (strip the parent).\n\t\tif ( node.is( 'element' ) ) {\n\t\t\tthis.handleNodes( node.getChildren() );\n\t\t}\n\t\t// If text is not allowed, try autoparagraphing it.\n\t\telse {\n\t\t\tthis._tryAutoparagraphing( node );\n\t\t}\n\t}\n\n\t/**\n\t * Append a node to the temporary DocumentFragment.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The node to insert.\n\t */\n\t_appendToFragment( node ) {\n\t\t/* istanbul ignore if */\n\t\tif ( !this.schema.checkChild( this.position, node ) ) {\n\t\t\t// Algorithm's correctness check. We should never end up here but it's good to know that we did.\n\t\t\t// Note that it would often be a silent issue if we insert node in a place where it's not allowed.\n\n\t\t\t/**\n\t\t\t * Given node cannot be inserted on the given position.\n\t\t\t *\n\t\t\t * @error insertcontent-wrong-position\n\t\t\t * @param {module:engine/model/node~Node} node Node to insert.\n\t\t\t * @param {module:engine/model/position~Position} position Position to insert the node at.\n\t\t\t */\n\t\t\tthrow new CKEditorError(\n\t\t\t\t'insertcontent-wrong-position',\n\t\t\t\tthis,\n\t\t\t\t{ node, position: this.position }\n\t\t\t);\n\t\t}\n\n\t\tthis.writer.insert( node, this._documentFragmentPosition );\n\t\tthis._documentFragmentPosition = this._documentFragmentPosition.getShiftedBy( node.offsetSize );\n\n\t\t// The last inserted object should be selected because we can't put a collapsed selection after it.\n\t\tif ( this.schema.isObject( node ) && !this.schema.checkChild( this.position, '$text' ) ) {\n\t\t\tthis.nodeToSelect = node;\n\t\t} else {\n\t\t\tthis.nodeToSelect = null;\n\t\t}\n\n\t\tthis._filterAttributesOf.push( node );\n\t}\n\n\t/**\n\t * Sets `_affectedStart` and `_affectedEnd` to the given `position`. Should be used before a change is done during insertion process to\n\t * mark the affected range.\n\t *\n\t * This method is used before inserting a node or splitting a parent node. `_affectedStart` and `_affectedEnd` are also changed\n\t * during merging, but the logic there is more complicated so it is left out of this function.\n\t *\n\t * @private\n\t * @param {module:engine/model/position~Position} position\n\t */\n\t_setAffectedBoundaries( position ) {\n\t\t// Set affected boundaries stickiness so that those position will \"expand\" when something is inserted in between them:\n\t\t// <paragraph>Foo][bar</paragraph> -> <paragraph>Foo]xx[bar</paragraph>\n\t\t// This is why it cannot be a range but two separate positions.\n\t\tif ( !this._affectedStart ) {\n\t\t\tthis._affectedStart = LivePosition.fromPosition( position, 'toPrevious' );\n\t\t}\n\n\t\t// If `_affectedEnd` is before the new boundary position, expand `_affectedEnd`. This can happen if first inserted node was\n\t\t// inserted into the parent but the next node is moved-out of that parent:\n\t\t// (1) <paragraph>Foo][</paragraph> -> <paragraph>Foo]xx[</paragraph>\n\t\t// (2) <paragraph>Foo]xx[</paragraph> -> <paragraph>Foo]xx</paragraph><widget></widget>[\n\t\tif ( !this._affectedEnd || this._affectedEnd.isBefore( position ) ) {\n\t\t\tif ( this._affectedEnd ) {\n\t\t\t\tthis._affectedEnd.detach();\n\t\t\t}\n\n\t\t\tthis._affectedEnd = LivePosition.fromPosition( position, 'toNext' );\n\t\t}\n\t}\n\n\t/**\n\t * Merges the previous sibling of the first node if it should be merged.\n\t *\n\t * After the content was inserted we may try to merge it with its siblings.\n\t * This should happen only if the selection was in those elements initially.\n\t *\n\t * @private\n\t */\n\t_mergeOnLeft() {\n\t\tconst node = this._firstNode;\n\n\t\tif ( !( node instanceof Element ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( !this._canMergeLeft( node ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst mergePosLeft = LivePosition._createBefore( node );\n\t\tmergePosLeft.stickiness = 'toNext';\n\n\t\tconst livePosition = LivePosition.fromPosition( this.position, 'toNext' );\n\n\t\t// If `_affectedStart` is sames as merge position, it means that the element \"marked\" by `_affectedStart` is going to be\n\t\t// removed and its contents will be moved. This won't transform `LivePosition` so `_affectedStart` needs to be moved\n\t\t// by hand to properly reflect affected range. (Due to `_affectedStart` and `_affectedEnd` stickiness, the \"range\" is\n\t\t// shown as `][`).\n\t\t//\n\t\t// Example - insert `<paragraph>Abc</paragraph><paragraph>Xyz</paragraph>` at the end of `<paragraph>Foo^</paragraph>`:\n\t\t//\n\t\t// <paragraph>Foo</paragraph><paragraph>Bar</paragraph>   -->\n\t\t// <paragraph>Foo</paragraph>]<paragraph>Abc</paragraph><paragraph>Xyz</paragraph>[<paragraph>Bar</paragraph>   -->\n\t\t// <paragraph>Foo]Abc</paragraph><paragraph>Xyz</paragraph>[<paragraph>Bar</paragraph>\n\t\t//\n\t\t// Note, that if we are here then something must have been inserted, so `_affectedStart` and `_affectedEnd` have to be set.\n\t\tif ( this._affectedStart.isEqual( mergePosLeft ) ) {\n\t\t\tthis._affectedStart.detach();\n\t\t\tthis._affectedStart = LivePosition._createAt( mergePosLeft.nodeBefore, 'end', 'toPrevious' );\n\t\t}\n\n\t\t// We need to update the references to the first and last nodes if they will be merged into the previous sibling node\n\t\t// because the reference would point to the removed node.\n\t\t//\n\t\t// <p>A^A</p> + <p>X</p>\n\t\t//\n\t\t// <p>A</p>^<p>A</p>\n\t\t// <p>A</p><p>X</p><p>A</p>\n\t\t// <p>AX</p><p>A</p>\n\t\t// <p>AXA</p>\n\t\tif ( this._firstNode === this._lastNode ) {\n\t\t\tthis._firstNode = mergePosLeft.nodeBefore;\n\t\t\tthis._lastNode = mergePosLeft.nodeBefore;\n\t\t}\n\n\t\tthis.writer.merge( mergePosLeft );\n\n\t\t// If only one element (the merged one) is in the \"affected range\", also move the affected range end appropriately.\n\t\t//\n\t\t// Example - insert `<paragraph>Abc</paragraph>` at the of `<paragraph>Foo^</paragraph>`:\n\t\t//\n\t\t// <paragraph>Foo</paragraph><paragraph>Bar</paragraph>   -->\n\t\t// <paragraph>Foo</paragraph>]<paragraph>Abc</paragraph>[<paragraph>Bar</paragraph>   -->\n\t\t// <paragraph>Foo]Abc</paragraph>[<paragraph>Bar</paragraph>   -->\n\t\t// <paragraph>Foo]Abc[</paragraph><paragraph>Bar</paragraph>\n\t\tif ( mergePosLeft.isEqual( this._affectedEnd ) && this._firstNode === this._lastNode ) {\n\t\t\tthis._affectedEnd.detach();\n\t\t\tthis._affectedEnd = LivePosition._createAt( mergePosLeft.nodeBefore, 'end', 'toNext' );\n\t\t}\n\n\t\tthis.position = livePosition.toPosition();\n\t\tlivePosition.detach();\n\n\t\t// After merge elements that were marked by _insert() to be filtered might be gone so\n\t\t// we need to mark the new container.\n\t\tthis._filterAttributesOf.push( this.position.parent );\n\n\t\tmergePosLeft.detach();\n\t}\n\n\t/**\n\t * Merges the next sibling of the last node if it should be merged.\n\t *\n\t * After the content was inserted we may try to merge it with its siblings.\n\t * This should happen only if the selection was in those elements initially.\n\t *\n\t * @private\n\t */\n\t_mergeOnRight() {\n\t\tconst node = this._lastNode;\n\n\t\tif ( !( node instanceof Element ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( !this._canMergeRight( node ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst mergePosRight = LivePosition._createAfter( node );\n\t\tmergePosRight.stickiness = 'toNext';\n\n\t\t/* istanbul ignore if */\n\t\tif ( !this.position.isEqual( mergePosRight ) ) {\n\t\t\t// Algorithm's correctness check. We should never end up here but it's good to know that we did.\n\t\t\t// At this point the insertion position should be after the node we'll merge. If it isn't,\n\t\t\t// it should need to be secured as in the left merge case.\n\t\t\t/**\n\t\t\t * An internal error occurred when merging inserted content with its siblings.\n\t\t\t * The insertion position should equal the merge position.\n\t\t\t *\n\t\t\t * If you encountered this error, report it back to the CKEditor 5 team\n\t\t\t * with as many details as possible regarding the content being inserted and the insertion position.\n\t\t\t *\n\t\t\t * @error insertcontent-invalid-insertion-position\n\t\t\t */\n\t\t\tthrow new CKEditorError( 'insertcontent-invalid-insertion-position', this );\n\t\t}\n\n\t\t// Move the position to the previous node, so it isn't moved to the graveyard on merge.\n\t\t// <p>x</p>[]<p>y</p> => <p>x[]</p><p>y</p>\n\t\tthis.position = Position._createAt( mergePosRight.nodeBefore, 'end' );\n\n\t\t// Explanation of setting position stickiness to `'toPrevious'`:\n\t\t// OK:  <p>xx[]</p> + <p>yy</p> => <p>xx[]yy</p> (when sticks to previous)\n\t\t// NOK: <p>xx[]</p> + <p>yy</p> => <p>xxyy[]</p> (when sticks to next)\n\t\tconst livePosition = LivePosition.fromPosition( this.position, 'toPrevious' );\n\n\t\t// See comment in `_mergeOnLeft()` on moving `_affectedStart`.\n\t\tif ( this._affectedEnd.isEqual( mergePosRight ) ) {\n\t\t\tthis._affectedEnd.detach();\n\t\t\tthis._affectedEnd = LivePosition._createAt( mergePosRight.nodeBefore, 'end', 'toNext' );\n\t\t}\n\n\t\t// We need to update the references to the first and last nodes if they will be merged into the previous sibling node\n\t\t// because the reference would point to the removed node.\n\t\t//\n\t\t// <p>A^A</p> + <p>X</p>\n\t\t//\n\t\t// <p>A</p>^<p>A</p>\n\t\t// <p>A</p><p>X</p><p>A</p>\n\t\t// <p>AX</p><p>A</p>\n\t\t// <p>AXA</p>\n\t\tif ( this._firstNode === this._lastNode ) {\n\t\t\tthis._firstNode = mergePosRight.nodeBefore;\n\t\t\tthis._lastNode = mergePosRight.nodeBefore;\n\t\t}\n\n\t\tthis.writer.merge( mergePosRight );\n\n\t\t// See comment in `_mergeOnLeft()` on moving `_affectedStart`.\n\t\tif ( mergePosRight.getShiftedBy( -1 ).isEqual( this._affectedStart ) && this._firstNode === this._lastNode ) {\n\t\t\tthis._affectedStart.detach();\n\t\t\tthis._affectedStart = LivePosition._createAt( mergePosRight.nodeBefore, 0, 'toPrevious' );\n\t\t}\n\n\t\tthis.position = livePosition.toPosition();\n\t\tlivePosition.detach();\n\n\t\t// After merge elements that were marked by _insert() to be filtered might be gone so\n\t\t// we need to mark the new container.\n\t\tthis._filterAttributesOf.push( this.position.parent );\n\n\t\tmergePosRight.detach();\n\t}\n\n\t/**\n\t * Checks whether specified node can be merged with previous sibling element.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The node which could potentially be merged.\n\t * @returns {Boolean}\n\t */\n\t_canMergeLeft( node ) {\n\t\tconst previousSibling = node.previousSibling;\n\n\t\treturn ( previousSibling instanceof Element ) &&\n\t\t\tthis.canMergeWith.has( previousSibling ) &&\n\t\t\tthis.model.schema.checkMerge( previousSibling, node );\n\t}\n\n\t/**\n\t * Checks whether specified node can be merged with next sibling element.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The node which could potentially be merged.\n\t * @returns {Boolean}\n\t */\n\t_canMergeRight( node ) {\n\t\tconst nextSibling = node.nextSibling;\n\n\t\treturn ( nextSibling instanceof Element ) &&\n\t\t\tthis.canMergeWith.has( nextSibling ) &&\n\t\t\tthis.model.schema.checkMerge( node, nextSibling );\n\t}\n\n\t/**\n\t * Tries wrapping the node in a new paragraph and inserting it this way.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The node which needs to be autoparagraphed.\n\t */\n\t_tryAutoparagraphing( node ) {\n\t\tconst paragraph = this.writer.createElement( 'paragraph' );\n\n\t\t// Do not autoparagraph if the paragraph won't be allowed there,\n\t\t// cause that would lead to an infinite loop. The paragraph would be rejected in\n\t\t// the next _handleNode() call and we'd be here again.\n\t\tif ( this._getAllowedIn( paragraph, this.position.parent ) && this.schema.checkChild( paragraph, node ) ) {\n\t\t\tparagraph._appendChild( node );\n\t\t\tthis._handleNode( paragraph );\n\t\t}\n\t}\n\n\t/**\n\t * Checks if a node can be inserted in the given position or it would be accepted if a paragraph would be inserted.\n\t * It also handles inserting the paragraph.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The node.\n\t * @returns {Boolean} Whether an allowed position was found.\n\t * `false` is returned if the node isn't allowed at the current position or in auto paragraph, `true` if was.\n\t */\n\t_checkAndAutoParagraphToAllowedPosition( node ) {\n\t\tif ( this.schema.checkChild( this.position.parent, node ) ) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Do not auto paragraph if the paragraph won't be allowed there,\n\t\t// cause that would lead to an infinite loop. The paragraph would be rejected in\n\t\t// the next _handleNode() call and we'd be here again.\n\t\tif ( !this.schema.checkChild( this.position.parent, 'paragraph' ) || !this.schema.checkChild( 'paragraph', node ) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Insert nodes collected in temporary DocumentFragment if the position parent needs change to process further nodes.\n\t\tthis._insertPartialFragment();\n\n\t\t// Insert a paragraph and move insertion position to it.\n\t\tconst paragraph = this.writer.createElement( 'paragraph' );\n\n\t\tthis.writer.insert( paragraph, this.position );\n\t\tthis._setAffectedBoundaries( this.position );\n\n\t\tthis._lastAutoParagraph = paragraph;\n\t\tthis.position = this.writer.createPositionAt( paragraph, 0 );\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @private\n\t * @param {module:engine/model/node~Node} node\n\t * @returns {Boolean} Whether an allowed position was found.\n\t * `false` is returned if the node isn't allowed at any position up in the tree, `true` if was.\n\t */\n\t_checkAndSplitToAllowedPosition( node ) {\n\t\tconst allowedIn = this._getAllowedIn( node, this.position.parent );\n\n\t\tif ( !allowedIn ) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Insert nodes collected in temporary DocumentFragment if the position parent needs change to process further nodes.\n\t\tif ( allowedIn != this.position.parent ) {\n\t\t\tthis._insertPartialFragment();\n\t\t}\n\n\t\twhile ( allowedIn != this.position.parent ) {\n\t\t\t// If a parent which we'd need to leave is a limit element, break.\n\t\t\tif ( this.schema.isLimit( this.position.parent ) ) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif ( this.position.isAtStart ) {\n\t\t\t\t// If insertion position is at the beginning of the parent, move it out instead of splitting.\n\t\t\t\t// <p>^Foo</p> -> ^<p>Foo</p>\n\t\t\t\tconst parent = this.position.parent;\n\n\t\t\t\tthis.position = this.writer.createPositionBefore( parent );\n\n\t\t\t\t// Special case  parent is empty (<p>^</p>).\n\t\t\t\t//\n\t\t\t\t// 1. parent.isEmpty\n\t\t\t\t// We can remove the element after moving insertion position out of it.\n\t\t\t\t//\n\t\t\t\t// 2. parent.parent === allowedIn\n\t\t\t\t// However parent should remain in place when allowed element is above limit element in document tree.\n\t\t\t\t// For example there shouldn't be allowed to remove empty paragraph from tableCell, when is pasted\n\t\t\t\t// content allowed in $root.\n\t\t\t\tif ( parent.isEmpty && parent.parent === allowedIn ) {\n\t\t\t\t\tthis.writer.remove( parent );\n\t\t\t\t}\n\t\t\t} else if ( this.position.isAtEnd ) {\n\t\t\t\t// If insertion position is at the end of the parent, move it out instead of splitting.\n\t\t\t\t// <p>Foo^</p> -> <p>Foo</p>^\n\t\t\t\tthis.position = this.writer.createPositionAfter( this.position.parent );\n\t\t\t} else {\n\t\t\t\tconst tempPos = this.writer.createPositionAfter( this.position.parent );\n\n\t\t\t\tthis._setAffectedBoundaries( this.position );\n\t\t\t\tthis.writer.split( this.position );\n\n\t\t\t\tthis.position = tempPos;\n\n\t\t\t\tthis.canMergeWith.add( this.position.nodeAfter );\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Gets the element in which the given node is allowed. It checks the passed element and all its ancestors.\n\t *\n\t * @private\n\t * @param {module:engine/model/node~Node} node The node to check.\n\t * @param {module:engine/model/element~Element} element The element in which the node's correctness should be checked.\n\t * @returns {module:engine/model/element~Element|null}\n\t */\n\t_getAllowedIn( node, element ) {\n\t\tif ( this.schema.checkChild( element, node ) ) {\n\t\t\treturn element;\n\t\t}\n\n\t\tif ( element.parent ) {\n\t\t\treturn this._getAllowedIn( node, element.parent );\n\t\t}\n\n\t\treturn null;\n\t}\n}\n"]}]}